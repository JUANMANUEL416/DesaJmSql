CREATE OR ALTER PROCEDURE DBO.SPQ_RPT_NOMINA @JSON NVARCHAR(MAX)
	WITH ENCRYPTION
AS
SET DATEFORMAT dmy
DECLARE @TBLERRORES TABLE (ERROR VARCHAR(MAX))
DECLARE  @PARAMETROS NVARCHAR(MAX)			,@MODELO VARCHAR(100)			   ,@METODO VARCHAR(100)
		,@USUARIO VARCHAR(12)				   ,@COMPANIA VARCHAR(2)		      ,@IDSEDE      VARCHAR(5)		
      ,@SYS_COMPUTERNAME VARCHAR(200)     ,@DATOS    VARCHAR(MAX)
      ,@CNSNIEPE VARCHAR(20)              ,@CNSPAGO  VARCHAR(20)           ,@NUMDOC    VARCHAR(20)
      ,@NRODOCUMENTO VARCHAR(20)          ,@SEXO VARCHAR(20)               ,@PNOMBRE VARCHAR(20)
      ,@SNOMBRE VARCHAR(20)               ,@PEAPELLIDO VARCHAR(20)         ,@SAPELLIDO VARCHAR(20)
      ,@F_NACIMIENTO DATE                 ,@DIRECCION VARCHAR(20)          ,@TELEFONO VARCHAR(20)
      ,@ESTCIVIL VARCHAR(20)              ,@GRUPO_SANG VARCHAR(20)         ,@NROCUENTA VARCHAR(20)
      ,@BANCO VARCHAR(20)                 ,@NOMINA VARCHAR(20)             ,@CCOSTO VARCHAR(20)
      ,@TCONTRATO VARCHAR(20)             ,@CODCARGO VARCHAR(20)           ,@GRADO VARCHAR(20)
      ,@NIVEL VARCHAR(20)                 ,@F_INGRESO DATETIME             ,@BASICO VARCHAR(20)
      ,@CIUD_DOC VARCHAR(20)              ,@NITSALUD VARCHAR(20)           ,@NITPENSION VARCHAR(20)
      ,@NITAREL VARCHAR(20)               ,@EMAIL VARCHAR(1000)              ,@NROLINEAS INT
      ,@CNSRPDX VARCHAR(20)               ,@INDICE INT                     ,@ERROR VARCHAR(2024)
      ,@XFECHA VARCHAR(20)                ,@TIPODOC VARCHAR(10)            ,@ER BIT
      ,@BASICOC DECIMAL(14,2)             ,@ESTRUCTURA INT                 ,@SEDEMPLE VARCHAR(6)
BEGIN
	SELECT *
	INTO #JSON
	FROM OPENJSON(@json) WITH (
			MODELO VARCHAR(100) '$.MODELO'
			,METODO VARCHAR(100) '$.METODO'
			,USUARIO VARCHAR(12) '$.USUARIO'
			,PARAMETROS NVARCHAR(MAX) AS JSON
	)

	SELECT   @MODELO = MODELO			,@METODO = METODO
			,@PARAMETROS = PARAMETROS	,@USUARIO = USUARIO
	FROM #JSON

   IF @METODO='COLILLAS'     
   BEGIN  
      PRINT 'INGRESO AL DATO'
      SELECT @CNSNIEPE=CNSNIEPE,@CNSPAGO=CNSPAGO,@NUMDOC=NUMDOC       
      FROM   OPENJSON (@PARAMETROS)
      WITH (           
        CNSNIEPE VARCHAR(20) '$.CNSNIEPE',
        CNSPAGO VARCHAR(20) '$.CNSPAGO',
        NUMDOC VARCHAR(20) '$.NUMDOC'
       )           
      IF EXISTS(SELECT * FROM NIEPE WHERE CNSNIEPE=@CNSNIEPE AND CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC)
      BEGIN
         SELECT  'OK' OK
         SELECT NIEPE.CODNOMINA,NIEPE.CNSPAGO,NIEPE.NOMBRE_PERIODO,NOMBRE_AREA,NOMBRE_CCOSTO,TER.NIT,TER.RAZONSOCIAL,
         NIEPE.DETALLE_CARGO,NIEPE.BASICO,NIEPE.VALOR_INGRESOS,VALOR_EGRESOS,NIEPE.VALOR_APORTES,NIEPE.VALOR_NETO
         FROM NIEPE INNER JOIN NPER ON NIEPE.CNSPAGO=NPER.CNSPAGO
                    INNER JOIN NPPAG ON NPER.CODPPAG=NPPAG.CODPPAG
                    INNER JOIN NEMP ON NIEPE.NUMDOC= NEMP.NUMDOC
                    INNER JOIN TER  ON NEMP.TERCEROID=TER.IDTERCERO
         WHERE CNSNIEPE=@CNSNIEPE 
         AND NIEPE.CNSPAGO=@CNSPAGO 
         AND NIEPE.NUMDOC=@NUMDOC
         SELECT CODCONCEPTO+'  '+NOMBRE_CONCEPTO+CASE WHEN COALESCE(IDTERCERO_PRF,'')<>'' AND IDTERCERO_PRF<>NUMDOC THEN ' : '+RAZONSOCIAL_PRF ELSE '' END NOMBRE_CONCEPTO,
                CONVERT(DECIMAL(14,2),CANTIDAD)CANTIDAD,CONVERT(DECIMAL(14,2),CASE WHEN TIPO='Ingreso' THEN VALOR ELSE 0 END) DEVENGADOS,
                CONVERT(DECIMAL(14,2),CASE WHEN TIPO='Egreso' AND VALOR> 0 THEN VALOR ELSE 0 END) DEDUCIDOS,
                CONVERT(DECIMAL(14,2),CASE WHEN TIPO='Egreso' AND VALOR =0 THEN VALOR_APORTES ELSE 0 END) EMPLEADOR 
         FROM NIEPED
         WHERE CNSNIEPE=@CNSNIEPE 
         AND NUMDOC=@NUMDOC
      END
   END   
   IF @METODO='LISTA_PAGOS'     
   BEGIN         
      SELECT @CNSPAGO= CNSPAGO     
      FROM   OPENJSON (@PARAMETROS)
      WITH (           
         CNSPAGO VARCHAR(20) '$.CNSPAGO'
         )           
      IF EXISTS(SELECT  * FROM NIEPE WHERE CNSPAGO=@CNSPAGO)
      BEGIN
         SELECT 'OK' OK

         SELECT CNSNIEPE,CNSPAGO,NIEPE.NUMDOC,TER.NIT,NIEPE.NOMBRE_EMPLEADO,COALESCE(NEMP.EMAIL,TER.EMAIL)EMAIL
         FROM NIEPE INNER JOIN TER ON NIEPE.NUMDOC=TER.IDTERCERO
                    INNER JOIN NEMP ON NIEPE.NUMDOC=NEMP.NUMDOC
         WHERE CNSPAGO=@CNSPAGO
         ORDER BY TER.NIT ASC
         RETURN
      END
   END   
	IF @METODO = 'CREA_RPDX'     
	BEGIN         
		SELECT @CNSRPDX = ''
		     , @IDSEDE = COALESCE(UBEQ.IDSEDE,USUSU.IDSEDE)
			 , @COMPANIA = COALESCE(UBEQ.COMPANIA,USUSU.COMPANIA)
			 , @SYS_COMPUTERNAME = COALESCE(USUSU.SYS_ComputerName,HOST_NAME())
		FROM USUSU 
		     LEFT JOIN UBEQ ON USUSU.SYS_ComputerName=UBEQ.SYS_ComputerName
		WHERE 
		     USUSU.USUARIO = @USUARIO
		
		BEGIN TRY           
			PRINT 'AQUI LLAMO A GENCONSECUTIVO @IDSEDE=' + COALESCE(@IDSEDE,'SIN SEDE')   
			SELECT @CNSRPDX=''

			EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE, '@RPDX', @CNSRPDX OUTPUT  
			SELECT @CNSRPDX = @IDSEDE+REPLACE(SPACE(8 - LEN(@CNSRPDX))+LTRIM(RTRIM(@CNSRPDX)),SPACE(1),0)

			PRINT '@CNSRPDX='+COALESCE(@CNSRPDX,'')   
            
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		END CATCH
		IF(SELECT COUNT(*) FROM @TBLERRORES)>0
		BEGIN
			SELECT 'KO' OK, ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' OK,@CNSRPDX CNSRPDX
		RETURN 
	END   
	IF @METODO='CARGAR_NEMP'
	BEGIN
			
		DECLARE @LINEA AS VARCHAR(MAX)
		DECLARE @TABLA AS TABLE(
			ITEM INT IDENTITY(1,1),
			VALOR VARCHAR(MAX)
		)

      SELECT  @NROLINEAS=COUNT(*)
		FROM OPENJSON(@PARAMETROS, '$.LINEAS') 

      PRINT '@NROLINEAS='+CAST(@NROLINEAS AS VARCHAR(20))
      IF @NROLINEAS>0
      BEGIN

		   SELECT @IDSEDE=COALESCE(UBEQ.IDSEDE,USUSU.IDSEDE),@COMPANIA=COALESCE(UBEQ.COMPANIA,USUSU.COMPANIA),
		   @SYS_COMPUTERNAME=COALESCE(USUSU.SYS_ComputerName,HOST_NAME())
		   FROM USUSU LEFT JOIN UBEQ ON USUSU.SYS_ComputerName=UBEQ.SYS_ComputerName
		   WHERE USUSU.USUARIO=@USUARIO

		   PRINT 'AQUI LLAMO A GENCONSECUTIVO @IDSEDE='+COALESCE(@IDSEDE,'SIN SEDE')   
         SELECT @CNSRPDX=''
		   EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE, '@RPDX', @CNSRPDX OUTPUT  
		   SELECT @CNSRPDX = @IDSEDE+REPLACE(SPACE(8 - LEN(@CNSRPDX))+LTRIM(RTRIM(@CNSRPDX)),SPACE(1),0)
		   PRINT '@CNSRPDX='+COALESCE(@CNSRPDX,'') 

         SELECT @INDICE=0
		   DECLARE SUBIR_CURSOR CURSOR FOR   
	      SELECT VALUE 
		   FROM OPENJSON(@PARAMETROS, '$.LINEAS')		  
		   OPEN SUBIR_CURSOR  
		   FETCH NEXT FROM SUBIR_CURSOR INTO @LINEA
		   WHILE @@FETCH_STATUS = 0  
		   BEGIN  
			   DELETE @TABLA WHERE 1=1

			   INSERT INTO @TABLA(VALOR)
			   SELECT VALUE FROM string_split(@LINEA,',')
            
            SELECT @ESTRUCTURA=COUNT(*) FROM @TABLA


            SET @ERROR=''
            SET @ER=0
            SELECT  @NRODOCUMENTO = NULL,@SEXO = NULL,@PNOMBRE = NULL,@SNOMBRE = NULL,@PEAPELLIDO = NULL,@SAPELLIDO = NULL,
                    @F_NACIMIENTO = NULL,@DIRECCION = NULL,@TELEFONO = NULL,@ESTCIVIL = NULL,@GRUPO_SANG = NULL,@NROCUENTA = NULL,
                    @BANCO = NULL,@NOMINA = NULL,@CCOSTO = NULL,@TCONTRATO = NULL,@CODCARGO = NULL,@GRADO = NULL,@NIVEL = NULL,
                    @F_INGRESO = NULL,@BASICO = NULL,@CIUD_DOC = NULL,@NITSALUD = NULL,@NITPENSION = NULL,@NITAREL = NULL,
                    @EMAIL = NULL 

            BEGIN TRY           
               SELECT @NRODOCUMENTO=VALOR FROM @TABLA WHERE ITEM=1+@INDICE
               SELECT @TIPODOC=VALOR FROM @TABLA WHERE ITEM=2+@INDICE
               SELECT @SEXO=VALOR FROM @TABLA WHERE ITEM=3+@INDICE
               SELECT @PNOMBRE=VALOR FROM @TABLA WHERE ITEM=4+@INDICE
               SELECT @SNOMBRE=VALOR FROM @TABLA WHERE ITEM=5+@INDICE
               SELECT @PEAPELLIDO=VALOR FROM @TABLA WHERE ITEM=6+@INDICE
               SELECT @SAPELLIDO=VALOR FROM @TABLA WHERE ITEM=7+@INDICE
               SELECT @XFECHA=VALOR FROM @TABLA WHERE ITEM=8+@INDICE
               IF ISDATE(@XFECHA)=1
               BEGIN
               SELECT @F_NACIMIENTO=CONVERT(DATE,VALOR) FROM @TABLA WHERE ITEM=8+@INDICE
               END
               ELSE 
               BEGIN
                  SELECT @F_NACIMIENTO=NULL,@ER=1,@ERROR='Fecha de Nacimiento no Valida '+@XFECHA
               END
               SELECT @DIRECCION=VALOR FROM @TABLA WHERE ITEM=9+@INDICE
               SELECT @TELEFONO=VALOR FROM @TABLA WHERE ITEM=10+@INDICE
               SELECT @ESTCIVIL=VALOR FROM @TABLA WHERE ITEM=11+@INDICE
               SELECT @GRUPO_SANG=VALOR FROM @TABLA WHERE ITEM=12+@INDICE
               SELECT @NROCUENTA=VALOR FROM @TABLA WHERE ITEM=13+@INDICE
               SELECT @BANCO=VALOR FROM @TABLA WHERE ITEM=14+@INDICE
               SELECT @NOMINA=VALOR FROM @TABLA WHERE ITEM=15+@INDICE
               SELECT @CCOSTO=VALOR FROM @TABLA WHERE ITEM=16+@INDICE
               SELECT @TCONTRATO=VALOR FROM @TABLA WHERE ITEM=17+@INDICE
               SELECT @CODCARGO=VALOR FROM @TABLA WHERE ITEM=18+@INDICE
               SELECT @GRADO=VALOR FROM @TABLA WHERE ITEM=19+@INDICE
               SELECT @NIVEL=VALOR FROM @TABLA WHERE ITEM=20+@INDICE
               SELECT @XFECHA=VALOR FROM @TABLA WHERE ITEM=21+@INDICE
               IF ISDATE(@XFECHA)=1
               BEGIN
               SELECT @F_INGRESO=CONVERT(DATE,VALOR) FROM @TABLA WHERE ITEM=21+@INDICE
               END
               ELSE 
               BEGIN
                  SELECT @F_INGRESO=NULL,@ER=1,@ERROR='Fecha de Ingreso no Valida ='+@XFECHA
               END
               SELECT @BASICO=VALOR FROM @TABLA WHERE ITEM=22+@INDICE
               SELECT @CIUD_DOC=VALOR FROM @TABLA WHERE ITEM=23+@INDICE
               SELECT @NITSALUD=VALOR FROM @TABLA WHERE ITEM=24+@INDICE
               SELECT @NITPENSION=VALOR FROM @TABLA WHERE ITEM=25+@INDICE
               SELECT @NITAREL=VALOR FROM @TABLA WHERE ITEM=26+@INDICE
               SELECT @EMAIL=VALOR FROM @TABLA WHERE ITEM=27+@INDICE
               SELECT @SEDEMPLE=VALOR FROM @TABLA WHERE ITEM=28+@INDICE
               IF @ESTRUCTURA <> 28
               BEGIN
                  SELECT @ER=1,@ERROR='Error de Estructura Campos ='+CAST(@ESTRUCTURA AS VARCHAR(4))
               END            

               IF @ER=1
               BEGIN
                  INSERT INTO RPDX(CNS,IDTERCERO,CNS1,ID1,ID2,ID3,ID4,ID5,FECHA1,STRINGMEDIO1,ID8,ID9,ID10,ID11,ID12,ID13,
                                    ID14,ID16,ID17,ID18,ID19,FECHA2,VALOR1,ID20,STRINGCORTO1,STRINGCORTO2,STRINGMEDIO3,
                                    STRINGGRANDE2,CANTIDAD10,STRINGMAX,CNS2)
                  SELECT @CNSRPDX,@NRODOCUMENTO,@TIPODOC,@SEXO,@PNOMBRE,@SNOMBRE,@PEAPELLIDO,@SAPELLIDO,@F_NACIMIENTO,@DIRECCION,@TELEFONO,@ESTCIVIL,@GRUPO_SANG,@NROCUENTA,@BANCO,@NOMINA,@CCOSTO,@TCONTRATO,@CODCARGO,
                         @GRADO,@NIVEL,@F_INGRESO,CASE WHEN ISNUMERIC(@BASICO)=1 THEN @BASICO ELSE 0 END,@CIUD_DOC,@NITSALUD,@NITPENSION,@NITAREL,@EMAIL,1,@ERROR,@SEDEMPLE
               END
               ELSE
               BEGIN
                  PRINT 'Validaición de existencia de datos'
                  
                  IF LEN(@TIPODOC)<=0 OR LEN(@TIPODOC)>3
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Tipo de Documento no Valido'
                  END
                  IF LEN(@NRODOCUMENTO)<=6 OR LEN(@NRODOCUMENTO)>11
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Nro  de Documento no Valido'
                  END
                  IF @F_INGRESO>DBO.FNK_GETDATE()
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Fecha de Ingreso Mayor a la Actual'
                  END
                  IF  @F_NACIMIENTO > DBO.FNK_GETDATE()
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Fecha de Nacimiento Mayor a la Actual'
                  END
                  IF NOT EXISTS(SELECT * FROM NOMI WHERE CODNOMINA=@NOMINA)
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+', Codigo de la Nomina No existe'
                  END
                  IF NOT EXISTS(SELECT * FROM CEN WHERE CCOSTO=@CCOSTO AND ESTADO='Activo')
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Centro de Costo  No existe o Esta inactivo @CCOSTO='+@CCOSTO
                  END
                  IF NOT EXISTS(SELECT * FROM NCARNG WHERE CODCARGO=@CODCARGO AND GRADO=@GRADO AND NIVEL=@NIVEL)
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',No existe el Codigo de Cargo, Grado y Nivel Verifique CODCARGO='+@CODCARGO+' GRADO='+@GRADO
                  END 
                  ELSE
                  BEGIN
                     IF ISNUMERIC(@BASICO)=1
                     BEGIN
                        SELECT TOP 1 @BASICOC=BASICO FROM NCARNGV WHERE CODCARGO=@CODCARGO AND GRADO=@GRADO AND NIVEL=@NIVEL ORDER BY FECHA DESC
                        IF @BASICO <> @BASICO
                        BEGIN
                           SELECT @ER=1,@ERROR=@ERROR+',Inconsistencia entre el Basico del Cargo vs el Basico del Empleado'
                        END
                     END
                     ELSE
                     BEGIN
                        SELECT @ER=1,@ERROR=@ERROR+',Error en el Basico = '+@BASICO
                     END
                  END
                  IF NOT EXISTS(SELECT * FROM TER WHERE (IDTERCERO=@NITSALUD OR NIT=@NITSALUD))
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',El idtercero para Aportes en SALUD  no Existe '
                  END
                  IF NOT EXISTS(SELECT * FROM TER WHERE (IDTERCERO=@NITPENSION OR NIT=@NITPENSION))
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',El idtercero para Aportes en PENSION  no Existe '
                  END
                  IF NOT EXISTS(SELECT * FROM TER WHERE (IDTERCERO=@NITAREL OR NIT=@NITAREL))
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',El idtercero para Aportes en ARL  no Existe '
                  END
                  IF LEN(@EMAIL)<5 OR CHARINDEX('@',@EMAIL,0)=0
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Correo Electronico no Valido '
                  END
                  IF NOT EXISTS(SELECT  * FROM SED WHERE IDSEDE=@SEDEMPLE)
                  BEGIN
                     SELECT @ER=1,@ERROR=@ERROR+',Sede Asociada al Empleado no Existe '+@SEDEMPLE
                  END
  
                  INSERT INTO RPDX(CNS,IDTERCERO,CNS1,ID1,ID2,ID3,ID4,ID5,FECHA1,STRINGMEDIO1,ID8,ID9,ID10,ID11,ID12,ID13,
                                    ID14,ID16,ID17,ID18,ID19,FECHA2,VALOR1,ID20,STRINGCORTO1,STRINGCORTO2,STRINGMEDIO3,
                                    STRINGGRANDE2,CANTIDAD10,STRINGMAX,CNS2)
                  SELECT @CNSRPDX,@NRODOCUMENTO,@TIPODOC,@SEXO,@PNOMBRE,@SNOMBRE,@PEAPELLIDO,@SAPELLIDO,@F_NACIMIENTO,@DIRECCION,@TELEFONO,@ESTCIVIL,@GRUPO_SANG,@NROCUENTA,@BANCO,@NOMINA,@CCOSTO,@TCONTRATO,@CODCARGO,
                         @GRADO,@NIVEL,@F_INGRESO,CASE WHEN ISNUMERIC(@BASICO)=1 THEN @BASICO ELSE 0 END,@CIUD_DOC,@NITSALUD,@NITPENSION,@NITAREL,@EMAIL,@ER,@ERROR,@SEDEMPLE
               END
            END TRY
            BEGIN CATCH
                SELECT @NRODOCUMENTO=VALOR FROM @TABLA WHERE ITEM=1+@INDICE
                INSERT INTO RPDX(CNS,IDTERCERO,STRINGGRANDE1,STRINGMAX,CANTIDAD10)
                SELECT @CNSRPDX,@NUMDOC,ERROR_MESSAGE(),@LINEA,1
            END CATCH
            
           SET @INDICE += @ESTRUCTURA
		   FETCH NEXT FROM SUBIR_CURSOR INTO @LINEA
		   END  
		  
		   CLOSE SUBIR_CURSOR  
		   DEALLOCATE SUBIR_CURSOR  

         SELECT @NROLINEAS=COUNT(*) FROM RPDX WHERE CNS=@CNSRPDX --AND CANTIDAD=1


         SELECT 'OK' OK,@CNSRPDX CNSRPDX,@NROLINEAS ERRADOS
         RETURN

      END
      ELSE
      BEGIN
         SELECT 'KO','No se encontraron Datos para Procesar, Verfique e intente de nuevo' ERROR
         RETURN
      END
	END

END


