IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'ENVIA_NOTADBCR_PPTO' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE ENVIA_NOTADBCR_PPTO
END
GO
CREATE PROCEDURE DBO.ENVIA_NOTADBCR_PPTO  
@CNSFNOT  VARCHAR(20),
@CONSECUTIVO VARCHAR(20)
AS
DECLARE @N_FACTURA VARCHAR(20)
DECLARE @CNSCXC    VARCHAR(20)
DECLARE @RECO      VARCHAR(20)
DECLARE @VR_NOTA   DECIMAL(14,2)
DECLARE @RUBRO     VARCHAR(50)
DECLARE @RUBRO_ID  INT
DECLARE @CNSPPTO   VARCHAR(20)
DECLARE @IDPLAN    VARCHAR(6)
DECLARE @FECHA     DATETIME
DECLARE @OBSERV    VARCHAR(2049)
DECLARE @CLASEN    VARCHAR(2)
DECLARE @ESTADOFNOT    VARCHAR(2)
BEGIN

   PRINT 'BUSCO DATOS FACTURA'
   SELECT @N_FACTURA=N_FACTURA,@VR_NOTA=VR_TOTAL,@FECHA=F_NOTA,@OBSERV=OBSERVACION,@CLASEN=CLASE, @ESTADOFNOT=COALESCE(ESTADO,'O'),
   @CNSCXC=CNSCXC
   FROM FNOT WHERE CNSFNOT=@CNSFNOT
   IF COALESCE(@ESTADOFNOT,'O')='A'
   BEGIN
		PRINT('NOTA CREDITO O DEBITO ANULADA')
		RETURN
   END

   PRINT 'BUSCO DATOS PPTO'
   SELECT @CNSPPTO=CASE WHEN ENPRESUPUESTO=1 THEN CONSECUTIVOPTO ELSE @CONSECUTIVO END,@RECO=RECO,@IDPLAN=IDPLAN,
            @CNSCXC=CASE WHEN DBO.FNK_VALORVARIABLE('PRESUP_TIPORECO')IN('FACTURA','DESDEFTR') THEN  CNSFCT ELSE @CNSCXC END
   FROM FTR WHERE N_FACTURA=@N_FACTURA

   IF COALESCE(@RECO,'')='' 
   BEGIN
      SELECT TOP 1 @RECO= RECO FROM PTRECO WHERE N_FACTURA=CASE WHEN DBO.FNK_VALORVARIABLE('PRESUP_TIPORECO')IN('FACTURA','DESDEFTR') 
      THEN  @N_FACTURA ELSE @CNSCXC END  AND ESTADO='Confirmado'
   END
   

   SELECT @RUBRO=CASE WHEN COALESCE(@CNSPPTO,'')<>@CONSECUTIVO THEN RUBROANT ELSE RUBRO END, 
          @RUBRO_ID=CASE WHEN COALESCE(@CNSPPTO,'')<>@CONSECUTIVO THEN   RUBROANT_ID ELSE RUBRO_ID END
   FROM PLN WHERE IDPLAN=@IDPLAN

   IF COALESCE(@RUBRO,'')=''
   BEGIN 
      SELECT @RUBRO=RUBRO, @RUBRO_ID=RUBRO_ID FROM PTRECAD WHERE CONSECUTIVO=@CNSPPTO AND RECO=@RECO
   END
   IF @CONSECUTIVO<>@CNSPPTO OR @CLASEN<> 'C'
   BEGIN
      PRINT 'El presupuesto de origen es diferente al actual, no se registra el movimiento'
      UPDATE FNOT SET ENPRESUPUESTO=1 WHERE CNSFNOT=@CNSFNOT
      RETURN 
   END

   PRINT 'RECONOCIMIENTO A AFECTAR'
   PRINT '@RECO='+@RECO
   PRINT '@CNSPPTO='+@CNSPPTO

   INSERT INTO PTNOT(COMPANIA,CONSECUTIVO,RECO,CNSNOTA,CLASE,FECHA,CNSCXC,CCOSTO,N_FACTURA,OBSERVACION,VR_TOTAL,ESTADO,CONSECUTIVON,RUBRON,RUBRO_ID)
   SELECT '01',@CNSPPTO,@RECO,@CNSFNOT,CASE WHEN @CLASEN='C' THEN 'CR' ELSE 'DB' END,@FECHA,@CNSCXC,DBO.FNK_VALORVARIABLE('PRESUP_CCOSTO'),
   CASE WHEN DBO.FNK_VALORVARIABLE('PRESUP_TIPORECO')IN('FACTURA','DESDEFTR') THEN  @N_FACTURA ELSE @CNSCXC END,
    @OBSERV,@VR_NOTA,'NoConfirmado',@CONSECUTIVO,@RUBRO,@RUBRO_ID

   UPDATE FNOT SET ENPRESUPUESTO=1,CONSECUTIVOPPTO=@CONSECUTIVO,RECO=@RECO WHERE CNSFNOT=@CNSFNOT


   EXEC SPK_APLICA_NOTA_PPTO '01',@CONSECUTIVO,@RECO,@CNSFNOT,'CONF'

END

