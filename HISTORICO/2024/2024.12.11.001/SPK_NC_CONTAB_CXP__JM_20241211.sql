IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_NC_CONTAB_CXP' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_NC_CONTAB_CXP
END
GO
CREATE PROCEDURE DBO.SPK_NC_CONTAB_CXP
@CNSFCXP		      VARCHAR(20), 
@USUARIO		      VARCHAR(12),
@SYS_COMPUTERNAME	 VARCHAR(254),
@COMPANIA		      VARCHAR(2),    
@SEDE			 VARCHAR(5),
@NROCOMPROBANTE	 VARCHAR(20)
WITH ENCRYPTION
AS
DECLARE @COM             VARCHAR(6),    @NOREFERENCIA       VARCHAR(20),   @ANO		        VARCHAR(4),    @MES		       INT
DECLARE @IDMODELOCONT    VARCHAR(2),    @IDPLAN		         VARCHAR(6),    @TIPOTERCONTABLE VARCHAR(10),   @VLR_IMPUESTOS	 DECIMAL(14,2)
DECLARE @CXP_TIPO	       VARCHAR(20),   @PREFIJO_CUR	      VARCHAR(6),    @CCOSTO_CUR	     VARCHAR(20),   @IDAREA_CUR	    VARCHAR(20)
DECLARE @VLR_NETO_CUR 	 DECIMAL(14,2), @PREFIJO_USCXS      VARCHAR(10),   @PROCEDENCIA     VARCHAR(10),   @ESTADO          VARCHAR(1)
DECLARE @PROC_MCP        VARCHAR(20),   @FECHATRA           DATETIME,      @TIPOCXP         VARCHAR(20),   @TIPOANTICIPO    VARCHAR(6)
DECLARE @IVADESCONTABLE  DECIMAL(14,2), @CCOSTO	            VARCHAR(20),   @IDAREA	        VARCHAR(20),   @TIPOREGIMEN     VARCHAR(1)
DECLARE @PRUEBA			 DECIMAL(14,2), @VLR_NOTACR		   DECIMAL(14,2), @VLR_IVANOTACR	  DECIMAL(14,2), @CUENTA_IVA      VARCHAR(20)
DECLARE @CUENTAGLOSA     VARCHAR (16),  @CUECREDITO         VARCHAR (16),  @CUENTASERGLO    VARCHAR (16),  @CTA_IMPCONSUMO  VARCHAR(20)
DECLARE @CNSFCOM         VARCHAR (16),  @CUEANTDB           VARCHAR (16),  @CUEANTCR        VARCHAR (16),  @VLR_IMPCOMSUMO  DECIMAL(14,2)
DECLARE @ESLEGA          INT,           @CNSMOV             VARCHAR(20),   @IDITAR           VARCHAR(2),   @CNSANT          VARCHAR(20)
DECLARE @GENCXP          INT,           @TER_ANTERIOR       VARCHAR(20),   @CUENTA_FLETE    VARCHAR(16),   @VARIOSTER       SMALLINT
DECLARE @COPAGO          DECIMAL(14,2), @CUE_MODE_COPAGO    VARCHAR(20),   @TIPOCOPAGO      VARCHAR(20)
BEGIN   
   SELECT * INTO #T FROM FCXP WHERE CNSFCXP = @CNSFCXP  
   SELECT * INTO #TH FROM FCXPD WHERE CNSFCXP = @CNSFCXP  
   SELECT TOP 1 @CCOSTO = CCOSTO FROM #TH GROUP BY CCOSTO ORDER BY COUNT(*) DESC
   SELECT TOP 1 @IDAREA = IDAREA FROM #TH GROUP BY IDAREA ORDER BY COUNT(*) DESC  
   SELECT @TIPOCXP       = TIPOCXP, @PROCEDENCIA   = PROCEDENCIA, @ESTADO        = ESTADO, @CNSFCOM       = CNSFCOM, @NOREFERENCIA  = NOREFERENCIA,
          @VLR_IMPUESTOS = CASE WHEN VLR_IMPUESTOS IS NULL THEN 0 ELSE VLR_IMPUESTOS END,
          @ANO      = CASE WHEN DBO.FNK_VALORVARIABLE('IDCON_FCONTABLE_CXP')='Radicacion' THEN YEAR(FECHA) ELSE YEAR(F_FACTURAREF) END,
          @MES      = CASE WHEN DBO.FNK_VALORVARIABLE('IDCON_FCONTABLE_CXP')='Radicacion' THEN MONTH(FECHA) ELSE MONTH(F_FACTURAREF) END,
          @FECHATRA = CASE WHEN DBO.FNK_VALORVARIABLE('IDCON_FCONTABLE_CXP')='Radicacion' THEN FECHA ELSE F_FACTURAREF END,
          @CNSANT   = COALESCE(CNSFCOM, '')
   FROM   #T 
   SELECT @VARIOSTER=COALESCE(VARIOSTER,0) FROM #T
   SELECT @GENCXP = GENCXP, @TER_ANTERIOR = FCXP.IDTERCERO FROM FCXPDBCR INNER JOIN FCXP ON FCXP.CNSFCXP = FCXPDBCR.CNSFCXP WHERE FCXPDBCR.CNSFCXP = @CNSANT AND GENCXP = 1

   SELECT @TIPOREGIMEN = TER.TIPOREGIMEN
   FROM #T INNER JOIN TER ON #T.IDTERCERO = TER.IDTERCERO
   
   PRINT 'TIPOREGIMEN: ' + @TIPOREGIMEN
   /*INICIO DEL IF*/
   IF NOT EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA = @COMPANIA AND ANO=@ANO AND MES=@MES)
   BEGIN
      RAISERROR('Periodo Contable NO Existe', 16, 1)
      RETURN
   END	
   SET @IDMODELOCONT = DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE')
   PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   IF ISNULL(@NROCOMPROBANTE,'') = '' -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   BEGIN
      SET @PROC_MCP='CXP'
      SET @NROCOMPROBANTE = SPACE(20) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
	   EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@MCP',@NROCOMPROBANTE OUTPUT -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
	   PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
	   SELECT @NROCOMPROBANTE = @SEDE + REPLACE(SPACE(8 - CASE WHEN LEN(@NROCOMPROBANTE) > 8 THEN 8 ELSE LEN(@NROCOMPROBANTE) END)+LTRIM(RTRIM(@NROCOMPROBANTE)),SPACE(1),0) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
	   PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
	   PRINT 'PROCEDENCIA=' + @PROCEDENCIA
      --SE REVISA SI LOS COMPROBANTES SE TOMAN DE ACUERDO A SEDE
      IF (SELECT DBO.FNK_VALORVARIABLE('COMPROBMULTISEDE')) = 'SI'
      BEGIN
         SELECT @COM = RTRIM(LTRIM(COMMS.COMPROBANTE)) FROM COMMS WHERE IDSEDE = @SEDE AND COMMS.CLASE = 'CXP' AND TIPO = @PROCEDENCIA
      END
      ELSE
      BEGIN
	      IF @PROCEDENCIA='Compras'
            SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXP_COM')))
	      ELSE
	         IF @PROCEDENCIA='Salud'
		         SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXP_SAL')))
	         ELSE
		         IF @PROCEDENCIA='Servicios'
		            SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXP_SER')))
		         ELSE
		            IF @PROCEDENCIA='Otros'
		               SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXP_OTR')))
		            ELSE
		               IF @PROCEDENCIA='Nomina'
		                  SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXP_NOM')))
		               ELSE
	                     IF @PROCEDENCIA='LevGlo'
		                     SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXP_LvGlo')))
		                  ELSE
		                     IF @PROCEDENCIA='ConcGlo'
		                        SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CONC')))
		                     ELSE
                              IF @PROCEDENCIA='ANTICIPOS'
		                        BEGIN
		                           SELECT @TIPOANTICIPO = TIPOANTICIPO FROM FCOM WHERE CNSFCOM = @CNSFCOM
		                           SELECT @COM = COMPROBANTE,@CUEANTDB=CUEDEBITO,@CUEANTCR=CUECREDITO FROM TANT WHERE TIPOANTICIPO    = @TIPOANTICIPO                
                              END
	   END
		--IF @COM=NULL OR @COM=''
		PRINT @COM
		IF ISNULL(@COM,'')=''
		BEGIN
		   SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_DEFAULT')))    
		END
		  --IF @COM=NULL OR @COM=''
		IF ISNULL(@COM,'')=''
		BEGIN
		   SET @COM='IX'
		END 
		SET @PREFIJO_USCXS='@COM'+@COM
		SET @NOREFERENCIA=SPACE(20)
		EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,@PREFIJO_USCXS,@NOREFERENCIA OUTPUT   
		SELECT @NOREFERENCIA = REPLACE(SPACE(8 - LEN(@NOREFERENCIA))+LTRIM(RTRIM(@NOREFERENCIA)),SPACE(1),0)
		PRINT 'Nuevo Comprobante: '+@COM+' '+@NOREFERENCIA
		PRINT 'Comprobante Contable (MCP)'
		INSERT INTO MCPE(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,
						     TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO,
						     COMPROBANTE, IDTERCERO, ANULADO,REFERENCIA3 )
		SELECT @NROCOMPROBANTE, @COMPANIA, 'CXP', @NOREFERENCIA, @ANO, @MES, CAST(STR(DAY(@FECHATRA))+'/'+LTRIM(STR(@MES))+'/'+@ANO AS DATETIME),
				0, 0, @CNSFCXP, NOREFERENCIA, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, LEFT(OBSERVACION, 512), -- STORRES se agrega LEFT de 512
				@SEDE, CASE WHEN @ESTADO='A' THEN 2 ELSE 0 END, @COM, (CASE WHEN #T.IDTERCERO IS NULL THEN '' ELSE #T.IDTERCERO END), 
				CASE WHEN @ESTADO='A' THEN 1 ELSE 0 END,CNSENVIOFIN
		FROM #T
   END
   ELSE
   BEGIN -- IF @NROCOMPROBANTE <> ''
      IF (SELECT COUNT(*) FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE)>0
      BEGIN
         INSERT INTO MCPE (COMPANIA, NROCOMPROBANTE, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO ,TOTALCREDITO, REFERENCIA1, REFERENCIA2,
                          REFERENCIA3, USUARIO, FECHA, LOTE ,OBSERVACION ,IDSEDE ,ESTADO ,ANULADO ,COMPROBANTE ,IDTERCERO, BANCO ,NOCHEQUE, VALOR_CHEQUE,
                          RPT_COMPROBANTE, FECHARADICACION, MARCA, SYS_COMPUTERNAME_MARCA, ESTADOIMP, CBTEINTERNO)
         SELECT COMPANIA, NROCOMPROBANTE, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO ,TOTALCREDITO, REFERENCIA1, REFERENCIA2,
                          REFERENCIA3, USUARIO, FECHA, LOTE ,OBSERVACION ,IDSEDE ,ESTADO ,ANULADO ,COMPROBANTE ,IDTERCERO, BANCO ,NOCHEQUE, VALOR_CHEQUE,
                          RPT_COMPROBANTE, FECHARADICACION, MARCA, SYS_COMPUTERNAME_MARCA, ESTADOIMP, CBTEINTERNO
         FROM   MCP
         WHERE NROCOMPROBANTE=@NROCOMPROBANTE
         --se borran de mcp, mch
         DELETE MCH WHERE NROCOMPROBANTE = @NROCOMPROBANTE
         DELETE MCP WHERE NROCOMPROBANTE = @NROCOMPROBANTE   
      END
      ELSE
      BEGIN
         DELETE MCHE WHERE NROCOMPROBANTE=@NROCOMPROBANTE
      END
   END
	 PRINT '@ESTADO = ' + @ESTADO
   IF @ESTADO='A' 
   BEGIN 
		  DELETE MCHE WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND PROCEDENCIA='CXP' AND REFERENCIA_PRO=@CNSFCXP
		  IF (SELECT COUNT(*) FROM MCHE WHERE NROCOMPROBANTE=@NROCOMPROBANTE)=0
		  BEGIN
				 UPDATE MCPE SET ESTADO='2', ANULADO=1, TOTALDEBITO=0, TOTALCREDITO=0 WHERE COMPANIA=@COMPANIA AND NROCOMPROBANTE=@NROCOMPROBANTE
		  END
		  UPDATE FCXP SET CONTABILIZADA=1 FROM #T WHERE FCXP.CNSFCXP=#T.CNSFCXP
		  RETURN
   END
   IF @TIPOCXP='IPS'
   BEGIN
      SET @CXP_TIPO='CXP_'+UPPER(@PROCEDENCIA)
   END  
   ELSE
   BEGIN 
      IF @TIPOCXP='COMER'  
      BEGIN
         SET @CXP_TIPO='CXP_'+LEFT(UPPER(@PROCEDENCIA),4)+@TIPOCXP	
      END
      ELSE
      BEGIN 
         SET @CXP_TIPO='CXP_'+UPPER(@PROCEDENCIA)+@TIPOCXP	
      END
   END
   PRINT 'Cuentas por Pagar de: '+@PROCEDENCIA+' - '+@TIPOCXP+ ' ; @CXP_TIPO: '+@CXP_TIPO

	SELECT @CUENTA_IVA = CUENTA_IVA FROM #TH WHERE CNSFCXP = @CNSFCXP AND COALESCE(#TH.CUENTA_IVA,'')<>''
	SELECT @CTA_IMPCONSUMO = CTAIMPCONSUMO FROM #TH WHERE CNSFCXP = @CNSFCXP AND COALESCE(#TH.CTAIMPCONSUMO,'')<>''

   IF @TIPOCXP='IPS'
	BEGIN       --SELECT TOP 1 * FROM FCXPD
	   IF @PROCEDENCIA IN ('Compras','Salud','Servicios', 'ANTICIPOS')
	   BEGIN  
         PRINT 'INGRESO POR ACA...-'
         SELECT @IVADESCONTABLE = SUM(COALESCE(#TH.VLR_IVA,0)),@VLR_IMPCOMSUMO=SUM(COALESCE(#TH.VLRIMPCONSUMO,0)) 
	      FROM  #TH 
		   WHERE #TH.PROCEDENCIA IN ('Compras', 'Servicios')			          
		   IF COALESCE(@CUENTA_IVA,'') <> ''
		   BEGIN
		      PRINT '-Ingreso en MCHE de los Debitos-'         
		      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                                REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		      SELECT @NROCOMPROBANTE,@COMPANIA,'DB', CASE WHEN CUE.CUENTA IS NULL THEN  DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,@CXP_TIPO,'DB',#TH.PREFIJO, #TH.CCOSTO,'P',#TH.IDSERVICIO,0) ELSE CUE.CUENTA END,
			        CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END,
                 #TH.CCOSTO, LEFT(UPPER(#T.OBSERVACION)+', DOCUMENTO No.'+#T.NOREFERENCIA,512),
			        SUM(#TH.VLR_NETO)-SUM(COALESCE(#TH.VLR_IVA,0)+COALESCE(#TH.VLRIMPCONSUMO,0)),
			        #T.NOREFERENCIA,#T.CNSFCXP, NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
			        #TH.PREFIJO,LEFT(#TH.IDAREA,10),'P',1 ,@CXP_TIPO+'_DB', 'Movimiento',
			        #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
		      FROM   #T, #TH LEFT JOIN CUE ON #TH.CUENTA_SER = CUE.CUENTA 
		      GROUP BY CASE WHEN CUE.CUENTA IS NULL THEN  DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,@CXP_TIPO,'DB',#TH.PREFIJO, #TH.CCOSTO,'P',#TH.IDSERVICIO,0) ELSE CUE.CUENTA END,
            CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END,#TH.CCOSTO,
			          #T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,#TH.PREFIJO, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), #TH.IDSERVICIO, #TH.IDAREA,
			      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, #T.VLR_FLETE,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE), CUE.CUENTA


    --        PRINT 'Corrigiendo  MCH...'
            PRINT 'IVA:'+STR(@IVADESCONTABLE)
			   UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@IVADESCONTABLE-@VLR_IMPCOMSUMO-C.VALOR)
			   FROM   (SELECT MAX(NROASIENTO) AS NROASIENTO 
			           FROM   MCHE
			           WHERE  NROCOMPROBANTE = @NROCOMPROBANTE 
				        AND    TIPO    = 'DB' 
				        AND    PROCESO = @CXP_TIPO + '_DB' AND REFERENCIA_PRO = @CNSFCXP
				        ) AS B,
				        (SELECT SUM(VALOR) AS VALOR 
				         FROM   MCHE
                     WHERE  NROCOMPROBANTE = @NROCOMPROBANTE 
                     AND    TIPO    = 'DB' 
                     AND    PROCESO = @CXP_TIPO + '_DB' 
                     AND    REFERENCIA_PRO=@CNSFCXP
                    ) AS C, #T
				WHERE  MCHE.NROASIENTO = B.NROASIENTO 
				AND    (#T.VLR_NETO-@IVADESCONTABLE-@VLR_IMPCOMSUMO-C.VALOR)<>0


            IF (SELECT COALESCE(CONVERT(NUMERIC,VLR_FLETE), 0) FROM #T WHERE CNSFCXP = @CNSFCXP) > 0
            BEGIN
            PRINT'ENTRO AL FLETE'
               SELECT @CUENTA_FLETE = CUENTA FROM KCDE WHERE TIPO = 'FCXP_FLETE'
               PRINT'CONTABILIZANDO EL DEBITO DEL FLETE'
               INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1, REFERENCIA2,ITEMREF,USUARIO,
                                 FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA, N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, 
                                 PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
               SELECT DISTINCT @NROCOMPROBANTE,@COMPANIA, 'DB', @CUENTA_FLETE, #T.IDTERCERO, #TH.CCOSTO, 
                      'FLETE: '+CUE.NOMCUENTA+', DOCUMENTO No.'+#T.NOREFERENCIA, #T.VLR_FLETE, 'FCXP_FLETE', #T.CNSFCXP, NULL, @USUARIO, 
                      DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, LEFT(#TH.IDAREA,10),'S',1 ,'FLETE_DB', 'Movimiento', #T.NOREFERENCIA,
                      DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, 
                      COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
               FROM #T,#TH,CUE
               WHERE CUE.CUENTA = @CUENTA_FLETE

               PRINT'CONTABILIZANDO EL CREDITO DEL FLETE'
               INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                              REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                              N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
                SELECT @NROCOMPROBANTE,@COMPANIA, 'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
                        'FLETE '+UPPER(#T.OBSERVACION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
                        #T.VLR_FLETE, 'FCXP_FLETE',#T.CNSFCXP,NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,
                        LEFT(#TH.IDAREA,10),'S',1 ,'FLETE_CR', 'Movimiento',
                        #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
                        #T.PROCEDENCIA,'CXP', @CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
                FROM #T,#TH,CUE
                GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,
		 			        LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), #T.VLR_FLETE,
		 			        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
            END

		      -- Contabilizaci? del Juego de Iva Para R?imen Simplificado.
            IF @TIPOREGIMEN = 'S' 
		      BEGIN
               IF  COALESCE(@IVADESCONTABLE,0)>0
               BEGIN
				      PRINT'-- Contabilizaci? del Iva descontable	'
                  IF DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI'
                  BEGIN
                     INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                                      REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                      N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
                     SELECT @NROCOMPROBANTE, @COMPANIA, 'DB',  XV1.CUENTA, #T.IDTERCERO, #TH.CCOSTO,CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO NO.'+#T.NOREFERENCIA,
                            ROUND(SUM((#TH.VLR_NETO-#TH.VLR_IVA)*(XV.VALOR*0.01)*(XV1.VALOR*0.01)),0), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	                         #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA_DESC_RS', 'MOVIMIENTO',
                            #T.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                            DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
				         FROM #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP 
                             INNER JOIN TER ON #T.IDTERCERO = TER.IDTERCERO AND TER.TIPOREGIMEN = 'S' 
                             INNER JOIN FIMXT X ON #T.IDTERCERO = X.IDTERCERO AND #TH.PREFIJO = X.CONCEPTO AND X.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_IVA') 
                                               AND X.TIPO='C' AND X.IDCATEGORIA='PRO' AND X.ESTADO='ACTIVO' AND X.PROCEDENCIA=#TH.PROCEDENCIA 
                             INNER JOIN FIMPDV XV ON X.IDIMPUESTO = XV.IDIMPUESTO AND X.IDCLASE = XV.IDCLASE AND #T.F_FACTURAREF BETWEEN XV.FECHAINI AND XV.FECHAFIN 
                             INNER JOIN FIMXT X1 ON #T.IDTERCERO = X1.IDTERCERO AND #TH.PREFIJO = X1.CONCEPTO 
                                                AND X1.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_IVADESC') AND X1.TIPO='C' 
                                                AND X1.IDCATEGORIA='PRO' AND X1.ESTADO='ACTIVO' AND X1.PROCEDENCIA=#TH.PROCEDENCIA 
                             INNER JOIN FIMPDV XV1 ON X1.IDIMPUESTO = XV1.IDIMPUESTO AND X1.IDCLASE = XV1.IDCLASE 
                                                  AND #T.F_FACTURAREF BETWEEN XV1.FECHAINI AND XV1.FECHAFIN 
                              LEFT JOIN CUE ON XV1.CUENTA = CUE.CUENTA AND CUE.COMPANIA=@COMPANIA
                     GROUP BY XV1.VALOR_INICIAL, XV1.CUENTA, CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
                             #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, 
                             COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
                     HAVING ISNULL(XV1.VALOR_INICIAL,0)<=SUM(#TH.VLR_NETO*(XV.VALOR*0.01)*(XV1.VALOR*0.01))
                 
                     INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
				                     REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
				                     N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
                     SELECT @NROCOMPROBANTE, @COMPANIA, 'CR',  XV1.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO NO.'+#T.NOREFERENCIA,
	                        SUM((#TH.VLR_NETO-#TH.VLR_IVA)*(XV.VALOR*0.01)*(XV1.VALOR*0.01)), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	                        #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA_DESC_RS', 'MOVIMIENTO',
	                        #T.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
	                        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
                     FROM #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP 
                             INNER JOIN TER ON #T.IDTERCERO = TER.IDTERCERO AND TER.TIPOREGIMEN = 'S' 
                             INNER JOIN FIMXT X ON #T.IDTERCERO = X.IDTERCERO AND #TH.PREFIJO = X.CONCEPTO AND 
			                                          X.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_IVA') AND X.TIPO='C' AND X.IDCATEGORIA='PRO' AND 
			                                          X.ESTADO='ACTIVO' AND X.PROCEDENCIA=#TH.PROCEDENCIA 
                             INNER JOIN FIMPDV XV ON X.IDIMPUESTO = XV.IDIMPUESTO AND X.IDCLASE = XV.IDCLASE 
                                                 AND #T.F_FACTURAREF BETWEEN XV.FECHAINI AND XV.FECHAFIN 
                             INNER JOIN FIMXT X1 ON #T.IDTERCERO = X1.IDTERCERO AND #TH.PREFIJO = X1.CONCEPTO 
                                                AND X1.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_RETEIVA') 
                                                AND X1.TIPO='C' AND X1.IDCATEGORIA='PRO' AND X1.ESTADO='ACTIVO' AND X1.PROCEDENCIA=#TH.PROCEDENCIA 
                             INNER JOIN FIMPDV XV1 ON X1.IDIMPUESTO = XV1.IDIMPUESTO AND X1.IDCLASE = XV1.IDCLASE 
                                                  AND #T.F_FACTURAREF BETWEEN XV1.FECHAINI AND XV1.FECHAFIN 
                              LEFT JOIN CUE ON XV1.CUENTA = CUE.CUENTA AND CUE.COMPANIA=@COMPANIA
                     GROUP BY XV1.VALOR_INICIAL, XV1.CUENTA, CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
		                       #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		                       DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
                     HAVING ISNULL(XV1.VALOR_INICIAL,0)<=SUM(#TH.VLR_NETO*(XV.VALOR*0.01)*(XV1.VALOR*0.01)) 

                                    
                  END
                  ELSE
                  BEGIN
                     INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                                      REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                      N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
                     SELECT @NROCOMPROBANTE, @COMPANIA, 'DB',CASE WHEN DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI' AND  COALESCE ( #TH.CUENTA_SER,'' )<>''  THEN  #TH.CUENTA_SER ELSE #TH.CUENTA_IVA END,  
                  	       CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END, #TH.CCOSTO, CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO No.'+#T.NOREFERENCIA,
                            SUM(#TH.VLR_IVA), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
                            #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA', 'Movimiento',
                            #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                            DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
                     FROM #T INNER JOIN  #TH ON #T.CNSFCXP=#TH.CNSFCXP 
                             INNER JOIN CUE ON CASE WHEN DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI' AND  COALESCE ( #TH.CUENTA_SER,'' )<>''  THEN  #TH.CUENTA_SER ELSE #TH.CUENTA_IVA END = CUE.CUENTA AND CUE.COMPANIA = @COMPANIA
                     WHERE #TH.PROCEDENCIA IN ('Compras', 'Servicios')
                     GROUP BY CUE.CUENTA,      CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
                              #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                              DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE),
						      CASE WHEN DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI' AND  COALESCE ( #TH.CUENTA_SER,'' )<>''  THEN  #TH.CUENTA_SER ELSE #TH.CUENTA_IVA END  
                  END
               END
				END
            ELSE
            BEGIN
               PRINT'-- Contabilizaci? del Iva descontable'
               PRINT 'Contabilizaci? del Iva descontable'
			      PRINT '--ENTRE POR AQUI'
               INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                                REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
               SELECT @NROCOMPROBANTE, @COMPANIA, 'DB',CASE WHEN DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI' AND  COALESCE ( #TH.CUENTA_SER,'' )=''  THEN  #TH.CUENTA_SER ELSE #TH.CUENTA_IVA END  , --Se intercarbia respuestas del THEN y ELSE 
                  	 #T.IDTERCERO, #TH.CCOSTO,CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO No.'+#T.NOREFERENCIA,
                      SUM(#TH.VLR_IVA), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
                      #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA', 'Movimiento',
                      #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
               FROM #T INNER JOIN  #TH ON #T.CNSFCXP=#TH.CNSFCXP 
                       INNER JOIN CUE ON CASE WHEN DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI' AND  COALESCE ( #TH.CUENTA_SER,'' )=''  THEN #TH.CUENTA_SER ELSE  #TH.CUENTA_IVA END   = CUE.CUENTA AND CUE.COMPANIA = @COMPANIA --Se intercarbia respuestas del THEN y ELSE 
               WHERE #TH.PROCEDENCIA IN ('Compras', 'Servicios')
                     AND #TH.VLR_IVA>0
               GROUP BY CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
                        #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE),
						CASE WHEN DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP')<>'SI' AND  COALESCE ( #TH.CUENTA_SER,'' )=''  THEN #TH.CUENTA_SER ELSE  #TH.CUENTA_IVA END   --- Se intercarbia respuestas del THEN y ELSE 

              END
               PRINT 'SALI_DE AQUI......'
               PRINT 'IMPUESTO AL CONSUMO......'

               INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                                REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
               SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', #TH.CTAIMPCONSUMO, #T.IDTERCERO, #TH.CCOSTO, 'IMP_CONSUMO: '+CUE.NOMCUENTA+', DOCUMENTO No.'+#T.NOREFERENCIA,
                      SUM(#TH.VLRIMPCONSUMO), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
                      #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IMP CONSUMO', 'Movimiento',
                      #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), 
                      #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
               FROM #T INNER JOIN  #TH ON #T.CNSFCXP=#TH.CNSFCXP 
                       INNER JOIN CUE ON #TH.CTAIMPCONSUMO = CUE.CUENTA AND CUE.COMPANIA = @COMPANIA
               WHERE #TH.PROCEDENCIA IN ('Compras', 'Servicios')
               GROUP BY CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
                        #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE), #TH.CTAIMPCONSUMO
         END
         ELSE
         BEGIN	    
            PRINT 'DB 1 @IVADESCONTABLE='+CAST(@IVADESCONTABLE AS VARCHAR(20))
            INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                             REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                             N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
            SELECT @NROCOMPROBANTE,@COMPANIA,'DB',
                   CASE WHEN CUE.CUENTA IS NULL THEN DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,@CXP_TIPO,'DB',#TH.PREFIJO, #TH.CCOSTO,'P',#TH.IDSERVICIO,0) 
                        ELSE CUE.CUENTA 
                   END,
                   CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END, #TH.CCOSTO, LEFT(UPPER(#T.OBSERVACION),450)+', DOCUMENTO No.'+#T.NOREFERENCIA, -- STORRES se agrega LEFT de 450 
                   SUM((#TH.VLR_NETO-CASE WHEN CUEIVA.CUENTA IS NULL THEN 0 ELSE #TH.VLR_IVA END)),--+(COALESCE(#T.VLR_FLETE,0)*((#TH.VLR_NETO*100)/(#T.VLR_NETO-@IVADESCONTABLE)))/100),
                   #T.NOREFERENCIA,#T.CNSFCXP, NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
                   #TH.PREFIJO,LEFT(#TH.IDAREA,10),'P',1 ,@CXP_TIPO+'_DB', 'Movimiento',
                   #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
            FROM   #T, #TH LEFT JOIN CUE ON #TH.CUENTA_SER=CUE.CUENTA AND CUE.COMPANIA='01' AND CUE.TIPO='Detalle' AND CUE.ESTADO='Activa' 
                           LEFT JOIN CUE CUEIVA ON #TH.CUENTA_IVA = CUEIVA.CUENTA AND CUEIVA.COMPANIA = @COMPANIA
            GROUP BY DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,@CXP_TIPO,'DB',#TH.PREFIJO, #TH.CCOSTO,'P',#TH.IDSERVICIO,0),
                  CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END,#TH.CCOSTO,
                     #T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,#TH.PREFIJO, 
                     LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), #TH.IDSERVICIO, #TH.IDAREA,
                     DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, #T.VLR_FLETE,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE), CUE.CUENTA
      --      PRINT 'Corrigiendo  MCH... IVA:'+STR(@IVADESCONTABLE)
      --      UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@IVADESCONTABLE-C.VALOR)
		    --  FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE
		    --        WHERE  NROCOMPROBANTE = @NROCOMPROBANTE 
		    --        AND    TIPO           = 'DB' 
		    --        AND    PROCESO        = @CXP_TIPO + '_DB' 
		    --        AND    REFERENCIA_PRO=@CNSFCXP) AS B,
			   --     (SELECT SUM(VALOR) AS VALOR FROM MCHE 
						--WHERE  NROCOMPROBANTE = @NROCOMPROBANTE AND TIPO='DB' AND PROCESO=@CXP_TIPO+'_DB' AND REFERENCIA_PRO=@CNSFCXP) AS C,
						--#T
		    --  WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@IVADESCONTABLE-C.VALOR)<>0
            -- Contabilizaci? del Juego de Iva Para R?imen Simplificado.
            IF (SELECT COALESCE(CONVERT(NUMERIC,VLR_FLETE), 0) FROM #T WHERE CNSFCXP = @CNSFCXP) > 0
            BEGIN
            PRINT'ENTRO AL FLETE'
               SELECT @CUENTA_FLETE = CUENTA FROM KCDE WHERE TIPO = 'FCXP_FLETE'
               PRINT'CONTABILIZANDO EL DEBITO DEL FLETE'
               INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1, REFERENCIA2,ITEMREF,USUARIO,
                                 FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA, N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, 
                                 PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
               SELECT DISTINCT @NROCOMPROBANTE,@COMPANIA, 'DB', @CUENTA_FLETE, #T.IDTERCERO, #TH.CCOSTO, 
                      'FLETE: '+CUE.NOMCUENTA+', DOCUMENTO No.'+#T.NOREFERENCIA, #T.VLR_FLETE, 'FCXP_FLETE', #T.CNSFCXP, NULL, @USUARIO, 
                      DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, LEFT(#TH.IDAREA,10),'S',1 ,'FLETE_DB', 'Movimiento', #T.NOREFERENCIA,
                      DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, 
                      COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
               FROM #T,#TH,CUE
               WHERE CUE.CUENTA = @CUENTA_FLETE
            END

		      IF @TIPOREGIMEN = 'S'
		      BEGIN
               IF COALESCE(@IVADESCONTABLE,0)>0
               BEGIN
			      -- Contabilizaci? del Iva descontable	
                  INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
			                          REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                   N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
                  SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', XV1.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO NO.'+#T.NOREFERENCIA,
	                      SUM(#TH.VLR_NETO*(XV.VALOR*0.01)*(XV1.VALOR*0.01)), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
				             #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA_DESC_RS', 'MOVIMIENTO',
				             #T.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				             DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
			         FROM #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP 
                          INNER JOIN TER ON #T.IDTERCERO = TER.IDTERCERO AND TER.TIPOREGIMEN = 'S' 
                          INNER JOIN FIMXT X ON #T.IDTERCERO = X.IDTERCERO AND #TH.PREFIJO = X.CONCEPTO 
                                            AND X.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_IVA') AND X.TIPO='C' AND X.IDCATEGORIA='PRO' 
                                            AND X.ESTADO='ACTIVO' AND X.PROCEDENCIA=#TH.PROCEDENCIA 
                          INNER JOIN FIMPDV XV ON X.IDIMPUESTO = XV.IDIMPUESTO AND X.IDCLASE = XV.IDCLASE 
                                              AND #T.F_FACTURAREF BETWEEN XV.FECHAINI AND XV.FECHAFIN 
                          INNER JOIN FIMXT X1 ON #T.IDTERCERO = X1.IDTERCERO AND #TH.PREFIJO = X1.CONCEPTO 
                                             AND X1.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_IVADESC') 
                                             AND X1.TIPO='C' AND X1.IDCATEGORIA='PRO' AND X1.ESTADO='ACTIVO' AND X1.PROCEDENCIA=#TH.PROCEDENCIA 
                          INNER JOIN FIMPDV XV1 ON X1.IDIMPUESTO = XV1.IDIMPUESTO AND X1.IDCLASE = XV1.IDCLASE 
                                               AND #T.F_FACTURAREF BETWEEN XV1.FECHAINI AND XV1.FECHAFIN 
                           LEFT JOIN CUE ON XV1.CUENTA = CUE.CUENTA AND CUE.COMPANIA=@COMPANIA
			         GROUP BY XV1.VALOR_INICIAL, XV1.CUENTA, CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
				 							    #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 							    DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
			         HAVING ISNULL(XV1.VALOR_INICIAL,0)<=SUM(#TH.VLR_NETO*(XV.VALOR*0.01)*(XV1.VALOR*0.01)) 
                
					   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
					                    REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
										     N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
					   SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', XV1.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO NO.'+#T.NOREFERENCIA,
					 					      SUM(#TH.VLR_NETO*(XV.VALOR*0.01)*(XV1.VALOR*0.01)), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					 					      #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA_DESC_RS', 'MOVIMIENTO',
					 					      #T.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					 					      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
					   FROM   #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP INNER JOIN 
					 					    TER ON #T.IDTERCERO = TER.IDTERCERO AND TER.TIPOREGIMEN = 'S' INNER JOIN
					 					    FIMXT X ON #T.IDTERCERO = X.IDTERCERO AND #TH.PREFIJO = X.CONCEPTO AND 
					 							   X.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_IVA') AND X.TIPO='C' AND X.IDCATEGORIA='PRO' AND 
					 							   X.ESTADO='ACTIVO' AND X.PROCEDENCIA=#TH.PROCEDENCIA INNER JOIN
					 					    FIMPDV XV ON X.IDIMPUESTO = XV.IDIMPUESTO AND X.IDCLASE = XV.IDCLASE AND 
					 							     #T.F_FACTURAREF BETWEEN XV.FECHAINI AND XV.FECHAFIN INNER JOIN
					 					    FIMXT X1 ON #T.IDTERCERO = X1.IDTERCERO AND #TH.PREFIJO = X1.CONCEPTO AND 
					 							    X1.IDIMPUESTO = DBO.FNK_VALORVARIABLE('IDIMP_RETEIVA') AND 
					 							    X1.TIPO='C' AND X1.IDCATEGORIA='PRO' AND X1.ESTADO='ACTIVO' AND X1.PROCEDENCIA=#TH.PROCEDENCIA INNER JOIN
					 					    FIMPDV XV1 ON X1.IDIMPUESTO = XV1.IDIMPUESTO AND X1.IDCLASE = XV1.IDCLASE AND 
					 							      #T.F_FACTURAREF BETWEEN XV1.FECHAINI AND XV1.FECHAFIN LEFT JOIN
				 	 					    CUE ON XV1.CUENTA = CUE.CUENTA AND CUE.COMPANIA=@COMPANIA
				 	   GROUP BY XV1.VALOR_INICIAL, XV1.CUENTA, 
				 	 						    CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
				 	 						    #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 	 						    DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
				 	   HAVING ISNULL(XV1.VALOR_INICIAL,0)<=SUM(#TH.VLR_NETO*(XV.VALOR*0.01)*(XV1.VALOR*0.01)) 
               END
            END
            ELSE
            BEGIN
			      PRINT 'Contabilizaci? del Iva descontable'
			      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
			                       REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
				 		              N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
			      SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' THEN 'IGV: ' ELSE 'IVA: ' END+CUE.NOMCUENTA+', DOCUMENTO No.'+#T.NOREFERENCIA,
			             SUM(#TH.VLR_IVA), #T.NOREFERENCIA, #T.CNSFCXP, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
				 			 #TH.PREFIJO, #TH.IDAREA, 'P', 1 ,'IVA', 'Movimiento',
				 			 #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 			 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
			      FROM   #T, #TH INNER JOIN CUE ON #TH.CUENTA_IVA = CUE.CUENTA AND CUE.COMPANIA = @COMPANIA
			      WHERE  #TH.PROCEDENCIA IN ('Compras', 'Servicios') AND COALESCE(#TH.VLR_IVA,0)>0 
			      GROUP BY CUE.CUENTA, #T.IDTERCERO, #TH.CCOSTO, CUE.NOMCUENTA, #T.NOREFERENCIA,
                        #T.CNSFCXP, #TH.PREFIJO, #TH.IDAREA, DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 				DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
            END
         END
        END
	   ELSE
        BEGIN
		
		
				 PRINT 'Contabilizaci? del Iva descontable:  '+COALESCE(@NROCOMPROBANTE,'') +' COMPANIA: '+ @COMPANIA
				 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							 REFERENCIA1,REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							 ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, 
							 PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)							 
				SELECT @NROCOMPROBANTE,@COMPANIA,'DB', CASE WHEN @PROCEDENCIA='Nomina' THEN
				DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT, 'NOMINA', 'DB',    #TH.PREFIJO, #TH.CCOSTO, 'S',(SELECT CODNOMINA FROM NPER WHERE CNSPAGO=#T.NOREFERENCIA ) ,0) ELSE  #T.CUEDEBITO END  AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 						'SERVICIOS POR '+UPPER(#T.OBSERVACION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
						SUM(#TH.VLR_NETO)+COALESCE(#T.VLR_FLETE,0),#T.NOREFERENCIA,#T.CNSFCXP,NULL,@USUARIO,
						DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.PREFIJO,LEFT(#TH.IDAREA,10),'S',1 ,
						@CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
						DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
						FROM #T,#TH
				GROUP BY #T.CUEDEBITO,#T.IDTERCERO,#TH.CCOSTO,#T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,
						 #TH.PREFIJO, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
						 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, #T.VLR_FLETE,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)

		 END      ---ENTRE AQUI
       PRINT 'Insertando Asiento (CR) -Insertando Registro MCH del Tercero'
       PRINT @VLR_IMPUESTOS
       IF DBO.FNK_VALORVARIABLE('FCXPDBCR_PORCENT_IVA') = 'SI'
       BEGIN
          SET @VLR_NOTACR = 0
		    SET @VLR_IVANOTACR = 0
          SELECT @VLR_NOTACR = ISNULL(VALOR,0), @VLR_IVANOTACR = ISNULL(VALORIVA ,0)
		    FROM   FCXPDBCR 
		    WHERE  CNSFCXP IN (SELECT TOP 1 CNSFCXP FROM #T) AND IDNOTA = DBO.FNK_VALORVARIABLE('IDNOTA_COMISIONADMIN')      
          INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
 		                     REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
 		  		             N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
		           'SERVICIOS POR '+UPPER(#T.OBSERVACION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
		 	        SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100)-@VLR_NOTACR-@VLR_IVANOTACR,
		 	        #T.NOREFERENCIA,#T.CNSFCXP,NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.PREFIJO,
		           LEFT(#TH.IDAREA,10),'S',1 ,@CXP_TIPO+'_CR', 'Movimiento',
		 	        #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
		 	        #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
		    FROM #T,#TH
		    WHERE #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
		    GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,
		 	          #TH.PREFIJO, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		 		       DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)        
          INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
		                     REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
		 	 		            N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',
                 CASE WHEN DBO.FNK_VALORVARIABLE('CTA_CR_COMISIONADMIN') <> '' THEN DBO.FNK_VALORVARIABLE('CTA_CR_COMISIONADMIN') ELSE 'CTA. NO DEF.' END,
                 #T.IDTERCERO,#TH.CCOSTO, 'SERVICIOS POR '+UPPER(#T.OBSERVACION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
                 FCXPDBCR.VALOR, #T.NOREFERENCIA,#T.CNSFCXP,NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.PREFIJO,
                 LEFT(#TH.IDAREA,10),'S',1 ,@CXP_TIPO+'_CR', 'Movimiento',
                 #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
                 #T.PROCEDENCIA,'CXP',@CNSFCXP, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
          FROM   #T INNER JOIN #TH ON #TH.CNSFCXP = #T.CNSFCXP
		 	           INNER JOIN FCXPDBCR ON FCXPDBCR.CNSFCXP = #T.CNSFCXP
          WHERE  #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0 AND 
		 	        FCXPDBCR.IDNOTA = DBO.FNK_VALORVARIABLE('IDNOTA_COMISIONADMIN')
          GROUP BY FCXPDBCR.VALOR, #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,
		 			    #TH.PREFIJO, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		 	          DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
       END
       ELSE
       BEGIN
          PRINT '--CREDITOS FCXPDBCR_PORCENT_IVA NO'
          --VERIFICAMOS QUE CUE.CREDITO DE LA FCXP ESTE OK
          SELECT @CUECREDITO = CUECREDITO FROM FCXP WHERE CNSFCXP = @CNSFCXP
          IF NOT EXISTS ( SELECT * FROM CUE WHERE CUENTA = @CUECREDITO)
          BEGIN
             IF @PROCEDENCIA = 'Compras'
             BEGIN
                IF COALESCE(@CNSFCOM,'') <> ''
                BEGIN
                    SELECT @CNSMOV = CNSMOV FROM IMOV WHERE CNSFCOM= @CNSFCOM
                    SELECT TOP 1 @IDITAR = IART.IDITAR 
                    FROM   IMOVH INNER JOIN IART ON IMOVH.IDARTICULO = IART.IDARTICULO
                    WHERE  IMOVH.CNSMOV  = @CNSMOV
                    SELECT @CUECREDITO = DBO.FNK_NC_CUENTA_KMCOM(DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE'),'CXP_COMPRAS','CR', @IDITAR, IMOV.CCOSTO,'P','',0)
                    FROM   IMOV WHERE CNSMOV = @CNSMOV
                    UPDATE FCXP SET CUECREDITO = @CUECREDITO WHERE CNSFCXP = @CNSFCXP
                END
             END
          END
          INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                           REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                           N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE
                           )
          SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
                  'SERVICIOS POR '+LEFT(UPPER(#T.OBSERVACION),450)+', DOCUMENTO No.'+#T.NOREFERENCIA, -- STORRES se agrega LEFT de 450
                  SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100),
                  #T.NOREFERENCIA,#T.CNSFCXP,NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.PREFIJO,
                  LEFT(#TH.IDAREA,10),'S',1 ,@CXP_TIPO+'_CR', 'Movimiento',
                  #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
                  #T.PROCEDENCIA,'CXP',@CNSFCXP,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE)
          FROM #T,#TH
          WHERE #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
          GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,
		 			  #TH.PREFIJO, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		 			  DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,COALESCE(#TH.CODUNG,#T.CODUNG), #T.CODPRG,COALESCE(#TH.IDSEDE,#T.IDSEDE), COALESCE(#T.VLR_FLETE,0)
       END
		 -- FIN. MOD.JQUIROGA 20090619
		 PRINT 'Corrigiendo  MCHE...'      
		 UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
		 FROM  (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE 
		       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
		       (SELECT SUM(VALOR) AS VALOR FROM MCHE
		       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
		       #T
		 WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0
		 PRINT ' -Insertando Registro MCH Impuestos '+@PROCEDENCIA
		 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
		  				 REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
		   			 PROCESO,CNSPAGO,GENERA,VALOR_PORCIMP,BASE_IMP,
						 N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		 SELECT   @NROCOMPROBANTE,@COMPANIA,'CR',FIMPDV.CUENTA,#T.IDTERCERO,@CCOSTO,
				  'IMPUESTO POR '+UPPER(FIMPD.DESCRIPCION), FCXPI.VALOR, FIMPDV.IDIMPUESTO,FIMPDV.IDCLASE,FIMPDV.ITEM,
				  NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,@IDAREA,'S',1,'CXP_IMPUESTO',
				  FCXPI.CNSFCXPI, 'Movimiento',FIMPDV.VALOR,FCXPI.BASE,
				  #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
				  #T.PROCEDENCIA,'CXP',@CNSFCXP,#T.CODUNG, #T.CODPRG,#T.IDSEDE
		 FROM     #T,FCXPI,FIMPD,FIMPDV
		 WHERE    #T.CNSFCXP=FCXPI.CNSFCXP AND FCXPI.IDIMPUESTO=FIMPD.IDIMPUESTO AND FCXPI.IDCLASE=FIMPD.IDCLASE AND
		  		  FIMPD.IDIMPUESTO=FIMPDV.IDIMPUESTO AND FIMPD.IDCLASE=FIMPDV.IDCLASE AND FCXPI.ITEM=FIMPDV.ITEM AND
				  FCXPI.VALOR<>0 AND FCXPI.TIPOCALCULO='Automatico'
		 -- ADD.JQUIROGA 20090520 - Contabiliza la cuenta DB si es un Impuesto Asumido
		 PRINT  '-Insertando Registro MCH Impuestos '+@PROCEDENCIA+' DB si es Impuesto Asumido'
		 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
		 				 REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
		 				 PROCESO,CNSPAGO,GENERA,VALOR_PORCIMP,BASE_IMP,
		 				 N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		 SELECT   @NROCOMPROBANTE,@COMPANIA,'DB',FCXPI.CUENTA_ASUM,#T.IDTERCERO, DBO.FNK_VALORVARIABLE('CCOSTO_ASUM') ,
		 		  'IMPUESTO POR '+UPPER(FIMPD.DESCRIPCION), FCXPI.VALOR, FIMPDV.IDIMPUESTO,FIMPDV.IDCLASE,FIMPDV.ITEM,
		 		  NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,@IDAREA,'S',1,'CXP_IMPUESTO',
		 		  FCXPI.CNSFCXPI, 'Movimiento',FIMPDV.VALOR,FCXPI.BASE,
		 		  #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
		 		  #T.PROCEDENCIA,'CXP',@CNSFCXP,#T.CODUNG, #T.CODPRG,#T.IDSEDE
		 FROM     #T,FCXPI,FIMPD,FIMPDV
		 WHERE    #T.CNSFCXP=FCXPI.CNSFCXP AND FCXPI.IDIMPUESTO=FIMPD.IDIMPUESTO AND FCXPI.IDCLASE=FIMPD.IDCLASE AND
		 		  FIMPD.IDIMPUESTO=FIMPDV.IDIMPUESTO AND FIMPD.IDCLASE=FIMPDV.IDCLASE AND FCXPI.ITEM=FIMPDV.ITEM AND
		 		  FCXPI.VALOR<>0 AND FCXPI.TIPOCALCULO='Automatico' AND FCXPI.IMPUESTO_ASUM = 1

		 PRINT  '-Insertando Registro MCH Impuestos '+@PROCEDENCIA+' DB si es Impuesto Asumido calculo manual'
		 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
		 				 REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
		 				 PROCESO,CNSPAGO,GENERA,VALOR_PORCIMP,BASE_IMP,
		 				 N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		 SELECT   @NROCOMPROBANTE,@COMPANIA,'DB',FCXPI.CUENTA_ASUM,#T.IDTERCERO, DBO.FNK_VALORVARIABLE('CCOSTO_ASUM') ,
		 		  'IMPUESTO POR '+UPPER(FIMPD.DESCRIPCION), FCXPI.VALOR, FCXPI.IDIMPUESTO,FCXPI.IDCLASE,FCXPI.ITEM,
		 		  NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,@IDAREA,'S',1,'CXP_IMPUESTO',
		 		  FCXPI.CNSFCXPI, 'Movimiento',FCXPI.VALORIMP,FCXPI.BASE,
		 		  #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
		 		  #T.PROCEDENCIA,'CXP',@CNSFCXP,#T.CODUNG, #T.CODPRG,#T.IDSEDE
		 FROM     #T,FCXPI,FIMPD
		 WHERE    #T.CNSFCXP=FCXPI.CNSFCXP AND FCXPI.IDIMPUESTO=FIMPD.IDIMPUESTO AND FCXPI.IDCLASE=FIMPD.IDCLASE AND
		 		  FCXPI.VALOR<>0 AND FCXPI.TIPOCALCULO='Manual' AND FCXPI.IMPUESTO_ASUM = 1

		 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
						 REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
						 PROCESO,CNSPAGO,GENERA,VALOR_PORCIMP,BASE_IMP,
						 N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG,IDSEDE)
		 SELECT   @NROCOMPROBANTE,@COMPANIA,'CR',FCXPI.CUENTA,#T.IDTERCERO,@CCOSTO, 'IMPUESTO POR '+UPPER(FIMPD.DESCRIPCION), 
		 		  FCXPI.VALOR, FCXPI.IDIMPUESTO, FCXPI.IDCLASE, FCXPI.ITEM, 
		 		  NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,@IDAREA,'S',1,'CXP_IMPUESTO',
		 		  FCXPI.CNSFCXPI, 'Movimiento',FCXPI.VALORIMP,FCXPI.BASE,
		 		  #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
		 		  #T.PROCEDENCIA,'CXP',@CNSFCXP,#T.CODUNG, #T.CODPRG,#T.IDSEDE
		 FROM     #T,FCXPI,FIMPD
		 WHERE    #T.CNSFCXP=FCXPI.CNSFCXP AND FCXPI.IDIMPUESTO=FIMPD.IDIMPUESTO AND FCXPI.IDCLASE=FIMPD.IDCLASE AND
		     	   FCXPI.VALOR<>0 AND FCXPI.TIPOCALCULO='Manual'
	 END
    ELSE
    BEGIN
       PRINT '****  CXP CON TIPOS DIFERENTES A IPS *****'
       IF @PROCEDENCIA='Salud' 
	    BEGIN   
		    PRINT 'Debitos. Salud - Contabilizando Salud .'
          SELECT @COPAGO=COALESCE(VLRCOPAGO,0),@TIPOCOPAGO=COALESCE(TIPOCOPAGO,'') FROM #TH WHERE VLRCOPAGO>0
          IF COALESCE(@COPAGO,0)>0
          BEGIN
             IF COALESCE(@TIPOCOPAGO,'')='Copago' OR COALESCE(@TIPOCOPAGO,'')=''
             BEGIN
               SELECT @TIPOCOPAGO='Copago'
               SELECT @CUE_MODE_COPAGO=DBO.FNK_VALORVARIABLE('CUE_COPAGO_ARS')
             END
             ELSE
             BEGIN
                SELECT @CUE_MODE_COPAGO=DBO.FNK_VALORVARIABLE('CUE_MODERADORA_ARS')
             END
    			 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
				   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
				   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
				   CODUNG, CODPRG)
			    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',@CUE_MODE_COPAGO AS CREDITO,#T.IDTERCERO,'',
 				 	'ANTICIPOS A PRESTADORES POR: '+@TIPOCOPAGO+' DOCUMENTO No.'+#T.NOREFERENCIA,
				   @COPAGO,#T.NOREFERENCIA,#T.CNSFCXP,'',NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),'','','P',1 ,
				   @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			    FROM #T
          END
         --QUERY2
		    IF @CUENTA_IVA <> ''
		    BEGIN			
			    PRINT '-Ingreso en MCH de los Debitos-'
             PRINT 'PRINT PARA SABER POR DONDE INGRESO'
       		 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
				 			REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
				 			ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
				 			CODUNG, CODPRG)
             SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				 		  'SERVICIOS POR '+CASE WHEN GSS.DESCRIPCION IS NULL THEN 'VARIOS' ELSE UPPER(GSS.DESCRIPCION) END+', DOCUMENTO No.'+#T.NOREFERENCIA,
		              CASE SUM(#TH.VLR_NETO)WHEN 0 THEN SUM(#TH.VLR_GLOSAS) ELSE SUM(#TH.VLR_NETO - #TH.VLR_IVA) END ,#T.NOREFERENCIA, #T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
					     DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10), 'P', 1,
					     @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					     DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				 FROM   #T,#TH LEFT JOIN GSS ON #TH.IDGRUPOSER = GSS.IDGRUPOSER
				 GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
				   		 #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					   	 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, GSS.DESCRIPCION, #T.CODUNG, #T.CODPRG 
             PRINT '-Ingreso en MCH de los Debitos del IVA-'
			    INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							CODUNG, CODPRG)
				 SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_IVA AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				 		  'SERVICIOS POR '+CASE WHEN GSS.DESCRIPCION IS NULL THEN 'VARIOS' ELSE UPPER(GSS.DESCRIPCION) END+', DOCUMENTO No.'+#T.NOREFERENCIA,
				 	     CASE SUM(#TH.VLR_NETO)WHEN 0 THEN SUM(#TH.VLR_GLOSAS) ELSE SUM(#TH.VLR_IVA) END ,#T.NOREFERENCIA, #T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				 	     DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10), 'P', 1,
				 	     @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 	     DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				 FROM   #T,#TH LEFT JOIN GSS ON #TH.IDGRUPOSER = GSS.IDGRUPOSER
				 GROUP BY #TH.CUENTA_IVA,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
				 		 #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 		 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, GSS.DESCRIPCION, #T.CODUNG, #T.CODPRG 
			    PRINT 'Cr?itos. Salud - Contabilizando CxP.'
			    INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
				   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
				   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
				   CODUNG, CODPRG)
			    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
 					'COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(GSS.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				   SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100),
				   #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				   DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				   @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			    FROM   #TH LEFT JOIN 
				   CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA LEFT JOIN 
				   GSS ON GSS.IDGRUPOSER=#TH.IDGRUPOSER,
				   #T
			    WHERE  #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
             AND COALESCE(VLRCOPAGO,0)<=0
			    GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
					 #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, GSS.DESCRIPCION, #T.CODUNG, #T.CODPRG
             PRINT 'Corrigiendo  MCH...'
			    UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
			    FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE
				       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
				      (SELECT SUM(VALOR) AS VALOR FROM MCHE
				       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
			         #T
			    WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0
             PRINT ' - Contabilizando Glosas.'
             INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
				   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
				   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
				   CODUNG, CODPRG)
			    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#TH.CUENTA_GLO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
				   'GLOSAS: '+UPPER(CEN.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				   SUM(#TH.VLR_GLOSAS),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				   DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				   @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			    FROM   #T, #TH, CEN
			    WHERE  #TH.CCOSTO = CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA AND #TH.VLR_GLOSAS<>0
			    GROUP BY #TH.CUENTA_GLO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			 	 	 #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		     	 	 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, #T.CODUNG, #T.CODPRG
		    END	
		    ELSE
		    BEGIN
			    PRINT '-Ingreso en MCH de los Debitos-'
             PRINT '@CXP_TIPO ='+COALESCE(@CXP_TIPO,'NO TENGO TIPO')
             INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							CODUNG, CODPRG)
             SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				 		'SERVICIOS POR '+CASE WHEN GSS.DESCRIPCION IS NULL THEN 'VARIOS' ELSE UPPER(GSS.DESCRIPCION) END+', DOCUMENTO No.'+#T.NOREFERENCIA,
				 	   CASE SUM(#TH.VLR_NETO)WHEN 0 THEN SUM(#TH.VLR_GLOSAS) ELSE SUM(#TH.VLR_NETO) END ,#T.NOREFERENCIA, #T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				 	   DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10), 'P', 1,
				 	   @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 	   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				 FROM #T,#TH LEFT JOIN GSS ON #TH.IDGRUPOSER = GSS.IDGRUPOSER
             WHERE  COALESCE(VLRCOPAGO,0)=0
				 GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
				 		 #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 		 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, GSS.DESCRIPCION, #T.CODUNG, #T.CODPRG
			    PRINT 'Cr?itos. Salud - Contabilizando CxP.'
    			 INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
				   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
				   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
				   CODUNG, CODPRG)
			    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
 				 	'COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(GSS.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				   SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100)-COALESCE(@COPAGO,0),
				   #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				   DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				   @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			    FROM   #TH LEFT JOIN 
				   CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA LEFT JOIN 
				   GSS ON GSS.IDGRUPOSER=#TH.IDGRUPOSER,
				   #T
			    WHERE  #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
             AND COALESCE(#TH.VLRCOPAGO,0)=0
			    GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
				 	 #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				 	 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, GSS.DESCRIPCION, #T.CODUNG, #T.CODPRG		

			    PRINT 'Corrigiendo  MCHE...'    
			    UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
			    FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE 
				       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
				      (SELECT SUM(VALOR) AS VALOR FROM MCHE
				       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
			          #T
			    WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0


			    PRINT ' - Contabilizando Glosas.'
			    INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
				   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
				   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
				   CODUNG, CODPRG)
			    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#TH.CUENTA_GLO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
				   'GLOSAS: '+UPPER(CEN.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				   SUM(#TH.VLR_GLOSAS),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				   DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				   @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			    FROM   #T, #TH, CEN
			    WHERE  #TH.CCOSTO = CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA AND #TH.VLR_GLOSAS<>0
			    GROUP BY #TH.CUENTA_GLO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
					    #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					    DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, #T.CODUNG, #T.CODPRG
		    END
	    END
   	 ELSE  
	       IF @PROCEDENCIA='Compras' 
	       BEGIN
             PRINT 'Debitos. Compras - Contabilizando Compras.'
	          IF @CUENTA_IVA <> ''
	          BEGIN 
         	    PRINT '-Ingreso en MCH de los Debitos- DETALLE'
			       INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							  CODUNG, CODPRG)
			       SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				           'SERVICIOS POR '+UPPER(ITAR.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
					          SUM((#TH.VLR_NETO+(COALESCE(#T.VLR_FLETE,0)*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100)-COALESCE(#TH.VLR_IVA,0)),
					          #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				          DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				          @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					          DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			       FROM #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP LEFT JOIN 
				         ITAR ON #TH.PREFIJO=ITAR.IDITAR
			       GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
					   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, ITAR.DESCRIPCION, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG,
					   #T.VLR_IVA, #T.VLR_DESCUENTO


                PRINT '-Ingreso en MCH de los Debitos del IVA-'
                INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							  CODUNG, CODPRG)
			       SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_IVA AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				          'SERVICIOS POR '+UPPER(ITAR.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
					          SUM(COALESCE(#TH.VLR_IVA,0)),
					          #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				          DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				          @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					          DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			       FROM #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP LEFT JOIN 
				         ITAR ON #TH.PREFIJO=ITAR.IDITAR
			       GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
					   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, ITAR.DESCRIPCION, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG,
					   #T.VLR_IVA, #T.VLR_DESCUENTO,#TH.CUENTA_IVA
                HAVING  SUM(#TH.VLR_IVA)>0

			       PRINT 'Cr?itos. Compras. - Contabilizando CxP.'
			       INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
					  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
					  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							  CODUNG, CODPRG)
			       SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
 				          'COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(ITAR.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				          SUM((#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100)),
					          #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				          DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				          @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				         DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				    FROM #TH LEFT JOIN CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA LEFT JOIN 
				          ITAR ON ITAR.IDITAR=#TH.PREFIJO,
				         #T
			       WHERE #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
			       GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
					   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, ITAR.DESCRIPCION, #T.CODUNG, #T.CODPRG
      		 END
		       ELSE
		       BEGIN
                PRINT '-Ingreso en MCH de los Debitos-'

               PRINT 'DB 1 @IVADESCONTABLE='+CAST(@IVADESCONTABLE AS VARCHAR(20))
               INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                                REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
                                N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
               SELECT @NROCOMPROBANTE,@COMPANIA,'DB',
                      CASE WHEN CUE.CUENTA IS NULL THEN DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,@CXP_TIPO,'DB',#TH.PREFIJO, #TH.CCOSTO,'P',#TH.IDSERVICIO,0) 
                           ELSE CUE.CUENTA 
                      END,
                      CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END, #TH.CCOSTO, LEFT(UPPER(#T.OBSERVACION),450)+', DOCUMENTO No.'+#T.NOREFERENCIA, -- STORRES se agrega LEFT de 450 
                      SUM((#TH.VLR_NETO-CASE WHEN CUEIVA.CUENTA IS NULL THEN 0 ELSE #TH.VLR_IVA END)),--+(COALESCE(#T.VLR_FLETE,0)*((#TH.VLR_NETO*100)/(#T.VLR_NETO-@IVADESCONTABLE)))/100),
                      #T.NOREFERENCIA,#T.CNSFCXP, NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
                      #TH.PREFIJO,LEFT(#TH.IDAREA,10),'P',1 ,@CXP_TIPO+'_DB', 'Movimiento',
                      #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
               FROM   #T, #TH LEFT JOIN CUE ON #TH.CUENTA_SER=CUE.CUENTA AND CUE.COMPANIA='01' AND CUE.TIPO='Detalle' AND CUE.ESTADO='Activa' 
                              LEFT JOIN CUE CUEIVA ON #TH.CUENTA_IVA = CUEIVA.CUENTA AND CUEIVA.COMPANIA = @COMPANIA
               GROUP BY DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,@CXP_TIPO,'DB',#TH.PREFIJO, #TH.CCOSTO,'P',#TH.IDSERVICIO,0),
                     CASE WHEN @GENCXP = 1 THEN @TER_ANTERIOR ELSE CASE WHEN @VARIOSTER=1 THEN #TH.IDTERCERO ELSE  #T.IDTERCERO END END,#TH.CCOSTO,
                        #T.OBSERVACION,#T.NOREFERENCIA,#T.CNSFCXP,#TH.PREFIJO, 
                        LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), #TH.IDSERVICIO, #TH.IDAREA,
                        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG, CUE.CUENTA

		          PRINT 'Cr?itos. Compras. - Contabilizando CxP.'
			       INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
					  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
					  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							  CODUNG, CODPRG)
			       SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
 				           'COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(ITAR.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,
	                    SUM((#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100)),
					        #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				           DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				           @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				           DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				    FROM #TH LEFT JOIN 
				         CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA LEFT JOIN 
				         ITAR ON ITAR.IDITAR=#TH.PREFIJO,
				         #T
			       WHERE #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
			       GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
					   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, ITAR.DESCRIPCION, #T.CODUNG, #T.CODPRG
		       END
      	    PRINT 'Corrigiendo  MCH...'
	          UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
	          FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE
			          WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
		            (SELECT SUM(VALOR) AS VALOR FROM MCHE
			          WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
		             #T
	          WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0
       	 END
   	    ELSE
	          IF @PROCEDENCIA='Servicios' or @PROCEDENCIA='LevGlo' or @PROCEDENCIA='ConcGlo'
	          BEGIN
	             PRINT 'Debitos. Servicios. - Contabilizando Servicios -- Glosas Conciliadas'
                IF @CUENTA_IVA <> ''
		          BEGIN 
				       PRINT '-Ingreso en MCH de los Debitos- OJO CONTABILIZO IVA...'
                   PRINT '@CXP_TIPO='+COALESCE(@CXP_TIPO,'NO TENGO')
                   PRINT 'DEBITO MENOS EL IVA'
				      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
						               REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
						               ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
								         CODUNG, CODPRG)
                  SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 					         'SERVICIOS POR '+UPPER(CASE WHEN FCTSER.DESCRIPCION IS NULL THEN 'VARIOS' ELSE FCTSER.DESCRIPCION END)+', DOCUMENTO No.'+#T.NOREFERENCIA,
					         SUM(((#TH.VLR_NETO)+COALESCE(#T.VLR_FLETE,0))-#TH.VLR_IVA),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
					         DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
					         @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
						      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
                  FROM   #T,#TH LEFT JOIN FCTSER ON #TH.PREFIJO=FCTSER.IDTIPOSER
				      GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
                           #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                           DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, FCTSER.DESCRIPCION, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG
                   
                   PRINT '-Ingreso en MCH de los Debitos del IVA- '

				       INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
						                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
						                  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
								            CODUNG, CODPRG)
				       SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_IVA AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
                          'SERVICIOS POR '+UPPER(CASE WHEN FCTSER.DESCRIPCION IS NULL THEN 'VARIOS' ELSE FCTSER.DESCRIPCION END)+', DOCUMENTO No.'+#T.NOREFERENCIA,
                          SUM(#TH.VLR_IVA),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
                          DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
                          @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                          DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				       FROM   #T,#TH LEFT JOIN FCTSER ON #TH.PREFIJO=FCTSER.IDTIPOSER
				       GROUP BY #TH.CUENTA_IVA,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
                            #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                            DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, FCTSER.DESCRIPCION, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG

                   PRINT 'Cr?itos. Servicios  - Contabilizando CxP.'
				       INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
						                 REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
						                 ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
								                 CODUNG, CODPRG)
				       SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
 					             LEFT('COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(FCTSER.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,512),
					             SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100),
					            #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
					             DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
					             @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					            DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				       FROM #TH LEFT JOIN 
					         CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA LEFT JOIN 
					         FCTSER ON FCTSER.IDTIPOSER=#TH.PREFIJO,
					         #T
				       WHERE  #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
				       GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
						   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
						   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, FCTSER.DESCRIPCION, #T.CODUNG, #T.CODPRG
                   PRINT 'Corrigiendo  MCH...'
				       UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
				       FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE
						       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
					         (SELECT SUM(VALOR) AS VALOR FROM MCHE
						       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
					          #T
				       WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0
		          END
		          IF @PROCEDENCIA='LevGlo' OR  @PROCEDENCIA='ConcGlo'
		          BEGIN 
                   SELECT @CUENTAGLOSA  = DBO.FNK_VALORVARIABLE('IDAUD_LEVDEBI')
                   SELECT @CUECREDITO   = DBO.FNK_VALORVARIABLE('IDAUD_CUECREDITO')
                   SELECT @CUENTASERGLO = DBO.FNK_VALORVARIABLE('IDAUD_CUENTASERGLO')
                   PRINT '-Ingreso en MCH de los Debitos- COSTOS'
                   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
			                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			                  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					            CODUNG, CODPRG)
	                SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
		                    #T.OBSERVACION +', FACTURA No.: '+#T.NOREFERENCIA,
		                    SUM(#TH.VLR_NETO),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		                    DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		                    @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			                 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	                FROM #T,#TH 
	                WHERE #TH.VLR_NETO> 0
	                GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			           #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			           DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,#T.CODUNG, #T.CODPRG,#T.OBSERVACION

	                PRINT '-Ingreso en MCH de los Debitos- PROVISION CXP'
                   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
			                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			                  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					            CODUNG, CODPRG)
	                SELECT @NROCOMPROBANTE,@COMPANIA,'DB',@CUENTAGLOSA AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
		                    #T.OBSERVACION +', FACTURA No.: '+#T.NOREFERENCIA,
		                    SUM(#TH.VLR_NETO),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		                    DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		                    @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			                 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	                FROM #T,#TH 
	                WHERE #TH.VLR_NETO> 0
	                GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			           #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			           DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,#T.CODUNG, #T.CODPRG,#T.OBSERVACION						   
	                PRINT 'Cr?itos. - Contabilizando CxP.'
                   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
			                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			                  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					            CODUNG, CODPRG)
	                SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
		                    #T.OBSERVACION +', FACTURA No.: '+#T.NOREFERENCIA,
		                    SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		                    DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		                    @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		                    DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	                FROM   #TH LEFT JOIN CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA,#T
	                WHERE  #TH.VLR_NETO > 0
	                GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			                   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			                   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, #T.CODUNG, #T.CODPRG,#T.OBSERVACION
                   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
			                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			                  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					            CODUNG, CODPRG)
	                SELECT @NROCOMPROBANTE,@COMPANIA,'CR',@CUENTASERGLO,#T.IDTERCERO,#TH.CCOSTO,
		                  #T.OBSERVACION +', FACTURA No.: '+#T.NOREFERENCIA,
		                  SUM(#TH.VLR_NETO),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		                  DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		                  @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
		                  DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	                FROM   #TH LEFT JOIN CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA,#T
	                WHERE  #TH.VLR_NETO > 0
	                GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			                   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			                   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, #T.CODUNG, #T.CODPRG,#T.OBSERVACION
                   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
		                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			               ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					         CODUNG, CODPRG)
	                SELECT @NROCOMPROBANTE,@COMPANIA,'DB',@CUENTAGLOSA,#T.IDTERCERO,#TH.CCOSTO,
		                 #T.OBSERVACION +', FACTURA No.: '+#T.NOREFERENCIA,
		                 SUM(#TH.VLR_GLOSAS),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		                 DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		                 @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			              DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	                FROM #T,#TH 
	                WHERE #TH.VLR_GLOSAS> 0
	                GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			           #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			           DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,#T.CODUNG, #T.CODPRG,#T.OBSERVACION
                   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
		                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			               ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					         CODUNG, CODPRG)
	                SELECT @NROCOMPROBANTE,@COMPANIA,'CR',@CUENTASERGLO,#T.IDTERCERO,#TH.CCOSTO,
		                  #T.OBSERVACION +', FACTURA No.: '+#T.NOREFERENCIA,
		                  SUM(#TH.VLR_GLOSAS),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		                  DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		                  @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			               DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
                   FROM #T,#TH 
	                WHERE #TH.VLR_GLOSAS> 0
	                GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			           #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			           DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,#T.CODUNG, #T.CODPRG,#T.OBSERVACION
         		 END
		     IF @PROCEDENCIA='Servicios'
		     BEGIN
              IF COALESCE(@CUENTA_IVA,'') = ''
              BEGIN 
				     PRINT '-Ingreso en MCH de los Debitos- OJO SIN CUENTA IVA'
				     INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
                                  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
                                  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
                                  CODUNG, CODPRG)
				     SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
                        'SERVICIOS POR '+UPPER(CASE WHEN FCTSER.DESCRIPCION IS NULL THEN 'VARIOS' ELSE FCTSER.DESCRIPCION END)+', DOCUMENTO No.'+#T.NOREFERENCIA,
                        SUM(#TH.VLR_NETO)+COALESCE(#T.VLR_FLETE, 0),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
                        DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
                        @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				     FROM   #T,#TH LEFT JOIN FCTSER ON #TH.PREFIJO=FCTSER.IDTIPOSER
				     GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
						        #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
						        DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, FCTSER.DESCRIPCION, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG
             
				  PRINT 'Cr?itos. Servicios  - Contabilizando CxP. DESPUES DE JOSE'
				  INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
						  REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
						  ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
								  CODUNG, CODPRG)
				  SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
 					 LEFT('COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(FCTSER.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,512),
					 SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100),
					#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
					 DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
					 @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
				  FROM #TH LEFT JOIN 
					   CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA LEFT JOIN 
					   FCTSER ON FCTSER.IDTIPOSER=#TH.PREFIJO,
					   #T
				  WHERE  #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
				  GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
						   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
						   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, FCTSER.DESCRIPCION, #T.CODUNG, #T.CODPRG

				  PRINT 'Corrigiendo  MCH...'
				  UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
				  FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE 
						WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
					   (SELECT SUM(VALOR) AS VALOR FROM MCHE 
						WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
					   #T
				  WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0
              END
		  END
    END
	 ELSE
	    IF @PROCEDENCIA='Nomina' 
	    BEGIN
	       PRINT 'Debitos. Nomina.'
	       PRINT ' - Contabilizando Nomina.'
          INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
                           REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
                           ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
                           CODUNG, CODPRG)
          SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 		 'CONCEPTO: '+UPPER(CASE WHEN NCON.DESCRIPCION IS NULL THEN 'VARIOS' ELSE NCON.DESCRIPCION END)+', DOCUMENTO No.'+#T.NOREFERENCIA,
		 SUM(#TH.VLR_NETO)+COALESCE(#T.VLR_FLETE,0),#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
		 DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
		 @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			 DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	    FROM #T,#TH LEFT JOIN NCON ON #TH.PREFIJO=NCON.CODCONCEPTO
	    GROUP BY #TH.CUENTA_SER,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
			   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, NCON.DESCRIPCION, #T.VLR_FLETE, #T.CODUNG, #T.CODPRG
	    /*******************************************************************************************************************/
	    PRINT 'Cr?itos. Nomina'
	    PRINT ' - Contabilizando CxP.'
	    INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
		            REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
			        ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
					  CODUNG, CODPRG)
	    SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
               LEFT('COSTOS DE '+UPPER(CEN.DESCRIPCION)+', SERVICIOS: '+UPPER(FCTSER.DESCRIPCION)+', DOCUMENTO No.'+#T.NOREFERENCIA,512),
               SUM(#TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100),
               #T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
               DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
               @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
               DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	    FROM   #TH LEFT JOIN CEN ON #TH.CCOSTO=CEN.CCOSTO AND CEN.COMPANIA=@COMPANIA 
                   LEFT JOIN FCTSER ON FCTSER.IDTIPOSER=#TH.PREFIJO,
			     #T
	    WHERE  #TH.VLR_NETO-(@VLR_IMPUESTOS*((#TH.VLR_NETO*100)/#T.VLR_NETO))/100<>0
	    GROUP BY #T.CUECREDITO,#T.IDTERCERO,#TH.CCOSTO,#TH.CCOSTO2,#T.NOREFERENCIA,#T.CNSFCXP,
		     	   #TH.IDGRUPOSER, LEFT(#TH.IDAREA,10), DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
			       DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA, CEN.DESCRIPCION, FCTSER.DESCRIPCION, #T.CODUNG, #T.CODPRG  
	    PRINT 'Corrigiendo  MCH...'
	    UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
	    FROM (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE 
		       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
		      (SELECT SUM(VALOR) AS VALOR FROM MCHE 
		       WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
		        #T
	    WHERE MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0
	   END
	   IF @PROCEDENCIA='ANTICIPOS'
	   BEGIN
         SELECT @TIPOANTICIPO = TIPOANTICIPO FROM FCOM WHERE CNSFCOM = @CNSFCOM           
         SELECT @CUEANTDB=CUEDEBITO,@CUEANTCR=CUECREDITO FROM TANT WHERE TIPOANTICIPO= @TIPOANTICIPO	
	      SELECT @ESLEGA=COALESCE(COUNT(*),0) FROM ANT WHERE CNSFCXP=@CNSFCXP  
	      IF @ESLEGA=0
	      BEGIN 
			   PRINT 'INGRESO A ANTICIPOS'
			   PRINT 'CREDITOS ANTICIPOS'
	  		   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							   CODUNG, CODPRG)
			   SELECT @NROCOMPROBANTE,@COMPANIA,'CR',@CUEANTCR AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
                   LEFT('ANTICIPO No.: '+RIGHT(#T.NOREFERENCIA,2)+' '+'ORDEN SE SERVICIO No.:'+@CNSFCOM+' '+UPPER(FCTSER.DESCRIPCION),500),
                   #TH.VLR_NETO,#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
                   DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
                   @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
                   DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG	       
			   FROM   #T INNER JOIN #TH    ON #T.CNSFCXP       = #TH.CNSFCXP
                       LEFT JOIN FCTSER ON FCTSER.IDTIPOSER = #TH.PREFIJO
			          
			   PRINT 'INSERTANDO LOS DEBITOS'
	  		   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							   CODUNG, CODPRG)
			   SELECT @NROCOMPROBANTE,@COMPANIA,'DB',@CUEANTDB AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				       'SERVICIOS POR '+UPPER(CASE WHEN FCTSER.DESCRIPCION IS NULL THEN 'VARIOS' ELSE FCTSER.DESCRIPCION END)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				       #TH.VLR_NETO,#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				       DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				       @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				       DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			   FROM   #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP 
					        LEFT JOIN FCTSER ON #TH.PREFIJO=FCTSER.IDTIPOSER
		            
			   PRINT 'Corrigiendo  MCH...'
			   UPDATE MCHE SET VALOR = MCHE.VALOR + (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)
			   FROM   (SELECT MAX(NROASIENTO) AS NROASIENTO FROM MCHE 
				        WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS B,
				       (SELECT SUM(VALOR) AS VALOR FROM MCHE 
				        WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND TIPO='CR' AND PROCESO=@CXP_TIPO+'_CR' AND REFERENCIA_PRO=@CNSFCXP) AS C,
				       #T
			   WHERE  MCHE.NROASIENTO=B.NROASIENTO AND (#T.VLR_NETO-@VLR_IMPUESTOS-C.VALOR)<>0	            
		   END
		   ELSE
		   BEGIN 
		      PRINT 'CONTABILIZANDO LEGALIZACION DE ANTICIPOS'
		      PRINT 'LLENADO VARIABLES'
		      DECLARE @VLR_ANTICIPOS DECIMAL(14,2)
		      DECLARE @VRL_SALDO     DECIMAL(14,2)
		      DECLARE @VLR_PAGADO    DECIMAL(14,2)
            SELECT @VLR_PAGADO=VALORCXP,@VLR_ANTICIPOS=VALORCXP,@VRL_SALDO=VALOR_LEG FROM ANT WHERE CNSFCXP=@CNSFCXP
            IF @VRL_SALDO=0 
            BEGIN
               SET @VLR_ANTICIPOS=0
            END
            PRINT 'INGRESO DEBITOS'
	  	      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
                             REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
                             ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
                             CODUNG, CODPRG)		   
			   SELECT @NROCOMPROBANTE,@COMPANIA,'DB',#TH.CUENTA_SER AS DEBITO,#T.IDTERCERO,#TH.CCOSTO,
 				       'SERVICIOS POR '+UPPER(CASE WHEN FCTSER.DESCRIPCION IS NULL THEN 'VARIOS' ELSE FCTSER.DESCRIPCION END)+', DOCUMENTO No.'+#T.NOREFERENCIA,
				       CASE WHEN #TH.CANTIDAD=1 THEN #TH.VLR_NETO+@VLR_ANTICIPOS ELSE #TH.VLR_NETO END ,#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				       DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				       @CXP_TIPO+'_DB', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				       DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
			   FROM   #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP 
					        LEFT JOIN FCTSER ON #TH.PREFIJO=FCTSER.IDTIPOSER			
			   PRINT 'ESTE ES EL VALOR DEL SALDO PENDIENTE  '+STR(@VRL_SALDO)		
			   IF @VRL_SALDO>0 
			   BEGIN
			      PRINT 'HAY SALDO PENDIENTE'	
	  			   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
                                REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
                                ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
                                CODUNG, CODPRG)					
				   SELECT @NROCOMPROBANTE,@COMPANIA,'CR',#T.CUECREDITO AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
                      LEFT('LEGALIZACION DE ANTICIPO No.: '+#T.CNSFCOM+' '+'Y CXP FACTURA No.:'+#T.NOREFERENCIA,500),
	  			          #T.SALDO,#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
					       DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
					       @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
					       DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG	       
				   FROM   #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP
						        LEFT JOIN  FCTSER ON FCTSER.IDTIPOSER=#TH.PREFIJO	
  		      END
  		      PRINT 'CONTABILIZANDO EL VALOR DE LOS ANTICIPOS'
	  	      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,
							   REFERENCIA1,REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,
							   ESTADO,PROCESO,GENERA,N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO,
							   CODUNG, CODPRG)  		   
		      SELECT @NROCOMPROBANTE,@COMPANIA,'CR',@CUEANTDB AS CREDITO,#T.IDTERCERO,#TH.CCOSTO,
				      LEFT('LEGALIZACION DE ANTICIPO No.: '+#T.CNSFCOM+' '+'Y CXP FACTURA No.:'+#T.NOREFERENCIA,500),
				      @VLR_PAGADO,#T.NOREFERENCIA,#T.CNSFCXP,#TH.CCOSTO2,NULL,@USUARIO,
				      DBO.FNK_FECHA_SIN_MLS(GETDATE()),#TH.IDGRUPOSER,LEFT(#TH.IDAREA,10),'P',1 ,
				      @CXP_TIPO+'_CR', 'Movimiento',#T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), 
				      DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG	       
			   FROM   #T INNER JOIN #TH ON #T.CNSFCXP=#TH.CNSFCXP
					     LEFT JOIN  FCTSER ON FCTSER.IDTIPOSER=#TH.PREFIJO								   
		   END		
	   END--FCXPD
      PRINT ' - Contabilizando Impuestos.'
	   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                       REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
                       PROCESO,CNSPAGO,GENERA,VALOR_PORCIMP,BASE_IMP,
                       N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
	   SELECT @NROCOMPROBANTE,@COMPANIA,'CR',FCXPI.CUENTA,#T.IDTERCERO,@CCOSTO, 'IMPUESTO POR '+UPPER(FIMPD.DESCRIPCION), 
			    FCXPI.VALOR, FIMPD.IDIMPUESTO,FIMPD.IDCLASE,FCXPI.ITEM, NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,@IDAREA,'S',1,'CXP_IMPUESTO',
			    #T.CNSFCXP, 'Movimiento',FCXPI.VALORIMP,FCXPI.BASE,
			    #T.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(#T.F_FACTURAREF), DBO.FNK_FECHA_SIN_HORA(#T.F_VENCE), 
			    #T.PROCEDENCIA,'CXP',@CNSFCXP, #T.CODUNG, #T.CODPRG
	   FROM   #T,FCXPI,FIMPD
	   WHERE  #T.CNSFCXP=FCXPI.CNSFCXP AND FCXPI.IDIMPUESTO=FIMPD.IDIMPUESTO AND FCXPI.IDCLASE=FIMPD.IDCLASE AND
 	  			   FCXPI.VALOR<>0
   END
   DROP TABLE #T
   DROP TABLE #TH

   IF DBO.FNK_VALORVARIABLE('FCXP_ENVIO_DIAN_AUTO')='SI'
   BEGIN 
   IF(@PROCEDENCIA='Servicios' AND EXISTS(SELECT 1 FROM FCXP WHERE   CNSFCXP=@CNSFCXP AND COALESCE(DOCEQUIVALENTE,0)=1 AND COALESCE(CNSRESOL,'')='' 
									AND COALESCE(N_FACTURA,'')='' AND COALESCE(ESTADODIAN,0)=0 ))
   BEGIN 
   EXEC SPK_NUMERODIAN_CXP @COMPANIA,@SEDE,@CNSFCXP,@PROCEDENCIA,''
   END 
	UPDATE FCXP SET ESTADODIAN=1 WHERE CNSFCXP=@CNSFCXP AND COALESCE(DOCEQUIVALENTE,0)=1 AND COALESCE(CNSRESOL,'')<>'' 
									AND COALESCE(N_FACTURA,'')<>'' AND COALESCE(ESTADODIAN,0)=0 
   END 

   IF EXISTS(SELECT * FROM CUE INNER JOIN MCHE ON CUE.CUENTA=MCHE.CUENTA WHERE MCHE.NROCOMPROBANTE=@NROCOMPROBANTE AND COALESCE(CUE.CUEESPEJO,'')<>'')
   BEGIN
      DECLARE @CUEESPEJO VARCHAR(20)
      DECLARE @CUEESPEJO1 VARCHAR(20)
      DECLARE @NROASIENTO INT
      DECLARE @TIPOESP    VARCHAR(3)

	   DECLARE CUESPEJO_CURSOR CURSOR FOR  
      SELECT NROASIENTO,CUE.CUEESPEJO,MCHE.TIPO 
      FROM MCHE INNER JOIN CUE ON MCHE.CUENTA=CUE.CUENTA 
      WHERE MCHE.NROCOMPROBANTE=@NROCOMPROBANTE
      AND COALESCE(CUE.CUEESPEJO,'')<>''
      GROUP BY NROASIENTO,CUE.CUEESPEJO,MCHE.TIPO         
	   OPEN CUESPEJO_CURSOR    
	   FETCH NEXT FROM CUESPEJO_CURSOR    
	   INTO @NROASIENTO,@CUEESPEJO,@TIPOESP
	   WHILE @@FETCH_STATUS = 0    
	   BEGIN
         SELECT  @CUEESPEJO1=CUEESPEJO FROM CUE WHERE CUENTA=@CUEESPEJO 
         PRINT 'INSERTO LAS CUENTA ESPEJO' 

         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, 
                           USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, FECHACONCILIACION, CNSFCXCXP, CODUNG, CODPRG, 
                           ERROR, IDPROVEEDOR, ENPRESUPUESTO, IDOPERACION, ESTADOIMP, MARCA, SYS_COMPUTERNAMEMARCA)
         SELECT NROCOMPROBANTE, COMPANIA, @TIPOESP, @CUEESPEJO, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, 
               USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, FECHACONCILIACION, CNSFCXCXP, CODUNG, CODPRG, 
               ERROR, IDPROVEEDOR, ENPRESUPUESTO, IDOPERACION, ESTADOIMP, MARCA, SYS_COMPUTERNAMEMARCA
         FROM MCHE
         WHERE NROASIENTO=@NROASIENTO

         PRINT 'CONTRAPARTIDA '+@TIPOESP

         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, 
                           USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, FECHACONCILIACION, CNSFCXCXP, CODUNG, CODPRG, 
                           ERROR, IDPROVEEDOR, ENPRESUPUESTO, IDOPERACION, ESTADOIMP, MARCA, SYS_COMPUTERNAMEMARCA)
         SELECT NROCOMPROBANTE, COMPANIA,CASE WHEN  @TIPOESP='DB' THEN 'CR' ELSE 'DB' END, @CUEESPEJO1, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, 
               USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, FECHACONCILIACION, CNSFCXCXP, CODUNG, CODPRG, 
               ERROR, IDPROVEEDOR, ENPRESUPUESTO, IDOPERACION, ESTADOIMP, MARCA, SYS_COMPUTERNAMEMARCA
         FROM MCHE
         WHERE NROASIENTO=@NROASIENTO

	   FETCH NEXT FROM CUESPEJO_CURSOR    
	   INTO @NROASIENTO,@CUEESPEJO,@TIPOESP
	   END
	   CLOSE CUESPEJO_CURSOR
	   DEALLOCATE CUESPEJO_CURSOR

   END

   EXEC SPK_NC_REVISAMCPE @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SEDE, @SYS_COMPUTERNAME  
   EXEC SPK_PASA_MCP_MCPNIIF @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SYS_COMPUTERNAME, @SEDE,@COM,'' 
END


