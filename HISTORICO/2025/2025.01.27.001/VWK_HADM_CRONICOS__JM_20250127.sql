IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_HADM_CRONICOS' AND TYPE='V')
BEGIN
 DROP VIEW VWK_HADM_CRONICOS
END
GO
CREATE VIEW VWK_HADM_CRONICOS
AS
SELECT CIT.NOADMISION, CIT.CONSECUTIVO,CIT.CONSECUTIVO AS IDAUT,DBO.FNK_FECHA_GRINGA(CIT.FECHA)FECHA,CONVERT(VARCHAR,CIT.FECHA,108) HORA,NOAUTORIZACION,AFI.TIPO_DOC,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
CIT.IDMEDICO,MED.NOMBRE,MES.DESCRIPCION,CIT.CLASEORDEN,CIT.IDPLAN,
PLN.DESCPLAN,1 AS NO_ITEM,CIT.IDSERVICIO,SER.DESCSERVICIO,SER.PREFIJO,PRE.NOM_PREFIJO,TER.NIT,TER.RAZONSOCIAL,'1' CANTIDAD,
COALESCE(CIT.VALORTOTAL,0)VALORTOTAL,COALESCE(CIT.VALORCOPAGO,0)VALORCOPAGO,
(COALESCE(CIT.VALORTOTAL,0)-COALESCE(CIT.VALORCOPAGO,0))VLR_EXCEDENTE,0 VRL_EVENTO,
COALESCE(CIT.FACTURADA,0) FACTURADA,CIT.N_FACTURA,CIT.NFACTURA AS NBOLETA,1 ESPROGRAMAS,1 PROTOCOLO,
0 RESUL,SED.NIT AS PROVEEDOR,COALESCE(SED.DESCRIPCION,'')AS N_PROVEEDOR,COALESCE(CIT.FACTURABLE,0)FACTURABLE
FROM [dbo].[CIT] INNER JOIN  AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO 
      INNER JOIN  MED ON CIT.IDMEDICO=MED.IDMEDICO 
      INNER JOIN  SER ON CIT.IDSERVICIO=SER.IDSERVICIO 
      INNER JOIN  PRE ON SER.PREFIJO=PRE.PREFIJO 
      INNER JOIN TER ON CIT.IDTERCEROCA=TER.IDTERCERO 
      INNER JOIN PLN ON CIT.IDPLAN=PLN.IDPLAN 
      INNER JOIN PPT ON CIT.IDTERCEROCA=PPT.IDTERCERO  AND CIT.IDPLAN=PPT.IDPLAN 
      LEFT JOIN  MES ON CIT.IDEMEDICA=MES.IDEMEDICA 
      LEFT JOIN SED ON COALESCE(CIT.IDSEDE,'01')=SED.IDSEDE
WHERE COALESCE(CIT.CUMPLIDA,0)=1 
AND CIT.IDAFILIADO IS NOT NULL            
AND COALESCE(CIT.FACTURADA,0)=0  
AND COALESCE(PLN.CRONICO,0)=1
AND EXISTS(SELECT * FROM HADM WHERE HADM.NOADMISION=CIT.NOADMISION)
UNION ALL
SELECT CIT.NOADMISION,CIT.CONSECUTIVO,AUT.IDAUT,DBO.FNK_FECHA_GRINGA(CIT.FECHA)FECHA,CONVERT(VARCHAR,CIT.FECHA,108) HORA,NOAUTORIZACION,AFI.TIPO_DOC,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
CIT.IDMEDICO,MED.NOMBRE,MES.DESCRIPCION,CIT.CLASEORDEN,CIT.IDPLAN,
PLN.DESCPLAN,AUTD.NO_ITEM,AUTD.IDSERVICIO,SER.DESCSERVICIO,SER.PREFIJO,PRE.NOM_PREFIJO,TER.NIT,TER.RAZONSOCIAL,AUTD.CANTIDAD,
COALESCE(AUTD.VALOR,0)VALOR,COALESCE(AUTD.VALORCOPAGO,0)VALORCOPAGO,
COALESCE(AUTD.VALOREXCEDENTE,0),CASE WHEN COALESCE(AUTD.PROTOCOLO,0)=0 THEN COALESCE(AUTD.VALOREXCEDENTE,0) ELSE 0 END VRL_EVENTO,
COALESCE(CIT.FACTURADA,0) FACTURADA,AUTD.N_FACTURA,AUTD.NFACTURA AS NBOLETA,COALESCE(AUT.ESPROGRAMAS,0),AUTD.PROTOCOLO,
CASE WHEN COALESCE(AUTD.ESDELAB,0)=1 THEN  COALESCE(AUTD.ENLAB,0) ELSE 1 END RESUL,AUT.IDFARMACIA ,TGEN.DESCRIPCION AS DISTRIBUIDOR,
CASE WHEN COALESCE(AUTD.NOCOBRABLE,0) =0 THEN 1 ELSE 0 END FACTURABLE
FROM [dbo].[CIT] INNER JOIN  AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO 
      INNER JOIN  MED ON CIT.IDMEDICO=MED.IDMEDICO 
      INNER JOIN TER ON CIT.IDTERCEROCA=TER.IDTERCERO 
      INNER JOIN PLN ON CIT.IDPLAN=PLN.IDPLAN 
      INNER JOIN PPT ON CIT.IDTERCEROCA=PPT.IDTERCERO  AND CIT.IDPLAN=PPT.IDPLAN 
      LEFT JOIN  MES ON CIT.IDEMEDICA=MES.IDEMEDICA 
      INNER JOIN AUT ON CIT.CONSECUTIVO=AUT.CONSECUTIVOCIT
      LEFT JOIN AUTD ON AUT.IDAUT=AUTD.IDAUT
      LEFT JOIN SER  ON AUTD.IDSERVICIO=SER.IDSERVICIO
      LEFT JOIN PRE  ON SER.PREFIJO=PRE.PREFIJO 
      LEFT JOIN TGEN ON AUT.IDFARMACIA=TGEN.CODIGO 
                        AND TGEN.CAMPO=CASE WHEN PRE.PREFIJO=DBO.FNK_VALORVARIABLE('PREFIJOMEDICAMENTOS') THEN 'FARMACIA'
                                            WHEN PRE.PREFIJO=DBO.FNK_VALORVARIABLE('PREFIJOLABORATORIO') THEN 'EXAMENES'
                                            WHEN PRE.PREFIJO=DBO.FNK_VALORVARIABLE('OMCODAPOYODX') THEN 'APOYO'  ELSE '' END
                        AND TGEN.TABLA='DISTRIBUIDORES'
WHERE COALESCE(CIT.CUMPLIDA,0)=1 
AND CIT.IDAFILIADO IS NOT NULL            
AND COALESCE(CIT.FACTURADA,0)=0 
AND COALESCE(AUTD.FACTURADA,0)=0
AND COALESCE(PLN.CRONICO,0)=1
AND COALESCE(AUT.LISTOFACT,'PEND')<>'NOFACT'
AND EXISTS(SELECT * FROM HADM WHERE HADM.NOADMISION=CIT.NOADMISION)



