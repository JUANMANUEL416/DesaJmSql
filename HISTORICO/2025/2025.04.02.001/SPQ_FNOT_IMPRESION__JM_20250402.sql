CREATE OR ALTER PROCEDURE  DBO.SPQ_FNOT_IMPRESION
@JSON  NVARCHAR(MAX)
WITH ENCRYPTION
AS  
DECLARE	 @PARAMETROS  NVARCHAR(MAX)     
         ,@MODELO    VARCHAR(100)         
         ,@METODO    VARCHAR(100)	
         ,@USUARIO      VARCHAR(12)
DECLARE @EXISTE INT
DECLARE @CNSFNOT VARCHAR(20)
DECLARE @PROCEDENCIA VARCHAR(10)
DECLARE @IDSEDE VARCHAR(5)
DECLARE @VLLETRAS VARCHAR(1024)
DECLARE @NROLETRAS SMALLINT
DECLARE @IDFIRMA VARCHAR(20)
DECLARE @NOMBREFACTU VARCHAR(120)
DECLARE @USUNOTA VARCHAR(20)
DECLARE @IXCOUNTRY VARCHAR(20)
DECLARE @VLR_AFECTO DECIMAL(14,2)
DECLARE @VLR_INAFECTO DECIMAL(14,2)
DECLARE @VLR_SUBTOTAL DECIMAL(14,2)
DECLARE @VIVA DECIMAL(14,2)
DECLARE @DEMO VARCHAR(20)
BEGIN  
	SET DATEFORMAT dmy
	SELECT *
	INTO #JSON
	FROM OPENJSON (@json)
	WITH (
		MODELO         VARCHAR(100)     '$.MODELO',
		METODO         VARCHAR(100)     '$.METODO',
		USUARIO        VARCHAR(12)      '$.USUARIO',
		PARAMETROS     NVARCHAR(MAX)  AS JSON
	)
	SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
	FROM #JSON
	DECLARE @TBLERRORES TABLE(ERROR VARCHAR(200)); 
   
	   SELECT @CNSFNOT =  CNSFNOT
	   FROM OPENJSON (@PARAMETROS)
	   WITH (CNSFNOT       VARCHAR(20)    '$.CNSFNOT')
   SELECT @IXCOUNTRY = DBO.FNK_VALORVARIABLE('IXCOUNTRY')

   IF NOT EXISTS(SELECT  * FROM FNOT WHERE CNSFNOT=@CNSFNOT)
   BEGIN
      SELECT 'KO' KO,'Consecutivo de nota no encontrada' ERROR
      RETURN 
   END
   PRINT 'EMPIEZO A ARMAR EL REPORTE...' 
   SELECT @VLLETRAS=LTRIM(RTRIM(TRIM(DBO.FNK_DE_VALORES_A_LETRAS(FNOT.VR_TOTAL)))),
   @USUNOTA= COALESCE(FNOT.USUARIOAPLICA,FNOT.USUARIO)
   FROM FNOT WHERE CNSFNOT=@CNSFNOT

   SELECT @IDFIRMA=NULL
   IF DBO.FNK_VALORVARIABLE('IDUSUARIO_REPRE')<>''
   BEGIN
      SELECT @IDFIRMA=IDFIRMA,@NOMBREFACTU=NOMBRE,@USUNOTA=USUARIO 
      FROM USUSU 
      WHERE USUARIO=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDUSUARIO_REPRE')))
   END
   IF COALESCE(@IDFIRMA,'')=''
   BEGIN
      SELECT @IDFIRMA=IDFIRMA,@NOMBREFACTU=NOMBRE 
      FROM USUSU WHERE USUARIO=@USUNOTA
   END
      IF CHARINDEX('/100',@VLLETRAS,1)>0 AND @IXCOUNTRY<>'PERU'
      BEGIN 
         SELECT @NROLETRAS=LEN(@VLLETRAS)-8
         SELECT @VLLETRAS=SUBSTRING(@VLLETRAS,0,@NROLETRAS)
      END
      ELSE
      BEGIN 
         IF LEN(@VLLETRAS)<4
         BEGIN
            SELECT @VLLETRAS='Cero.'
         END
         IF  @IXCOUNTRY='PERU'
         BEGIN
            IF CHARINDEX('/100',@VLLETRAS,1)=0
            BEGIN
               SELECT @VLLETRAS=@VLLETRAS+' 00/100 '
            END
         END
      END
      IF DBO.FNK_VALORVARIABLE('BDATA_PRODUCCION')<>DB_NAME()
      BEGIN
         SELECT @DEMO='DEMO'
      END
      ELSE
      BEGIN
         SELECT @DEMO=''
      END
      IF @IXCOUNTRY='PERU'
      BEGIN

         SELECT @VLR_AFECTO=SUM(CASE WHEN COALESCE(PIVA,0)>0 THEN COALESCE(VR_TOTAL,0)-CASE WHEN COALESCE(PIVA,0)>0 THEN  VALORIVA*CANTIDAD ELSE 0 END ELSE 0 END), 
         @VLR_INAFECTO=SUM(CASE WHEN COALESCE(PIVA,0)=0 THEN COALESCE(VR_TOTAL,0) ELSE 0 END),
         @VLR_SUBTOTAL=ROUND(SUM(VR_TOTAL-CASE WHEN COALESCE(PIVA,0)>0 THEN  VALORIVA*CANTIDAD ELSE 0 END),2),
         @VIVA=ROUND(SUM(CASE WHEN COALESCE(PIVA,0)>0 THEN  VALORIVA*CANTIDAD ELSE 0 END),2)
         FROM FNOTD 
         WHERE FNOTD.CNSFNOT =@CNSFNOT

         IF COALESCE(@VLR_SUBTOTAL,0)<>(COALESCE(@VLR_AFECTO,0)+COALESCE(@VLR_INAFECTO,0))
         BEGIN
            SELECT @VLR_SUBTOTAL=(COALESCE(@VLR_AFECTO,0)+COALESCE(@VLR_INAFECTO,0))
         END
      END

      SELECT 'OK' OK,CNSFNOT,FNOT.CLASE,CONVERT(VARCHAR,F_NOTA,103)F_NOTA,LEFT(CONVERT(VARCHAR,F_NOTA,108),5)H_NOTA,N_FACTURA,
               COALESCE(DBO.FNK_RTF(OBSERVACION),'')OBSERVACION,IDCONCEPTO,CPNT.DESCRIPCION,FNOT.IDTERCERO,TER.NIT,TER.RAZONSOCIAL,
                  COALESCE(FNOT.CUDE,'')CUFE,COALESCE(DBO.FNK_QRCODE(FNOT.CNSFNOT),'')CODQR,CNSDIANFE,
                  @NOMBREFACTU AS N_FACTURADOR,@USUNOTA USUARIO,
                  CASE WHEN EXISTS(SELECT DICOM FROM ARCHIVOS WHERE ID = @IDFIRMA ) 
                     THEN  (SELECT DICOM FROM ARCHIVOS WHERE ID = @IDFIRMA)
                     ELSE '' END DICOM,dbo.FNK_VALORVARIABLE('FORMATONOTASDBCR')IDFORMATO,FNOT.ESTADO,
                     @VLLETRAS+CASE WHEN @IXCOUNTRY='PERU' THEN ' SOLES ' ELSE ' PESOS M/CTE. ' END AS VLR_LETRAS,
                     FNOT.VR_TOTAL,@VLR_AFECTO AS VLR_AFECTO,
                     @VLR_INAFECTO AS VLR_INAFECTO, @VLR_SUBTOTAL AS VLR_SUBTOTAL,@VIVA AS VIVA,@DEMO AS DEMO
      FROM FNOT LEFT JOIN CPNT ON FNOT.IDCONCEPTO=CPNT.CODIGO
                  LEFT JOIN TER ON FNOT.IDTERCERO=TER.IDTERCERO
      WHERE CNSFNOT=@CNSFNOT

   SELECT IDSERVICIO,DESCRIPCION,VR_UNITARIO,COALESCE(PIVA,0)PIVA,COALESCE(VALORIVA,0)VALORIVA,CANTIDAD,VR_TOTAL,
          VR_UNITARIO-CASE WHEN COALESCE(PIVA,0)>0 THEN COALESCE(VALORIVA,0) ELSE 0 END AS VR_UNITARIOP
   FROM FNOTD 
   WHERE CNSFNOT=@CNSFNOT
   
   IF DBO.FNK_VALORVARIABLE('FACTSEDE')='SI'
   BEGIN
      SELECT TER.RAZONSOCIAL,TER.NIT,TER.DIRECCION,TER.TELEFONOS,CIU.NOMBRE CIUDAD,TER.EMAIL,SED.CODHABILITA
      FROM SED INNER JOIN TER ON SED.NIT=TER.NIT
                 INNER JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
      WHERE IDSEDE=@IDSEDE
   END
   ELSE
   BEGIN
      SELECT 'SIN SEDE'
   END
   RETURN
END


