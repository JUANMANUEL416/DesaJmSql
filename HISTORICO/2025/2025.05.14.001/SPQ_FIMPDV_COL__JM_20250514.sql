CREATE OR ALTER PROCEDURE DBO.SPQ_FIMPDV_COL
@JSON  NVARCHAR(MAX)
WITH
ENCRYPTION
AS
DECLARE @PARAMETROS    NVARCHAR(MAX)  ,@MODELO           VARCHAR(100)    ,@METODO        VARCHAR(100)  ,@USUARIO        VARCHAR(12)
       ,@GRUPO         VARCHAR(8)     ,@SYS_COMPUTERNAME VARCHAR(254)    ,@SEDE          VARCHAR(5)	 ,@A              INT
       ,@IDENTITY      INT 
       ,@PROCESO       VARCHAR(20)    ,@FIMPDV           NVARCHAR(MAX)
       ,@IDIMPUESTO    VARCHAR(10)
       ,@IDCLASE       VARCHAR(10)
       ,@ITEM          SMALLINT
       ,@VALOR         DECIMAL(9,5)
       ,@FECHAINI      DATETIME
       ,@FECHAINI_STR  VARCHAR(10)
       ,@FECHAFIN      DATETIME
       ,@FECHAFIN_STR  VARCHAR(10)
       ,@VALOR_INICIAL DECIMAL(14,2)
       ,@VALOR_FINAL   DECIMAL(14,2)
       ,@CUENTA        VARCHAR(16)
       ,@CUENTA_ASUM   VARCHAR(16)
       ,@MUVT          BIT
       ,@VLRUTV        DECIMAL(14,2)
       ,@ID            INT
BEGIN
   SET LANGUAGE Spanish
   SET DATEFORMAT dmy
   
   SELECT @A = ISJSON(@JSON)
   IF @A = 0
   BEGIN
     RAISERROR('Json: Formato Erroneo',16,1)
     RETURN
   END
   PRINT 'INGRESE A SPQ_FIMPDV_COL'
   SELECT *
   INTO #JSON
   FROM OPENJSON (@json)
   WITH (
     MODELO         VARCHAR(100)     '$.MODELO',
     METODO         VARCHAR(100)     '$.METODO',
     USUARIO        VARCHAR(12)      '$.USUARIO',
     PARAMETROS     NVARCHAR(MAX)     AS JSON
   )
   
   SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS , @USUARIO = USUARIO
   FROM #JSON
   --DEFINICION DE TABLA DE ERRORES
   DECLARE @TBLERRORES TABLE(ERROR VARCHAR(200))
   -- TOMA DEL GRUPO, SYS_COMPUTERNAME, SEDE   DE ACUERDO AL USUARIO
   PRINT 'USUARIO:'+@USUARIO
   --SELECT @GRUPO = DBO.FNK_DESCIFRAR(GRUPO) FROM USUSU WHERE USUARIO = @USUARIO
   --SELECT @SYS_COMPUTERNAME = SYS_COMPUTERNAME FROM USUSU WHERE USUARIO = @USUARIO
   --SELECT @SEDE = IDSEDE FROM UBEQ WHERE SYS_ComputerName = @SYS_COMPUTERNAME
   IF COALESCE(@SEDE,'') = '' SELECT @SEDE = '01'
   PRINT 'SEDE='+@SEDE
   IF @METODO = 'CRUDFIMPDV'
   BEGIN
      PRINT 'CRUDFIMPDV'
      SELECT @FIMPDV  = REGISTRO
      FROM OPENJSON (@PARAMETROS)
      WITH(
         REGISTRO   NVARCHAR(MAX)     AS JSON
      )
      SELECT @PROCESO     = JSON_VALUE(@FIMPDV ,'$.PROCESO')
      print '@PROCESO=' +@PROCESO
      --Leo Campos enviados y los coloco en las variables respectivas
      SELECT @IDIMPUESTO = JSON_VALUE(@FIMPDV , '$.IDIMPUESTO' )
      SELECT @IDCLASE = JSON_VALUE(@FIMPDV , '$.IDCLASE' )
      SELECT @ITEM = JSON_VALUE(@FIMPDV , '$.ITEM' )
      SELECT @VALOR = JSON_VALUE(@FIMPDV , '$.VALOR' )
      SELECT @FECHAINI_STR = JSON_VALUE(@FIMPDV , '$.FECHAINI')
      SELECT @FECHAINI = CONVERT(DATE, SUBSTRING(@FECHAINI_STR,9,2)+'/'+SUBSTRING(@FECHAINI_STR,6,2)+'/'+SUBSTRING(@FECHAINI_STR,1,4))
      SELECT @FECHAFIN_STR = JSON_VALUE(@FIMPDV , '$.FECHAFIN')
      SELECT @FECHAFIN = CONVERT(DATE, SUBSTRING(@FECHAFIN_STR,9,2)+'/'+SUBSTRING(@FECHAFIN_STR,6,2)+'/'+SUBSTRING(@FECHAFIN_STR,1,4))
      SELECT @VALOR_INICIAL = JSON_VALUE(@FIMPDV , '$.VALOR_INICIAL' )
      SELECT @VALOR_FINAL = JSON_VALUE(@FIMPDV , '$.VALOR_FINAL' )
      SELECT @CUENTA = JSON_VALUE(@FIMPDV , '$.CUENTA' )
      SELECT @CUENTA_ASUM = JSON_VALUE(@FIMPDV , '$.CUENTA_ASUM' )
      SELECT @MUVT = JSON_VALUE(@FIMPDV , '$.MUVT' )
      SELECT @VLRUTV = coalesce(JSON_VALUE(@FIMPDV , '$.VLRUTV' ),0)
      SELECT @ID = JSON_VALUE(@FIMPDV , '$.ID' )
      
      --return


      IF UPPER(@PROCESO) = 'INSERTAR'
      BEGIN
         DECLARE @ITEMNVO INT
         PRINT 'INSERTAR'
         SELECT @ITEMNVO = COALESCE(MAX(ITEM),0) + 1 FROM FIMPDV WHERE IDIMPUESTO = @IDIMPUESTO AND IDCLASE = @IDCLASE
         
         BEGIN TRY
            INSERT INTO FIMPDV(IDIMPUESTO,IDCLASE,ITEM,VALOR,FECHAINI,FECHAFIN,VALOR_INICIAL,
                             VALOR_FINAL,CUENTA,CUENTA_ASUM,MUVT,VLRUTV)
            SELECT @IDIMPUESTO,@IDCLASE,@ITEMNVO,@VALOR,@FECHAINI,@FECHAFIN,@VALOR_INICIAL,
                             @VALOR_FINAL,@CUENTA,@CUENTA_ASUM,@MUVT,@VLRUTV
            SELECT @IDENTITY = SCOPE_IDENTITY()
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK ,STR(@IDENTITY) CNS 
         RETURN
      END
      IF UPPER(@PROCESO) = 'EDITAR'
      BEGIN
         BEGIN TRY
            UPDATE FIMPDV SET
                    IDIMPUESTO = @IDIMPUESTO,IDCLASE = @IDCLASE,ITEM = @ITEM,VALOR = @VALOR,FECHAINI = @FECHAINI,FECHAFIN = @FECHAFIN,VALOR_INICIAL = @VALOR_INICIAL,
                             VALOR_FINAL = @VALOR_FINAL,CUENTA = @CUENTA,CUENTA_ASUM = @CUENTA_ASUM,MUVT = @MUVT,VLRUTV = @VLRUTV
            WHERE ID = @ID
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
         RETURN
      END
      RETURN
   END
END


