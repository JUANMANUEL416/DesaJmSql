IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_FTRNDCR' AND TYPE='V')
BEGIN
DROP VIEW VWK_FTRNDCR
END
GO
CREATE VIEW VWK_FTRNDCR
AS
SELECT FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.IDTERCERO,TER.NIT,TER.RAZONSOCIAL,
FTR.VR_TOTAL,CASE WHEN VK.CNSCXC IS NULL THEN 'SinCXC' ELSE 'EnCXC'END ESTADO,COALESCE(VK.CNSCXC,'')CNSCXC,
COALESCE(VK.SALDONETO,0)SALDO
FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
         INNER JOIN VWK_CXCDIASVTO VK ON FTR.N_FACTURA=VK.N_FACTURA 
WHERE FTR.ESTADO='P'
AND COALESCE(FTR.TIPOANULACION,'')<>'NC'
AND COALESCE(VK.CLASEINFO,'')='SINGLO'
AND VK.TIPO='F'
AND 1=CASE WHEN COALESCE(VK.CNSCXC,'NO RADICADA')='NO RADICADA' THEN CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU' 
           THEN CASE WHEN  COALESCE(FTR.FACTEP,'') IN('101','102') THEN 1 ELSE 0 END WHEN COALESCE(FTR.FACTE,0)<>2 THEN 0 ELSE 1 END ELSE 1 END



