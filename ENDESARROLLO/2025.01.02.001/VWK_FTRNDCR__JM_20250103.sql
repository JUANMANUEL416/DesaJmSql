IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_FTRNDCR' AND TYPE='V')
BEGIN
DROP VIEW VWK_FTRNDCR
END
GO
CREATE VIEW VWK_FTRNDCR
AS
SELECT FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.IDTERCERO,TER.NIT,TER.RAZONSOCIAL,
FTR.VR_TOTAL,CASE WHEN FCXCD.CNSCXC IS NULL THEN 'SinCXC' ELSE 'EnCXC'END ESTADO,COALESCE(FCXCD.CNSCXC,'')CNSCXC,
COALESCE(VK.SALDONETO,COALESCE(FCXCD.SALDONETO,FTR.VR_TOTAL))SALDO
FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
         LEFT JOIN FCXCD ON FTR.N_FACTURA=FCXCD.N_FACTURA
         LEFT JOIN VWK_CXCDIASVTO VK ON FTR.N_FACTURA=VK.N_FACTURA AND COALESCE(FCXCD.CNSCXC,'NO RADICADA')=VK.CNSCXC
WHERE FTR.ESTADO='P'
AND COALESCE(FTR.TIPOANULACION,'')<>'NC'
AND VK.CLASEINFO='SINGLO'
AND VK.TIPO='F'
AND 1=CASE WHEN FCXCD.CNSCXC IS NULL THEN CASE WHEN COALESCE(FTR.FACTE,0)<>2 THEN 0 ELSE 1 END ELSE 1 END



