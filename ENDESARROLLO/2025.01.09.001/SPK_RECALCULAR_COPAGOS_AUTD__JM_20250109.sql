CREATE OR ALTER PROCEDURE DBO.SPK_RECALCULAR_COPAGOS_AUTD
	@IDAUT VARCHAR(20)
WITH ENCRYPTION
AS
DECLARE @NO_ITEM INT
DECLARE @PRECIO_TOTAL DECIMAL(14,9)
DECLARE @PORCENTAJE_PRORRATEO DECIMAL(14,9)
DECLARE @VALOR_ITEM DECIMAL(14,9)
DECLARE @COPAGO_FIJO DECIMAL(14,9)

DECLARE @COBERTURA_ASEGURADORA DECIMAL(14,9)
DECLARE @COBERTURA_PACIENTE DECIMAL(14,9)

DECLARE @COPAGO_VARIABLE DECIMAL(14,9)
DECLARE @VALOR_COPAGO DECIMAL(14,9) = 0
DECLARE @VALOR_EXCEDENTE DECIMAL(14,9)=0
DECLARE @TOTAL_COPAGO DECIMAL(14,9)=0

DECLARE @VLR_COPAGOVAR DECIMAL(14,9)=0
DECLARE @VLR_PRCOPAGOVAR DECIMAL(14,9)=0
DECLARE @IDSERMOVILIDAD VARCHAR(20) = DBO.FNK_VALORVARIABLE('IDSERMOVILIDAD') 
BEGIN
	
	UPDATE AUTD
	SET VALORCOPAGO = 0, VALOREXCEDENTE = 0
	WHERE IDAUT=@IDAUT 
	AND COALESCE(GENERADO, 0)<>1

	SELECT @PRECIO_TOTAL = SUM(AUTD.VALOR)
	FROM AUTD 
	WHERE IDAUT=@IDAUT
	AND COALESCE(GENERADO, 0)=1

	PRINT @PRECIO_TOTAL

	DECLARE _cursor CURSOR FOR   
	    SELECT NO_ITEM FROM AUTD WHERE IDAUT=@IDAUT AND COALESCE(GENERADO, 0)=1 AND IDSERVICIO <> @IDSERMOVILIDAD
	  
	OPEN _cursor  
	FETCH NEXT FROM _cursor INTO @NO_ITEM
	  
	WHILE @@FETCH_STATUS = 0  
	BEGIN  

		SELECT @COBERTURA_PACIENTE = 0
			,@TOTAL_COPAGO = 0
			,@VALOR_COPAGO = 0
			,@VALOR_EXCEDENTE = 0


		SELECT @VALOR_ITEM = VALOR 
			,@COPAGO_FIJO = COALESCE(COPAGO_FIJO, 0)
			,@COBERTURA_ASEGURADORA = COALESCE(COPAGO_VARIABLE, 0)
		FROM AUTD WHERE IDAUT=@IDAUT AND NO_ITEM=@NO_ITEM

		SELECT @COBERTURA_PACIENTE = 100 - @COBERTURA_ASEGURADORA
		IF @COBERTURA_PACIENTE < 0
      BEGIN
         FETCH NEXT FROM _cursor INTO @NO_ITEM
         CONTINUE
      END
		SELECT @PORCENTAJE_PRORRATEO = @COPAGO_FIJO * 100 / @PRECIO_TOTAL

		PRINT '@VALOR_ITEM: ' + CAST(@VALOR_ITEM AS VARCHAR(20))
		PRINT '@COPAGO_FIJO: ' + CAST(@COPAGO_FIJO AS VARCHAR(20))
		-- PRINT '@COPAGO_VARIABLE: ' + CAST(@COPAGO_VARIABLE AS VARCHAR(20))

		-- Calculo del Copago Fijo
		IF @PORCENTAJE_PRORRATEO > 0
		BEGIN
			PRINT '@PORCENTAJE_PRORRATEO: ' + CAST(@PORCENTAJE_PRORRATEO AS VARCHAR(20))
			SELECT @COPAGO_FIJO = @VALOR_ITEM * @PORCENTAJE_PRORRATEO / 100
				,@VALOR_EXCEDENTE = @VALOR_ITEM - @VALOR_COPAGO
			
			IF @VALOR_EXCEDENTE < 0
			BEGIN
				SELECT @COPAGO_FIJO = @VALOR_ITEM
					,@VALOR_EXCEDENTE = 0
			END
		END
	  
		-- Calculo del Copago Variable
	  	IF @COBERTURA_PACIENTE > 0 
		BEGIN
			PRINT '@COBERTURA_PACIENTE: ' + CAST(@COBERTURA_PACIENTE AS VARCHAR(20))
			SELECT @VALOR_COPAGO =  (@VALOR_ITEM-@COPAGO_FIJO) * @COBERTURA_PACIENTE / 100
				,@VALOR_EXCEDENTE = (@VALOR_ITEM-@COPAGO_FIJO) * (100 - @COBERTURA_PACIENTE) / 100

			IF @VALOR_EXCEDENTE < 0
			BEGIN
				SELECT @VALOR_COPAGO = @VALOR_ITEM - @COPAGO_FIJO
					,@VALOR_EXCEDENTE = 0
			END

			SELECT @TOTAL_COPAGO = @COPAGO_FIJO + @VALOR_COPAGO
		END
		ELSE
         PRINT '@COPAGO_FIJO ='+STR(COALESCE(@COPAGO_FIJO,0))
			IF @COPAGO_FIJO > 0
			BEGIN
				IF @COPAGO_FIJO >= @VALOR_ITEM
				BEGIN
					SELECT @TOTAL_COPAGO = @VALOR_ITEM
						,@VALOR_COPAGO = @VALOR_ITEM
						,@VALOR_EXCEDENTE = 0
				END
				ELSE
				BEGIN
					SELECT @TOTAL_COPAGO = @COPAGO_FIJO
						,@VALOR_COPAGO = @COPAGO_FIJO
						,@VALOR_EXCEDENTE = @VALOR_ITEM- @COPAGO_FIJO
					
				END


			END
         ELSE
         BEGIN
			   PRINT '@COBERTURA_PACIENTE: ' + CAST(@COBERTURA_PACIENTE AS VARCHAR(20))
			   SELECT @VALOR_COPAGO =  (@VALOR_ITEM-@COPAGO_FIJO) * @COBERTURA_PACIENTE / 100
				   ,@VALOR_EXCEDENTE = (@VALOR_ITEM-@COPAGO_FIJO) * (100 - @COBERTURA_PACIENTE) / 100

			   IF @VALOR_EXCEDENTE < 0
			   BEGIN
				   SELECT @VALOR_COPAGO = @VALOR_ITEM - @COPAGO_FIJO
					   ,@VALOR_EXCEDENTE = 0
			   END

			   SELECT @TOTAL_COPAGO = @COPAGO_FIJO + @VALOR_COPAGO            
         END
      
		PRINT '@COPAGO_FIJO: ' + CAST(@COPAGO_FIJO AS VARCHAR(20))
		PRINT '@TOTAL_COPAGO: ' + CAST(@TOTAL_COPAGO AS VARCHAR(20))
		PRINT '@VALOR_EXCEDENTE: ' + CAST(@VALOR_EXCEDENTE AS VARCHAR(20))

		UPDATE AUTD
		SET VALORCOPAGO = @TOTAL_COPAGO
			,VALOREXCEDENTE = @VALOR_EXCEDENTE
		WHERE IDAUT=@IDAUT AND NO_ITEM=@NO_ITEM


	    FETCH NEXT FROM _cursor INTO @NO_ITEM
	    END  
	  
	CLOSE _cursor  
	DEALLOCATE _cursor  


	IF EXISTS(SELECT 1 FROM AUTD WHERE IDAUT=@IDAUT AND IDSERVICIO = @IDSERMOVILIDAD)
	BEGIN
		PRINT 'ES MOVILDIAD'
		IF EXISTS(SELECT * FROM AUTD WHERE IDAUT=@IDAUT AND COALESCE(GENERADO,0)=1 AND IDSERVICIO = @IDSERMOVILIDAD)
		BEGIN
			SELECT @VLR_COPAGOVAR =PPTMOVI.COPAVAR
				,@VLR_PRCOPAGOVAR=PRCOPAVAR
			FROM AUT 
				INNER JOIN AFI 		ON AUT.IDAFILIADO=AFI.IDAFILIADO
				INNER JOIN PPTMOVI 	ON PPTMOVI.IDTERCERO=AUT.IDTERCEROCA 
									AND PPTMOVI.IDPLAN=AUT.IDPLAN 
									AND AFI.CIUDAD=PPTMOVI.CIUDAD 
									AND AFI.CORREGIMIENTO=PPTMOVI.DISTRITO
			WHERE AUT.IDAUT=@IDAUT
         PRINT '@VLR_COPAGOVAR='+STR(@VLR_COPAGOVAR)
         PRINT '@VLR_PRCOPAGOVAR='+STR(@VLR_PRCOPAGOVAR)
			--VALOREXCEDENTE
			IF EXISTS(SELECT * FROM AUTD WHERE IDAUT=@IDAUT AND COALESCE(PROTOCOLO,0)=1 AND COALESCE(GENERADO,0)=1)
			BEGIN
				PRINT '11111'
				UPDATE AUTD SET COPAGO_VARIABLE=@VLR_PRCOPAGOVAR,VALORCOPAGO=CASE WHEN COALESCE(@VLR_PRCOPAGOVAR,0)>0 THEN (VALOR*CANTIDAD)*(((100-@VLR_PRCOPAGOVAR)/100)) ELSE 0 END FROM AUTD WHERE IDAUT=@IDAUT AND IDSERVICIO=@IDSERMOVILIDAD
				-- UPDATE AUTD SET COPAGO_VARIABLE=@VLR_PRCOPAGOVAR FROM AUTD WHERE IDAUT=@IDAUT AND IDSERVICIO = @IDSERMOVILIDAD
			END
			ELSE
			BEGIN
				PRINT '2222'
				UPDATE AUTD SET COPAGO_VARIABLE=@VLR_COPAGOVAR
					,VALORCOPAGO = IIF(COALESCE(@VLR_COPAGOVAR,0)>0, (VALOR*CANTIDAD)*(((100-@VLR_COPAGOVAR)/100)), VALOR*CANTIDAD) 
				FROM AUTD 
				WHERE IDAUT=@IDAUT 
				AND IDSERVICIO = @IDSERMOVILIDAD
			END
			UPDATE AUTD
			SET VALOREXCEDENTE = (VALOR*CANTIDAD) - (COALESCE(VALORCOPAGO,0))
			WHERE IDAUT=@IDAUT AND IDSERVICIO=@IDSERMOVILIDAD
		END
		ELSE
		BEGIN
			UPDATE AUTD SET COPAGO_VARIABLE=0,VALORCOPAGO=0 FROM AUTD WHERE IDAUT=@IDAUT AND IDSERVICIO = @IDSERMOVILIDAD
		END
	END

	SELECT @VALOR_COPAGO = SUM(COALESCE(VALORCOPAGO,0))
		,@VALOR_EXCEDENTE = SUM(COALESCE(VALOREXCEDENTE,0))
	FROM AUTD WHERE IDAUT=@IDAUT
	AND COALESCE(GENERADO, 0)=1

	UPDATE AUT
	SET VALORCOPAGO = @VALOR_COPAGO
		,VALOREXEDENTE = @VALOR_EXCEDENTE
	WHERE IDAUT=@IDAUT

END




