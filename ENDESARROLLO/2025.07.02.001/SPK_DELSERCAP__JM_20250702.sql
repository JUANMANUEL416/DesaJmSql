IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_DELSERCAP' AND XTYPE='P')
BEGIN
   DROP PROC SPK_DELSERCAP
END
GO
CREATE PROCEDURE DBO.SPK_DELSERCAP  
@CNSFTR      VARCHAR(20),  
@N_CUOTA     INT,  
@IDTERCERO   VARCHAR(20),  
@IDPLAN      VARCHAR(6),  
@FECHAINI    DATETIME,  
@FECHAFIN    DATETIME,  
@PROCEDENCIA VARCHAR(4),
@NOADMISION VARCHAR(20)=NULL,  
@IDSEDE     VARCHAR(6) = NULL
WITH ENCRYPTION
AS  
DECLARE @N_FACTURA VARCHAR(20)    
BEGIN    
   SELECT @N_FACTURA = N_FACTURA FROM FTR WHERE CNSFCT=@CNSFTR    
   IF DBO.FNK_VALORVARIABLE('PMODIFICAR_RELA_PGP')<>'SI'
   BEGIN
      IF @PROCEDENCIA='TODA' OR @PROCEDENCIA='HADM'    
      BEGIN    
         PRINT 'Asignando No. de Factura a las Prestaciones...'    
         UPDATE HPRED SET FACTURADA=0, N_FACTURA=''    
         FROM HPRED INNER JOIN FTRDC A ON HPRED.NOPRESTACION=A.NOPRESTACION AND HPRED.NOITEM=A.NOITEM    
         WHERE A.FECHA>=@FECHAINI 
         AND A.FECHA<@FECHAFIN+1 
         AND A.CNSFTR=@CNSFTR 
         AND A.PROCEDENCIA = 'HADM'    
         AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END

         DELETE FTRDC    
         WHERE FECHA>=@FECHAINI 
         AND FECHA<@FECHAFIN+1 
         AND CNSFTR=@CNSFTR
         AND PROCEDENCIA = 'HADM' 
         AND IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN IDSEDE ELSE @IDSEDE END

         
         DELETE HADMF WHERE N_FACTURA=@N_FACTURA AND CNSFCT=@CNSFTR

      END    
      IF @PROCEDENCIA='TODA' OR @PROCEDENCIA='AUT'     
      BEGIN     
         PRINT 'Asignando No. de Factura a las Autorizaciones...'    
         UPDATE AUTD SET FACTURADA=0, N_FACTURA=''      
         FROM AUTD INNER JOIN FTRDC A ON AUTD.IDAUT=A.NOPRESTACION AND AUTD.NO_ITEM=A.NOITEM    
         WHERE A.FECHA>=@FECHAINI 
         AND A.FECHA<@FECHAFIN+1 
         AND A.CNSFTR=@CNSFTR 
         AND A.PROCEDENCIA = 'AUT'  
         AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END
         
         UPDATE AUT SET FACTURADA=0, N_FACTURA=''      
         FROM AUT INNER JOIN FTRDC A ON AUT.IDAUT=A.NOPRESTACION  
         WHERE A.FECHA>=@FECHAINI 
         AND A.FECHA<@FECHAFIN+1 
         AND A.CNSFTR=@CNSFTR 
         AND A.PROCEDENCIA = 'AUT' 
         AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END
         
         DELETE FTRDC    
         WHERE FECHA>=@FECHAINI 
         AND FECHA<@FECHAFIN+1 
         AND CNSFTR=@CNSFTR 
         AND PROCEDENCIA = 'AUT' 
         AND IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN IDSEDE ELSE @IDSEDE END
         
      END    
      IF @PROCEDENCIA='TODA' OR @PROCEDENCIA='CIT'    
      BEGIN    
         PRINT 'Asignando No. de Factura a las Citas...'    
         UPDATE CIT SET FACTURADA=0, N_FACTURA=''    
         FROM CIT INNER JOIN FTRDC A ON CIT.CONSECUTIVO=A.NOPRESTACION     
         WHERE A.FECHA>=@FECHAINI 
         AND A.FECHA<@FECHAFIN+1 
         AND A.CNSFTR=@CNSFTR 
         AND A.PROCEDENCIA = 'CIT' 
         AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END

         
         DELETE FTRDC    
         WHERE FECHA>=@FECHAINI 
         AND FECHA<@FECHAFIN+1 
         AND CNSFTR=@CNSFTR 
         AND PROCEDENCIA = 'CIT'  
         AND IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN IDSEDE ELSE @IDSEDE END
         
      END    
      IF @PROCEDENCIA='TODA' OR @PROCEDENCIA='ONCO'    
      BEGIN    
         PRINT 'Asignando No. de Factura a las Citas...'    
         UPDATE HCATDIMOV SET FACTURADA=0, N_FACTURA=''    
         FROM HCATDIMOV INNER JOIN FTRDC A ON CONSECUTIVOCIT=A.NOADMISION     
         WHERE A.FECHA>=@FECHAINI 
         AND A.FECHA<@FECHAFIN+1 
         AND A.CNSFTR=@CNSFTR 
         AND A.PROCEDENCIA = 'ONCO' 
         AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END

         UPDATE CIT SET FACTURADA=0, N_FACTURA=''    
         FROM CIT INNER JOIN FTRDC A ON CIT.CONSECUTIVO=A.NOPRESTACION     
         WHERE A.FECHA>=@FECHAINI 
         AND A.FECHA<@FECHAFIN+1 
         AND A.CNSFTR=@CNSFTR 
         AND A.PROCEDENCIA = 'ONCO' 
         AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END

         
         DELETE FTRDC    
         WHERE FECHA>=@FECHAINI 
         AND FECHA<@FECHAFIN+1 
         AND CNSFTR=@CNSFTR 
         AND PROCEDENCIA = 'ONCO'   
         AND IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN IDSEDE ELSE @IDSEDE END
         
      END  
   END
   ELSE
   BEGIN
      PRINT 'Asignando No. de Factura a las Prestaciones...'    
      UPDATE HPRED SET FACTURADA=0, N_FACTURA=''    
      FROM HPRED INNER JOIN FTRDC A ON HPRED.NOPRESTACION=A.NOPRESTACION AND HPRED.NOITEM=A.NOITEM    
      WHERE A.CNSFTR=@CNSFTR 
      AND A.N_CUOTA=@N_CUOTA
      AND A.PROCEDENCIA = 'HADM'  
      AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END
      
      DELETE HADMF WHERE N_FACTURA=@N_FACTURA AND CNSFCT=@CNSFTR

      PRINT 'Asignando No. de Factura a las Autorizaciones...'    
      UPDATE AUTD SET FACTURADA=0, N_FACTURA=''      
      FROM AUTD INNER JOIN FTRDC A ON AUTD.IDAUT=A.NOPRESTACION AND AUTD.NO_ITEM=A.NOITEM    
      WHERE A.CNSFTR=@CNSFTR 
      AND A.N_CUOTA=@N_CUOTA
      AND A.PROCEDENCIA = 'AUT'  
      AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END
      
      
      UPDATE AUT SET FACTURADA=0, N_FACTURA=''      
      FROM AUT INNER JOIN FTRDC A ON AUT.IDAUT=A.NOPRESTACION  
      WHERE A.CNSFTR=@CNSFTR 
      AND A.N_CUOTA=@N_CUOTA
      AND A.PROCEDENCIA = 'AUT'
      AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END
      
         
      UPDATE CIT SET FACTURADA=0, N_FACTURA=''    
      FROM CIT INNER JOIN FTRDC A ON CIT.CONSECUTIVO=A.NOPRESTACION     
      WHERE A.CNSFTR=@CNSFTR 
      AND A.N_CUOTA=@N_CUOTA
      AND A.PROCEDENCIA = 'CIT'  
      AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END
         
      UPDATE HCATDIMOV SET FACTURADA=0,N_FACTURA=''
      FROM HCATDIMOV INNER JOIN FTRDC A ON CONSECUTIVOCIT=A.NOPRESTACION     
      WHERE A.CNSFTR=@CNSFTR 
      AND A.N_CUOTA=@N_CUOTA
      AND A.PROCEDENCIA = 'ONCO' 
      AND A.IDSEDE =CASE WHEN COALESCE(@IDSEDE,'')='' THEN A.IDSEDE ELSE @IDSEDE END

      DELETE FTRDC    
      WHERE  CNSFTR=@CNSFTR
      AND N_CUOTA=@N_CUOTA       

   END
   UPDATE FTR SET  CP_VLR_SERVICIOS = COALESCE(V.VALORTOTAL,0), CP_VLR_COPAGOS = COALESCE(V.VALORCOPAGO,0), VALORCOPAGO   = COALESCE(V.VALORCOPAGO,0)
   FROM FTR LEFT JOIN (SELECT CNSFTR, SUM(VALORTOTAL) VALORTOTAL, SUM(VLR_COPAGO) VALORCOPAGO    
						FROM FTRDC WHERE CNSFTR = @CNSFTR
						GROUP BY CNSFTR) V   ON V.CNSFTR=FTR.CNSFCT
   WHERE CNSFCT = @CNSFTR    

    UPDATE FTRD SET VLR_COPAGOS = COALESCE(V.VALORCOPAGO,0)
     FROM (SELECT VALORCOPAGO = SUM( VLR_COPAGO) FROM FTRDC WHERE CNSFTR = @CNSFTR ) V  
    WHERE CNSFTR = @CNSFTR  
	
    UPDATE FTR SET VR_TOTAL = V.VR_TOTAL 
    FROM (SELECT VR_TOTAL= SUM(VALOR*CANTIDAD)-SUM( VLR_COPAGOS) FROM FTRD WHERE CNSFTR = @CNSFTR  )V 
    WHERE CNSFCT = @CNSFTR  
END


