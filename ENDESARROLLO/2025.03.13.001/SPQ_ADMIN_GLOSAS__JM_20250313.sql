CREATE OR ALTER PROCEDURE DBO.SPQ_ADMIN_GLOSAS @JSON NVARCHAR(MAX)
	WITH ENCRYPTION
AS
SET DATEFORMAT dmy
DECLARE @TBLERRORES TABLE (ERROR VARCHAR(MAX))
DECLARE  @PARAMETROS NVARCHAR(MAX)			,@MODELO VARCHAR(100)			   ,@METODO VARCHAR(100)
		,@USUARIO VARCHAR(12)				   ,@COMPANIA VARCHAR(2)		      ,@IDSEDE      VARCHAR(5)		
      ,@SYS_COMPUTERNAME VARCHAR(200)     ,@DATOS    VARCHAR(MAX)
DECLARE @CNSENTREGA VARCHAR(20)           ,@PROCESO  VARCHAR(20)           ,@REQSEDE BIT
        ,@DEP_RECIBE VARCHAR(20)          ,@IDSEDEF  VARCHAR(5)            ,@N_FACTURA VARCHAR(20)
        ,@F_INICIAL DATE                  ,@F_FINAL  DATE                  ,@IDTERCERO VARCHAR(20)
        ,@PROCEDENCIA VARCHAR(20)         ,@IDPLAN      VARCHAR(20)
        ,@MSEDE BIT                       ,@CNSCXC VARCHAR(20)             ,@OBSERVACION VARCHAR(2048)
        ,@COORFACTURACION VARCHAR(20)     ,@COORCARTERA VARCHAR(20)        ,@CNSENTREGAORI VARCHAR(20)
        ,@NODOCUMENTO VARCHAR(20)         ,@USUFACTU VARCHAR(20)
BEGIN
	SELECT *
	INTO #JSON
	FROM OPENJSON(@json) WITH (
			MODELO VARCHAR(100) '$.MODELO'
			,METODO VARCHAR(100) '$.METODO'
			,USUARIO VARCHAR(12) '$.USUARIO'
			,PARAMETROS NVARCHAR(MAX) AS JSON
	)

	SELECT   @MODELO = MODELO			,@METODO = METODO
			,@PARAMETROS = PARAMETROS	,@USUARIO = USUARIO
	FROM #JSON
   IF @METODO='CRUD_ENVIOGLO'     
    BEGIN 
      SELECT @DATOS=DATOS
      FROM   OPENJSON (@PARAMETROS)
      WITH (
         DATOS NVARCHAR(MAX) AS JSON
      ) 
   
      SELECT @CNSENTREGA=COALESCE(CNSENTREGA,''),@PROCESO=PROCESO,@REQSEDE=REQSEDE,@IDSEDEF=IDSEDEF,
      @DEP_RECIBE=DEP_RECIBE
      FROM   OPENJSON (@DATOS)
      WITH   (
      CNSENTREGA VARCHAR(20)  '$.CNSENTREGA',
      PROCESO    VARCHAR(20)  '$.PROCESO',
      REQSEDE    BIT          '$.REQSEDE',
      IDSEDEF    VARCHAR(6)   '$.IDSEDE',
      DEP_RECIBE  VARCHAR(20) '$.DEP_RECIBE'
      )
      PRINT 'Valido si es Crear o Editar'
      IF COALESCE(@CNSENTREGA,'')=''
      BEGIN
         PRINT 'Empiezo a revisar datos y capturar los nuevos @USUARIO='+COALESCE(@USUARIO,'SIN USUARIO')
         SELECT @SYS_COMPUTERNAME=COALESCE(SYS_ComputerName,HOST_NAME()) FROM USUSU WHERE USUARIO=@USUARIO

         IF COALESCE(@IDSEDEF,'')=''
         BEGIN
            PRINT 'busco la sede del usuario'
            SELECT @IDSEDEF=IDSEDE FROM UBEQ WHERE SYS_ComputerName=@SYS_COMPUTERNAME
         END
         IF COALESCE(@IDSEDEF,'')=''
         BEGIN
            SELECT @IDSEDEF= IDSEDE FROM USUSU WHERE USUARIO=@USUARIO
         END
         SELECT @IDSEDE=@IDSEDEF,@COMPANIA='01'
         IF NOT EXISTS(SELECT * FROM ENT WHERE USUARIO=@USUARIO AND ESTADO=0 AND PROCESO=@PROCESO AND COALESCE(CERRADO,0)=0 AND IDSEDE=@IDSEDE )
         BEGIN
            BEGIN TRY 
		         PRINT 'AQUI LLAMO A GENCONSECUTIVO @IDSEDE='+COALESCE(@IDSEDE,'SIN SEDE')   
               SELECT @CNSENTREGA=''
		         EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE, '@ENT', @CNSENTREGA OUTPUT  
		         SELECT @CNSENTREGA = @IDSEDE + REPLACE(SPACE(8 - LEN(@CNSENTREGA))+LTRIM(RTRIM(@CNSENTREGA)),SPACE(1),0)
		         PRINT '@CNSFTR='+COALESCE(@CNSENTREGA,'')

               INSERT INTO ENT(CNSENTREGA, PROCESO, USUARIOENTREGA, FECHAENTREGA, USUARIORECIBE, USUARIO, COMPANIA, ESTADO, ENT_ENTREGA, ENT_RECIBE, 
               FECHARECIBE, IDSEDE, CERRADO, IDTERCERO, IDPLAN, MSEDE)
               SELECT @CNSENTREGA, @PROCESO, @USUARIO, DBO.FNK_GETDATE(), NULL, @USUARIO, '01', 0,DBO.FNK_VALORVARIABLE('IDFDEPCARTERA'),@DEP_RECIBE,
               NULL, @IDSEDE, NULL, NULL, NULL, @REQSEDE
            END TRY
            BEGIN CATCH
               INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
            END CATCH         
         END
         ELSE
         BEGIN
            SELECT 'KO' KO,'Existe una Entrega Abierta Para Dependencia de Destino Creada por el Usuario:'+@USUARIO+' Es Necesario Cerrar La Anterior Entrega' AS ERROR
            RETURN
         END
      END
      ELSE
      BEGIN
         UPDATE ENT SET USUARIOENTREGA=@USUARIO,IDSEDE=CASE WHEN COALESCE(@IDSEDEF,'')<>'' THEN @IDSEDEF ELSE IDSEDE END
         WHERE CNSENTREGA=@CNSENTREGA
      END
   
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      SELECT 'OK' OK,@CNSENTREGA AS CNSENTREGA
      RETURN 
   END
END