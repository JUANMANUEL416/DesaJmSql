CREATE OR ALTER PROCEDURE DBO.SPK_XML_MOVIN
@CNSMOV  VARCHAR(20)
WITH ENCRYPTION
AS 
DECLARE 
 @XML VARCHAR(MAX)             ,@XMLD VARCHAR(MAX)                ,@ID_TRX VARCHAR(20)          ,@COD_ORG_VTA VARCHAR(20)    
,@COD_CANAL VARCHAR(2)         ,@COD_SECTOR VARCHAR(2)            ,@COD_GRP_VEN VARCHAR(3)      ,@COD_OFI_VTA VARCHAR(10)    
,@COD_ESPEC VARCHAR(2)         ,@COD_MEC_PAGO VARCHAR(2)          ,@TIP_MOV VARCHAR(3)          ,@NUM_MOV_CAB VARCHAR(8)     
,@NUM_MOV_LIN VARCHAR(8)       ,@ID_MEZCLA VARCHAR(20)            ,@ID_OSTEO VARCHAR(1)         ,@FEC_MOV VARCHAR(8)
,@FEC_CON VARCHAR(8)            ,@ENCUENTRO VARCHAR(8)            ,@NUM_NHC VARCHAR(11)         ,@APE1_PAC VARCHAR(7)
,@APE2_PAC VARCHAR(8)           ,@NOM_PAC VARCHAR(17)             ,@COD_ART_ORI VARCHAR(10)     ,@CANT_ART_ORI VARCHAR(1)    
,@COD_ART_DES VARCHAR(10)      ,@CANT_ART_DES VARCHAR(10)         ,@COD_SEDE_ORI VARCHAR(4)     ,@COD_ALM_ORI VARCHAR(4)     
,@COD_SEDE_DES VARCHAR(10)     ,@COD_ALM_DES VARCHAR(10)          ,@CEBE VARCHAR(10)            ,@CECO VARCHAR(10)
,@FEC_MSG VARCHAR(14)          ,@DES_USUARIO VARCHAR(8)          ,@NOITEM SMALLINT
,@IDSERVICIO VARCHAR(20)       ,@FECHACONF VARCHAR(20)           ,@NOADMISION VARCHAR(20)       ,@DOCIDAFILIADO VARCHAR(20)
,@PAPELLIDO VARCHAR(30)        ,@SAPELLIDO VARCHAR(30)           ,@NOMBRES VARCHAR(60)          ,@IDARTICULO VARCHAR(20)
,@CANTIDAD INT                 ,@FECHAMOV VARCHAR(20)            ,@DESCRIPCION VARCHAR(50)
,@CLASE VARCHAR(10)            ,@USUARIOCONF VARCHAR(20)         ,@sUrl VARCHAR(1024)           ,@OK VARCHAR(4)
,@response VARCHAR(MAX)
BEGIN
   IF EXISTS(SELECT * FROM IMOV WHERE CNSMOV=@CNSMOV AND ESTADO<>1 )
   BEGIN
      PRINT 'Movimiento de inventario sin confirmar, Verifique'
      RETURN
   END

   SELECT @CLASE=IZSOL.CLASE
   FROM IMOV INNER JOIN IZSOL ON IMOV.NODOCUMENTO=IZSOL.CNSIZSOL
   WHERE IMOV.CNSMOV=@CNSMOV

   PRINT '@CLASE '+COALESCE(@CLASE,'SIN CLASE')

   IF @CLASE IN('HPRE','SENFER','OMEDICA')
   BEGIN
      DECLARE IMOVH_CURSOR CURSOR FOR
      SELECT IMOV.IDTIPOMOV,REPLACE(CONVERT(VARCHAR,IMOV.FECHACONF,102),'.','') FECHACONF,
      IZSOL.NOADMISION,AFI.DOCIDAFILIADO,AFI.PAPELLIDO,AFI.SAPELLIDO,AFI.PNOMBRE+CASE WHEN COALESCE(AFI.SNOMBRE,'')<>'' THEN ' '+AFI.SNOMBRE ELSE '' END,
      IMOVH.IDARTICULO,CONVERT(INT,IMOVH.CANTIDAD)CANTIDAD,REPLACE(CONVERT(VARCHAR,IMOV.FECHAMOV,102),'.','') FECHAMOV,ITMO.DESCRIPCION,
      IMOV.USUARIOCONF
      FROM IMOVH INNER JOIN IMOV ON IMOV.CNSMOV=IMOVH.CNSMOV
                 INNER JOIN IZSOL ON IMOV.NODOCUMENTO=IZSOL.CNSIZSOL
                 INNER JOIN HADM ON IZSOL.NOADMISION=HADM.NOADMISION
                 INNER JOIN AFI ON HADM.IDAFILIADO=AFI.IDAFILIADO
                 INNER JOIN ITMO ON IMOV.IDTIPOMOV=ITMO.IDTIPOMOV
      WHERE IMOVH.CNSMOV=@CNSMOV
   END
   ELSE
   BEGIN
      IF @CLASE='CE'
      BEGIN
         DECLARE IMOVH_CURSOR CURSOR FOR
         SELECT IMOV.IDTIPOMOV,REPLACE(CONVERT(VARCHAR,IMOV.FECHACONF,102),'.','') FECHACONF,
         IZSOL.NOADMISION,AFI.DOCIDAFILIADO,AFI.PAPELLIDO,AFI.SAPELLIDO,AFI.PNOMBRE+CASE WHEN COALESCE(AFI.SNOMBRE,'')<>'' THEN ' '+AFI.SNOMBRE ELSE '' END,
         IMOVH.IDARTICULO,CONVERT(INT,IMOVH.CANTIDAD)CANTIDAD,REPLACE(CONVERT(VARCHAR,IMOV.FECHAMOV,102),'.','') FECHAMOV,ITMO.DESCRIPCION,
         IMOV.USUARIOCONF
         FROM IMOVH INNER JOIN IMOV ON IMOV.CNSMOV=IMOVH.CNSMOV
                    INNER JOIN IZSOL ON IMOV.NODOCUMENTO=IZSOL.CNSIZSOL
                    INNER JOIN AUT ON IZSOL.NOADMISION=AUT.IDAUT
                    INNER JOIN AFI ON AUT.IDAFILIADO=AFI.IDAFILIADO
                    INNER JOIN ITMO ON IMOV.IDTIPOMOV=ITMO.IDTIPOMOV
         WHERE IMOVH.CNSMOV=@CNSMOV

      END      
   END
   SELECT @NOITEM=1
   OPEN IMOVH_CURSOR    
   FETCH NEXT FROM IMOVH_CURSOR    
   INTO @IDSERVICIO,@FECHACONF,@NOADMISION,@DOCIDAFILIADO,@PAPELLIDO,@SAPELLIDO,@NOMBRES,@IDARTICULO,@CANTIDAD,@FECHAMOV,@DESCRIPCION,@USUARIOCONF
   WHILE @@FETCH_STATUS = 0    
   BEGIN 
      PRINT 'COMIENZO EL CURSOR'
      SELECT @ID_TRX=CAST(CONVERT(INT,LEFT(@CNSMOV,2))AS VARCHAR(2))+CAST(CONVERT(INT,RIGHT(@CNSMOV,LEN(@CNSMOV)-2)) AS VARCHAR(10))+CAST(@NOITEM AS VARCHAR(3))
      SELECT @COD_ORG_VTA='CI10',@COD_CANAL='1D',@COD_SECTOR='D1',@COD_GRP_VEN='GVL',@COD_OFI_VTA='O001'
      SELECT @COD_ESPEC=@IDSERVICIO,@COD_MEC_PAGO='99',@TIP_MOV='ZF1',@NUM_MOV_CAB=CAST(CONVERT(INT,LEFT(@CNSMOV,2))AS VARCHAR(2))+CAST(CONVERT(INT,RIGHT(@CNSMOV,LEN(@CNSMOV)-2)) AS VARCHAR(10))
      SELECT @NUM_MOV_LIN=CAST(CONVERT(INT,LEFT(@CNSMOV,2))AS VARCHAR(2))+CAST(CONVERT(INT,RIGHT(@CNSMOV,LEN(@CNSMOV)-2)) AS VARCHAR(10))+CAST(@NOITEM AS VARCHAR(3))
      SELECT @ID_MEZCLA='1',@ID_OSTEO='0',@FEC_MOV=@FECHAMOV,@FEC_CON=@FECHACONF,@ENCUENTRO=@NOADMISION,@NUM_NHC=@DOCIDAFILIADO
      SELECT @APE1_PAC=@PAPELLIDO,@APE2_PAC=@SAPELLIDO,@NOM_PAC=@NOMBRES,@COD_ART_ORI=@IDARTICULO,@CANT_ART_ORI=@CANTIDAD,@COD_ART_DES='',@CANT_ART_DES=''
      SELECT @COD_SEDE_ORI='1008',@COD_ALM_DES='',@CEBE='',@CECO='',@FEC_MSG=@FECHAMOV,@DES_USUARIO=@USUARIOCONF,@COD_ALM_ORI='1008',@COD_SEDE_DES=''
      SELECT @XML=''
      SELECT @XML='<?xml version="1.0"?>'
      SELECT @XML=@XML +'<urn:MT_zpomm004_MovimientosFarmacia_req xmlns:urn="urn:cinternacional.pe:zpomm004:Xhis:MovimientosFarmacia">'
      SELECT @XML=@XML +'<Items>'
      SELECT @XML=@XML +'<ID_TRX>'+@ID_TRX+'</ID_TRX>'
      SELECT @XML=@XML +'<COD_ORG_VTA>'+@COD_ORG_VTA+'</COD_ORG_VTA>'
      SELECT @XML=@XML +'<COD_CANAL>'+@COD_CANAL+'</COD_CANAL>'
      SELECT @XML=@XML +'<COD_SECTOR>'+@COD_SECTOR+'</COD_SECTOR>'
      SELECT @XML=@XML +'<COD_GRP_VEN>'+@COD_GRP_VEN+'</COD_GRP_VEN>'
      SELECT @XML=@XML +'<COD_OFI_VTA>'+@COD_OFI_VTA+'</COD_OFI_VTA>'
      SELECT @XML=@XML +'<COD_ESPEC>'+@COD_ESPEC+'</COD_ESPEC>'
      SELECT @XML=@XML +'<COD_MEC_PAGO>'+@COD_MEC_PAGO+'</COD_MEC_PAGO>'
      SELECT @XML=@XML +'<TIP_MOV>'+@TIP_MOV+'</TIP_MOV>'
      SELECT @XML=@XML +'<NUM_MOV_CAB>'+@NUM_MOV_CAB+'</NUM_MOV_CAB>'
      SELECT @XML=@XML +'<NUM_MOV_LIN>'+@NUM_MOV_LIN+'</NUM_MOV_LIN>'
      SELECT @XML=@XML +'<ID_MEZCLA>'+@ID_MEZCLA+'</ID_MEZCLA>'
      SELECT @XML=@XML +'<ID_OSTEO>'+@ID_OSTEO+'</ID_OSTEO>'
      SELECT @XML=@XML +'<FEC_MOV>'+@FEC_MOV+'</FEC_MOV>'
      SELECT @XML=@XML +'<FEC_CON>'+@FEC_CON+'</FEC_CON>'
      SELECT @XML=@XML +'<ENCUENTRO>'+@ENCUENTRO+'</ENCUENTRO>'
      SELECT @XML=@XML +'<NUM_NHC>'+@NUM_NHC+'</NUM_NHC>'
      SELECT @XML=@XML +'<APE1_PAC>'+@APE1_PAC+'</APE1_PAC>'
      SELECT @XML=@XML +'<APE2_PAC>'+@APE2_PAC+'</APE2_PAC>'
      SELECT @XML=@XML +'<NOM_PAC>'+@NOM_PAC+'</NOM_PAC>'
      SELECT @XML=@XML +'<COD_ART_ORI>'+@COD_ART_ORI+'</COD_ART_ORI>'
      SELECT @XML=@XML +'<CANT_ART_ORI>'+@CANT_ART_ORI+'</CANT_ART_ORI>'
      SELECT @XML=@XML +'<COD_ART_DES>'+@COD_ART_DES+'</COD_ART_DES>'
      SELECT @XML=@XML +'<CANT_ART_DES>'+@CANT_ART_DES+'</CANT_ART_DES>'
      SELECT @XML=@XML +'<COD_SEDE_ORI>'+@COD_SEDE_ORI+'</COD_SEDE_ORI>'
      SELECT @XML=@XML +'<COD_ALM_ORI>'+@COD_ALM_ORI+'</COD_ALM_ORI>'
      SELECT @XML=@XML +'<COD_SEDE_DES>'+@COD_SEDE_DES+'</COD_SEDE_DES>'
      SELECT @XML=@XML +'<COD_ALM_DES>'+@COD_ALM_DES+'</COD_ALM_DES>'
      SELECT @XML=@XML +'<CEBE>'+@CEBE+'</CEBE>'
      SELECT @XML=@XML +'<CECO>'+@CECO+'</CECO>'
      SELECT @XML=@XML +'<FEC_MSG>'+@FEC_MSG+'</FEC_MSG>'
      SELECT @XML=@XML +'<DES_USUARIO>'+@DES_USUARIO+'</DES_USUARIO>'
      SELECT @XML=@XML +'</Items>'
      SELECT @XML=@XML +'</urn:MT_zpomm004_MovimientosFarmacia_req>'
      PRINT '@XML '+COALESCE(@XML,'SIN XML')
      SELECT @NOITEM = @NOITEM+1

      IF COALESCE(@XML,'')='' OR LEN(@XML)<40
      BEGIN
         INSERT INTO INTERFAXINV(FECHA,ID_TRX,PROCESO,SOLICITUD,FORMATEADO,RESPUESTA,ESTADO,CNSMOV,IDARTICULO)
         SELECT DBO.FNK_GETDATE(), @CNSMOV,'CONSUMO',@XML,@XML,@response,'ERRORES',@CNSMOV,@IDARTICULO 
         FETCH NEXT FROM IMOVH_CURSOR    
         INTO @IDSERVICIO,@FECHACONF,@NOADMISION,@DOCIDAFILIADO,@PAPELLIDO,@SAPELLIDO,@NOMBRES,@IDARTICULO,@CANTIDAD,@FECHAMOV,@DESCRIPCION,@USUARIOCONF
         CONTINUE
      END
      PRINT 'NOTIFICO A SAP'
      SELECT @sUrl='/MovInventario/CircuitoConsumoEM'


      EXEC SPK_ENVIA_TRAMAS_CIPERU @ENDPOINT=@sUrl, @TRAMA = @XML ,@OK=@OK OUTPUT,  @RESPUESTA= @response OUTPUT

      --EXEC SPK_ENVIA_JSON_INTERFAX @JSON,@sUrl,@OK OUTPUT,@response OUTPUT

      IF @OK='KO'
      BEGIN
         INSERT INTO INTERFAXINV(FECHA,ID_TRX,PROCESO,SOLICITUD,FORMATEADO,RESPUESTA,ESTADO,CNSMOV,IDARTICULO)
         SELECT DBO.FNK_GETDATE(), @CNSMOV,'CONSUMO',@XML,@XML,@response,'ERRORES',@CNSMOV,@IDARTICULO 
      END
      ELSE
      BEGIN
         INSERT INTO INTERFAXINV(FECHA,ID_TRX,PROCESO,SOLICITUD,FORMATEADO,RESPUESTA,ESTADO,CNSMOV,IDARTICULO)
         SELECT DBO.FNK_GETDATE(), @CNSMOV,'CONSUMO',@XML,@XML,@response,'OK',@CNSMOV,@IDARTICULO 
      END      
      FETCH NEXT FROM IMOVH_CURSOR    
      INTO @IDSERVICIO,@FECHACONF,@NOADMISION,@DOCIDAFILIADO,@PAPELLIDO,@SAPELLIDO,@NOMBRES,@IDARTICULO,@CANTIDAD,@FECHAMOV,@DESCRIPCION,@USUARIOCONF
   END
   CLOSE IMOVH_CURSOR
   DEALLOCATE IMOVH_CURSOR

END


