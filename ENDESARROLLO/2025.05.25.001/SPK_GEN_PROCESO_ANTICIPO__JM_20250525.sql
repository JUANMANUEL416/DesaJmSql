IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_GEN_PROCESO_ANTICIPO' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_GEN_PROCESO_ANTICIPO 
END
GO
CREATE PROCEDURE DBO.SPK_GEN_PROCESO_ANTICIPO
@CNSFCOM       VARCHAR(20),
@VALOR         DECIMAL(14,2),
@IDSEDE        VARCHAR(5),
@USUARIO       VARCHAR(20),
@TIPOANTICIPO  VARCHAR(6)
WITH ENCRYPTION
AS  
DECLARE @CNSFCXP      VARCHAR(20),   @VEZ            INT,            @CIUDAD            VARCHAR(5),     @IDTERCERO_CUR     VARCHAR(20),  @IDSERVICIO_CUR    VARCHAR(20),
        @CANTIDAD_CUR DECIMAL(14,2), @VALOR_CUR      DECIMAL(14,2),  @VLR_DESCUENTO_CUR DECIMAL(14,2) , @VLR_IVA_CUR       DECIMAL(14,2),@VLR_NETO_CUR      DECIMAL(14,2),
        @PREFIJO_CUR  VARCHAR(6),    @CCOSTO_CUR     VARCHAR(20),    @IDAREA_CUR        VARCHAR(20),    @IDCLASEIMP_CUR    VARCHAR(2),   @ITEM              INT,
        @CODUNG       VARCHAR(5),    @CODPRG         VARCHAR(20),    @IDIMPUESTO        VARCHAR(10),    @IDCLASE           VARCHAR(10),  @DECONSUMO         SMALLINT,
        @ITEM_FIMPDV  SMALLINT,      @CUENTA_IVA     VARCHAR(16),    @FECHA_FAC         DATETIME,       @NOREFERENCIA      VARCHAR(20),  @VLR_NETO          DECIMAL(14,2),
        @F_FACTURAREF DATETIME,      @VLR_DESCUENTO  DECIMAL(14,2) , @CUEANTDB          VARCHAR(16),    @F_VENCE           DATETIME,     @VLR_IVA           DECIMAL(14,2),
        @CNSFCOT      VARCHAR(20),   @CNSFCXPPM      VARCHAR(20),    @IDTERCERO         VARCHAR(20),    @CNSFCXPP          VARCHAR(20),  @HOST_NAME         VARCHAR(20),
        @VLR_ANTICIPOS DECIMAL(14,2) ,@PPAGO INT
BEGIN  
  
   IF NOT EXISTS(SELECT * FROM FCOM WHERE CNSFCOM=@CNSFCOM AND VR_TOTAL>=@VALOR)
   BEGIN
      RAISERROR('El valor del anticipo no puede superar el monto de la Orden de Servicios',16,1)
      RETURN
   END
   SELECT @VLR_ANTICIPOS=SUM(VLR_ABONOS) FROM FCXP WHERE PROCEDENCIA='Anticipos' AND ESTADO<>'A' AND CNSFCOM=@CNSFCOM

   IF NOT EXISTS(SELECT * FROM FCOM WHERE CNSFCOM=@CNSFCOM AND VR_TOTAL>=(@VALOR+COALESCE(@VLR_ANTICIPOS,0)))
   BEGIN
      RAISERROR('El valor de los anticipos no pueden  superar el monto de la Orden de Servicios',16,1)
      RETURN
   END

   SELECT @PPAGO=COUNT(*) FROM FCXP INNER JOIN FCXPP ON FCXP.CNSFCXP=FCXPP.CNSFCXP
                   INNER JOIN FCJ   ON FCXPP.CODCAJA=FCJ.CODCAJA AND FCXPP.CNSFACJ=FCJ.CNSFACJ
   WHERE CNSFCOM=@CNSFCOM
   AND FCXP.ESTADO<>'A'
   AND FCXPP.ESTADO<>'A'
   AND FCJ.ESTADO<>'A'
   AND FCJ.CERRADA=0
   IF COALESCE(@PPAGO,0)>0
   BEGIN
      RAISERROR('Existen Ordenes de pago en caja Pendientes de Confirmar, no se puede Continuar',16,1)
      RETURN      
   END
   PRINT '@CNSFCOM == '+@CNSFCOM
   PRINT 'Primero Genero la Cxp'
   EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@FCXPANT', @CNSFCXP OUTPUT  
   SELECT @CNSFCXP = @IDSEDE + 'AN' + REPLACE(SPACE(6 - LEN(@CNSFCXP))+LTRIM(RTRIM(@CNSFCXP)),SPACE(1),0) 

   PRINT '@CNSFCXP == '+@CNSFCXP
   
   SELECT @VEZ = COUNT(*) FROM FCXP WHERE PROCEDENCIA = 'Anticipos' AND CNSFCOM = @CNSFCOM
   SELECT @VEZ = @VEZ + 1

   SELECT @CIUDAD = CIUDAD FROM SED WHERE IDSEDE = @IDSEDE
   
   SELECT @CUEANTDB=CUEDEBITO,@IDTERCERO=FCOM.IDTERCERO
   FROM   FCOM LEFT JOIN TANT ON FCOM.TIPOANTICIPO = TANT.TIPOANTICIPO
   WHERE  CNSFCOM = @CNSFCOM 
   
   SELECT @FECHA_FAC=FECHA FROM FCOM WHERE CNSFCOM=@CNSFCOM

   INSERT INTO FCXP (CNSFCXP, FECHA, CNSFCOM, IDTERCERO, NOREFERENCIA, F_FACTURAREF, F_VENCE,VALOR, ESTADO,
                     F_CANCELADO, USUARIO, TIPOCXP, PROCEDENCIA, OBSERVACION, COMPANIA, SYS_ComputerName,
                     USUARIOMOD, FECHAMOD, NUMCUOTA, MARCACONT, CONTABILIZADA, NROCOMPROBANTE, SALDO,
                     IDCLASEIMP, VLR_DESCUENTO, VLR_IVA, VLR_NETO, VLR_IMPUESTOS, SALDO_IMPUESTO, 
                     VLR_NOTASDEBITO, VLR_COMISION, VLR_GLOSAS, VLR_FLETE, CUEDEBITO, CUECREDITO,
                     CNSFCXPPM, MODALIDAD, SUBSIDIO, IDCONTRATO, VLR_NOTASCREDITO ,VLR_ABONOS, IDSEDE,
                     PERIODO_ANO, PERIODO_MES, CODUNG, CODPRG, CIUDAD, ENPRESUPUESTO, SEAMORTIZA, NUMPERAMORT, 
                     IDPROPIETARIO, FACCONTROL, USUARIOMARCA, FECHAMARCA)
   SELECT @CNSFCXP, DBO.FNK_FECHA_SIN_MLS( GETDATE()), @CNSFCOM, IDTERCERO, 
          @CNSFCOM + '-' + CASE WHEN @VEZ < 10 THEN '0' ELSE '' END + LTRIM(RTRIM(CONVERT(VARCHAR(3), @VEZ))),
          DBO.FNK_FECHA_SIN_MLS( FECHA), DBO.FNK_FECHA_SIN_MLS( GETDATE()),@VALOR, 'N', NULL, @USUARIO,
          RTRIM(LTRIM(DBO.FNK_VALORVARIABLE('IDTIPOCXP_DEFAULT'))), 'Anticipos', OBSERVACION, '01', HOST_NAME(),
          NULL, NULL, 0, 0, 1 , '', 0, NULL, 0, 0, 0, 0, NULL, NULL, NULL, 0, 0, NULL, TANT.CUECREDITO, NULL, 'Evento', 'Total',
          NULL, 0, 0, @IDSEDE, NULL, NULL, '', '', @CIUDAD, 0, 0, 0, NULL, NULL, NULL, NULL       
   FROM   FCOM LEFT JOIN TANT ON FCOM.TIPOANTICIPO = TANT.TIPOANTICIPO
   WHERE  CNSFCOM = @CNSFCOM 

   --GENERAR FCXPD
      PRINT '@TIPOANTICIPO = '+@TIPOANTICIPO
      SET  @ITEM=1
      INSERT INTO FCXPD (CNSFCXP,ITEM,IDSERVICIO,CANTIDAD,VALOR,VLR_DESCUENTO,VLR_IVA,VLR_NETO,ESTADO,
                         N_PRESUP,ITEM_PRESUP,IDCLASEIMP,PREFIJO,CCOSTO,IDAREA,VLR_GLOSAS,
                         CUENTA_SER, CODUNG, CODPRG, PROCEDENCIA, IDIMPUESTO, IDCLASE, ITEM_FIMPDV, CUENTA_IVA ) 
      SELECT @CNSFCXP,@ITEM,@TIPOANTICIPO,1 ,@VALOR,@VLR_DESCUENTO_CUR,@VLR_IVA_CUR, @VALOR, 'P', 
             @CNSFCOM,0,@IDCLASEIMP_CUR,@PREFIJO_CUR,@CCOSTO_CUR,@IDAREA_CUR,0,@CUEANTDB,
             --DBO.FNK_CUENTA_KMCOM(DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE'),'CXP_SERVICIOS','DB',@PREFIJO_CUR, @IDAREA_CUR,@CCOSTO_CUR,'P',''), 
             @CODUNG, @CODPRG, 'Servicios', @IDIMPUESTO, @IDCLASE, CASE @DECONSUMO WHEN 1 THEN NULL
                                                                                   ELSE @ITEM_FIMPDV
                                                                   END,
             CASE @DECONSUMO WHEN 1 THEN NULL
                             ELSE @CUENTA_IVA
             END      

   --GENERAR FCXPD
   --DECLARE CUR_FCOM CURSOR FOR
   --SELECT FCOMD.IDARTICULO, FCOMD.CANTIDAD, @VALOR, 0, 0, @VALOR,
   --       FCTSERD.IDTIPOSER,FCOM.CCOSTO,FCOM.IDAREA,NULL, FCOM.CODUNG, FCOM.CODPRG, FCOMD.IDIMPUESTO, FCOMD.IDCLASE,
   --       FCOM.DECONSUMO, ISNULL(FCOM.FECHA, GETDATE()) 
   --FROM   FCOM INNER JOIN FCOMD   ON FCOM.CNSFCOM     = FCOMD.CNSFCOM 
   --             LEFT JOIN FCTSERD ON FCOMD.IDARTICULO = FCTSERD.IDSERVICIO 
   --                              AND FCOMD.TIPO       = 'Servicios'
   --WHERE  FCOM.CNSFCOM = @CNSFCOM
   
   --OPEN CUR_FCOM
   
   --FETCH NEXT FROM CUR_FCOM
   --INTO @IDSERVICIO_CUR, @CANTIDAD_CUR, @VALOR_CUR, @VLR_DESCUENTO_CUR, @VLR_IVA_CUR, @VLR_NETO_CUR,
	  --   @PREFIJO_CUR, @CCOSTO_CUR, @IDAREA_CUR, @IDCLASEIMP_CUR, @CODUNG, @CODPRG, @IDIMPUESTO, @IDCLASE, 
   --     @DECONSUMO, @FECHA_FAC
   --SET  @ITEM=1
   --WHILE @@FETCH_STATUS = 0
   --BEGIN  
      
   --   SELECT @ITEM_FIMPDV = ITEM, @CUENTA_IVA = CUENTA
   --   FROM   FNK_VALOR_IMPUESTO(@IDIMPUESTO, @IDCLASE, @FECHA_FAC, @VALOR_CUR)
      
   --   INSERT INTO FCXPD (CNSFCXP,ITEM,IDSERVICIO,CANTIDAD,VALOR,VLR_DESCUENTO,VLR_IVA,VLR_NETO,ESTADO,
   --                      N_PRESUP,ITEM_PRESUP,IDCLASEIMP,PREFIJO,CCOSTO,IDAREA,VLR_GLOSAS,
   --                      CUENTA_SER, CODUNG, CODPRG, PROCEDENCIA, IDIMPUESTO, IDCLASE, ITEM_FIMPDV, CUENTA_IVA ) 
   --   SELECT @CNSFCXP,@ITEM,@IDSERVICIO_CUR,@CANTIDAD_CUR,@VALOR_CUR,@VLR_DESCUENTO_CUR,@VLR_IVA_CUR, @VLR_NETO_CUR, 'P', 
   --          @CNSFCOM,0,@IDCLASEIMP_CUR,@PREFIJO_CUR,@CCOSTO_CUR,@IDAREA_CUR,0,@CUEANTDB,
   --          --DBO.FNK_CUENTA_KMCOM(DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE'),'CXP_SERVICIOS','DB',@PREFIJO_CUR, @IDAREA_CUR,@CCOSTO_CUR,'P',''), 
   --          @CODUNG, @CODPRG, 'Servicios', @IDIMPUESTO, @IDCLASE, CASE @DECONSUMO WHEN 1 THEN NULL
   --                                                                                ELSE @ITEM_FIMPDV
   --                                                                END,
   --          CASE @DECONSUMO WHEN 1 THEN NULL
   --                          ELSE @CUENTA_IVA
   --          END      
   --   SET @ITEM=@ITEM+1
   --   FETCH NEXT FROM CUR_FCOM
   --   INTO	@IDSERVICIO_CUR,@CANTIDAD_CUR,@VALOR_CUR,@VLR_DESCUENTO_CUR,@VLR_IVA_CUR,@VLR_NETO_CUR,
   --         @PREFIJO_CUR,@CCOSTO_CUR,@IDAREA_CUR,@IDCLASEIMP_CUR, @CODUNG, @CODPRG, @IDIMPUESTO, @IDCLASE, 
   --         @DECONSUMO, @FECHA_FAC
   --END
   --CLOSE CUR_FCOM 
   --DEALLOCATE CUR_FCOM
   
   SELECT @VLR_DESCUENTO = SUM(VLR_DESCUENTO), @VLR_IVA = SUM(VLR_IVA), @VLR_NETO=SUM(VLR_NETO)
   FROM   FCXPD WHERE CNSFCXP = @CNSFCXP
   
   UPDATE FCXP SET CNSFCOM  = @CNSFCOM,
            	  	 VALOR    = @VALOR,
            		 SALDO    = @VALOR,
            		 VLR_DESCUENTO=@VLR_DESCUENTO,
            		 VLR_IVA  = @VLR_IVA,
            		 VLR_NETO = @VLR_NETO
   WHERE  CNSFCXP = @CNSFCXP
   
   UPDATE FCOM SET ENCXP = 1, ESTADO = 'I' WHERE CNSFCOM=@CNSFCOM 
   
   PRINT 'CREAMOS LA ORDEN DE PAGO...........'
   
   EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@FCXPPM', @CNSFCXPPM OUTPUT  
   SELECT @CNSFCXPPM = @IDSEDE +  REPLACE(SPACE(8 - LEN(@CNSFCXPPM))+LTRIM(RTRIM(@CNSFCXPPM)),SPACE(1),0)    

   PRINT '@CNSFCXPPM == '+@CNSFCXPPM   

   PRINT 'INSERT FCXPPM'
   INSERT INTO FCXPPM(CNSFCXPPM, FECHA, OBSERVACION, USUARIO, USUARIOCONF, FECHACONF, SYS_COMPUTERNAME, N_RECIBO, ESTADO, VALOR, PROCEDENCIA, CODCAJA, IDTERCERO_AFAVOR, CODUNG, CODPRG, CUENTA_RUBRO, F_CONTABLE)
   SELECT @CNSFCXPPM,@FECHA_FAC,'ORDEN DE PAGO DE ANTICIPO '+@CNSFCXP+'GENERADO AUTOMATICAMENTE',@USUARIO,NULL,NULL,HOST_NAME(),NULL,'N',@VALOR,'CXP',
   DBO.FNK_VALORVARIABLE('CODCAJANTICIPOS'),@IDTERCERO,NULL,NULL,NULL,GETDATE()
   
   PRINT 'INSERT FCXPP'

   EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@FCXPP', @CNSFCXPP OUTPUT  
   SELECT @CNSFCXPP = @IDSEDE +  REPLACE(SPACE(8 - LEN(@CNSFCXPP))+LTRIM(RTRIM(@CNSFCXPP)),SPACE(1),0)   
   
   PRINT '@CNSFCXPP '+@CNSFCXPP
   
   INSERT INTO FCXPP ( CNSFCXPP, CNSFCXP, FECHA, OBSERVACION, SALDOANTERIOR, ABONO, SALDONUEVO, FECHAPPAGO, VALORPPAGO, USUARIO, USUARIOCONF, FECHACONF, SYS_COMPUTERNAME, CODCAJA, CNSFACJ, N_RECIBO,
                       ESTADO, IDTERCERO, IDCLASEIMP, VLR_IMPUESTOS, VLR_NETO, PROCEDENCIA, CNSFCXPPM)
   SELECT @CNSFCXPP,@CNSFCXP,@FECHA_FAC,'Pago Anticipos',@VALOR,@VALOR,0,NULL,@VALOR,@USUARIO,NULL,NULL,HOST_NAME(),NULL,NULL,NULL,'N',NULL,NULL,0,@VALOR,'CXP',@CNSFCXPPM

   PRINT 'POR ULTIMO SE AUTORIZA EL PAGO '
   
   SELECT @HOST_NAME=HOST_NAME()

   EXEC SPK_CONFIRMAR_PAGOSMASIVO @CNSFCXPPM,'01',@IDSEDE,@HOST_NAME,@USUARIO

   
   PRINT 'Termine......'

END



