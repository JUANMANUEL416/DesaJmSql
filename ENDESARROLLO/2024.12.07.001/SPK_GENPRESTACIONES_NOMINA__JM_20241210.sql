IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_GENPRESTACIONES_NOMINA' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_GENPRESTACIONES_NOMINA 
END
GO
CREATE PROCEDURE DBO.SPK_GENPRESTACIONES_NOMINA
@CNSPROGRA VARCHAR(20),
@CNSLIQUIDA VARCHAR(20),
@CLASE     VARCHAR(10),
@TIPO      VARCHAR(5) , 
@COMPANIA  VARCHAR(2), 
@IDSEDE    VARCHAR(5),
@SYS_COMPUTERNAME VARCHAR(255) 
WITH ENCRYPTION
AS 
DECLARE @CNSPAGO   VARCHAR(20) 
DECLARE @NUMDOC  VARCHAR(20)
DECLARE @FECHAINI DATETIME
DECLARE @FECHAFIN DATETIME
DECLARE @FECHAINIL DATETIME
DECLARE @FECHAFINL DATETIME
DECLARE @CODNOMINA VARCHAR(10)
DECLARE @ITEM            VARCHAR(8)    
DECLARE @ITEM_N          INT    
DECLARE @ITEM_NEW        VARCHAR(8) 
DECLARE @CODCONCEPTO     VARCHAR(20)
DECLARE @DETALLE         VARCHAR(100)
DECLARE @VALORL          DECIMAL(14,2)
DECLARE @VALORD          DECIMAL(14,2)
DECLARE @DIASL				 INT 
DECLARE @DIASBASE			 INT
DECLARE @BASICO          DECIMAL(14,2)
DECLARE @DIASMIN			 INT
DECLARE @ANO             VARCHAR(4)
DECLARE @CAMPO           VARCHAR(12)
DECLARE @CANTI           INT
DECLARE @FECHAINILIQ     DATETIME
DECLARE @FECHAFINLIQ     DATETIME 
DECLARE @TERAPORTE VARCHAR(20)
BEGIN  
	PRINT 'TRAIGO LA PLANTILLA....'

	SELECT @DIASMIN=CONVERT(INT, COALESCE(DBO.FNK_VALORVARIABLE('NOMI_PRIMADIAS_MIN'),0))
   IF EXISTS(SELECT * FROM NPER WHERE CNSPAGO=@CNSPAGO AND CERRADO=1)
   BEGIN
      PRINT 'Periodo de Nomina Cerrado, No se Puede Continuar'
      RETURN
   END

	EXEC SPK_ADDDEL_CONCEPTOS_DE_CARGOS 'ADD',@CNSPAGO

	SELECT @FECHAINIL=NVAC.FECHAINI,@FECHAFINL=NVAC.FECHAFIN,@CNSPAGO=C.CNSPAGO,@ANO=NVAC.ANO
	FROM NVAC INNER JOIN NOMI B ON NVAC.NUMDOC=B.CODNOMINA
				 INNER JOIN NVACD C ON NVAC.CNSVAC=C.CNSVAC
	WHERE NVAC.CNSVAC=@CNSPROGRA
	
	IF @TIPO='P'
	BEGIN
		IF @CLASE='Primaj'
		BEGIN
		   SELECT @CAMPO='ProvPrimaJ'
		END
		IF @CLASE='PrimaD'
		BEGIN
			SELECT @CAMPO='ProvPrimaD'
		END
		IF @CLASE='Cesan'
		BEGIN
			SELECT @CAMPO='ProvCesan'
		END
		IF @CLASE='ICesan'
		BEGIN
			SELECT @CAMPO='ProvICesan'
		END
		IF @CLASE='VACA'
		BEGIN
			SELECT @CAMPO='ProvVACA'
		END
	END
   IF DBO.FNK_VALORVARIABLE('PERIODO_PRESTA_NOM')='FECHAS'
   BEGIN
      SELECT @FECHAINILIQ=FECHAINI,@FECHAFINLIQ=DATEADD(DAY,1,FECHAFIN) FROM NVAC WHERE CNSVAC=@CNSPROGRA
   END
	PRINT 'PAGO ES ----'+@CNSPAGO

    SELECT @FECHAINI  = NPER.FECHAINI,   
           @FECHAFIN  = NPER.FECHAFIN,  
           @CODNOMINA = NOMI.CODNOMINA
    FROM NPER INNER JOIN NOMI ON NPER.CNSPAGO   = @CNSPAGO 
                             AND NPER.CODNOMINA = NOMI.CODNOMINA  

    PRINT 'Borrando Empleados del Pago...'
    DELETE NEMPFD WHERE CNSPAGO=@CNSPAGO
    DELETE NEMPF WHERE CNSPAGO=@CNSPAGO

    SELECT @ITEM=MAX(ITEM) FROM NEMPF WHERE LEFT(ITEM,3)='CAR' AND CNSPAGO=@CNSPAGO  
      IF @ITEM IS NULL OR @ITEM=''    
      BEGIN    
         PRINT 'NUEVO ITEM '
         SET @ITEM_NEW='CAR00001'    
      END    
      ELSE    
      BEGIN    
         SET @ITEM=RIGHT(@ITEM,5)    
         SET @ITEM_N=CAST(@ITEM AS INT)    
         SET @ITEM_N=@ITEM_N+1    
         SET @ITEM_NEW='CAR'+RIGHT('0000'+RTRIM(LTRIM(STR(@ITEM_N))),5)    
        -- PRINT 'SUMA DE ITEM '+@CODCARGO_CUR+' '+@ITEM_NEW    
      END     

      PRINT 'Insertando NEMPF...'
      INSERT INTO NEMPF(CNSPAGO, NUMDOC, ITEM)    
      SELECT @CNSPAGO, NEMP.NUMDOC, @ITEM_NEW
      FROM   NEMP INNER JOIN NOMIE ON NEMP.NUMDOC     = NOMIE.NUMDOC 
                                  AND NOMIE.CODNOMINA = @CODNOMINA 
                                  AND NOMIE.ESTADO    = 'Activo' 
                                  AND NEMP.ESTADO     = 'Activo' 
		GROUP BY NEMP.NUMDOC 

      
		DECLARE PG_CURSOR CURSOR FOR 
		SELECT  A.NUMDOC,B.IDEVENTO_PAGO 
		FROM NVAC A INNER JOIN NVACD B ON A.CNSVAC=B.CNSVAC
						INNER JOIN NOMIE C ON A.NUMDOC=C.NUMDOC
						INNER JOIN NEMP  D ON A.NUMDOC=D.NUMDOC
		WHERE A.CNSLIQUIDA=@CNSLIQUIDA AND D.ESTADO='Activo'
		GROUP BY  A.NUMDOC,B.IDEVENTO_PAGO
		OPEN PG_CURSOR    
		FETCH NEXT FROM PG_CURSOR    
		INTO @NUMDOC,@CODCONCEPTO
		WHILE @@FETCH_STATUS = 0    
		BEGIN 
		   PRINT 'EMPEZAMOS CODIGO EMPLEADO = '+@NUMDOC
         PRINT 'EMPEZAMOS CODIGO CONCEPTO = '+@CODCONCEPTO

			SELECT TOP 1  @TERAPORTE = NPRFED.IDTERCERO
			FROM NPRFE INNER JOIN NPRFED ON NPRFE.CODPRF=NPRFED.CODPRF 
				      INNER JOIN NCOND ON NCOND.CODPRF=NPRFE.CODPRF
			WHERE NPRFE.NUMDOC=@NUMDOC AND NCOND.CODCONCEPTO=@CODCONCEPTO
			ORDER BY NPRFED.FECHAINI DESC
			SELECT @DIASL= DATEDIFF(DAY,FECHAING,@FECHAFIN),@DIASBASE=DATEDIFF(DAY,@FECHAINIL,@FECHAFINL),@BASICO=BASICO,@CANTI=HORASXCARGO FROM FNK_INFO_NEMPHIS(@FECHAFIN)  WHERE NUMDOC=@NUMDOC
			IF @TIPO='C'
			BEGIN
				SELECT @VALORL=VALOR_EMPLEADO FROM FNK_CALCULO_VALORCONCEPTO_NOM(@NUMDOC,@CODCONCEPTO,@FECHAINI,@FECHAFIN,@CNSPAGO, 1,0,0) 
		   END
			IF @TIPO='P'
			BEGIN
            IF DBO.FNK_VALORVARIABLE('PERIODO_PRESTA_NOM')='FECHAS'
            BEGIN
				   SELECT @VALORD=SUM (NIEPED.VALOR_APORTES)
				   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														   AND NIEPE.NUMDOC=NIEPED.NUMDOC
				   WHERE NIEPE.NUMDOC=@NUMDOC 
               AND  CAST('01/'+MES+'/'+ANO AS DATETIME)>=@FECHAINILIQ
               AND  CAST('01/'+MES+'/'+ANO AS DATETIME)<@FECHAFINLIQ
               AND COALESCE(NIEPED.PAGADO,0)=0 
				   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
            END
            ELSE
            BEGIN
				   SELECT @VALORD=SUM (NIEPED.VALOR_APORTES)
				   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														   AND NIEPE.NUMDOC=NIEPED.NUMDOC
				   WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				   AND MES>=CASE WHEN @CLASE<>'PrimaD' THEN 1 ELSE 7 END 
				   AND MES<CASE WHEN @CLASE NOT IN('PrimaD','Cesan','ICesan') THEN 7  ELSE 13 END
               AND COALESCE(NIEPED.PAGADO,0)=0 
				   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
            END
			END
			IF @TIPO='C'
			BEGIN
				IF @DIASBASE>@DIASL
				BEGIN
					PRINT 'DIAS LABORADOS MENOR....'
					IF @DIASL<@DIASMIN
					BEGIN
						PRINT 'ESTE  NO VA....'+@NUMDOC

						DELETE NEMPF WHERE NUMDOC=@NUMDOC AND CNSPAGO=@CNSPAGO

						FETCH NEXT FROM PG_CURSOR    
						INTO @NUMDOC,@CODCONCEPTO
						CONTINUE
					END
					ELSE
					BEGIN
						SELECT @VALORD=(@VALORL*ROUND(@DIASL,-1))/360
					END
				END
				ELSE 
				BEGIN
					PRINT 'DIAS LABORADOS COMPLETOS...'
					SELECT @VALORD=@VALORL
				END
			END
			IF @TIPO='P'
			BEGIN
				IF COALESCE(@VALORD,0)<=0
				BEGIN
					PRINT 'ESTE  NO VA....'+@NUMDOC

					--DELETE NEMPF WHERE NUMDOC=@NUMDOC AND CNSPAGO=@CNSPAGO

					FETCH NEXT FROM PG_CURSOR    
					INTO @NUMDOC,@CODCONCEPTO
					CONTINUE
				END
			END
         INSERT INTO NEMPFD (NUMDOC, CNSPAGO, ITEM, CODCONCEPTO, DETALLE, CANTIDAD, VALOR, VALOR_EMPRESA, VALOR100P,   
                                 IDTRANSPRESTAMO, NUMDOCPRESTAMO, NUMCUOTA, CODPRF, IDTERCERO, INCLUIR_EXCLUIR, LIQUIDAR, INFO,   
                                 BASE_PRESTACIONES, ITEMCONCEPTO, VALHORASLAB, GENERANOVEFU, CODNOVEFU, BASE_CALCULO,LINEA) 
			SELECT @NUMDOC,@CNSPAGO,'CAR00001',@CODCONCEPTO,@DETALLE,CASE WHEN A.CANTIDAD<=0 THEN @CANTI ELSE A.CANTIDAD END,@VALORD,
			A.VALOR_EMPRESA,@VALORD,A.IDTRANSPRESTAMO,A.NUMDOCPRESTAMO,
					 A.NUMCUOTA,A.CODPRF,COALESCE(@TERAPORTE,@NUMDOC),'Automatica', 'Si','No','No',A.ITEMCONCEPTO,1,0,0,A.BASE_CALCULO,1
					 FROM FNK_CALCULO_VALORCONCEPTO_NOM(@NUMDOC,@CODCONCEPTO,@FECHAINI,@FECHAFIN,@CNSPAGO, 1,0,0) A

			UPDATE NVAC SET ESTADO='Liquidado' WHERE CNSLIQUIDA=@CNSLIQUIDA AND NUMDOC=@NUMDOC

			UPDATE NVACD SET  ESTADO='Liquidado',VALOR=@VALORD,BASICO=@BASICO
			FROM NVAC INNER JOIN NVACD  ON NVAC.CNSVAC=NVACD.CNSVAC
			WHERE NVAC.CNSLIQUIDA=@CNSLIQUIDA AND NVAC.NUMDOC=@NUMDOC AND NVACD.CNSPAGO=@CNSPAGO

			IF @TIPO='P'
			BEGIN
            DELETE NEMPFD WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC AND CODCONCEPTO IN(SELECT CODCONCEPTOA  FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
         END

         IF EXISTS(SELECT * FROM NPERC WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC)
         BEGIN
            SELECT @CODCONCEPTO=CODCONCEPTO  FROM  NPERC WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC
            INSERT INTO NEMPFD (NUMDOC, CNSPAGO, ITEM, CODCONCEPTO, DETALLE, CANTIDAD, VALOR, VALOR_EMPRESA, VALOR100P,   
                                    IDTRANSPRESTAMO, NUMDOCPRESTAMO, NUMCUOTA, CODPRF, IDTERCERO, INCLUIR_EXCLUIR, LIQUIDAR, INFO,   
                                    BASE_PRESTACIONES, ITEMCONCEPTO, VALHORASLAB, GENERANOVEFU, CODNOVEFU, BASE_CALCULO,LINEA) 
			   SELECT @NUMDOC,@CNSPAGO,'CAR00001',@CODCONCEPTO,@DETALLE,CASE WHEN A.CANTIDAD<=0 THEN @CANTI ELSE A.CANTIDAD END,
			   A.VALOR_EMPLEADO,A.VALOR_EMPRESA,A.VALOR_EMPLEADO,A.IDTRANSPRESTAMO,A.NUMDOCPRESTAMO,
					    A.NUMCUOTA,A.CODPRF,COALESCE(@TERAPORTE,@NUMDOC),'Automatica', 'Si','No','No',A.ITEMCONCEPTO,1,0,0,A.BASE_CALCULO,1
					    FROM FNK_CALCULO_VALORCONCEPTO_NOM(@NUMDOC,@CODCONCEPTO,@FECHAINI,@FECHAFIN,@CNSPAGO, 1,0,0) A            
         END

			PRINT 'ACTUALIZANDO VALORES'
			EXEC SPK_CALCULAR_NEMPF @CNSPAGO,@NUMDOC


         

		FETCH NEXT FROM PG_CURSOR    
		INTO @NUMDOC,@CODCONCEPTO
		END
		CLOSE PG_CURSOR
		DEALLOCATE PG_CURSOR
		IF @TIPO='P'
		BEGIN
         DELETE NEMPF WHERE CNSPAGO=@CNSPAGO AND NUMDOC NOT IN(SELECT NUMDOC FROM NEMPFD WHERE CNSPAGO=@CNSPAGO)
      END	
      
      EXEC SPK_CALCULAR_NEMPF @CNSPAGO,''  

      PRINT 'Actualiza valores de NPER'
      UPDATE NPER SET 
      TOTAL_INGRESOS     = CASE WHEN V.TOTAL_INGRESOS IS NULL THEN 0 ELSE V.TOTAL_INGRESOS END, 
            TOTAL_EGRESOS      = CASE WHEN V.TOTAL_EGRESOS IS NULL THEN 0 ELSE V.TOTAL_EGRESOS END,  
            TOTAL_APORTES      = CASE WHEN V.TOTAL_APORTES IS NULL THEN 0 ELSE V.TOTAL_APORTES END,
      TOTAL_PARAFISCALES = CASE WHEN P.TOTAL_PARAFISCALES IS NULL THEN 0 ELSE P.TOTAL_PARAFISCALES END
      FROM NPER,
         (SELECT SUM(VALOR_INGRESOS) AS TOTAL_INGRESOS,SUM(VALOR_EGRESOS) AS TOTAL_EGRESOS,
            SUM(VALOR_APORTES) AS TOTAL_APORTES FROM NEMPF WHERE CNSPAGO=@CNSPAGO) V,
         (SELECT SUM(TOTAL_PARAFISCALES) AS TOTAL_PARAFISCALES
            FROM NPERP INNER JOIN NPRF ON NPRF.CODPRF=NPERP.CODPRF WHERE NPERP.CNSPAGO=@CNSPAGO AND NPRF.CLASE='Parafiscal') P
      WHERE CNSPAGO=@CNSPAGO

      UPDATE NPER SET TOTAL_NOMINA=TOTAL_INGRESOS+TOTAL_APORTES+TOTAL_PARAFISCALES 
      WHERE CNSPAGO=@CNSPAGO

      PRINT 'ACTUALIZO LOS TERCEROS DE LA NOMINA'
      UPDATE NEMPFD SET IDTERCERO=NEMP.TERCEROID 
      FROM NEMPFD INNER JOIN NEMP ON NEMPFD.NUMDOC=NEMP.NUMDOC AND  IDTERCERO=NEMP.NUMDOC 
      WHERE CNSPAGO=@CNSPAGO 
		
END



