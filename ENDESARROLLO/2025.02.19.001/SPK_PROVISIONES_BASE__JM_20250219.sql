IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SPK_PROVISIONES_BASE' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_PROVISIONES_BASE
END

GO
CREATE PROCEDURE [dbo].[SPK_PROVISIONES_BASE]
	@CNS   VARCHAR(20),
	@FECHA DATETIME,
   @CLASE VARCHAR(10)
WITH ENCRYPTION
AS 
DECLARE @NRODIAS SMALLINT
DECLARE @PORWAT  DECIMAL(7,6)
BEGIN
   IF COALESCE(@CLASE,'')='Amortiza'
   BEGIN
      --SELECT * FROM PARN
      PRINT 'INGRESO A AMORTIZACIONES'
      SELECT @NRODIAS=DATO FROM PARN WHERE PARAMETRO='EQUIVALEFECXC'
      SELECT @PORWAT=CONVERT(NUMERIC(7,6),DATO) FROM PARN WHERE PARAMETRO='INTERESAMORTIZA'

      INSERT RPDX(CNS,IDTERCERO,STRINGMEDIO2,ID1,ID4,FECHA1,VALOR1,VALOR2,VALOR3,ID2,CANTIDAD1,ID3,ID5,ID6,FECHA2) 
      SELECT  @CNS,IDTERCERO, RAZONSOCIAL, N_FACTURA,@CLASE,MIN(F_RECIBIDO),SUM(SALDONETO), @PORWAT,SUM(VLR_INTERES),'AMNIIF',MAX(DIAS),
             'Amortiza', CXC_ESTIMADA,PASIVO_EST,@FECHA
      FROM (
      SELECT T.IDTERCERO, T.RAZONSOCIAL, A.N_FACTURA, B.F_RECIBIDO,B.SALDONETO,
     	         ((B.SALDONETO*@PORWAT)/100)VLR_INTERES,
     	          (SELECT DATEDIFF(dd,B.F_VENCE, @FECHA)) AS DIAS,TTEC.CXC_ESTIMADA,TTEC.PASIVO_EST
         FROM   FCXCDV AS B INNER JOIN FTR AS A ON B.N_FACTURA = A.N_FACTURA
		                      INNER JOIN TER AS T ON T.IDTERCERO = A.IDTERCERO
                            INNER JOIN TTEC ON A.TIPOTTEC=TTEC.TIPO
		   WHERE  B.F_VENCE IS NOT NULL  AND B.SALDONETO > 0 
		   AND    DATEDIFF(DAY,B.F_VENCE,@FECHA)>=  @NRODIAS
		   AND    DATEDIFF(DAY,B.F_VENCE,@FECHA)<= @NRODIAS+30
         AND    COALESCE(AMONIIF,0)=0
         )X
         GROUP BY IDTERCERO, RAZONSOCIAL, N_FACTURA, CXC_ESTIMADA,PASIVO_EST
  END
  ELSE
  BEGIN
      INSERT RPDX(CNS,IDTERCERO,STRINGMEDIO2,ID1,ID4,FECHA1,VALOR1,VALOR2,VALOR3,ID2,CANTIDAD1,ID3) 
      SELECT @CNS, T.IDTERCERO, T.RAZONSOCIAL, A.N_FACTURA,@CLASE, B.F_RECIBIDO,SUM(B.SALDONETO),
     	          KPROVCNF.PORCENTAJE,SUM(((B.SALDONETO*KPROVCNF.PORCENTAJE)/100)), KPROVCNF.CATEGORIA,
     	          (SELECT DATEDIFF(dd, MAX(B.F_VENCE), @FECHA)) AS DIAS, 'PROVISIONES'
         FROM   FCXCDV AS B LEFT JOIN FTR AS A ON B.N_FACTURA = A.N_FACTURA
		                      LEFT JOIN TER AS T ON T.IDTERCERO = A.IDTERCERO, KPROVCNF
		   WHERE  COALESCE(B.SALDONETO,0) > 0 
         AND COALESCE(A.IDTERCERO,'')<>''
		   AND    DATEDIFF(DAY,B.F_VENCE,@FECHA)>  KPROVCNF.RI
		   AND    DATEDIFF(DAY,B.F_VENCE,@FECHA)<= KPROVCNF.RF
         AND    KPROVCNF.CLASE=@CLASE
         GROUP BY  T.IDTERCERO, T.RAZONSOCIAL, A.N_FACTURA,B.F_RECIBIDO,KPROVCNF.PORCENTAJE,KPROVCNF.CATEGORIA
  END
END

