CREATE OR ALTER PROCEDURE DBO.SPQ_FCXP
	@JSON NVARCHAR(MAX)
WITH ENCRYPTION
AS 
DECLARE @PARAMETROS       NVARCHAR(MAX) 
	    ,@MODELO           VARCHAR(100)		,@METODO  VARCHAR(100)
	    ,@SEDE             VARCHAR(5)		,@USUARIO VARCHAR(20),			@DocAdq VARCHAR(20) , @Cuds varchar(256)
	    ,@CNSFCXP          VARCHAR(100)		,@dataFCXP NVARCHAR(MAX)		,@datoFCXPI NVARCHAR(MAX)	,@CNSMOV VARCHAR(20)
	    ,@SYS_COMPUTERNAME VARCHAR(200)		,@PROCESO VARCHAR(20)			,@CNSFCXPI VARCHAR(20)		,@datoFCXPDBCR NVARCHAR(MAX)
		,@CIUDAD			VARCHAR(20)		,@IDSEDE VARCHAR(20)			,@CUENTADB VARCHAR(20)		,@CUENTACR VARCHAR(20), @CNSINICIAL  INT, @VENCIDA     SMALLINT
		,@ITEM				INT				,@TIPO VARCHAR(20)				,@datoFCXPA NVARCHAR(MAX)	,@datoFCXPAD NVARCHAR(MAX), @CNSACTUAL   INT, @LONGFTRARS  INT
		,@CONTABILIZADA		INT				,@NROCOMPROBANTE VARCHAR(20)	,@CNSFCOM VARCHAR(20)		,@DATO VARCHAR(20)	,@IDNOTA VARCHAR(20), @CNSFINAL    INT
		,@dataFCXPD			NVARCHAR(MAX)	,@NOITEM INT					,@OBSERVACION VARCHAR(250)	,@PROCEDE INT		,@PROC VARCHAR(5), @PREFIJOFAC  VARCHAR(10)
		,@COMPANIA			VARCHAR(5)		,@TIPOCALCULO VARCHAR(10)		,@IDIMPUESTO VARCHAR(20)	,@IDCLASE VARCHAR(20)	,@WHERE_DATA VARCHAR(500),  @CNSNUEVO    INT
		,@FECHA_CAL			VARCHAR(8)		,@CALCULAR1 DECIMAL(14,2)		,@CALCULAR2 DECIMAL(14,2)	,@VALOR DECIMAL(14,2)	,@sqlCommand Nvarchar(max),  @CNSRESOL    VARCHAR(20)
		,@IMPUESTO		DECIMAL(14,2)		,@SELECCIONADOS VARCHAR(1000)	,@CONT INT					,@I INT		,@datoFCXPAG NVARCHAR(MAX)	,@SEDEPPAL    VARCHAR(6)
		,@IDCATEGORIA VARCHAR(10)			,@FECHA DATE					,@IDTERCERO VARCHAR(20)		,@DIAS INT		,@COUNT_SEL INT		,@PRE VARCHAR(20)
		,@DOC_DISTRIBUYE VARCHAR(20)		,@MANEXO BIT	,@PROCEDENCIA VARCHAR(20)	,@CONSECUTIVO NVARCHAR(MAX)		,@ITEM_DBCR INT	,@IMPUESTOS NVARCHAR(MAX)
DECLARE @IDMODELOCONT VARCHAR(20) , @IDTIPOCONT VARCHAR(20), @IDAREA VARCHAR(20), @PREFIJO VARCHAR(20), @CCOSTO VARCHAR(20), @CLASECONT VARCHAR(20), @IDSERVICIO VARCHAR(20)
		,@TITULO  NVARCHAR(MAX)
DECLARE @TBLERRORES TABLE(ERROR VARCHAR(500));
DECLARE @LOG_ERR TABLE (ERROR VARCHAR(500));
DECLARE @VLR_NETO DECIMAL(14,2), @VLR_GLOSAS DECIMAL(14,2),  @SALDO DECIMAL(14,2),@VLR_ABONOS DECIMAL(14,2),@VLR_NOTADB DECIMAL(14,2),@VLR_NOTACR DECIMAL(14,2)
BEGIN
	SET DATEFORMAT dmy
	SET NOCOUNT ON

	SELECT *
	INTO #JSON
	FROM OPENJSON(@json) WITH (
		METODO  VARCHAR(100) '$.METODO'
		,USUARIO VARCHAR(100) '$.USUARIO'
		,PARAMETROS NVARCHAR(MAX) AS JSON
	)

	SELECT @METODO     = METODO
		,@PARAMETROS = PARAMETROS
		,@USUARIO    = USUARIO
	FROM #JSON

	--SELECT @GRUPO = DBO.FNK_DESCIFRAR(GRUPO) FROM USUSU WHERE USUARIO = @USUARIO
	SELECT @SYS_COMPUTERNAME = SYS_COMPUTERNAME FROM USUSU WHERE USUARIO = @USUARIO
	SELECT @SEDE = IDSEDE, @IDSEDE = IDSEDE, @COMPANIA = COMPANIA FROM UBEQ WHERE SYS_ComputerName = @SYS_COMPUTERNAME
	
	IF @METODO = 'CONSULTAR'
	BEGIN
		SELECT @CNSFCXP = JSON_VALUE(@PARAMETROS, '$.CNSFCXP')

		SELECT 'OK' AS OK, @CNSFCXP AS CNSFCXP

		SELECT 
			FCXP.*
			,TER.RAZONSOCIAL
			,TER.NIT
			,TER.DV
			,TER.TIPO_ID
			,TGEN.DESCRIPCION AS TIPO_ID_DESC
			,FCXPD = (SELECT * FROM FCXPD WHERE CNSFCXP=FCXP.CNSFCXP FOR JSON PATH)
		FROM FCXP 
		INNER JOIN TER ON TER.IDTERCERO=FCXP.IDTERCERO
		LEFT JOIN TGEN ON TGEN.TABLA='General' AND TGEN.CAMPO='TIPOIDENT' AND TGEN.CODIGO=TER.TIPO_ID
		WHERE CNSFCXP=@CNSFCXP

	END
	IF @METODO = 'SEL_TODOS_HPRED'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)

		IF 1 = 2
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'XXXXXXXX'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
			
		BEGIN TRY 
			SELECT 'OK'OK
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END

	IF @METODO = 'CRUD_FCXP'
	BEGIN
		SELECT @dataFCXP =  dataFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		dataFCXP		NVARCHAR(MAX) AS JSON
		)

		SELECT @PROCESO =UPPER( JSON_VALUE(@dataFCXP,'$.PROCESO'))
		SELECT @IDSEDE = JSON_VALUE(@dataFCXP,'$.IDSEDE')
		IF EXISTS (SELECT   * FROM FCXP WHERE  CNSFCXP = JSON_VALUE(@dataFCXP,'$.CNSFCXP') AND COALESCE(CONTABILIZADA,0)=1)
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro ya se encuentra contabilizado'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		
		
		SELECT * INTO #DATAFCXP FROM OPENJSON(@dataFCXP)
		WITH(
		CNSFCXP				VARCHAR(20)		'$.CNSFCXP'				,TIPOCXP			VARCHAR(20)		'$.TIPOCXP'
		,IDSEDE				VARCHAR(20)		'$.IDSEDE'				,CIUDAD				VARCHAR(20)		'$.CIUDAD'
		,PROCEDENCIA		VARCHAR(20)		'$.PROCEDENCIA'			,IDTERCERO			VARCHAR(20)		'$.IDTERCERO'
		,CUECREDITO			VARCHAR(20)		'$.CUECREDITO'			,NOREFERENCIA		VARCHAR(20)		'$.NOREFERENCIA'
		,OBSERVACION		VARCHAR(200)	'$.OBSERVACION'			,FACCONTROL			VARCHAR(20)		'$.FACCONTROL'
		,VALOR				DECIMAL(14,2)	'$.VALOR'				,VLR_DESCUENTO		DECIMAL(14,2)	'$.VLR_DESCUENTO'
		,VLR_IVA			DECIMAL(14,2)	'$.VLR_IVA'				,VLR_NETO			DECIMAL(14,2)	'$.VLR_NETO'
		,VLR_IMPUESTOS		DECIMAL(14,2)	'$.VLR_IMPUESTOS'		,VLR_GLOSAS			DECIMAL(14,2)	'$.VLR_GLOSAS'
		,VLR_ABONOS			DECIMAL(14,2)	'$.VLR_ABONOS'			,VLR_NOTASDEBITO	DECIMAL(14,2)	'$.VLR_NOTASDEBITO'
		,VLR_NOTASCREDITO	DECIMAL(14,2)	'$.VLR_NOTASCREDITO'	,VLR_FLETE			DECIMAL(14,2)	'$.VLR_FLETE'
		,SALDO				DECIMAL(14,2)	'$.SALDO'				,SEAMORTIZA			BIT				'$.SEAMORTIZA'
		,NUMPERAMORT		INT				'$.NUMPERAMORT'			,TCAMBIO			DECIMAL(14,2)	'$.TCAMBIO'
		,CNSFCOM			VARCHAR(20)		'$.CNSFCOM'				,VARIOSTER			BIT				'$.VARIOSTER'
		,CNSRP				VARCHAR(20)		'$.CNSRP'				,CNSPPTO			VARCHAR(20)		'$.CNSPPTO'
		,CNSCDP				VARCHAR(20)		'$.CNSCDP')		

		IF DBO.FNK_VALORVARIABLE('PRESUP_CXP_ACTIVADO') = 'SI'  
			AND EXISTS (SELECT * FROM PTRP, #DATAFCXP WHERE PTRP.IDTERCERO = #DATAFCXP.IDTERCERO AND PTRP.CONSECUTIVO = YEAR(GETDATE()) 
															AND PTRP.ESTADO = 'Confirmado' AND COALESCE(#DATAFCXP.CNSRP,'') = '' )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Debe de seleccionar un registro de Presupuesto'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN 
		END
		IF (SELECT COUNT(*) FROM FCXP, #DATAFCXP WHERE FCXP.IDTERCERO= #DATAFCXP.IDTERCERO AND COALESCE(FCXP.NOREFERENCIA,'')<>'' AND FCXP.NOREFERENCIA = #DATAFCXP.IDTERCERO
			AND FCXP.ESTADO <> 'A' ) >0 AND UPPER(@PROCESO)='NUEVO'
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El No. de Referencia ya existe registrado en CxP de este proveedor.'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN 
		END
		IF (SELECT COUNT(*) FROM FCXP, #DATAFCXP WHERE FCXP.IDTERCERO= #DATAFCXP.IDTERCERO AND COALESCE(FCXP.NOREFERENCIA,'')<>'' AND FCXP.NOREFERENCIA = #DATAFCXP.IDTERCERO
			AND FCXP.ESTADO <> 'A' AND FCXP.CNSFCXP <> #DATAFCXP.CNSFCXP ) >0 AND UPPER(@PROCESO)='EDITAR'
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El No. de Referencia ya existe registrado en CxP de este proveedor.'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN 
		END
		--IF EXISTS (SELECT  * FROM FCXPD,#DATAFCXP WHERE FCXPD.CNSFCXP = #DATAFCXP.CNSFCXP) AND UPPER(@PROCESO)='EDITAR'
		--BEGIN
		--	INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro cuenta con detalle, no se puede realizar cambios.'
		--	SELECT 'KO' OK
		--	SELECT ERROR FROM @TBLERRORES
		--	RETURN 
		--END
		IF EXISTS (SELECT DBO.FNK_VALORVARIABLE('RESTRIN_CREA_CXP'))
		BEGIN
			IF (SELECT DBO.FNK_VALORVARIABLE('RESTRIN_CREA_CXP')) = 'TODO'
			BEGIN
				SELECT @COUNT_SEL = (SELECT COUNT(*) FROM FCXP,#DATAFCXP  WHERE FCXP.ESTADO='N' AND FCXP.PROCEDENCIA= #DATAFCXP.PROCEDENCIA AND NOT EXISTS(SELECT * FROM FCXPD WHERE FCXP.CNSFCXP=FCXPD.CNSFCXP))
			END
			IF (SELECT DBO.FNK_VALORVARIABLE('RESTRIN_CREA_CXP')) = 'TERCERO'
			BEGIN
				SELECT @COUNT_SEL = (SELECT COUNT(*) FROM FCXP,#DATAFCXP WHERE FCXP.ESTADO='N' AND FCXP.IDTERCERO= #DATAFCXP.IDTERCERO AND FCXP.PROCEDENCIA= #DATAFCXP.PROCEDENCIA AND NOT EXISTS(SELECT * FROM FCXPD WHERE FCXP.CNSFCXP=FCXPD.CNSFCXP))
			END
			IF (SELECT DBO.FNK_VALORVARIABLE('RESTRIN_CREA_CXP')) = 'USUARIO'
			BEGIN
				SELECT @COUNT_SEL = (SELECT COUNT(*) FROM FCXP,#DATAFCXP WHERE FCXP.ESTADO='N' AND FCXP.USUARIO= @USUARIO AND FCXP.PROCEDENCIA= #DATAFCXP.PROCEDENCIA AND NOT EXISTS(SELECT * FROM FCXPD WHERE FCXP.CNSFCXP=FCXPD.CNSFCXP))
			END
			IF (SELECT DBO.FNK_VALORVARIABLE('RESTRIN_CREA_CXP')) = 'USUTER'
			BEGIN
				SELECT @COUNT_SEL = (SELECT COUNT(*) FROM FCXP,#DATAFCXP WHERE FCXP.ESTADO='N' AND FCXP.IDTERCERO= #DATAFCXP.IDTERCERO AND FCXP.USUARIO= @USUARIO AND FCXP.PROCEDENCIA= #DATAFCXP.PROCEDENCIA AND NOT EXISTS(SELECT * FROM FCXPD WHERE FCXP.CNSFCXP=FCXPD.CNSFCXP))
			END
		END
		IF @COUNT_SEL > 0
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Existen Cuentas por Pagar para Este Tercero Sin Detalles y sin Definir.. Se Deben Terminar o Anular.'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN 
		END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				UPDATE FCXP SET 
				 TIPOCXP			= #DATAFCXP.TIPOCXP			
				,IDSEDE				= #DATAFCXP.IDSEDE				
				,CIUDAD				= #DATAFCXP.CIUDAD				
				,PROCEDENCIA		= #DATAFCXP.PROCEDENCIA		
				--,FECHA				= #DATAFCXP.FECHA		
				,FECHA				= COALESCE( REPLACE(JSON_VALUE(@dataFCXP ,'$.FECHA'),'-','') , DBO.FNK_GETDATE()) 
				,IDTERCERO			= #DATAFCXP.IDTERCERO			
				,CUECREDITO			= #DATAFCXP.CUECREDITO			
				,NOREFERENCIA		= #DATAFCXP.NOREFERENCIA		
				,F_FACTURAREF		= COALESCE( REPLACE(JSON_VALUE(@dataFCXP ,'$.F_FACTURAREF'),'-','') , DBO.FNK_GETDATE())		
				,F_VENCE			= COALESCE( REPLACE(JSON_VALUE(@dataFCXP ,'$.F_VENCE'),'-','') , DBO.FNK_GETDATE())		
				,OBSERVACION		= #DATAFCXP.OBSERVACION		
				,FACCONTROL			= #DATAFCXP.FACCONTROL			
				,VALOR				= #DATAFCXP.VALOR				
				,VLR_DESCUENTO		= #DATAFCXP.VLR_DESCUENTO		
				,VLR_IVA			= #DATAFCXP.VLR_IVA			
				,VLR_NETO			= #DATAFCXP.VLR_NETO			
				,VLR_IMPUESTOS		= #DATAFCXP.VLR_IMPUESTOS		
				,VLR_GLOSAS			= #DATAFCXP.VLR_GLOSAS			
				,VLR_ABONOS			= #DATAFCXP.VLR_ABONOS			
				,VLR_NOTASDEBITO	= #DATAFCXP.VLR_NOTASDEBITO	
				,VLR_NOTASCREDITO	= #DATAFCXP.VLR_NOTASCREDITO	
				,VLR_FLETE			= #DATAFCXP.VLR_FLETE			
				,SALDO				= #DATAFCXP.SALDO				
				,SEAMORTIZA			= #DATAFCXP.SEAMORTIZA			
				,NUMPERAMORT		= #DATAFCXP.NUMPERAMORT		
				,TCAMBIO			= #DATAFCXP.TCAMBIO			
				,CNSFCOM			= #DATAFCXP.CNSFCOM			
				,VARIOSTER			= #DATAFCXP.VARIOSTER	
				,CNSRP				= #DATAFCXP.CNSRP	
				,CNSPPTO			= #DATAFCXP.CNSPPTO	
				,CNSCDP				= #DATAFCXP.CNSCDP	
				,DOCEQUIVALENTE		= CASE WHEN TER.TIPOREGIMEN='S' AND COALESCE(TER.MANEXO,0)=1 THEN 1 ELSE 0 END
				FROM FCXP INNER JOIN #DATAFCXP ON FCXP.CNSFCXP = #DATAFCXP.CNSFCXP
							LEFT JOIN TER ON #DATAFCXP.IDTERCERO = TER.IDTERCERO

				UPDATE FCXP SET FCXP.CIUDAD = SED.CIUDAD 
				FROM FCXP 
				INNER JOIN #DATAFCXP ON FCXP.CNSFCXP = #DATAFCXP.CNSFCXP
				INNER JOIN SED ON FCXP.IDSEDE = SED.IDSEDE

			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				PRINT 'ENTRA A NUEVOO'
				SELECT @CIUDAD = CIUDAD FROM SED WHERE IDSEDE = @IDSEDE

				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Salud'
					SELECT @PROC = 'SA', @PRE = '@FCXPSL'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Compras'
					SELECT @PROC = 'CM', @PRE = '@FCXPCM'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Servicios'
					SELECT @PROC = 'SR', @PRE = '@FCXPSR'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Otros'
					SELECT @PROC = 'OT', @PRE = '@FCXPOT'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Contab'
					SELECT @PROC = 'CN', @PRE = '@FCXPCN'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Nomina'
					SELECT @PROC = 'NM', @PRE = '@FCXPNM'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'CAJAMENOR'
					SELECT @PROC = 'CJM', @PRE = '@FCXPCJM'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Anticipos'
					SELECT @PROC = 'AN', @PRE = '@FCXPANT'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'Caja'
					SELECT @PROC = 'CJ', @PRE = '@FCXPSL'
				IF (JSON_VALUE(@dataFCXP,'$.PROCEDENCIA')) = 'LevGlo'
					SELECT @PROC = 'LG', @PRE = '@FCXPLG'

				EXEC SPK_GENCONSECUTIVO '01', @SEDE, @PRE,  @CNSFCXP OUTPUT  
				SELECT @CNSFCXP = @SEDE +@PROC+ REPLACE(SPACE(6 - LEN(@CNSFCXP))+LTRIM(RTRIM(@CNSFCXP)),SPACE(1),0)

				INSERT INTO FCXP (
				CNSFCXP
				,TIPOCXP			
				,IDSEDE				
				,CIUDAD				
				,PROCEDENCIA		
				,FECHA				
				,IDTERCERO			
				,CUECREDITO			
				,NOREFERENCIA		
				,F_FACTURAREF		
				,F_VENCE			
				,OBSERVACION		
				,FACCONTROL			
				,VALOR				
				,VLR_DESCUENTO		
				,VLR_IVA			
				,VLR_NETO			
				,VLR_IMPUESTOS		
				,VLR_GLOSAS			
				,VLR_ABONOS			
				,VLR_NOTASDEBITO	
				,VLR_NOTASCREDITO	
				,VLR_FLETE			
				,SALDO				
				,SEAMORTIZA			
				,NUMPERAMORT		
				,TCAMBIO			
				,CNSFCOM			
				,VARIOSTER	
				, ESTADO, USUARIO, FECHAMOD, USUARIOMOD, MODALIDAD, COMPANIA, SYS_ComputerName
				, DOCEQUIVALENTE, CNSRP,CNSPPTO, CNSCDP
					)
				SELECT  --VALOR, SALDO, VLR_DESCUENTO, VLR_IVA, VLR_NETO, VLR_IMPUESTOS, VLR_NOTASDEBITO, VLR_GLOSAS, VLR_FLETE, VLR_NOTASCREDITO, VLR_ABONOS, VLR_TDOLAR
				@CNSFCXP
				 ,#DATAFCXP.TIPOCXP			
				 ,#DATAFCXP.IDSEDE			
				 ,#DATAFCXP.CIUDAD			
				 ,#DATAFCXP.PROCEDENCIA		
				 ,COALESCE( REPLACE(JSON_VALUE(@dataFCXP ,'$.FECHA'),'-','') , DBO.FNK_GETDATE())				
				 ,#DATAFCXP.IDTERCERO		
				 ,#DATAFCXP.CUECREDITO		
				 ,#DATAFCXP.NOREFERENCIA	
				 ,COALESCE( REPLACE(JSON_VALUE(@dataFCXP ,'$.F_FACTURAREF'),'-','') , DBO.FNK_GETDATE())			
				 ,COALESCE( REPLACE(JSON_VALUE(@dataFCXP ,'$.F_VENCE'),'-','') , DBO.FNK_GETDATE())				
				 ,COALESCE(#DATAFCXP.OBSERVACION,'')		
				 ,#DATAFCXP.FACCONTROL		
				 ,COALESCE(#DATAFCXP.VALOR,0)			
				 ,COALESCE(#DATAFCXP.VLR_DESCUENTO,0)	
				 ,COALESCE(#DATAFCXP.VLR_IVA,0)			
				 ,COALESCE(#DATAFCXP.VLR_NETO,0)		
				 ,COALESCE(#DATAFCXP.VLR_IMPUESTOS,0)	
				 ,COALESCE(#DATAFCXP.VLR_GLOSAS,0)		
				 ,COALESCE(#DATAFCXP.VLR_ABONOS,0)		
				 ,COALESCE(#DATAFCXP.VLR_NOTASDEBITO,0)	
				 ,COALESCE(#DATAFCXP.VLR_NOTASCREDITO,0)
				 ,COALESCE(#DATAFCXP.VLR_FLETE,0)		
				 ,COALESCE(#DATAFCXP.SALDO,0)			
				 ,#DATAFCXP.SEAMORTIZA		
				 ,#DATAFCXP.NUMPERAMORT		
				 ,#DATAFCXP.TCAMBIO			
				 ,#DATAFCXP.CNSFCOM			
				 ,#DATAFCXP.VARIOSTER
				 , 'N', @USUARIO, DBO.FNK_GETDATE(), @USUARIO, 'Evento',@COMPANIA  , @SYS_COMPUTERNAME
				 , CASE WHEN TER.TIPOREGIMEN='S' AND COALESCE(TER.MANEXO,0)=1 THEN 1 ELSE 0 END
				 , #DATAFCXP.CNSRP, #DATAFCXP.CNSPPTO, #DATAFCXP.CNSCDP
				 FROM #DATAFCXP LEFT JOIN TER ON #DATAFCXP.IDTERCERO = TER.IDTERCERO

				 UPDATE FCXP SET PERIODO_ANO = YEAR(FECHA), PERIODO_MES = MONTH(FECHA) WHERE CNSFCXP = @CNSFCXP

				 UPDATE FCXP SET FCXP.CIUDAD = SED.CIUDAD 
				FROM FCXP 
				INNER JOIN SED ON FCXP.IDSEDE = SED.IDSEDE
				WHERE FCXP.CNSFCXP = @CNSFCXP

				 SELECT 'OK'  OK, @CNSFCXP CNSFCXP
			END

		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'CRUD_FCXPD'
	BEGIN
		SELECT @dataFCXPD =  dataFCXPD
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		dataFCXPD		NVARCHAR(MAX) AS JSON
		)

		SELECT @PROCESO =UPPER( JSON_VALUE(@dataFCXPD,'$.PROCESO'))
		SELECT @IDSEDE = JSON_VALUE(@dataFCXPD,'$.IDSEDE')
		IF EXISTS (SELECT   * FROM FCXP WHERE  CNSFCXP = JSON_VALUE(@dataFCXPD,'$.CNSFCXP') AND COALESCE(CONTABILIZADA,0)=1)
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro ya se encuentra contabilizado'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT * INTO #DATAFCXPD FROM OPENJSON(@dataFCXPD)
		WITH(
		CNSFCXP				VARCHAR(20)		'$.CNSFCXP'			,ITEM				INT				'$.ITEM'
		,PROCEDENCIA		VARCHAR(20)		'$.PROCEDENCIA'		,REDONDEO			VARCHAR(20)		'$.REDONDEO'
		,MIMPCONSUMO		BIT				'$.MIMPCONSUMO'		,IDTERCERO			VARCHAR(20)		'$.IDTERCERO'
		,UNSPSC				VARCHAR(20)		'$.UNSPSC'			,IDSERVICIO			VARCHAR(20)		'$.IDSERVICIO'
		,CANTIDAD			DECIMAL(14,2)	'$.CANTIDAD'		,VALOR				DECIMAL(14,2)	'$.VALOR'
		,VLR_DOLARES		DECIMAL(14,2)	'$.VLR_DOLARES'		,VLR_DESCUENTO		DECIMAL(14,2)	'$.VLR_DESCUENTO'
		,VLR_IVA			DECIMAL(14,2)	'$.VLR_IVA'			,CUENTA_IVA			VARCHAR(20)		'$.CUENTA_IVA'
		,VLRIMPCONSUMO		DECIMAL(14,2)	'$.VLRIMPCONSUMO'	,CTAIMPCONSUMO		VARCHAR(20)		'$.CTAIMPCONSUMO'
		,VLR_GLOSAS			DECIMAL(14,2)	'$.VLR_GLOSAS'		,VLR_NETO			DECIMAL(14,2)	'$.VLR_NETO'
		,CCOSTO				VARCHAR(20)		'$.CCOSTO'			,IDSEDE				VARCHAR(20)		'$.IDSEDE'
		,CODUNG				VARCHAR(20)		'$.CODUNG'			,IDAREA				VARCHAR(20)		'$.IDAREA'
		,CUENTA_SER			VARCHAR(20)		'$.CUENTA_SER'		,RUBRO				VARCHAR(50)		'$.RUBRO'
		,PREFIJO			VARCHAR(20)		'$.PREFIJO'			,DISTRIBUYE			BIT				'$.DISTRIBUYE'
		,DISTRIBUCION		VARCHAR(20)		'$.DISTRIBUCION'		)

		SELECT @CNSFCXP = #DATAFCXPD.CNSFCXP  FROM #DATAFCXPD 
		IF UPPER(@PROCESO)='EDITAR' AND EXISTS (SELECT * FROM FCXP WHERE FCXP.CNSFCXP = @CNSFCXP AND COALESCE(FCXP.DISTRIBUYE,0) = 1)
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro de tipo Distribucion, no se puede editar.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
		 IF UPPER(@PROCESO)='NUEVO' AND EXISTS (SELECT * FROM FCXP WHERE FCXP.CNSFCXP = @CNSFCXP AND COALESCE(FCXP.DISTRIBUYE,0) = 1)
			AND EXISTS (SELECT * FROM FCXPD WHERE FCXPD.CNSFCXP = @CNSFCXP)
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'Ya cuenta con detalles de Tipo Distirbucion.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				UPDATE FCXPD SET  --DISTRIBUYE
					PROCEDENCIA		 = #DATAFCXPD.PROCEDENCIA	
					,REDONDEO		 = #DATAFCXPD.REDONDEO		
					,MIMPCONSUMO	 = #DATAFCXPD.MIMPCONSUMO	
					,IDTERCERO		 = #DATAFCXPD.IDTERCERO		
					,UNSPSC			 = #DATAFCXPD.UNSPSC			
					,IDSERVICIO		 = #DATAFCXPD.IDSERVICIO		
					,CANTIDAD		 = #DATAFCXPD.CANTIDAD		
					,VALOR			 = #DATAFCXPD.VALOR		
					,VLR_DOLARES	 = #DATAFCXPD.VLR_DOLARES	
					,VLR_DESCUENTO	 = #DATAFCXPD.VLR_DESCUENTO	
					,VLR_IVA		 = #DATAFCXPD.VLR_IVA		
					,CUENTA_IVA		 = #DATAFCXPD.CUENTA_IVA		
					,VLRIMPCONSUMO	 = #DATAFCXPD.VLRIMPCONSUMO	
					,CTAIMPCONSUMO	 = #DATAFCXPD.CTAIMPCONSUMO	
					,VLR_GLOSAS		 = #DATAFCXPD.VLR_GLOSAS		
					,VLR_NETO		 = #DATAFCXPD.VLR_NETO		
					,CCOSTO			 = #DATAFCXPD.CCOSTO			
					,IDSEDE			 = #DATAFCXPD.IDSEDE			
					--,CODUNG			 = #DATAFCXPD.CODUNG			
					,IDAREA			 = #DATAFCXPD.IDAREA			
					,CUENTA_SER		 = #DATAFCXPD.CUENTA_SER		
					,RUBRO			 = #DATAFCXPD.RUBRO			
					,PREFIJO		 = #DATAFCXPD.PREFIJO		
				FROM FCXPD INNER JOIN #DATAFCXPD ON FCXPD.CNSFCXP = #DATAFCXPD.CNSFCXP AND FCXPD.ITEM = #DATAFCXPD.ITEM 
				--UPDATE FCXPD SET IDSEDE = (SELECT IDSEDE FROM CEN WHERE CCOSTO = JSON_VALUE(@dataFCXPD,'$.CCOSTO'))
				--				, CODUNG = (SELECT TOP 1 CODUNG FROM SEDUNG WHERE CCOSTO = JSON_VALUE(@dataFCXPD,'$.CCOSTO') AND IDSEDE = (SELECT IDSEDE FROM CEN WHERE CCOSTO = JSON_VALUE(@dataFCXPD,'$.CCOSTO')) AND ESTADO = 'Activo' ) 
				--FROM FCXPD INNER JOIN #DATAFCXPD ON FCXPD.CNSFCXP = #DATAFCXPD.CNSFCXP AND FCXPD.ITEM = #DATAFCXPD.ITEM 
				SELECT @CNSFCXP = #DATAFCXPD.CNSFCXP from #DATAFCXPD
				IF (SELECT COUNT(*) FROM SEDUNG, #DATAFCXPD WHERE SEDUNG.ESTADO = 'Activo' AND SEDUNG.IDSEDE = #DATAFCXPD.IDSEDE AND SEDUNG.CCOSTO = #DATAFCXPD.CCOSTO ) > 0
					UPDATE FCXPD SET CODUNG =  (SELECT TOP 1 SEDUNG.CODUNG FROM SEDUNG, #DATAFCXPD WHERE SEDUNG.ESTADO = 'Activo' AND SEDUNG.IDSEDE = #DATAFCXPD.IDSEDE AND SEDUNG.CCOSTO = #DATAFCXPD.CCOSTO)    WHERE FCXPD.CNSFCXP =  @CNSFCXP AND FCXPD.ITEM = @ITEM

				EXEC SPK_CALCULOVALORESCXP @CNSFCXP 
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				PRINT 'ENTRA A NUEVOO'
				
				SELECT @IDSEDE = JSON_VALUE(@dataFCXPD,'$.IDSEDE')
				IF COALESCE(@IDSEDE,'') = '' 
					SELECT @IDSEDE = (SELECT IDSEDE FROM FCXP WHERE CNSFCXP = JSON_VALUE(@dataFCXPD,'$.CNSFCXP') )
	
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1  FROM FCXPD WHERE CNSFCXP = JSON_VALUE(@dataFCXPD,'$.CNSFCXP') --AND ITEM = JSON_VALUE(@dataFCXPD,'$.ITEM')

				INSERT INTO FCXPD (
				CNSFCXP			
				,ITEM			
				,PROCEDENCIA	
				,REDONDEO		
				,MIMPCONSUMO	
				,IDTERCERO		
				,UNSPSC			
				,IDSERVICIO		
				,CANTIDAD		
				,VALOR		
				,VLR_DOLARES	
				,VLR_DESCUENTO	
				,VLR_IVA		
				,CUENTA_IVA		
				,VLRIMPCONSUMO	
				,CTAIMPCONSUMO	
				,VLR_GLOSAS		
				,VLR_NETO		
				,CCOSTO			
				,IDSEDE			
				--,CODUNG	
				,IDAREA
				,CUENTA_SER		
				,RUBRO			
				,PREFIJO	
				,ESTADO
					)
				SELECT 
				 #DATAFCXPD.CNSFCXP			
				,@ITEM			
				,#DATAFCXPD.PROCEDENCIA	
				,#DATAFCXPD.REDONDEO		
				,#DATAFCXPD.MIMPCONSUMO	
				,#DATAFCXPD.IDTERCERO		
				,#DATAFCXPD.UNSPSC			
				,#DATAFCXPD.IDSERVICIO		
				,COALESCE(#DATAFCXPD.CANTIDAD,0)		
				,COALESCE(#DATAFCXPD.VALOR,0)		
				,COALESCE(#DATAFCXPD.VLR_DOLARES,0)	
				,COALESCE(#DATAFCXPD.VLR_DESCUENTO,0)	
				,COALESCE(#DATAFCXPD.VLR_IVA,0)		
				,#DATAFCXPD.CUENTA_IVA		
				,COALESCE(#DATAFCXPD.VLRIMPCONSUMO,0)	
				,#DATAFCXPD.CTAIMPCONSUMO	
				,COALESCE(#DATAFCXPD.VLR_GLOSAS,0)	
				,COALESCE(#DATAFCXPD.VLR_NETO,0)		
				,#DATAFCXPD.CCOSTO			
				,#DATAFCXPD.IDSEDE			
				--,#DATAFCXPD.CODUNG			
				,#DATAFCXPD.IDAREA			
				,#DATAFCXPD.CUENTA_SER		
				,#DATAFCXPD.RUBRO			
				,#DATAFCXPD.PREFIJO
				,'P'
				 FROM #DATAFCXPD

				SELECT @CNSFCXP = #DATAFCXPD.CNSFCXP from #DATAFCXPD

				IF (SELECT COUNT(*) FROM SEDUNG, #DATAFCXPD WHERE SEDUNG.ESTADO = 'Activo' AND SEDUNG.IDSEDE = #DATAFCXPD.IDSEDE AND SEDUNG.CCOSTO = #DATAFCXPD.CCOSTO ) > 0
					UPDATE FCXPD SET CODUNG =  (SELECT TOP 1 SEDUNG.CODUNG FROM SEDUNG, #DATAFCXPD WHERE SEDUNG.ESTADO = 'Activo' AND SEDUNG.IDSEDE = #DATAFCXPD.IDSEDE AND SEDUNG.CCOSTO = #DATAFCXPD.CCOSTO)    WHERE FCXPD.CNSFCXP =  @CNSFCXP AND FCXPD.ITEM = @ITEM

				IF EXISTS(SELECT * FROM #DATAFCXPD WHERE #DATAFCXPD.DISTRIBUYE = 1)
				BEGIN
					SELECT @DOC_DISTRIBUYE = DISTRIBUCION FROM  #DATAFCXPD
					UPDATE FCXP SET DISTRIBUYE = 1, DOC_DISTRIBUYE = @DOC_DISTRIBUYE WHERE FCXP.CNSFCXP = @CNSFCXP
					EXEC SPK_GENERAR_FDIS @DOC_DISTRIBUYE ,@CNSFCXP, @ITEM
				END
				EXEC SPK_CALCULOVALORESCXP @CNSFCXP 
			END

		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	

	IF @METODO = 'CRUD_FCXPI'
	BEGIN
		SELECT @datoFCXPI =  datoFCXPI
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		datoFCXPI		NVARCHAR(MAX) AS JSON
		)
		SELECT @PROCESO =UPPER( JSON_VALUE(@datoFCXPI,'$.PROCESO'))

		SELECT * INTO #datoFCXPI FROM  OPENJSON(@datoFCXPI)
		WITH (
		CNSFCXP				VARCHAR(20)			'$.CNSFCXP'			,CNSFCXPI			VARCHAR(20)			'$.CNSFCXPI'
		,IMPUESTO_ASUM		BIT					'$.IMPUESTO_ASUM'	,CUENTA_ASUM		VARCHAR(20)			'$.CUENTA_ASUM'
		,TIPOCALCULO		VARCHAR(20)			'$.TIPOCALCULO'		,IDIMPUESTO			VARCHAR(20)			'$.IDIMPUESTO'
		,IDCLASE			VARCHAR(20)			'$.IDCLASE'			,ITEM				INT					'$.ITEM'
		,VALORIMP			DECIMAL(14,2)		'$.VALORIMP'		,BASE				DECIMAL(14,2)		'$.BASE'
		,FECHAINI			DATE				'$.FECHAINI'		,FECHAFIN			DATE				'$.FECHAFIN'
		,VALOR				DECIMAL(14,2)		'$.VALOR'			,CUENTA				VARCHAR(20)			'$.CUENTA'
		,PROCEDENCIA		VARCHAR(10)			'$.PROCEDENCIA' )

		SELECT @TIPOCALCULO = TIPOCALCULO,@CNSFCXP = CNSFCXP, @IDIMPUESTO = IDIMPUESTO, @IDCLASE = IDCLASE  FROM #datoFCXPI
		IF @TIPOCALCULO = 'Automatico' 
			SELECT @FECHA_CAL = COALESCE( REPLACE(CONVERT(DATE,FCXP.F_FACTURAREF),'-',''),NULL), @CALCULAR1 =  FCXP.VALOR-VLR_DESCUENTO-VLR_GLOSAS,
			@CALCULAR2 = FCXP.VLR_IVA 
			FROM FCXP WHERE FCXP.ESTADO<>'A' AND FCXP.CNSFCXP = @CNSFCXP

		IF DBO.FNK_ValorVariable('IDIMP_RETEIVA') = @IDIMPUESTO
		BEGIN 
			SELECT @FECHA_CAL = COALESCE( REPLACE(CONVERT(DATE,FCXP.F_FACTURAREF),'-',''),NULL), @CALCULAR1 = FCXP.VLR_IVA 
			FROM FCXP WHERE FCXP.ESTADO<>'A' AND FCXP.CNSFCXP = @CNSFCXP
		END
		ELSE
		BEGIN
			SELECT @FECHA_CAL = COALESCE( REPLACE(CONVERT(DATE,FCXP.F_FACTURAREF),'-',''),NULL), @CALCULAR1 = FCXP.VALOR-VLR_DESCUENTO-VLR_GLOSAS
			FROM FCXP WHERE FCXP.ESTADO<>'A' AND FCXP.CNSFCXP = @CNSFCXP
		END

		IF @TIPOCALCULO = 'Automatico' AND NOT EXISTS (SELECT * FROM DBO.FNK_CALCULO_IMPUESTO (@IDIMPUESTO, @IDCLASE, @CALCULAR1, @FECHA_CAL ))
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Este impuesto no se encuentra configurado para la vigencia de la CXP, Revise la Configuración'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF UPPER(@PROCESO)='ELIMINAR' AND (SELECT CONTABILIZADA FROM FCXP, #datoFCXPI WHERE  FCXP.CNSFCXP = #datoFCXPI.CNSFCXP	) = 1
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro se encuentra contabilizado'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF UPPER(@PROCESO)='EDITAR' AND (SELECT CONTABILIZADA FROM FCXP, #datoFCXPI WHERE  FCXP.CNSFCXP = #datoFCXPI.CNSFCXP	) = 1
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro se encuentra contabilizado'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				UPDATE FCXPI SET 
				IMPUESTO_ASUM		= #datoFCXPI.IMPUESTO_ASUM		
				,CUENTA_ASUM		= #datoFCXPI.CUENTA_ASUM		
				,TIPOCALCULO		= #datoFCXPI.TIPOCALCULO		
				,IDIMPUESTO			= #datoFCXPI.IDIMPUESTO			
				,IDCLASE			= #datoFCXPI.IDCLASE			
				,ITEM				= #datoFCXPI.ITEM				
				,VALORIMP			= #datoFCXPI.VALORIMP			
				,BASE				= #datoFCXPI.BASE				
				,FECHAINI			= REPLACE(JSON_VALUE(@datoFCXPI ,'$.FECHAINI'),'-','') 	
				,FECHAFIN			= REPLACE(JSON_VALUE(@datoFCXPI ,'$.FECHAFIN'),'-','') 	
				,VALOR				= #datoFCXPI.VALOR				
				,CUENTA				= #datoFCXPI.CUENTA				
				,PROCEDENCIA		= #datoFCXPI.PROCEDENCIA	
				FROM FCXPI INNER JOIN #datoFCXPI ON FCXPI.CNSFCXPI = #datoFCXPI.CNSFCXPI
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1  FROM FCXPI WHERE CNSFCXP = @CNSFCXP

				SET @CNSFCXPI=SPACE(20)  
				--EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@FCXPI',@CNSFCXPI OUTPUT  
				--SELECT @CNSFCXPI = @SEDE + REPLACE(SPACE(8 - LEN(@CNSFCXPI))+LTRIM(RTRIM(@CNSFCXPI)),SPACE(1),0)  
				--EXEC SPQ_GENSEQUENCE @SEDE,'@FCXPI',NULL ,@CNSFCXPI OUTPUT  
				EXEC SPQ_GENSEQUENCE @SEDE = @SEDE, @PREFIJO = '@FCXPI', @EXTRA = '', @LONGITUD = 8, @NVOCONSEC = @CNSFCXPI OUTPUT

				INSERT INTO FCXPI (
				CNSFCXP			
				,CNSFCXPI		
				,IMPUESTO_ASUM	
				,CUENTA_ASUM	
				,TIPOCALCULO	
				,IDIMPUESTO		
				,IDCLASE		
				,ITEM			
				,VALORIMP		
				,BASE			
				,FECHAINI		
				,FECHAFIN		
				,VALOR			
				,CUENTA			
				,PROCEDENCIA	)
				SELECT 
				 #datoFCXPI.CNSFCXP			
				,@CNSFCXPI		
				,#datoFCXPI.IMPUESTO_ASUM	
				,#datoFCXPI.CUENTA_ASUM	
				,#datoFCXPI.TIPOCALCULO	
				,#datoFCXPI.IDIMPUESTO		
				,#datoFCXPI.IDCLASE		
				,COALESCE(#datoFCXPI.ITEM,@ITEM)		
				,#datoFCXPI.VALORIMP		
				,#datoFCXPI.BASE			
				,REPLACE(JSON_VALUE(@datoFCXPI ,'$.FECHAINI'),'-','') 		
				,REPLACE(JSON_VALUE(@datoFCXPI ,'$.FECHAFIN'),'-','') 		
				,#datoFCXPI.VALOR			
				,#datoFCXPI.CUENTA			
				,'Otros'
				FROM #datoFCXPI
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1  FROM FCXPAD WHERE CNSFCXP = JSON_VALUE(@datoFCXPAD,'$.CNSFCXP') AND ITEM = JSON_VALUE(@datoFCXPAD,'$.ITEM')
			END
			IF UPPER(@PROCESO)='ELIMINAR'
			BEGIN
				DELETE FCXPI  FROM FCXPI INNER JOIN #datoFCXPI ON FCXPI.CNSFCXPI = #datoFCXPI.CNSFCXPI
			END
			print 'SPK_CALCULOVALORESCXP'
			EXEC SPK_CALCULOVALORESCXP @CNSFCXP 
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'CRUD_FCXPDBCR'
	BEGIN
		SELECT @datoFCXPDBCR =  datoFCXPDBCR
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		datoFCXPDBCR		NVARCHAR(MAX) AS JSON
		)
		SELECT @PROCESO =UPPER( JSON_VALUE(@datoFCXPDBCR,'$.PROCESO'))
		SELECT * INTO #datoFCXPDBCR FROM  OPENJSON(@datoFCXPDBCR)
		WITH (
		CNSFCXP					VARCHAR(20)			'$.CNSFCXP'				,ITEM				INT					'$.ITEM'
		,IDNOTA					VARCHAR(20)			'$.IDNOTA'				,TIPO				VARCHAR(20)			'$.TIPO'
		,DECRUCES				INT					'$.DECRUCES'			,GIVA				BIT					'$.GIVA'
		,GIMPUESTOS				BIT					'$.GIMPUESTOS'			,VALOR				DECIMAL(14,2)		'$.VALOR'
		,PORCENTAJEIVA			DECIMAL(14,2)		'$.PORCENTAJEIVA'		,VALORIVA			DECIMAL(14,2)		'$.VALORIVA'
		,GENCXP					BIT					'$.GENCXP'				,VLR_IMPUESTOS		DECIMAL(14,2)		'$.VLR_IMPUESTOS'
		,VLR_NETO				DECIMAL(14,2)		'$.VLR_NETO'			,CAMTER				BIT					'$.CAMTER'
		,IDTERCEROGENCXP		VARCHAR(20)			'$.IDTERCEROGENCXP'		,IDSERVICIO			VARCHAR(20)			'$.IDSERVICIO'
		,NODOCUMENTO			VARCHAR(20)			'$.NODOCUMENTO'			,OBSERVACION		VARCHAR(200)		'$.OBSERVACION'
		,PROCEDENCIA			VARCHAR(10)			'$.PROCEDENCIA'			,CUENTA_DB			VARCHAR(20)			'$.CUENTA_DB'
		,CUENTA_CR				VARCHAR(20)			'$.CUENTA_CR'			,CCOSTO				VARCHAR(20)			'$.CCOSTO'
		,NOREFERENCIA			VARCHAR(20)			'$.NOREFERENCIA'		,CODUNG				VARCHAR(20)			'$.CODUNG'
		,CODPRG					VARCHAR(20)			'$.CODPRG'				,USUARIO			VARCHAR(20)			'$.USUARIO'
		,SYS_COMPUTERNAME		VARCHAR(20)			'$.SYS_COMPUTERNAME'	,NROCOMPROBANTE		VARCHAR(20)			'$.NROCOMPROBANTE' )

		IF (SELECT ESTADO FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')) = 'A'
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'LA  CXP ESTA ANULADA O NO EXISTE'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
		 IF (SELECT COALESCE(SALDO,0) FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')) <=0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'LA CXP NO TIENE SALDO PARA HACER NOTAS'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				SELECT @CUENTADB=CUENTA, @TIPO = TIPO FROM FNT WHERE IDNOTA = JSON_VALUE(@datoFCXPDBCR,'$.IDNOTA') 
				SELECT @CNSFCXP=CNSFCXP, @CUENTACR=CUECREDITO FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')
				UPDATE  FCXPDBCR SET 
				IDNOTA				  = #datoFCXPDBCR.IDNOTA				
				,TIPO				  = @TIPO				
				,DECRUCES			  = #datoFCXPDBCR.DECRUCES			
				,FECHA				  = REPLACE(JSON_VALUE(@datoFCXPDBCR ,'$.FECHA'),'-','') 				
				,GIVA				  = #datoFCXPDBCR.GIVA				
				,GIMPUESTOS			  = #datoFCXPDBCR.GIMPUESTOS			
				,VALOR				  = #datoFCXPDBCR.VALOR				
				,PORCENTAJEIVA		  = DBO.FNK_VALORVARIABLE('IDIVA')	
				,VALORIVA			  = #datoFCXPDBCR.VALORIVA			
				,GENCXP				  = #datoFCXPDBCR.GENCXP				
				,VLR_IMPUESTOS		  = #datoFCXPDBCR.VLR_IMPUESTOS		
				,VLR_NETO			  = #datoFCXPDBCR.VLR_NETO			
				,CAMTER				  = #datoFCXPDBCR.CAMTER				
				,IDTERCEROGENCXP	  = #datoFCXPDBCR.IDTERCEROGENCXP	
				,IDSERVICIO			  = #datoFCXPDBCR.IDSERVICIO			
				,NODOCUMENTO		  = #datoFCXPDBCR.NODOCUMENTO		
				,OBSERVACION		  = #datoFCXPDBCR.OBSERVACION		
				,PROCEDENCIA		  = #datoFCXPDBCR.PROCEDENCIA		
				,CUENTA_DB			  = @CUENTADB			
				,CUENTA_CR			  = @CUENTACR			
				,CCOSTO				  = #datoFCXPDBCR.CCOSTO				
				,NOREFERENCIA		  = #datoFCXPDBCR.NOREFERENCIA		
				,CODUNG				  = #datoFCXPDBCR.CODUNG				
				,CODPRG				  = #datoFCXPDBCR.CODPRG				
				,USUARIO			  = #datoFCXPDBCR.USUARIO			
				,SYS_COMPUTERNAME	  = #datoFCXPDBCR.SYS_COMPUTERNAME	
				,NROCOMPROBANTE		  = #datoFCXPDBCR.NROCOMPROBANTE	
				FROM FCXPDBCR INNER JOIN #datoFCXPDBCR ON FCXPDBCR.CNSFCXP = #datoFCXPDBCR.CNSFCXP AND FCXPDBCR.ITEM = #datoFCXPDBCR.ITEM
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				SELECT @CUENTADB=CUENTA, @TIPO = TIPO FROM FNT WHERE IDNOTA = JSON_VALUE(@datoFCXPDBCR,'$.IDNOTA') 
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1 FROM FCXPDBCR WHERE CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')
				SELECT @CNSFCXP=CNSFCXP, @CUENTACR=CUECREDITO FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')

				INSERT INTO FCXPDBCR (
				CNSFCXP				
				,ITEM				
				,IDNOTA				
				,TIPO				
				,DECRUCES			
				,FECHA				
				,GIVA				
				,GIMPUESTOS			
				,VALOR				
				,PORCENTAJEIVA		
				,VALORIVA			
				,GENCXP				
				,VLR_IMPUESTOS		
				,VLR_NETO			
				,CAMTER				
				,IDTERCEROGENCXP	
				,IDSERVICIO			
				,NODOCUMENTO		
				,OBSERVACION		
				,PROCEDENCIA		
				,CUENTA_DB			
				,CUENTA_CR			
				,CCOSTO				
				,NOREFERENCIA		
				,CODUNG				
				,CODPRG				
				,USUARIO			
				,SYS_COMPUTERNAME	
				,NROCOMPROBANTE	, ESTADO	
				)
				SELECT 
				#datoFCXPDBCR.CNSFCXP				
				,@ITEM			
				,#datoFCXPDBCR.IDNOTA				
				,@TIPO			
				,#datoFCXPDBCR.DECRUCES			
				,REPLACE(JSON_VALUE(@datoFCXPDBCR ,'$.FECHA'),'-','') 					
				,#datoFCXPDBCR.GIVA				
				,#datoFCXPDBCR.GIMPUESTOS			
				,#datoFCXPDBCR.VALOR				
				,DBO.FNK_VALORVARIABLE('IDIVA')		
				,#datoFCXPDBCR.VALORIVA			
				,#datoFCXPDBCR.GENCXP				
				,#datoFCXPDBCR.VLR_IMPUESTOS		
				,#datoFCXPDBCR.VLR_NETO			
				,#datoFCXPDBCR.CAMTER				
				,#datoFCXPDBCR.IDTERCEROGENCXP	
				,#datoFCXPDBCR.IDSERVICIO			
				,#datoFCXPDBCR.NODOCUMENTO		
				,#datoFCXPDBCR.OBSERVACION		
				,#datoFCXPDBCR.PROCEDENCIA		
				,@CUENTADB		
				,@CUENTACR			
				,#datoFCXPDBCR.CCOSTO				
				,#datoFCXPDBCR.NOREFERENCIA		
				,#datoFCXPDBCR.CODUNG				
				,#datoFCXPDBCR.CODPRG				
				,@USUARIO			
				,@SYS_COMPUTERNAME
				,#datoFCXPDBCR.NROCOMPROBANTE	, 'N'	
				FROM #datoFCXPDBCR
			END
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'CRUD_FCXPDBCR_2'
	BEGIN
		SELECT @datoFCXPDBCR =  datoFCXPDBCR, @CONSECUTIVO = CONSECUTIVO, @IMPUESTOS = IMPUESTOS
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		datoFCXPDBCR		NVARCHAR(MAX) AS JSON
		,CONSECUTIVO		NVARCHAR(MAX) AS JSON
		,IMPUESTOS			NVARCHAR(MAX) AS JSON
		)
		SELECT * INTO #CONSECUTIVO FROM  OPENJSON(@CONSECUTIVO)
		WITH (	CNSFCXP		VARCHAR(20)			'$.CNSFCXP'
				,ITEM		INT					'$.ITEM')

		SELECT * INTO #IMPUESTOS FROM  OPENJSON(@IMPUESTOS)
		WITH (	CNSFCXPI		VARCHAR(20)			'$.CNSFCXPI')

		SELECT @PROCESO =UPPER( JSON_VALUE(@datoFCXPDBCR,'$.PROCESO'))
		SELECT * INTO #datoFCXPDBCR_2 FROM  OPENJSON(@datoFCXPDBCR)
		WITH (
		CNSFCXP					VARCHAR(20)		'$.CNSFCXP'				,ITEM					INT				'$.ITEM'
		,IDNOTA					VARCHAR(20)		'$.IDNOTA'				,TIPO					VARCHAR(20)		'$.TIPO'
		,DECRUCES				INT				'$.DECRUCES'			,GIVA					BIT				'$.GIVA'
		,GIMPUESTOS				BIT				'$.GIMPUESTOS'			,VALOR					DECIMAL(14,2)	'$.VALOR'
		,PORCENTAJEIVA			DECIMAL(14,2)	'$.PORCENTAJEIVA'		,VALORIVA				DECIMAL(14,2)	'$.VALORIVA'
		,GENCXP					BIT				'$.GENCXP'				,VLR_IMPUESTOS			DECIMAL(14,2)	'$.VLR_IMPUESTOS'
		,VLR_NETO				DECIMAL(14,2)	'$.VLR_NETO'			,CAMTER					BIT				'$.CAMTER'
		,IDTERCEROGENCXP		VARCHAR(20)		'$.IDTERCEROGENCXP'		,IDSERVICIO				VARCHAR(20)		'$.IDSERVICIO'
		,NODOCUMENTO			VARCHAR(20)		'$.NODOCUMENTO'			,OBSERVACION			VARCHAR(200)	'$.OBSERVACION'
		,PROCEDENCIA			VARCHAR(10)		'$.PROCEDENCIA'			,CUENTA_DB				VARCHAR(20)		'$.CUENTA_DB'
		,CUENTA_CR				VARCHAR(20)		'$.CUENTA_CR'			,CCOSTO					VARCHAR(20)		'$.CCOSTO'
		,NOREFERENCIA			VARCHAR(20)		'$.NOREFERENCIA'		,CODUNG					VARCHAR(20)		'$.CODUNG'
		,CODPRG					VARCHAR(20)		'$.CODPRG'				,USUARIO				VARCHAR(20)		'$.USUARIO'
		,SYS_COMPUTERNAME		VARCHAR(20)		'$.SYS_COMPUTERNAME'	,NROCOMPROBANTE			VARCHAR(20)		'$.NROCOMPROBANTE'
		,TIPO_TOTAL				BIT				'$.TIPO_TOTAL'			,ITEMS					BIT				'$.ITEMS')
		
		IF (SELECT ESTADO FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')) = 'A'
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'LA CXP ESTA ANULADA O NO EXISTE'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF UPPER(@PROCESO)='EDITAR' AND EXISTS (SELECT  * FROM FCXPDBCR WHERE CNSCXP = JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP') )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La CXP ya cuenta con una Nota.'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				SELECT @CUENTADB=CUENTA, @TIPO = TIPO FROM FNT WHERE IDNOTA = JSON_VALUE(@datoFCXPDBCR,'$.IDNOTA') 
				SELECT @CNSFCXP=CNSFCXP, @CUENTACR=CUECREDITO FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')
				UPDATE  FCXPDBCR SET 
				IDNOTA				  = #datoFCXPDBCR_2.IDNOTA				
				,TIPO				  = @TIPO				
				,DECRUCES			  = #datoFCXPDBCR_2.DECRUCES			
				,FECHA				  = REPLACE(JSON_VALUE(@datoFCXPDBCR ,'$.FECHA'),'-','') 				
				,GIVA				  = #datoFCXPDBCR_2.GIVA				
				,GIMPUESTOS			  = #datoFCXPDBCR_2.GIMPUESTOS			
				,VALOR				  = #datoFCXPDBCR_2.VALOR				
				,PORCENTAJEIVA		  = DBO.FNK_VALORVARIABLE('IDIVA')	
				,VALORIVA			  = #datoFCXPDBCR_2.VALORIVA			
				,GENCXP				  = #datoFCXPDBCR_2.GENCXP				
				,VLR_IMPUESTOS		  = #datoFCXPDBCR_2.VLR_IMPUESTOS		
				,VLR_NETO			  = #datoFCXPDBCR_2.VLR_NETO			
				,CAMTER				  = #datoFCXPDBCR_2.CAMTER				
				,IDTERCEROGENCXP	  = #datoFCXPDBCR_2.IDTERCEROGENCXP	
				,IDSERVICIO			  = #datoFCXPDBCR_2.IDSERVICIO			
				,NODOCUMENTO		  = #datoFCXPDBCR_2.NODOCUMENTO		
				,OBSERVACION		  = #datoFCXPDBCR_2.OBSERVACION		
				,PROCEDENCIA		  = #datoFCXPDBCR_2.PROCEDENCIA		
				,CUENTA_DB			  = @CUENTADB			
				,CUENTA_CR			  = @CUENTACR			
				,CCOSTO				  = #datoFCXPDBCR_2.CCOSTO				
				,NOREFERENCIA		  = #datoFCXPDBCR_2.NOREFERENCIA		
				,CODUNG				  = #datoFCXPDBCR_2.CODUNG				
				,CODPRG				  = #datoFCXPDBCR_2.CODPRG				
				,USUARIO			  = #datoFCXPDBCR_2.USUARIO			
				,SYS_COMPUTERNAME	  = #datoFCXPDBCR_2.SYS_COMPUTERNAME	
				,NROCOMPROBANTE		  = #datoFCXPDBCR_2.NROCOMPROBANTE	
				FROM FCXPDBCR INNER JOIN #datoFCXPDBCR_2 ON FCXPDBCR.CNSFCXP = #datoFCXPDBCR_2.CNSFCXP AND FCXPDBCR.ITEM = #datoFCXPDBCR_2.ITEM
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				SELECT @CUENTADB=CUENTA, @TIPO = TIPO FROM FNT WHERE IDNOTA = JSON_VALUE(@datoFCXPDBCR,'$.IDNOTA') 
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1 FROM FCXPDBCR WHERE CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')
				SELECT @CNSFCXP=CNSFCXP, @CUENTACR=CUECREDITO FROM FCXP WHERE  CNSFCXP= JSON_VALUE(@datoFCXPDBCR,'$.CNSFCXP')

				INSERT INTO FCXPDBCR (
				CNSFCXP				
				,ITEM				
				,IDNOTA				
				,TIPO				
				,DECRUCES			
				,FECHA				
				,GIVA				
				,GIMPUESTOS			
				,VALOR				
				,PORCENTAJEIVA		
				,VALORIVA			
				,GENCXP				
				,VLR_IMPUESTOS		
				,VLR_NETO			
				,CAMTER				
				,IDTERCEROGENCXP	
				,IDSERVICIO			
				,NODOCUMENTO		
				,OBSERVACION		
				,PROCEDENCIA		
				,CUENTA_DB			
				,CUENTA_CR			
				,CCOSTO				
				,NOREFERENCIA		
				,CODUNG				
				,CODPRG				
				,USUARIO			
				,SYS_COMPUTERNAME	
				,NROCOMPROBANTE	, ESTADO	, ORIGEN, TIPO_TOTAL
				)
				SELECT 
				#datoFCXPDBCR_2.CNSFCXP				
				,@ITEM			
				,#datoFCXPDBCR_2.IDNOTA				
				,@TIPO			
				,#datoFCXPDBCR_2.DECRUCES			
				,REPLACE(JSON_VALUE(@datoFCXPDBCR ,'$.FECHA'),'-','') 					
				,#datoFCXPDBCR_2.GIVA				
				,#datoFCXPDBCR_2.GIMPUESTOS			
				,#datoFCXPDBCR_2.VALOR				
				,#datoFCXPDBCR_2.PORCENTAJEIVA	
				,#datoFCXPDBCR_2.VALORIVA			
				,#datoFCXPDBCR_2.GENCXP				
				,#datoFCXPDBCR_2.VLR_IMPUESTOS		
				,#datoFCXPDBCR_2.VLR_NETO			
				,#datoFCXPDBCR_2.CAMTER				
				,#datoFCXPDBCR_2.IDTERCEROGENCXP	
				,#datoFCXPDBCR_2.IDSERVICIO			
				,#datoFCXPDBCR_2.NODOCUMENTO		
				,#datoFCXPDBCR_2.OBSERVACION		
				,#datoFCXPDBCR_2.PROCEDENCIA		
				,@CUENTADB		
				,@CUENTACR			
				,#datoFCXPDBCR_2.CCOSTO				
				,#datoFCXPDBCR_2.NOREFERENCIA		
				,#datoFCXPDBCR_2.CODUNG				
				,#datoFCXPDBCR_2.CODPRG				
				,@USUARIO			
				,@SYS_COMPUTERNAME
				,#datoFCXPDBCR_2.NROCOMPROBANTE	, 'N'	, 'QUASAR', #datoFCXPDBCR_2.TIPO_TOTAL
				FROM #datoFCXPDBCR_2
--QUERY 2
--QUERY 2			
				IF (SELECT COUNT(*) FROM #CONSECUTIVO)>0 AND (SELECT COALESCE(#datoFCXPDBCR_2.ITEMS,0) FROM #datoFCXPDBCR_2 ) = 1
					AND (SELECT COALESCE(#datoFCXPDBCR_2.TIPO_TOTAL,0) FROM #datoFCXPDBCR_2 ) = 0 
				BEGIN
					DECLARE @VALOR_DESC decimal(16,2), @TOTAL DECIMAL(16,2)
					SELECT @VALOR_DESC = (SELECT VALOR FROM #datoFCXPDBCR_2 )
					SELECT @TOTAL = (SELECT SUM (FCXPD.VLR_NETO) FROM FCXPD, #CONSECUTIVO WHERE FCXPD.CNSFCXP = #CONSECUTIVO.CNSFCXP AND FCXPD.ITEM = #CONSECUTIVO.ITEM)
					INSERT INTO FCXPDNOT( CNSFCXP, ITEM, IDSERVICIO,  VALOR_DESCUENTO
					,DESCTO
					,VLR_DESCTO
					,VLR_DT_IVA
					,VLR_DT_PROD
					,CTA_IVA
					,CTA_SER
					,AFECTA_IVA
					,AFECTA_IMPUESTOS
					,CANTIDAD
					,VALOR
					,PORIVA
					,VLR_IVA
					,VLR_NETO
					,FECHA_CREA
					,ITEM_DBCR
					)
					SELECT #CONSECUTIVO.CNSFCXP, #CONSECUTIVO.ITEM, FCXPD.IDSERVICIO,  @VALOR_DESC
					, (FCXPD.VLR_NETO*100)/@TOTAL 
					, ((FCXPD.VLR_NETO*100)/@TOTAL)/100 * @VALOR_DESC 
					, (((FCXPD.VLR_NETO*100)/@TOTAL)/100 * @VALOR_DESC) *  ((FCXPD.VLR_IVA*100) /FCXPD.VLR_NETO )/100
					, (((FCXPD.VLR_NETO*100)/@TOTAL)/100 * @VALOR_DESC ) - ((((FCXPD.VLR_NETO*100)/@TOTAL)/100 * @VALOR_DESC) *  ((FCXPD.VLR_IVA*100) /FCXPD.VLR_NETO )/100 )
					, FCXPD.CUENTA_IVA
					, FCXPD.CUENTA_SER
					, #datoFCXPDBCR_2.GIVA
					, #datoFCXPDBCR_2.GIMPUESTOS
					, FCXPD.CANTIDAD
					, FCXPD.VALOR
					, (FCXPD.VLR_IVA*100) /FCXPD.VLR_NETO
					, FCXPD.VLR_IVA
					, FCXPD.VLR_NETO
					, DBO.FNK_GETDATE()
					, @ITEM
					FROM #CONSECUTIVO, FCXPD , #datoFCXPDBCR_2
					WHERE #CONSECUTIVO.CNSFCXP = FCXPD.CNSFCXP AND #CONSECUTIVO.ITEM = FCXPD.ITEM
				END

				IF (SELECT COUNT(*) FROM #IMPUESTOS)>0 AND (SELECT COALESCE(#datoFCXPDBCR_2.GIMPUESTOS,0) FROM #datoFCXPDBCR_2 ) = 1
					AND (SELECT COALESCE(#datoFCXPDBCR_2.TIPO_TOTAL,0) FROM #datoFCXPDBCR_2 ) = 0 
				BEGIN
					INSERT INTO FCXPDBCRIMP ( CNSFCXP, ITEM_DBCR, CNSFCXPI, BASE_DBCR, VALORIMP_DBCR, VALOR_DBCR, OBSERVACION, FECHA)
					SELECT #datoFCXPDBCR_2.CNSFCXP,@ITEM,#IMPUESTOS.CNSFCXPI, NULL, NULL,NULL,NULL,DBO.FNK_GETDATE() 
					FROM #IMPUESTOS , #datoFCXPDBCR_2
				END

			END
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	
	IF @METODO = 'CRUD_FCXPA'
	BEGIN
		SELECT @datoFCXPA =  datoFCXPA
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		datoFCXPA		NVARCHAR(MAX) AS JSON
		)
		SELECT @PROCESO =UPPER( JSON_VALUE(@datoFCXPA,'$.PROCESO'))
		SELECT * INTO #datoFCXPA FROM OPENJSON (@datoFCXPA)
		WITH(
		CNSFCXP					VARCHAR(20)						'$.CNSFCXP'
		,ITEM					INT					'$.ITEM'
		,FECHA					DATETIME					'$.FECHA'
		,SALDOANTERIOR			DECIMAL(14,2)					'$.SALDOANTERIOR'
		,VALORPERIODO			DECIMAL(14,2)					'$.VALORPERIODO'
		,TOTALAMORTIZADO		DECIMAL(14,2)						'$.TOTALAMORTIZADO'
		,CONTABILIZADA			BIT					'$.CONTABILIZADA'
		,MARCACONT				BIT					'$.MARCACONT'
		,NROCOMPROBANTE			VARCHAR(20)						'$.NROCOMPROBANTE'
		)
		IF 1 = 2
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'XXXXXXXX'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				UPDATE FCXPA SET
				 FECHA				= REPLACE(JSON_VALUE(@datoFCXPA ,'$.FECHA'),'-','') 		
				,SALDOANTERIOR		= #datoFCXPA.SALDOANTERIOR		
				,VALORPERIODO		= #datoFCXPA.VALORPERIODO		
				,TOTALAMORTIZADO	= #datoFCXPA.TOTALAMORTIZADO	
				,CONTABILIZADA		= #datoFCXPA.CONTABILIZADA		
				,MARCACONT			= #datoFCXPA.MARCACONT			
				,NROCOMPROBANTE		= #datoFCXPA.NROCOMPROBANTE		
				FROM FCXPA INNER JOIN #datoFCXPA ON FCXPA.CNSFCXP = #datoFCXPA.CNSFCXP AND  FCXPA.ITEM = #datoFCXPA.ITEM
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				--SELECT @ITEM = MAX(ITEM) FROM FCXPA WHERE CNSFCXP = JSON_VALUE(@datoFCXPA,'$.CNSFCXP')
				--SET @ITEM = ISNULL(@ITEM,0)
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1 FROM FCXPA WHERE CNSFCXP = JSON_VALUE(@datoFCXPA,'$.CNSFCXP')

				INSERT INTO FCXPA (
				CNSFCXP				
				,ITEM		
				,FECHA
				,SALDOANTERIOR		
				,VALORPERIODO		
				,TOTALAMORTIZADO	
				,CONTABILIZADA		
				,MARCACONT			
				,NROCOMPROBANTE		
				)
				SELECT
				 #datoFCXPA.CNSFCXP				
				,@ITEM	
				,REPLACE(JSON_VALUE(@datoFCXPA ,'$.FECHA'),'-','') 
				,#datoFCXPA.SALDOANTERIOR		
				,#datoFCXPA.VALORPERIODO		
				,#datoFCXPA.TOTALAMORTIZADO	
				,#datoFCXPA.CONTABILIZADA		
				,#datoFCXPA.MARCACONT			
				,#datoFCXPA.NROCOMPROBANTE		
				FROM #datoFCXPA
			END
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'CRUD_FCXPAD'
	BEGIN
		SELECT @datoFCXPAD =  datoFCXPAD
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		datoFCXPAD		NVARCHAR(MAX) AS JSON
		)
		SELECT @PROCESO =UPPER( JSON_VALUE(@datoFCXPAD,'$.PROCESO'))
		SELECT * INTO #datoFCXPAD FROM OPENJSON (@datoFCXPAD)
		WITH(
		CNSFCXP					VARCHAR(20)						'$.CNSFCXP'
		,ITEM					INT								'$.ITEM'
		,CCOSTO					VARCHAR(20)						'$.CCOSTO'
		,VLRASIGNADO			DECIMAL(14,2)					'$.VLRASIGNADO'
		,PRCASIGNADO			DECIMAL(14,2)					'$.PRCASIGNADO'
		,CUENTA					VARCHAR(20)						'$.CUENTA'
		)
		IF 1 = 2
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'XXXXXXXX'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				UPDATE FCXPAD SET
				 CCOSTO			= #datoFCXPAD.CCOSTO			
				,VLRASIGNADO	= #datoFCXPAD.VLRASIGNADO	
				,PRCASIGNADO	= #datoFCXPAD.PRCASIGNADO	
				,CUENTA			= #datoFCXPAD.CUENTA			
				FROM FCXPAD INNER JOIN #datoFCXPAD ON FCXPAD.CNSFCXP = #datoFCXPAD.CNSFCXP AND  FCXPAD.ITEM = #datoFCXPAD.ITEM
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN
				--SELECT @ITEM = MAX(ITEM) FROM FCXPAD WHERE CNSFCXP = JSON_VALUE(@datoFCXPAD,'$.CNSFCXP') AND ITEM = JSON_VALUE(@datoFCXPAD,'$.ITEM')
				--SET @ITEM = ISNULL(@ITEM,0)
				SELECT @ITEM=COALESCE(MAX(ITEM),0)+1  FROM FCXPAD WHERE CNSFCXP = JSON_VALUE(@datoFCXPAD,'$.CNSFCXP') AND ITEM = JSON_VALUE(@datoFCXPAD,'$.ITEM')

				INSERT INTO FCXPAD (
				CNSFCXP			
				,ITEM			
				,CCOSTO			
				,VLRASIGNADO	
				,PRCASIGNADO	
				,CUENTA			
				)
				SELECT
				 #datoFCXPAD.CNSFCXP				
				,#datoFCXPAD.ITEM	
				,#datoFCXPAD.CCOSTO			
				,#datoFCXPAD.VLRASIGNADO	
				,#datoFCXPAD.PRCASIGNADO	
				,#datoFCXPAD.CUENTA		
				FROM #datoFCXPAD
			END
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'ANULAR_FCXP'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
		SELECT @IDSEDE= IDSEDE FROM FCXP WHERE CNSFCXP = @CNSFCXP

		IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(ESTADO,'') = 'A') 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El registro ya se encuentra anulado.'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(N_FACTURA,'') <> '' AND COALESCE(DOCEQUIVALENTE,0) = 1) 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No puede anular la CXP esta ya tiene asociado un consecutivo de Anexo Soporte, por favor realiza una Nota'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF  (SELECT DBO.FNK_VALORVARIABLE('PRESUP_CXP_ACTIVADO')) = 'SI' AND EXISTS (SELECT  * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(ENPRESUPUESTO,0) = 1 )
			AND EXISTS(SELECT  * FROM PTCXP WHERE CNSCXP = @CNSFCXP AND ESTADO <> 'Anulado' )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Cuenta Por Pagar Esta en Presupuesto y se Encuentra Confirmada'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(CONTABILIZADA,0) = 1) 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No puede anular la CXP esta ya tiene asociado un consecutivo de Anexo Soporte, por favor realiza una Nota'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		BEGIN TRY 
			EXEC SPK_ANULAR_CXP @CNSFCXP ,  '01', @IDSEDE
			--SPK_CONTAB_CXP
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'CONTABILIZAR_FCXP'
	BEGIN
      PRINT 'INGRESO AL MODULO'
		SELECT @CNSFCXP =  CNSFCXP --@IDSEDE
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
      PRINT @CNSFCXP
		SELECT @IDSEDE= IDSEDE,@CONTABILIZADA =  COALESCE(CONTABILIZADA,0), @VLR_NETO = COALESCE(VLR_NETO,0), 
              @VLR_GLOSAS = COALESCE(VLR_GLOSAS,0),@SALDO = SALDO,@VLR_ABONOS=COALESCE(VLR_ABONOS,0),@VLR_NOTACR=COALESCE(VLR_NOTASCREDITO,0),
              @VLR_NOTADB=COALESCE(VLR_NOTASDEBITO,0),@NROCOMPROBANTE=NROCOMPROBANTE,@FECHA=F_FACTURAREF
		FROM FCXP WHERE CNSFCXP = @CNSFCXP

		IF COALESCE(@IDSEDE,'')=''
		BEGIN
			SELECT @IDSEDE = @SEDE
		END
		IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND PROCEDENCIA in( 'Nomina','CAJAMENOR' ))
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Procedencia de la CXP no permite no permite Envio o Deshacer contabilización'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      IF @CONTABILIZADA = 0
      BEGIN
         IF @VLR_NETO <=0 OR  @SALDO<= 0 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El Valor de la Cuenta Por Pagar Es Menor que Cero(0).'
         END
         IF DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP') = 'SI'
         BEGIN
            IF EXISTS(SELECT * FROM FCXPD WHERE CNSFCXP = @CNSFCXP AND COALESCE(VLR_IVA, 0)> 0 AND  COALESCE(CUENTA_IVA, '') = '')
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'La cuenta Contable de IVA no esta Matriculada en los Detalles de la CXP.'
            END
         END
         IF NOT EXISTS (SELECT * FROM FCXP INNER JOIN CUE ON FCXP.CUECREDITO = CUE.CUENTA WHERE FCXP.CNSFCXP = @CNSFCXP AND CUE.TIPO = 'Detalle' )
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La Cuenta Contable de la CXP No Existe En El Plan Contable'
         END
         IF EXISTS (SELECT * FROM FCXPD WHERE COALESCE(CUENTA_SER,'NO') NOT IN(SELECT CUENTA FROM CUE WHERE TIPO='Detalle') AND FCXPD.CNSFCXP = @CNSFCXP )
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La Cuenta Contable de los Detalles de la  CXP No Existe En El Plan Contable'
         END
         IF EXISTS (SELECT * FROM FCXPD WHERE CNSFCXP= @CNSFCXP AND COALESCE(VLR_DOLARES,0)>0)
         BEGIN
            IF (SELECT COALESCE(TCAMBIO,0) FROM FCXP WHERE CNSFCXP= @CNSFCXP ) <= 0
            BEGIN
			      INSERT INTO @TBLERRORES(ERROR) SELECT 'No se Ha Digitado el Valor de la Tasa Cambiaria... '
            END
         END
      END
      ELSE
      BEGIN
         IF @CONTABILIZADA=1
         BEGIN
            IF NOT EXISTS(SELECT * FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND ESTADO=2 AND COALESCE(ANULADO,0)<>1)
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'Inconsistencia, el comprobante contable no esta contabilizado, Verifique e intente de nuevo'
            END
            IF @VLR_ABONOS>0 OR @VLR_NOTACR>0 OR @VLR_NOTADB>0
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'Cuenta por pagar con Movimientos Financieros, no se puede Descontabilizar'
            END
            IF EXISTS(SELECT   * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(N_FACTURA,'')<>'' AND COALESCE(ESTADODIAN, 0)<>0 ) 
		      BEGIN
			      INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede descontabilizar una CXP que haya sido procesado ante la Dian '
            END
         END
      END
		IF  (SELECT COUNT(*) FROM FCXPP WHERE  CNSFCXP=@CNSFCXP AND ESTADO<>'A')>0
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La cuenta por Pagar YA Tiene Orndenes de Pago... No Se Puede Anular el Comprobante'
		END
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK, ERROR FROM @TBLERRORES
         RETURN
      END	
      PRINT 'VOY A CONTABILIDAD '+STR(@CONTABILIZADA)
		BEGIN TRY 
			IF @CONTABILIZADA = 0
			BEGIN
				PRINT 'ENTRA A CONTABILIZAR'
				EXEC SPK_CALCULOVALORESCXP @CNSFCXP 
				EXEC SPK_NC_CONTAB_CXP @CNSFCXP, @USUARIO, @SYS_COMPUTERNAME, '01', @IDSEDE, @NROCOMPROBANTE
            SELECT @NROCOMPROBANTE=CASE WHEN CONTABILIZADA=1 THEN NROCOMPROBANTE ELSE '' END FROM FCXP WHERE CNSFCXP=@CNSFCXP
			END
			IF @CONTABILIZADA = 1 
			BEGIN
            IF NOT EXISTS(SELECT * FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND MCP.ANO=YEAR(DBO.FNK_GETDATE()) AND MCP.MES=MONTH(DBO.FNK_GETDATE()))
            BEGIN
               PRINT 'ES DE UNA VIGENCIA DIFERENTE'
				   EXEC SPK_REVERSAR_MCP_BANCO @NROCOMPROBANTE, '01', @IDSEDE, @USUARIO, @SYS_COMPUTERNAME, ''
               SELECT @NROCOMPROBANTE=''
            END
            ELSE
            BEGIN
					PRINT 'ENTRA A ACTUALIZAR ........'
					UPDATE MCP SET ANULADO = 1 WHERE NROCOMPROBANTE = @NROCOMPROBANTE
					EXEC SPK_REVISAR_COMPROBANTE '01', @NROCOMPROBANTE
					EXEC SPK_SUMA_DBCR @NROCOMPROBANTE
               SELECT @NROCOMPROBANTE=''
            END
            PRINT 'LIBERO LA CXP'
				UPDATE FCXP SET CONTABILIZADA = 0, NROCOMPROBANTE = NULL WHERE CNSFCXP = @CNSFCXP
			END
			IF @CONTABILIZADA = 2
			BEGIN
				IF EXISTS (SELECT  * FROM FCXP WHERE DOCEQUIVALENTE=1 AND N_FACTURA<>'' AND ESTADODIAN<>0 AND CNSFCXP = @CNSFCXP)
				BEGIN
					INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede descontabilizar una CXP que haya sido procesado ante la Dian'
					SELECT 'KO' OK
					SELECT ERROR FROM @TBLERRORES
					RETURN
				END
				IF EXISTS (SELECT  * FROM FCXP WHERE (SALDO<=0 OR VLR_ABONOS>0 OR VLR_NOTASCREDITO>0 OR VLR_NOTASDEBITO>0) AND CNSFCXP = @CNSFCXP)
				BEGIN
					INSERT INTO @TBLERRORES(ERROR) SELECT 'La Cuenta por Pagar ya Tiene Abonos O La Cuenta Por Pagar No Tiene Saldo'
					SELECT 'KO' OK
					SELECT ERROR FROM @TBLERRORES
					RETURN
				END
				IF EXISTS (SELECT * FROM FCXPP WHERE CNSFCXP = @CNSFCXP AND ESTADO <> 'A')
				BEGIN
					INSERT INTO @TBLERRORES(ERROR) SELECT 'La cuenta por Pagar YA Tiene Orndenes de Pago.'
					SELECT 'KO' OK
					SELECT ERROR FROM @TBLERRORES
					RETURN
				END
				UPDATE FCXP SET CONTABILIZADA = 0 WHERE CNSFCXP = @CNSFCXP 
				DELETE MCHE WHERE  NROCOMPROBANTE  = @NROCOMPROBANTE
				DELETE MCPE WHERE  NROCOMPROBANTE = @NROCOMPROBANTE
            SELECT @NROCOMPROBANTE=''
			END
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK,@NROCOMPROBANTE AS NROCOMPROBANTE
		RETURN
	END

	IF @METODO = 'RECALCULAR_FCXP'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
		SELECT @IDSEDE= IDSEDE FROM FCXP WHERE CNSFCXP = @CNSFCXP
		
		BEGIN TRY 
			EXEC SPK_CALCULOVALORESCXP @CNSFCXP 
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'PRESUPUESTO_FCXP'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
		SELECT @IDSEDE= IDSEDE FROM FCXP WHERE CNSFCXP = @CNSFCXP
		
		BEGIN TRY 
			EXEC SPK_ENTREGA_CXP_PTTO @CNSFCXP 
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'CAMBIA_FCXP'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
		SELECT @IDSEDE= IDSEDE, @CNSFCOM = CNSFCOM FROM FCXP WHERE CNSFCXP = @CNSFCXP
		IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(CNSFCOM,'') = '') 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No Proviene de Inventario No se puede Realizar el Cambio'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF (SELECT COUNT(*) FROM IMOV WHERE  CNSFCOM = @CNSFCOM AND ESTADO = 1) <= 0
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No existe Entreda al inventario Relacionada a la orden de Compra, no se puede realizar el Cambio'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		BEGIN TRY 
			UPDATE IMOV SET TIPO_DOC_COMPRA = 'R' , IDTIPOMOV = (SELECT DBO.FNK_VALORVARIABLE('IDINVMOV_REMISION_EN')) WHERE IMOV.CNSFCOM = @CNSFCOM AND ESTADO = 1
			UPDATE IMOVH SET ENCXP = 0 FROM IMOVH INNER JOIN IMOV ON IMOVH.CNSMOV = IMOV.CNSMOV WHERE IMOV.CNSFCOM = @CNSFCOM AND IMOV.ESTADO = 1
			EXEC SPK_ANULAR_CXP @CNSFCXP, '01', @IDSEDE
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'PRESTABLECIDOS_FCXP'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
		SELECT @IDSEDE= IDSEDE, @CNSFCOM = CNSFCOM FROM FCXP WHERE CNSFCXP = @CNSFCXP
		IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(VLR_IMPUESTOS,0) > 0 AND COALESCE(CONTABILIZADA,0) <> 0) 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Debe Seleccionar un registro Sim Impuestos, sin Contabilizar'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		
		BEGIN TRY 
			SET @DATO = (SELECT DBO.FNK_VALORVARIABLE('IDINVMOV_REMISION_EN'))
			EXEC SPK_IMPUESTOS_CXP @CNSFCXP, @DATO, '01', @IDSEDE
			EXEC SPK_CALCULOVALORESCXP @CNSFCXP
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'PRESTABLECIDOS_FCXP_MASIVO'
	BEGIN
		SELECT  @SELECCIONADOS = SELECCIONADOS
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		SELECCIONADOS		VARCHAR(1000) '$.SELECCIONADOS'
		)

		DECLARE @TTABLE TABLE (ITEM INT IDENTITY, CNSFCXP VARCHAR(13) )
		INSERT INTO @ttable( CNSFCXP )
		SELECT VALUE from string_split(@SELECCIONADOS,',')SELECCIONADOS

		SET @DATO = (SELECT DBO.FNK_VALORVARIABLE('IDINVMOV_REMISION_EN'))

		BEGIN TRY 
			SELECT @CONT = COUNT(*) FROM @ttable
			SELECT @I = 1
			WHILE @I <= @CONT
			BEGIN
				SELECT @CNSFCXP = CNSFCXP FROM @ttable WHERE ITEM = @I
				IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(VLR_IMPUESTOS,0) > 0 AND COALESCE(CONTABILIZADA,0) <> 0)
				BEGIN
					SET @I= @I + 1
				END
				ELSE
				BEGIN
					SELECT @IDSEDE= IDSEDE, @CNSFCOM = CNSFCOM FROM FCXP WHERE CNSFCXP = @CNSFCXP

					EXEC SPK_IMPUESTOS_CXP @CNSFCXP, @DATO, '01', @IDSEDE
					EXEC SPK_CALCULOVALORESCXP @CNSFCXP
					SET @I= @I + 1
				END
			END

		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'CONTABILIZADO_FCXP_MASIVO'
	BEGIN
		SELECT  @SELECCIONADOS = SELECCIONADOS
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		SELECCIONADOS		VARCHAR(1000) '$.SELECCIONADOS'
		)

		DECLARE @TABLE TABLE (ITEM INT IDENTITY, CNSFCXP VARCHAR(13) )
		INSERT INTO @table( CNSFCXP )
		SELECT VALUE from string_split(@SELECCIONADOS,',')SELECCIONADOS

		SET @DATO = (SELECT DBO.FNK_VALORVARIABLE('IDINVMOV_REMISION_EN'))

		BEGIN TRY 
			SELECT @CONT = COUNT(*) FROM @table
			SELECT @I = 1
			WHILE @I <= @CONT
			BEGIN
				SELECT @CNSFCXP = CNSFCXP FROM @table WHERE ITEM = @I
				SET @CALCULAR1 = 0
				IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP  AND COALESCE(CONTABILIZADA,0) <> 0)
				BEGIN
					SET @I= @I + 1 
					SET @CALCULAR1 = 1
					PRINT '1'
				END
				IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP  AND COALESCE(CONTABILIZADA,0) = 0 AND COALESCE(VLR_NETO,0) <= 0 ) AND  DBO.FNK_VALORVARIABLE('IDTIPOCXP_DEFAULT') = 'IPS' AND  @CALCULAR1 = 0
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '2'
				END
				IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP  AND COALESCE(CONTABILIZADA,0) = 0 AND COALESCE(SALDO,0) <= 0 ) AND  DBO.FNK_VALORVARIABLE('IDTIPOCXP_DEFAULT') = 'IPS' AND  @CALCULAR1 = 0
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '3'
				END
				IF EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP  AND COALESCE(CONTABILIZADA,0) = 0 AND COALESCE(VLR_NETO,0) <= 0 AND COALESCE(VLR_GLOSAS,0) <= 0 ) AND  @CALCULAR1 = 0
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '4'
				END
				IF EXISTS (SELECT * FROM FCXPD WHERE COALESCE(VLR_IVA, 0) <> 0 AND  COALESCE(CUENTA_IVA, '') = '' AND CNSFCXP = @CNSFCXP) 
					AND  DBO.FNK_VALORVARIABLE('CUENTA_IVA_CXP') = 'SI' AND  @CALCULAR1 = 0
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '5'
				END
				IF  (SELECT COUNT(*) FROM FCXP A INNER JOIN CUE B ON A.CUECREDITO=B.CUENTA WHERE A.CNSFCXP = @CNSFCXP AND B.TIPO='Detalle') = 0 AND  @CALCULAR1 = 0
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '6'
				END
				IF  (SELECT COUNT(*) FROM FCXPD WHERE COALESCE(CUENTA_SER,'NO') NOT IN(SELECT CUENTA FROM CUE WHERE TIPO='Detalle') AND CNSFCXP = @CNSFCXP) > 0 AND  @CALCULAR1 = 0
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '7'
				END
				
				IF  @CALCULAR1 = 0 AND  DBO.FNK_VALORVARIABLE('PRESUP_CXP_ACTIVADO') = 'SI' AND EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP  AND COALESCE(ENPRESUPUESTO,0) = 0) AND (SELECT COUNT(*) FROM FCXPD WHERE CNSFCXP = @CNSFCXP AND COALESCE(RUBRO,'')='' ) = 0
					AND EXISTS (SELECT * 
								FROM   FCXP INNER JOIN FCXPD ON FCXPD.CNSFCXP = FCXP.CNSFCXP 
											INNER JOIN PTRPD ON FCXP.CNSPPTO  = PTRPD.CONSECUTIVO 
															AND FCXP.CNSCDP   = PTRPD.CDP 
															AND FCXP.CNSRP    = PTRPD.RP 
															AND FCXPD.RUBRO   = PTRPD.RUBRO 
								WHERE  FCXP.CNSFCXP = @CNSFCXP
								AND    FCXPD.VLR_NETO > PTRPD.SALDO)
				BEGIN
					SET @I= @I + 1
					SET @CALCULAR1 = 1
					PRINT '8'
				END
				IF  @CALCULAR1 = 0 AND  DBO.FNK_VALORVARIABLE('PRESUP_CXP_ACTIVADO') = 'SI' AND EXISTS (SELECT * FROM FCXP WHERE CNSFCXP = @CNSFCXP  AND COALESCE(ENPRESUPUESTO,0) = 0) AND (SELECT COUNT(*) FROM FCXPD WHERE CNSFCXP = @CNSFCXP AND COALESCE(RUBRO,'')='' ) = 0
					AND NOT EXISTS (SELECT COUNT(*) 
						FROM   FCXP INNER JOIN FCXPD ON FCXPD.CNSFCXP = FCXP.CNSFCXP 
									INNER JOIN PTRPD ON FCXP.CNSPPTO  = PTRPD.CONSECUTIVO 
													AND FCXP.CNSCDP   = PTRPD.CDP 
													AND FCXP.CNSRP    = PTRPD.RP 
													AND FCXPD.RUBRO   = PTRPD.RUBRO 
						WHERE  FCXP.CNSFCXP = @CNSFCXP
						AND    FCXPD.VLR_NETO > PTRPD.SALDO)
				BEGIN
					PRINT '99'
					EXEC SPK_ENTREGA_CXP_PTTO @CNSFCXP, @USUARIO
				END
				IF  @CALCULAR1 = 0
				BEGIN
					PRINT '100'
					SELECT @NROCOMPROBANTE = COALESCE(NROCOMPROBANTE,''), @IDSEDE = IDSEDE FROM FCXP WHERE  CNSFCXP=@CNSFCXP 

					EXEC SPK_NC_CONTAB_CXP @CNSFCXP, @USUARIO, @SYS_COMPUTERNAME, '01', @IDSEDE, @NROCOMPROBANTE
					--IF DBO.FNK_VALORVARIABLE('CXP_NIFF_ACTIVADO') = 'SI'  /* NO EXISTEEEEEE */
					--BEGIN
					--	EXEC SPK_NIFF_VALORPRESENTE_CXP @CNSFCXP, '01', @IDSEDE, @USUARIO, @SYS_COMPUTERNAME
					--END
					SET @I= @I + 1
				END
			END

		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'RECALCULAR_FCXP_MASIVO'
	BEGIN
		SELECT  @SELECCIONADOS = SELECCIONADOS 
		FROM OPENJSON(@PARAMETROS)
		WITH( SELECCIONADOS		NVARCHAR(MAX)		'$.SELECCIONADOS' )

		SELECT ROW_NUMBER() OVER(ORDER BY FCXP.CNSFCXP DESC) AS FILA_CITA , FCXP.CNSFCXP INTO #DATOS FROM FCXP WHERE CNSFCXP IN (SELECT VALUE from string_split(@SELECCIONADOS,','))

		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				DECLARE @ITEM_INT INT
				DECLARE @LIMITE INT
				SELECT @ITEM_INT=1,@LIMITE=0
				SELECT @LIMITE=COUNT(*) FROM  #DATOS
				WHILE @ITEM_INT<=@LIMITE
				BEGIN
					SET @CNSFCXP = NULL
					SELECT @CNSFCXP = CNSFCXP  FROM #DATOS WHERE FILA_CITA = @ITEM_INT
					EXEC SPK_CALCULOVALORESCXP @CNSFCXP
					SELECT @ITEM_INT = @ITEM_INT+1 
				END
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END
	IF @METODO = 'CONTABILIZAR_NOTACREDITO'
	BEGIN
		SELECT  @CNSFCXP = CNSFCXP , @ITEM = ITEM
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		'$.CNSFCXP'
				,ITEM		INT				'$.ITEM')

		SELECT @SALDO = COALESCE(SALDO,0) FROM FCXP WHERE CNSFCXP = @CNSFCXP
		IF EXISTS (SELECT 1 FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(CONTABILIZADA,0) = 0 )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La CXP no se ha enviado a Contabilidad.'
		END
		IF EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM=@ITEM AND COALESCE(CONTABILIZADA,0) <> 0 )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Nota ya ha sido enviada a contabilidad.'
		END
		IF EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM = @ITEM AND TIPO = 'DB' AND (@SALDO-VLR_NETO) < 0 )
		BEGIN
			SELECT @VLR_NETO = COALESCE(VLR_NETO,0) FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM = @ITEM
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La operacion de esta nota no es permitida por dejar el saldo SALDO = ' + @SALDO + ' VLR_NETO = ' + @VLR_NETO + ' de la CxP con un valor inferior a cero (0).' 
		END
		IF (SELECT COUNT(1) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				IF (SELECT COALESCE(GENCXP,0) FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM = @ITEM ) = 1
				BEGIN
					EXEC SPK_CIERRA_FCXPDBCR @CNSFCXP, @ITEM, @IDSEDE, @USUARIO
					IF DBO.FNK_VALORVARIABLE('CONT_FCXPDBCR_Y_FCXP') = 'SI'
					BEGIN
                  EXEC SPK_NC_CONTAB_CXPFNT @CNSFCXP, @ITEM, @USUARIO, @SYS_COMPUTERNAME, @COMPANIA, @IDSEDE, ''
                  SELECT @CONTABILIZADA=CONTABILIZADA, @VALOR=VALOR, @TIPO=TIPO FROM FCXPDBCR WHERE CNSFCXP=@CNSFCXP AND ITEM=@ITEM
                  IF @CONTABILIZADA IN (1,2)
                  BEGIN
                        IF @TIPO='DB'
                           UPDATE FCXP SET VLR_NOTASDEBITO = ISNULL(VLR_NOTASDEBITO,0) + @VALOR WHERE CNSFCXP=@CNSFCXP

                        IF @TIPO='CR'
                           UPDATE FCXP SET VLR_NOTASCREDITO = ISNULL(VLR_NOTASCREDITO,0) + @VALOR WHERE CNSFCXP=@CNSFCXP
                  END
						SELECT  'OK' OK ,  'SI' VENTANA,COALESCE(GENCXP,0) GENCXP FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM = @ITEM
					END
				END
				IF (SELECT COALESCE(GENCXP,0) FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM = @ITEM ) = 0
      		BEGIN
               EXEC SPQ_NC_CONTAB_CXPFNT @CNSFCXP, @ITEM, @USUARIO, @SYS_COMPUTERNAME, @COMPANIA, @IDSEDE, ''
               SELECT @CONTABILIZADA=CONTABILIZADA, @VALOR=VALOR, @TIPO=TIPO 
               FROM FCXPDBCR WHERE CNSFCXP=@CNSFCXP AND ITEM=@ITEM
               IF @CONTABILIZADA IN (1,2)
               BEGIN
                  IF @TIPO='DB'
                        UPDATE FCXP SET VLR_NOTASDEBITO = ISNULL(VLR_NOTASDEBITO,0) + @VALOR WHERE CNSFCXP=@CNSFCXP

                  IF @TIPO='CR'
                        UPDATE FCXP SET VLR_NOTASCREDITO = ISNULL(VLR_NOTASCREDITO,0) + @VALOR WHERE CNSFCXP=@CNSFCXP
               END
					SELECT 'OK' OK ,  'SI' VENTANA,COALESCE(GENCXP,0) GENCXP, CONTABILIZADA, NROCOMPROBANTE FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM = @ITEM
				END
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END
	IF @METODO = 'ENVIARDIAN_NOTACREDITO'
	BEGIN
		SELECT  @CNSFCXP = CNSFCXP , @ITEM = ITEM
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		'$.CNSFCXP'
				,ITEM		INT				'$.ITEM')

		SELECT @SALDO = COALESCE(SALDO,0) FROM FCXP WHERE CNSFCXP = @CNSFCXP
		IF EXISTS (SELECT 1 FROM FCXP WHERE CNSFCXP = @CNSFCXP AND COALESCE(CONTABILIZADA,0) = 0 )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La CXP no se ha enviado a Contabilidad.'
		END
		IF EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM=@ITEM AND COALESCE(CONTABILIZADA,0) =0 )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Nota no ha sido enviada a contabilidad, debe contabilizarla primero.'
		END
		IF NOT EXISTS (SELECT 1 FROM FCXP WHERE CNSFCXP = @CNSFCXP AND ESTADODIAN=2 AND DOCEQUIVALENTE=1 )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La CXP no ha sido enviado a la DIAN aun.'
		END
		IF NOT EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM=@ITEM AND COALESCE(ESTADODIAN,0) IN (0,3,1) )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Nota ya fue procesado por la dian.'
		END
		IF NOT EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM=@ITEM AND TIPO='DB' )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Nota solo puede ser de tipo Débito'
		END
		IF (SELECT COUNT(1) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
                UPDATE FCXPDBCR SET ESTADODIAN=CASE WHEN COALESCE(ESTADODIAN,0)=0 THEN 1 ELSE 0 END WHERE CNSFCXP=@CNSFCXP AND ITEM=@ITEM
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END	
	IF @METODO = 'ELIMINAR_FCXPD'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP, @NOITEM = NOITEM, @PROCEDE = PROCEDE
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		,NOITEM		INT			'$.NOITEM'
		,PROCEDE	INT			'$.PROCEDE'
		)

		IF EXISTS (SELECT   * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND CONTABILIZADA = 1)
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El regitro ya esta Contabilizada'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF EXISTS (SELECT   * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND ENPRESUPUESTO = 1)
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La Cuenta Por Pagar Ya Fue Enviada a Presupuesto'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF EXISTS (SELECT   * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND ESTADO = 'A')
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El regitro esta Anulada'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		
		BEGIN TRY 
			IF EXISTS(SELECT * FROM FCXPD, IMOV WHERE FCXPD.CNSFCXP = @CNSFCXP AND FCXPD.ITEM = @NOITEM  AND COALESCE(FCXPD.N_PRESUP,'') = IMOV.CNSMOV )
			BEGIN
				EXEC SPK_ANULAR_ITEM_CXP @CNSFCXP, @NOITEM, @COMPANIA , @IDSEDE
			END
			IF @PROCEDE = 1
			BEGIN
				DELETE FROM FCXPD WHERE CNSFCXP = @CNSFCXP AND ITEM = @NOITEM
			END
			IF @PROCEDE = 2
			BEGIN
				DELETE FROM FCXPD WHERE CNSFCXP = @CNSFCXP
			END
			EXEC SPK_CALCULOVALORESCXP @CNSFCXP 
 
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END		
--QUERY 3
--QUERY 3
	IF @METODO = 'OBSERVACION_FCXPD'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP, @OBSERVACION = OBSERVACION
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP				VARCHAR(20)				'$.CNSFCXP'
		,OBSERVACION		VARCHAR(250)			'$.OBSERVACION'
		)
		
		BEGIN TRY 
			UPDATE FCXP SET OBSERVACION = @OBSERVACION WHERE   CNSFCXP = @CNSFCXP
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'CAL_IMPUESTO'
	BEGIN
		SELECT @TIPOCALCULO =  TIPOCALCULO, @IDIMPUESTO = IDIMPUESTO, @IDCLASE = IDCLASE, @CNSFCXP = CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		TIPOCALCULO				VARCHAR(20)				'$.TIPOCALCULO'
		,IDIMPUESTO				VARCHAR(250)			'$.IDIMPUESTO'
		,IDCLASE				VARCHAR(250)			'$.IDCLASE'
		,CNSFCXP				VARCHAR(250)			'$.CNSFCXP'
		)
		IF @TIPOCALCULO = 'Automatico' 
			SELECT @FECHA_CAL = COALESCE( REPLACE(CONVERT(DATE,FCXP.F_FACTURAREF),'-',''),NULL), @CALCULAR1 =  FCXP.VALOR-VLR_DESCUENTO-VLR_GLOSAS,
			@CALCULAR2 = FCXP.VLR_IVA 
			FROM FCXP WHERE FCXP.ESTADO<>'A' AND FCXP.CNSFCXP = @CNSFCXP
--query3
--query3
		IF DBO.FNK_ValorVariable('IDIMP_RETEIVA') = @IDIMPUESTO
		BEGIN 
			PRINT 'ACA 111111'
			SELECT @FECHA_CAL = COALESCE( REPLACE(CONVERT(DATE,FCXP.F_FACTURAREF),'-',''),NULL), @CALCULAR1 = FCXP.VLR_IVA 
			FROM FCXP WHERE FCXP.ESTADO<>'A' AND FCXP.CNSFCXP = @CNSFCXP
		END
		ELSE
		BEGIN
			PRINT 'ACA 222222'
			SELECT @FECHA_CAL = COALESCE( REPLACE(CONVERT(DATE,FCXP.F_FACTURAREF),'-',''),NULL), @CALCULAR1 = FCXP.VALOR-VLR_DESCUENTO-VLR_GLOSAS
			FROM FCXP WHERE FCXP.ESTADO<>'A' AND FCXP.CNSFCXP = @CNSFCXP
		END
	
      IF @TIPOCALCULO = 'Automatico' AND NOT EXISTS (SELECT * FROM DBO.FNK_CALCULO_IMPUESTO (@IDIMPUESTO, @IDCLASE, @CALCULAR1, @FECHA_CAL ))
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Este impuesto no se encuentra configurado para la vigencia de la CXP, Revise la Configuración'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		
		BEGIN TRY 
			SELECT TOP 1 'OK' OK, ITEM, VALOR, FECHAINI [FECHA_INI], FECHAFIN [FECHA_FIN], 
			VALORIMP, BASE, CUENTA, CUENTA_ASUM,MUVT,VRLUVT , @CALCULAR1 [BASE_1]
			FROM DBO.FNK_CALCULO_IMPUESTO (@IDIMPUESTO, @IDCLASE, @CALCULAR1, @FECHA_CAL)
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END	
	IF @METODO = 'AFECTA_RETENCION'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP, @VALOR = VALOR
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP				VARCHAR(20)				'$.CNSFCXP'
		,VALOR				DECIMAL(14,2)			'$.VALOR'
		)
		
		BEGIN TRY 
			IF EXISTS (SELECT * FROM FCXPI WHERE CNSFCXP= @CNSFCXP AND IDIMPUESTO <> (SELECT DBO.FNK_VALORVARIABLE('IDIMP_RETEIVA')) AND COALESCE(FCXPI.IMPUESTO_ASUM,0)=0)
			BEGIN
				SELECT @IMPUESTO = (SELECT  CONVERT(DECIMAL(7,2),((SUM(VALOR)*100)/AVG(BASE))) FROM FCXPI WHERE CNSFCXP = @CNSFCXP AND IDIMPUESTO <> (SELECT DBO.FNK_VALORVARIABLE('IDIMP_RETEIVA')) AND COALESCE(FCXPI.IMPUESTO_ASUM,0)=0)
				SELECT 'OK'OK, ROUND (@VALOR*(@IMPUESTO/100),0) [VLR_IMPUESTOS]
			END
			ELSE
				SELECT 'OK'OK, 0 [VLR_IMPUESTOS]
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	
	IF @METODO = 'CRUD_FCXPAG'
	BEGIN
		SELECT @datoFCXPAG =  datoFCXPAG
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		datoFCXPAG		NVARCHAR(MAX) AS JSON
		)
		SELECT @PROCESO =UPPER( JSON_VALUE(@datoFCXPAG,'$.PROCESO'))
		SELECT * INTO #datoFCXPAG FROM OPENJSON (@datoFCXPAG)
		WITH(
		CNSFCXP					VARCHAR(20)						'$.CNSFCXP'
		,CCOSTO					VARCHAR(20)						'$.CCOSTO'
		,PRCASIGNADO			DECIMAL(14,2)					'$.PRCASIGNADO'
		,CUENTA					VARCHAR(20)						'$.CUENTA'
		)
		--SELECT COALESCE(SUM(FCXPAG.PRCASIGNADO),0) FROM FCXPAG,#datoFCXPAG  WHERE FCXPAG.CNSFCXP = #datoFCXPAG.CNSFCXP
		IF UPPER(@PROCESO)='NUEVO' AND EXISTS (SELECT * FROM FCXPAG INNER JOIN #datoFCXPAG ON FCXPAG.CNSFCXP = #datoFCXPAG.CNSFCXP AND  FCXPAG.CCOSTO = #datoFCXPAG.CCOSTO)
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Ya existe un egistro con ese Centro de Costo'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF  ((SELECT COALESCE(SUM(FCXPAG.PRCASIGNADO),0) FROM FCXPAG,#datoFCXPAG  WHERE FCXPAG.CNSFCXP = #datoFCXPAG.CNSFCXP AND FCXPAG.CCOSTO <> #datoFCXPAG.CCOSTO ) + (SELECT COALESCE(PRCASIGNADO,0) FROM #datoFCXPAG ))
		> 100
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El porcentaje asignado supero el 100%'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
			
		BEGIN TRY 
			IF UPPER(@PROCESO)='EDITAR'
			BEGIN
				UPDATE FCXPAG SET
				 CCOSTO			= #datoFCXPAG.CCOSTO			
				,PRCASIGNADO	= #datoFCXPAG.PRCASIGNADO	
				,CUENTA			= #datoFCXPAG.CUENTA			
				FROM FCXPAG INNER JOIN #datoFCXPAG ON FCXPAG.CNSFCXP = #datoFCXPAG.CNSFCXP AND  FCXPAG.CCOSTO = #datoFCXPAG.CCOSTO
			END
			IF UPPER(@PROCESO)='NUEVO'
			BEGIN

				INSERT INTO FCXPAG (
				CNSFCXP			
				,CCOSTO			
				,PRCASIGNADO	
				,CUENTA			
				)
				SELECT
				 #datoFCXPAG.CNSFCXP				
				,#datoFCXPAG.CCOSTO			
				,#datoFCXPAG.PRCASIGNADO	
				,#datoFCXPAG.CUENTA		
				FROM #datoFCXPAG
			END
			IF UPPER(@PROCESO)='ELIMINAR'
			BEGIN
				DELETE FCXPAG FROM FCXPAG,#datoFCXPAG  WHERE FCXPAG.CNSFCXP = #datoFCXPAG.CNSFCXP AND FCXPAG.CCOSTO = #datoFCXPAG.CCOSTO
			END
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'INSERT_FCXPI'
	BEGIN
		SELECT @CNSFCXP =  CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20) '$.CNSFCXP'
		)
		SELECT @IDSEDE= IDSEDE FROM FCXP WHERE CNSFCXP = @CNSFCXP
		
		BEGIN TRY 
			SET @IDCATEGORIA = (SELECT DBO.FNK_VALORVARIABLE('IDINVMOV_REMISION_EN'))
			EXEC SPK_IMPUESTOS_CXP @CNSFCXP, @IDCATEGORIA, @COMPANIA, @IDSEDE
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'VALIDA_TERCERO'
	BEGIN
		SELECT @IDTERCERO = IDTERCERO, @FECHA = FECHA
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		IDTERCERO		VARCHAR(20)		'$.IDTERCERO'
		,FECHA			DATE			'$.FECHA'
		)
		SELECT @DIAS = (SELECT COALESCE(DIASVTO,0) FROM TER WHERE  IDTERCERO = @IDTERCERO)
		BEGIN TRY 
		SELECT 'OK'  OK, DATEADD(DAY,@DIAS,@FECHA) FECHAVENCE
			
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'GEN_NUM_DIAN'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (
		CNSFCXP		VARCHAR(20)		'$.CNSFCXP'
		)
		SELECT @IDTERCERO = FCXP.IDTERCERO,@MANEXO = COALESCE(TER.MANEXO,0), @PROCEDENCIA = FCXP.PROCEDENCIA, @IDSEDE = FCXP.IDSEDE  FROM FCXP 
		INNER JOIN TER ON FCXP.IDTERCERO = TER.IDTERCERO
		WHERE FCXP.CNSFCXP = @CNSFCXP

		IF EXISTS (SELECT * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND COALESCE(FCXP.CNSRESOL,'')<> '')
		BEGIN
			RETURN
		END
		IF EXISTS (SELECT  * FROM FCJ, FCXP WHERE  CLASE_FAC = 'PAGO' AND FCJ.CNSRESOL = FCXP.CNSRESOL AND FCXP.CNSFCXP = @CNSFCXP AND FCJ.N_FACTURA = FCXP.N_FACTURA AND COALESCE(FCXP.N_FACTURA,'')<>'') 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Error al encontrar el Documento soporte, Por favor comunicarse con el area de tecgnología'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF  @MANEXO <> 1
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El tercero asociado al registro, no corresponde, para un Anexo de Soporte'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF  @PROCEDENCIA = 'Nomina'
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La procedencia del Registro es de tipo Nomina'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF  (SELECT COALESCE(FCXP.ESTADODIAN,0) FROM FCXP WHERE FCXP.CNSFCXP = @CNSFCXP ) <> 0
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El estado DIAN del registro ya no esta pendiente por generar'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT @PROCEDENCIA = 'CXP'
		IF DBO.FNK_VALORVARIABLE('FACTSEDE')='NO'
		BEGIN
			SELECT @SEDEPPAL=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDSEDEPRINCIPAL')))
			IF NOT EXISTS(SELECT * FROM SED WHERE IDSEDE=@SEDEPPAL)
			BEGIN
				SELECT @SEDEPPAL=IDENTIFICADOR FROM FDIAN WHERE VENCIDA=0 AND PROCEDENCIA = 'CXP'
					IF NOT EXISTS(SELECT * FROM SED WHERE IDSEDE=@SEDEPPAL)
					BEGIN
						SELECT TOP 1 @SEDEPPAL=IDSEDE FROM FTR WHERE COALESCE(IDSEDE,'')<>'' ORDER BY F_FACTURA DESC
					END
			END
			SELECT @IDSEDE=@SEDEPPAL
		END
		ELSE
		BEGIN
			IF @PROCEDENCIA='CAJA' 
				SELECT @SEDEPPAL=@IDSEDE
			ELSE
				SELECT @SEDEPPAL=COALESCE(IDSEDE,'') FROM FCXP WHERE CNSFCXP=@CNSFCXP

			IF COALESCE(@SEDEPPAL,'')='' SELECT @SEDEPPAL=@IDSEDE

			SELECT @IDSEDE=@SEDEPPAL
		END
		SELECT @PREFIJOFAC=COALESCE(PREFIJO,''), @CNSACTUAL=CNSACTUAL, @CNSNUEVO=COALESCE(CNSACTUAL,0)+1  
		FROM FDIAN WHERE IDENTIFICADOR=@IDSEDE AND COALESCE(VENCIDA,0)=0 AND PROCEDENCIA = 'CXP'

		PRINT '@PREFIJOFAC ='+@PREFIJOFAC
		PRINT '@CNSNUEVO ='+CONVERT(VARCHAR,@CNSNUEVO)

		SELECT @PREFIJOFAC=COALESCE(PREFIJO,''),
				@LONGFTRARS=COALESCE(LONGFTR,0),
				@CNSINICIAL=CNSINICIAL,
				@CNSFINAL=CNSFINAL,
				@VENCIDA=COALESCE(VENCIDA,0),
				@CNSRESOL=CNSRESOL
		FROM FDIAN 
		WHERE IDENTIFICADOR=@IDSEDE 
		AND COALESCE(VENCIDA,0)=0 
		AND PROCEDENCIA = 'CXP'
		AND CNSINICIAL <= @CNSNUEVO 
		AND CNSFINAL+1 > @CNSNUEVO

		IF  @CNSNUEVO>@CNSFINAL OR @CNSNUEVO<@CNSINICIAL
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Se ha terminado los consecutivos de facturacion Habilitados, No se puede Continuar'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF  COALESCE(@CNSRESOL,'')=''
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'NO existe resolucion para este nro de factura, No se puede Continuar'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END

		BEGIN TRY 
			UPDATE FCXP SET CNSRESOL = @CNSRESOL, N_FACTURA = CONVERT(VARCHAR, @PREFIJOFAC, 10)+CONVERT(VARCHAR, @CNSNUEVO, 40),
			NOREFERENCIA = CONVERT(VARCHAR, @PREFIJOFAC, 10)+CONVERT(VARCHAR, @CNSNUEVO, 40) WHERE CNSFCXP = @CNSFCXP
			UPDATE FDIAN SET CNSACTUAL = @CNSNUEVO WHERE CNSRESOL=@CNSRESOL AND PREFIJO=@PREFIJOFAC AND IDENTIFICADOR=@IDSEDE AND PROCEDENCIA = 'CXP'


		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'IMPRMIR_ANEXO'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP, @TITULO = TITULO
		FROM OPENJSON (@PARAMETROS)
		WITH		 ( CNSFCXP		VARCHAR(20)		'$.CNSFCXP',		TITULO		VARCHAR(MAX)		'$.TITULO'		)
		--IF EXISTS (SELECT * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND COALESCE(FCXP.CNSRESOL,'') = '')
		--BEGIN
		--	RETURN
		--END
		BEGIN TRY  --ESTADODIAN
			SELECT 'OK' AS OK
			IF (SELECT COALESCE(FCXP.CUDS,'') FROM FCXP WHERE CNSFCXP = @CNSFCXP) = ''
			BEGIN
				IF  (SELECT COALESCE(ESTADODIAN,0) FROM FCXP WHERE  FCXP.CNSFCXP = @CNSFCXP) = 2
				BEGIN
					SELECT @DocAdq = dbo.FNK_LIMPIATEXTO(TER.NIT,'0-9') FROM TER WHERE IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')
					SELECT @Cuds = 	COALESCE(FCXP.CUDS,DBO.FNK_GENERAR_CUFE_CXP(FCXP.N_FACTURA ,@DocAdq,FDIAN.CLAVETECNICA,FCXP.N_FACTURA))
						FROM FCXP	
							INNER JOIN TER ON TER.IDTERCERO=FCXP.IDTERCERO
							LEFT JOIN FDIAN ON FCXP.CNSRESOL=FDIAN.CNSRESOL
						WHERE CNSFCXP= @CNSFCXP
					UPDATE FCXP SET CUDS = @Cuds WHERE CNSFCXP= @CNSFCXP
				END
			END
			SELECT FCXP.ESTADODIAN,FCXP.IDTERCERO,TER.DIRECCION, TER.NIT, TER.DV, TER.TELEFONOS, TER.RAZONSOCIAL, TER.CIUDAD, CIU.NOMBRE
			, FCXP.FECHA,FCXP.CNSRESOL,FCXP.N_FACTURA,FCXP.NOREFERENCIA,FCXP.NOREFERENCIA DOCUMENTO
			, FDIAN.F_RESOLUCION, FDIAN.PREFIJO, FDIAN.CNSINICIAL, FDIAN.CNSFINAL, FDIAN.FECHAVEN, FDIAN.FECHAINI
			,FCXP.OBSERVACION, DATEDIFF(MONTH,FDIAN.FECHAINI , FDIAN.FECHAVEN ) DIFERENCIA
			,(SELECT SUM (FCXPD.VLR_NETO) FROM FCXPD WHERE FCXPD.CNSFCXP = @CNSFCXP  ) SUBTOTAL
			, 0 RETENCION, (SELECT SUM (FCXPD.VLR_NETO) FROM FCXPD WHERE FCXPD.CNSFCXP = @CNSFCXP  ) TOTAL, FCXP.F_FACTURAREF, FCXP.VLR_IVA
			,DBO.FNK_QRCODE_CXP(@CNSFCXP) QR, FCXP.CUDS, @TITULO TITULO
			, (SELECT RAZONSOCIAL FROM TER WHERE IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')) [PROPIETARIO]
			, (SELECT NIT FROM TER WHERE IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')) [NIT_PROPIETARIO]
			FROM FCXP
			INNER JOIN TER ON FCXP.IDTERCERO = TER.IDTERCERO
			LEFT JOIN FDIAN ON  FDIAN.PROCEDENCIA = 'CXP' AND VENCIDA = 0
			LEFT JOIN CIU ON TER.CIUDAD = CIU.CIUDAD
			WHERE FCXP.CNSFCXP = @CNSFCXP

			SELECT FCXPD.ITEM, FCXPD.VALOR, FCXPD.CANTIDAD, FCXPD.VLR_NETO, FCXPD.VLR_IVA , FCXPD.CNSFCXP, 0 RETENCION
			, CASE FCXPD.PROCEDENCIA
                /*WHEN 'Servicios' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)              
				WHEN 'Salud' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)    */          
				WHEN 'Servicios' THEN CASE WHEN EXISTS (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) ELSE (SELECT TOP 1 FCTSERD.DESCRIPCION FROM  FCTSERD WHERE FCTSERD.IDSERVICIO = FCXPD.IDSERVICIO) END
				WHEN 'Salud' THEN CASE WHEN EXISTS (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) ELSE (SELECT TOP 1 FCTSERD.DESCRIPCION FROM  FCTSERD WHERE FCTSERD.IDSERVICIO = FCXPD.IDSERVICIO) END
				WHEN 'Compras' THEN (SELECT DESCRIPCION FROM IART WHERE IART.IDARTICULO =FCXPD.IDSERVICIO)                
				WHEN 'CAJA' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)                 
				WHEN 'CAJAMENOR' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)               
				WHEN 'Nomina' THEN (SELECT DESCRIPCION FROM NCON WHERE NCON.CODCONCEPTO =FCXPD.IDSERVICIO)          
				END [DESCRIPCION]
			FROM FCXPD
			WHERE FCXPD.CNSFCXP = @CNSFCXP

		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'VAL_CONTABLE'
	BEGIN
		SELECT @IDMODELOCONT = IDMODELOCONT, @IDTIPOCONT = IDTIPOCONT, @TIPO = TIPO ,@IDAREA = IDAREA ,@CCOSTO = CCOSTO, @CLASECONT = CLASECONT, @IDSERVICIO = IDSERVICIO
		FROM OPENJSON (@PARAMETROS)
		WITH		 (
			IDMODELOCONT			VARCHAR(20)		'$.IDMODELOCONT'
			,IDTIPOCONT				VARCHAR(20)		'$.IDTIPOCONT'
			,TIPO					VARCHAR(20)		'$.TIPO'
			,IDAREA					VARCHAR(20)		'$.IDAREA'
			,CCOSTO					VARCHAR(20)		'$.CCOSTO'
			,CLASECONT				VARCHAR(20)		'$.CLASECONT'
			,IDSERVICIO				VARCHAR(20)		'$.IDSERVICIO'
		)
		IF @IDTIPOCONT = 'Servicio'
			SELECT @PREFIJO = IDTIPOSER FROM FCTSERD  WHERE IDSERVICIO = @IDSERVICIO

		IF @IDTIPOCONT = 'Compras'
			SELECT @PREFIJO = IDITAR FROM IART WHERE IDARTICULO = @IDSERVICIO

		SELECT @IDTIPOCONT = CASE @IDTIPOCONT WHEN 'Servicios' THEN 'CXP_SERVICIOS'  WHEN 'Compras' THEN 'CXP_COMPRAS'  WHEN 'Salud' THEN 'CXP_SALUD'  END
		BEGIN TRY
			
			SELECT 'OK' AS OK, DBO.FNK_CUENTA_KMCOM(
			@IDMODELOCONT,
			@IDTIPOCONT,
			@TIPO,
			@PREFIJO,
			@IDAREA,
			@CCOSTO,
			@CLASECONT,
			@IDSERVICIO) RESULTADO

		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'IMPRIMIRCXP'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP, @PROCEDENCIA = PROCEDENCIA 
		FROM OPENJSON (@PARAMETROS)
		WITH		 (
			CNSFCXP			VARCHAR(20)		'$.CNSFCXP'
			,PROCEDENCIA	VARCHAR(20)		'$.PROCEDENCIA'
		)
		SELECT 'OK' OK ,CNSFCXP, FECHA, FCXP.IDTERCERO, TER.RAZONSOCIAL, TER.NIT, NOREFERENCIA, F_FACTURAREF, F_VENCE,  FCXP.ESTADO, FCXP.USUARIO,USUSU.NOMBRE [USUSU_NOMBRE] , TIPOCXP, PROCEDENCIA, OBSERVACION
			, CONTABILIZADA, NROCOMPROBANTE,   CUECREDITO
			, MODALIDAD, SUBSIDIO, FCXP.IDSEDE, SED.DESCRIPCION, FCXP.CIUDAD, CIU.NOMBRE [CIU_NOMBRE], IDPROPIETARIO 
			, CASE COALESCE(@PROCEDENCIA,'') WHEN 'FCXP' THEN 'Cuentas por Pagar' ELSE '' END [TITULO]
			,VLR_NETO, VLR_IVA, VLR_IMPUESTOS, VALOR, SALDO, VLR_NOTASDEBITO, VLR_GLOSAS, VLR_FLETE,VLR_NOTASCREDITO,VLR_ABONOS,VLR_DESCUENTO
		FROM  FCXP 
			INNER JOIN TER ON FCXP.IDTERCERO = TER.IDTERCERO
			LEFT JOIN CIU ON FCXP.CIUDAD = CIU.CIUDAD
			LEFT JOIN SED ON FCXP.IDSEDE = SED.IDSEDE
			LEFT JOIN USUSU ON FCXP.USUARIO = USUSU.USUARIO
		WHERE CNSFCXP = @CNSFCXP

		--SELECT FCXPD.ITEM, FCXPD.IDSERVICIO, IART.DESCRIPCION, FCXPD.CANTIDAD, FCXPD.VALOR,VLR_DESCUENTO, VLR_IVA, VLR_GLOSAS, VLR_NETO  
		--FROM  FCXPD
		--	LEFT JOIN IART ON FCXPD.IDSERVICIO = IART.IDARTICULO
		--WHERE CNSFCXP = @CNSFCXP
		
		SELECT FCXPD.CNSFCXP, FCXPD.ITEM, FCXPD.IDSERVICIO, FCXPD.CANTIDAD, FCXPD.VALOR, FCXPD.ESTADO, N_PRESUP, FCXPD.ITEM_PRESUP
              , FCXPD.VLR_NETO, FCXPD.CCOSTO, FCXPD.IDAREA, FCXPD.CUENTA_SER, FCXPD.PROCEDENCIA, FCXPD.RUBRO, FCXPD.REDONDEO, FCXPD.IDTERCERO
              , FCXPD.UNSPSC, FCXPD.VLR_DOLARES, FCXPD.CUENTA_IVA, FCXPD.VLRIMPCONSUMO, FCXPD.CTAIMPCONSUMO, FCXPD.IDSEDE, FCXPD.PREFIJO
              , CASE FCXPD.PROCEDENCIA
                /*WHEN 'Servicios' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)              
				WHEN 'Salud' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)    */          
				WHEN 'Servicios' THEN CASE WHEN EXISTS (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) ELSE (SELECT TOP 1 FCTSERD.DESCRIPCION FROM  FCTSERD WHERE FCTSERD.IDSERVICIO = FCXPD.IDSERVICIO) END
				WHEN 'Salud' THEN CASE WHEN EXISTS (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) ELSE (SELECT TOP 1 FCTSERD.DESCRIPCION FROM  FCTSERD WHERE FCTSERD.IDSERVICIO = FCXPD.IDSERVICIO) END
				WHEN 'Compras' THEN (SELECT DESCRIPCION FROM IART WHERE IART.IDARTICULO =FCXPD.IDSERVICIO)                
				WHEN 'CAJA' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)                 
				WHEN 'CAJAMENOR' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)               
				WHEN 'Nomina' THEN (SELECT DESCRIPCION FROM NCON WHERE NCON.CODCONCEPTO =FCXPD.IDSERVICIO)          
				END [DESCRIPCION]
              , FCXPD.VLR_GLOSAS, FCXPD.CODUNG, FCXPD.VLR_DESCUENTO, FCXPD.VLR_IVA,CAST(COALESCE(FCXPD.MIMPCONSUMO,0) AS BIT) MIMPCONSUMO
              , CASE WHEN FCXPD.MIMPCONSUMO = 1 THEN 'Si' ELSE 'No' END [MIMPCONSUMO_DESC]
            FROM FCXPD
            WHERE FCXPD.CNSFCXP = @CNSFCXP
	END
	IF @METODO = 'NOTIFICAR_DIAN'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP
		FROM OPENJSON (@PARAMETROS)
		WITH		 (
		CNSFCXP		VARCHAR(20)		'$.CNSFCXP'
		)

		IF EXISTS (SELECT * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND COALESCE(FCXP.DOCEQUIVALENTE,0) = 0) 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No esta registrado como Equivalente' 
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		IF EXISTS (SELECT * FROM FCXP WHERE  CNSFCXP = @CNSFCXP AND COALESCE(FCXP.N_FACTURA,FCXP.NOREFERENCIA,'') = '') 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No esta registrado con N° Factura' 
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		BEGIN TRY 
			--SELECT COALESCE(ESTADODIAN,0) FROM FCXP WHERE CNSFCXP= @CNSFCXP
			UPDATE FCXP SET ESTADODIAN=1 WHERE CNSFCXP = @CNSFCXP
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK' AS OK
		RETURN
	END
	IF @METODO = 'CLONAR_FCXP'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		 '$.CNSFCXP')
	
		/*IF EXISTS (SELECT * FROM BSINCIN WHERE CERRADO = 0 AND USUARIO = @USUARIO )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El usuario tiene un registro sin cerrar.'
		END*/
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				SELECT @IDSEDE = IDSEDE FROM FCXP WHERE CNSFCXP = @CNSFCXP
				EXEC SPK_CLONA_CXP @CNSFCXP, @USUARIO, '01', @IDSEDE, @SYS_COMPUTERNAME	
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END	
	IF @METODO = 'VALIDA_IDNOTA'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		 '$.CNSFCXP')

		SELECT TOP 1 'OK' OK , FCXPD.CNSFCXP, FCXPD.ITEM, FCXPD.IDSERVICIO, COALESCE(FCXPD.CCOSTO,NULL) CCOSTO
        , CASE FCXPD.PROCEDENCIA
                /*WHEN 'Servicios' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)              
				WHEN 'Salud' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)    */          
				WHEN 'Servicios' THEN CASE WHEN EXISTS (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) ELSE (SELECT TOP 1 FCTSERD.DESCRIPCION FROM  FCTSERD WHERE FCTSERD.IDSERVICIO = FCXPD.IDSERVICIO) END
				WHEN 'Salud' THEN CASE WHEN EXISTS (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO) ELSE (SELECT TOP 1 FCTSERD.DESCRIPCION FROM  FCTSERD WHERE FCTSERD.IDSERVICIO = FCXPD.IDSERVICIO) END
				WHEN 'Compras' THEN (SELECT DESCRIPCION FROM IART WHERE IART.IDARTICULO =FCXPD.IDSERVICIO)                
				WHEN 'CAJA' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)                 
				WHEN 'CAJAMENOR' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)               
				WHEN 'Nomina' THEN (SELECT DESCRIPCION FROM NCON WHERE NCON.CODCONCEPTO =FCXPD.IDSERVICIO)          
				END [DESCRIPCION]
		FROM FCXPD WHERE CNSFCXP = @CNSFCXP ORDER BY  ITEM ASC		
	END	
	IF @METODO = 'CRUD_NOTA_EDITA'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP, @ITEM = ITEM
		FROM OPENJSON(@PARAMETROS)
		WITH(	CNSFCXP			VARCHAR(20)		 '$.CNSFCXP'
				,ITEM		INT				'$.ITEM')
	
		BEGIN
			BEGIN TRY
				SELECT 'OK'OK
				SELECT FCXPDNOT.CNSFCXP, FCXPDNOT.VALOR_DESCUENTO, FCXPDNOT.ITEM, FCXPDNOT.IDSERVICIO, FCXPDNOT.CANTIDAD, FCXPDNOT.VALOR, FCXPDNOT.PORIVA, FCXPDNOT.VLR_IVA, FCXPDNOT.VLR_NETO, FCXPDNOT.DESCTO
				, FCXPDNOT.VLR_DESCTO, FCXPDNOT.VLR_DT_IVA, FCXPDNOT.VLR_DT_PROD, FCXPDNOT.CTA_IVA, FCXPDNOT.CTA_SER, FCXPDNOT.AFECTA_IVA, FCXPDNOT.AFECTA_IMPUESTOS, FCXPDNOT.FECHA_CREA 
				FROM FCXPDNOT
            WHERE FCXPDNOT.CNSFCXP = @CNSFCXP AND ITEM_DBCR = @ITEM

				SELECT  FCXPDBCRIMP.ITEM_DBCR, FCXPI.CNSFCXPI, FCXPI.CNSFCXP,CAST( COALESCE(FCXPI.IMPUESTO_ASUM,0) AS BIT) IMPUESTO_ASUM , FCXPI.CUENTA_ASUM
					, FCXPI.BASE, FCXPI.VALORIMP, FCXPI.VALOR       , FCXPI.FECHAINI, FCXPI.FECHAFIN, FCXPI.CUENTA, FCXPI.MUVT, FIMP.TIPO
					, FCXPI.IDIMPUESTO,FIMP.DESCRIPCION [IMPUES_DESC] , FCXPI.IDCLASE,FIMPD.DESCRIPCION [CLASE_DESC]       , ITEM, PROCEDENCIA,  TIPOCALCULO 
				FROM FCXPDBCRIMP
					INNER JOIN FCXPI ON FCXPDBCRIMP.CNSFCXPI = FCXPI.CNSFCXPI
					LEFT JOIN FIMP ON FCXPI.IDIMPUESTO = FIMP.IDIMPUESTO
					LEFT JOIN FIMPD ON  FCXPI.IDCLASE = FIMPD.IDCLASE AND FIMPD.IDIMPUESTO = FIMP.IDIMPUESTO
				WHERE FCXPDBCRIMP.CNSFCXP = @CNSFCXP AND FCXPDBCRIMP.ITEM_DBCR = @ITEM

			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			--SELECT 'OK'OK
		END 
	END	
	IF @METODO = 'ELIMINR_NOTACREDITO'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP, @ITEM=ITEM
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		 '$.CNSFCXP'
              ,ITEM 		VARCHAR(20)		 '$.ITEM')
	
		/*IF EXISTS (SELECT * FROM BSINCIN WHERE CERRADO = 0 AND USUARIO = @USUARIO )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'El usuario tiene un registro sin cerrar.'
		END*/
		IF EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP=@CNSFCXP AND ITEM=@ITEM AND COALESCE(CONTABILIZADA,0)<>0 )
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'La nota credito ya ha sido contabilizada'
		END
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				DELETE FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP
				DELETE FROM FCXPDNOT WHERE CNSFCXP = @CNSFCXP
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END	
	IF @METODO = 'DESAPLICAR_NOTACREDITO'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP, @ITEM=ITEM
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		 '$.CNSFCXP'
              ,ITEM 		VARCHAR(20)		 '$.ITEM')
	
		IF EXISTS (SELECT 1 FROM FCXPDBCR WHERE CNSFCXP=@CNSFCXP AND ITEM=@ITEM AND COALESCE(CONTABILIZADA,0)<>0 )
		BEGIN
			BEGIN TRY           
			      EXEC SPK_ANULAR_FCXPDBCR  @CNSFCXP,@ITEM           
			END TRY
			BEGIN CATCH
			        INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
			END CATCH
		END
		ELSE
		BEGIN
			BEGIN TRY
				DELETE FROM FCXPDBCR WHERE CNSFCXP = @CNSFCXP AND ITEM=@ITEM
				DELETE FROM FCXPDNOT WHERE CNSFCXP = @CNSFCXP AND ITEM=@ITEM
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH
      END
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		SELECT 'OK'OK
	END	
	IF @METODO = 'EXPORTA_DATOS'
	BEGIN
		SELECT @PROCESO = PROCESO, @WHERE_DATA = WHERE_DATA
		FROM OPENJSON(@PARAMETROS)
		WITH( PROCESO			VARCHAR(20)		 '$.PROCESO'
		,WHERE_DATA			VARCHAR(500)		 '$.WHERE_DATA'
		)
		
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				SELECT 'OK'OK
				SET @sqlCommand = '
					SELECT  FCXP.CNSFCXP,DBO.FNK_FECHA(FCXP.FECHA) FECHA,TER.NIT,TER.RAZONSOCIAL,FCXP.NOREFERENCIA,DBO.FNK_FECHA(FCXP.F_FACTURAREF) [FECHA FACTURA],
						FCXP.OBSERVACION,FCXP.VALOR,FCXP.VLR_IMPUESTOS,FCXP.VLR_DESCUENTO,FCXP.VLR_IVA,VLR_NOTASDEBITO,FCXP.VLR_NOTASCREDITO,FCXP.VLR_NETO,  
						FCXP.VLR_ABONOS,FCXP.SALDO,FCXP.PROCEDENCIA,COALESCE(FCXP.CUECREDITO,''NO CUENTA'') CUECREDITO,COALESCE(CUE.NOMCUENTA,''NO TIENE CUENTA'') NOMCUENTA,
						FCXP.PERIODO_ANO,FCXP.PERIODO_MES,FCXP.IDSEDE,FCXP.ESTADO               
					FROM FCXP  INNER JOIN TER  ON FCXP.IDTERCERO=TER.IDTERCERO     
						LEFT  JOIN CUE  ON FCXP.CUECREDITO=CUE.CUENTA  
					WHERE '+ @WHERE_DATA

					EXEC sys.sp_executesql @sqlCommand

				IF @PROCESO = 'TODO'
				BEGIN
					SET @sqlCommand = '
					SELECT FCXPD.CNSFCXP, ITEM,FCXPD.IDSERVICIO,FCXPD.CANTIDAD,FCXPD.VALOR,FCXPD.VLR_DESCUENTO,FCXPD.VLR_IVA,FCXPD.VLR_NETO,FCXPD.NOLOTE,FCXPD.IDAREA,
						FCXPD.CCOSTO,FCXPD.CUENTA_SER,CUE.NOMCUENTA 
						,CASE FCXPD.PROCEDENCIA
						WHEN ''Servicios'' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)
						WHEN ''Salud'' THEN (SELECT DESCRIPCION FROM FCTSER WHERE FCTSER.IDTIPOSER =FCXPD.IDSERVICIO)
						WHEN ''Compras'' THEN (SELECT DESCRIPCION FROM IART WHERE IART.IDARTICULO =FCXPD.IDSERVICIO)
						WHEN ''CAJA'' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)
						WHEN ''CAJAMENOR'' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO =FCXPD.IDSERVICIO)
						WHEN ''Nomina'' THEN (SELECT DESCRIPCION FROM NCON WHERE NCON.CODCONCEPTO =FCXPD.IDSERVICIO)
						END [DESCRIPCION]
					FROM  FCXPD 
						LEFT JOIN CUE  ON FCXPD.CUENTA_SER=CUE.CUENTA  
					WHERE FCXPD.CNSFCXP IN (SELECT  FCXP.CNSFCXP            
											FROM FCXP  INNER JOIN TER  ON FCXP.IDTERCERO=TER.IDTERCERO     
											WHERE '+ @WHERE_DATA+ '     )' 

					EXEC sys.sp_executesql @sqlCommand
				END
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END	
	IF @METODO = 'VALIDA_TOTALES'
	BEGIN
		SELECT  @MANEXO = MANEXO, @WHERE_DATA = WHERE_DATA
		FROM OPENJSON(@PARAMETROS)
		WITH( WHERE_DATA		NVARCHAR(MAX)	'$.WHERE_DATA'
			,MANEXO				BIT				'$.MANEXO'	)

		IF @MANEXO = 1
		BEGIN 
			SELECT 'OK'OK

			SET @sqlCommand = '
				SELECT  COUNT(*) TOTAL, SUM(FCXP.SALDO)  SALDO            
				FROM FCXP  INNER JOIN TER  ON FCXP.IDTERCERO=TER.IDTERCERO     
					LEFT  JOIN CUE  ON FCXP.CUECREDITO= CUE.CUENTA       
				WHERE '+ @WHERE_DATA

				EXEC sys.sp_executesql @sqlCommand
		END
	END	
	IF @METODO = 'PROCESAR_IMOVH'
	BEGIN
		SELECT @CNSFCXP = CNSFCXP, @CNSMOV = CNSMOV 
		FROM OPENJSON(@PARAMETROS)
		WITH( CNSFCXP		VARCHAR(20)		 '$.CNSFCXP' , CNSMOV		VARCHAR(20)		 '$.CNSMOV')
	
		/*IF 
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'XXX'
		END*/
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				EXEC SPK_INSERT_CXP_INV @CNSFCXP,@CNSMOV, 'CXP'
			END TRY
			BEGIN CATCH 
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE() ;  
			END CATCH  
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
			SELECT 'OK'OK
		END 
	END	
   IF @METODO = 'TRAE_IMPUESTOSCXP'
   BEGIN
      SELECT @CNSFCXP = JSON_VALUE(@PARAMETROS, '$.CNSFCXP')

      SELECT 'OK' OK
      SELECT FCXPI.IDIMPUESTO,FIMP.DESCRIPCION AS IMPUESTO,FCXPI.IDCLASE,FIMPD.DESCRIPCION,CONVERT(DECIMAL(7,2),VALORIMP)VALORIMP,CONVERT(DECIMAL(14,2),FCXPI.VALOR)VALOR
      FROM FCXPI INNER JOIN FIMPD ON FCXPI.IDIMPUESTO=FIMPD.IDIMPUESTO AND FCXPI.IDCLASE=FIMPD.IDCLASE
                 INNER JOIN FIMP ON FIMPD.IDIMPUESTO=FIMP.IDIMPUESTO
      WHERE CNSFCXP=@CNSFCXP
      RETURN
   END
END
