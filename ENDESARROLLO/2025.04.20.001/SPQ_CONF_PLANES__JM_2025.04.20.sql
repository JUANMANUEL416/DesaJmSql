CREATE OR ALTER PROCEDURE DBO.SPQ_CONF_PLANES @JSON NVARCHAR(MAX)
	WITH ENCRYPTION
AS
DECLARE @DATOS NVARCHAR(MAX)
DECLARE @PARAMETROS NVARCHAR(MAX), @MODELO VARCHAR(100), @METODO VARCHAR(100), @USUARIO VARCHAR(20)
DECLARE @PROCESO VARCHAR(20), @IDPLAN VARCHAR(6), @DESCPLAN VARCHAR(45), @ESTADO VARCHAR(8), @TIPOSISTEMA VARCHAR(20)
DECLARE @REGIMEN2193 VARCHAR(20), @ESPAQUETE BIT, @TIPOVOLUNTARIO VARCHAR(3), @RIAS BIT, @HCSINCIT SMALLINT, @DEPRUEBAS BIT
DECLARE @PREFIJOCARNET VARCHAR(2)
DECLARE @IDPLANEDITE VARCHAR(6)
DECLARE @TBLERRORES TABLE (ERROR VARCHAR(MAX))

BEGIN
	SELECT @MODELO = MODELO, @METODO = METODO, @USUARIO = USUARIO, @PARAMETROS = PARAMETROS
	FROM OPENJSON(@json) WITH (MODELO VARCHAR(100) '$.MODELO', METODO VARCHAR(100) '$.METODO', USUARIO VARCHAR(12) '$.USUARIO', PARAMETROS NVARCHAR(MAX) AS JSON
			)

	IF @METODO = 'GUARDAR'
	BEGIN
		BEGIN TRY
			SELECT @IDPLAN = IDPLAN, @DESCPLAN = DESCPLAN, @ESTADO = ESTADO, @TIPOSISTEMA = TIPOSISTEMA, @REGIMEN2193 = REGIMEN2193, @ESPAQUETE = ESPAQUETE, 
				@TIPOVOLUNTARIO = TIPOVOLUNTARIO, @HCSINCIT = HCSINCIT, @DEPRUEBAS = DEPRUEBAS, @PREFIJOCARNET = PREFIJOCARNET, @RIAS = RIAS, @PROCESO = PROCESO
			FROM OPENJSON(@PARAMETROS) WITH (
					IDPLAN VARCHAR(6) '$.IDPLAN', DESCPLAN VARCHAR(45) '$.DESCPLAN', ESTADO VARCHAR(8) '$.ESTADO', TIPOSISTEMA VARCHAR(20) '$.TIPOSISTEMA', 
					REGIMEN2193 VARCHAR(20) '$.REGIMEN2193', ESPAQUETE BIT '$.ESPAQUETE', TIPOVOLUNTARIO VARCHAR(3) '$.TIPOVOLUNTARIO.CODIGO', RIAS BIT '$.RIAS', 
					HCSINCIT SMALLINT '$.HCSINCIT', DEPRUEBAS BIT '$.DEPRUEBAS', PREFIJOCARNET VARCHAR(2) '$.PREFIJOCARNET', PROCESO VARCHAR(20) '$.PROCESO'
					)

			IF UPPER(@PROCESO) = 'INSERTAR'
			BEGIN
				BEGIN TRY
					INSERT INTO @TBLERRORES (ERROR)
					SELECT CONCAT ('El CODIGO ', @IDPLAN, ' YA SE ENCUENTRA REGISTRADO')
					WHERE EXISTS (
							SELECT 1
							FROM PLN
							WHERE IDPLAN = @IDPLAN
							)

					IF (
							SELECT COUNT(*)
							FROM @TBLERRORES
							) <= 0
					BEGIN
						INSERT INTO PLN (IDPLAN, DESCPLAN, ESTADO, TIPOSISTEMA, REGIMEN2193, ESPAQUETE, TIPOVOLUNTARIO, RIAS, HCSINCIT, DEPRUEBAS, PREFIJOCARNET
							)
						SELECT @IDPLAN, @DESCPLAN, @ESTADO, @TIPOSISTEMA, @REGIMEN2193, @ESPAQUETE, @TIPOVOLUNTARIO, @RIAS, @HCSINCIT, @DEPRUEBAS, @PREFIJOCARNET
					END
				END TRY

				BEGIN CATCH
					INSERT INTO @TBLERRORES (ERROR)
					SELECT ERROR_MESSAGE()
				END CATCH

				IF (
						SELECT COUNT(*)
						FROM @TBLERRORES
						) > 0
				BEGIN
					SELECT 'KO' OK

					SELECT ERROR
					FROM @TBLERRORES

					RETURN
				END

				SELECT 'OK' OK

				RETURN
			END

			IF UPPER(@PROCESO) = 'EDITAR'
			BEGIN
				BEGIN TRY
					SELECT @DATOS = DATOS
					FROM OPENJSON(@PARAMETROS) WITH (DATOS NVARCHAR(MAX) AS JSON)

					SELECT @IDPLANEDITE = IDPLANEDITE
					FROM OPENJSON(@DATOS) WITH (IDPLANEDITE VARCHAR(6) '$.IDPLANEDITE')

					IF (@IDPLAN <> @IDPLANEDITE)
					BEGIN
						INSERT INTO @TBLERRORES (ERROR)
						SELECT CONCAT ('El CODIGO ', @IDPLAN, ' YA SE ENCUENTRA REGISTRADO')
						WHERE EXISTS (
								SELECT 1
								FROM PLN
								WHERE IDPLAN = @IDPLAN
								)

						IF (
								SELECT COUNT(*)
								FROM @TBLERRORES
								) <= 0
						BEGIN
							UPDATE PLN
							SET IDPLAN = @IDPLAN, DESCPLAN = @DESCPLAN, ESTADO = @ESTADO, TIPOSISTEMA = @TIPOSISTEMA, REGIMEN2193 = @REGIMEN2193, ESPAQUETE = @ESPAQUETE
								, TIPOVOLUNTARIO = @TIPOVOLUNTARIO, RIAS = @RIAS, HCSINCIT = @HCSINCIT, DEPRUEBAS = @DEPRUEBAS, PREFIJOCARNET = @PREFIJOCARNET
							WHERE IDPLAN = @IDPLANEDITE
						END
					END
					ELSE
					BEGIN
						UPDATE PLN
						SET IDPLAN = @IDPLAN, DESCPLAN = @DESCPLAN, ESTADO = @ESTADO, TIPOSISTEMA = @TIPOSISTEMA, REGIMEN2193 = @REGIMEN2193, ESPAQUETE = @ESPAQUETE, 
							TIPOVOLUNTARIO = @TIPOVOLUNTARIO, RIAS = @RIAS, HCSINCIT = @HCSINCIT, DEPRUEBAS = @DEPRUEBAS, PREFIJOCARNET = @PREFIJOCARNET
						WHERE IDPLAN = @IDPLAN
					END
				END TRY

				BEGIN CATCH
					INSERT INTO @TBLERRORES (ERROR)
					SELECT ERROR_MESSAGE()
				END CATCH

				IF (
						SELECT COUNT(*)
						FROM @TBLERRORES
						) > 0
				BEGIN
					SELECT 'KO' OK

					SELECT ERROR
					FROM @TBLERRORES

					RETURN
				END

				SELECT 'OK' OK

				RETURN
			END
		END TRY

		BEGIN CATCH
			INSERT INTO @TBLERRORES (ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF (
				SELECT COUNT(*)
				FROM @TBLERRORES
				) > 0
		BEGIN
			SELECT 'KO' OK

			SELECT ERROR
			FROM @TBLERRORES

			RETURN
		END

		SELECT 'OK' OK
	END
END


