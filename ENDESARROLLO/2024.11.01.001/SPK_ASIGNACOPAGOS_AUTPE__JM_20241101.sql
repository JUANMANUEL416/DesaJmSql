CREATE OR ALTER PROCEDURE DBO.SPK_ASIGNACOPAGOS_AUTPE
@IDAUT VARCHAR(20),
@NOITEM SMALLINT
WITH ENCRYPTION
AS
SET DATEFORMAT dmy
DECLARE @CONSECUTIVOCIT VARCHAR(20)
DECLARE @PORCENTAJE  DECIMAL(14,2)
DECLARE @PREFIJO VARCHAR(10)
DECLARE @VLR_COPA_VAR DECIMAL(14,2)
DECLARE @VLR_COPA_FIJO DECIMAL(14,2)
DECLARE @VLR_COPA_VARAUT DECIMAL(14,2)
DECLARE @PREFIJOMED VARCHAR(10)
DECLARE @PREFIJOLAB VARCHAR(10)
DECLARE @PREFIJOAPO VARCHAR(10)
DECLARE @PREFIJOCON VARCHAR(10)
BEGIN
   PRINT 'SPK_ASIGNACOPAGOS_AUTPE '+@IDAUT+'NOITEMN '+CAST(@NOITEM AS VARCHAR(20))
   SELECT @CONSECUTIVOCIT=CONSECUTIVOCIT,@PREFIJO=PREFIJO FROM AUT WHERE IDAUT=@IDAUT 
   SET  @PREFIJOMED=DBO.FNK_VALORVARIABLE('PREFIJOMEDICAMENTOS')
   SET  @PREFIJOLAB=DBO.FNK_VALORVARIABLE('PREFIJOLABORATORIO')
   SET  @PREFIJOAPO=DBO.FNK_VALORVARIABLE('PREFIJOAPOYODX')
   SET  @PREFIJOCON=DBO.FNK_VALORVARIABLE('PREFIJOCONSULTA')

   SELECT  @PORCENTAJE=100-CASE @PREFIJO WHEN @PREFIJOMED THEN COPA_VAR_PORC WHEN @PREFIJOLAB THEN  COPA_VAR_EXA 
          WHEN @PREFIJOAPO THEN COPA_VAR_APOYO WHEN @PREFIJOCON THEN COPA_VAR_INTERC ELSE 0 END,
          @VLR_COPA_VARAUT=CASE @PREFIJO WHEN @PREFIJOMED THEN COPAGO_VA_FAR WHEN @PREFIJOLAB THEN COPAGO_VA_EXA 
          ELSE 0 END,
          @VLR_COPA_FIJO=CASE @PREFIJO WHEN @PREFIJOMED THEN COPAGO_FI_FAR WHEN @PREFIJOLAB THEN  COPAGO_FI_EXA 
          ELSE 0 END
   FROM CIT 
   WHERE CONSECUTIVO=@CONSECUTIVOCIT

   IF EXISTS(SELECT * FROM PPTCNT INNER JOIN AUT ON PPTCNT.IDTERCERO=AUT.IDTERCEROCA AND PPTCNT.IDPLAN=AUT.IDPLAN AND PPTCNT.PREFIJO=AUT.PREFIJO)
   BEGIN
      UPDATE AUT SET COPAGO_FIJO=PPTCNT.COPAFIJO, COPAGO_VARIABLE=PPTCNT.COPAVAR 
      FROM PPTCNT INNER JOIN AUT ON PPTCNT.IDTERCERO=AUT.IDTERCEROCA AND PPTCNT.IDPLAN=AUT.IDPLAN AND PPTCNT.PREFIJO=AUT.PREFIJO
   END
   ELSE
   BEGIN
      UPDATE AUT SET COPAGO_FIJO=@VLR_COPA_FIJO,COPAGO_VARIABLE=@VLR_COPA_VARAUT
      WHERE IDAUT=@IDAUT 
   END

   PRINT '@PORCENTAJE '+CAST(@PORCENTAJE AS VARCHAR(20))
   PRINT '@PREFIJO '+@PREFIJO

   IF @PORCENTAJE>0 AND EXISTS(SELECT  * FROM AUTD WHERE IDAUT=@IDAUT AND NO_ITEM=@NOITEM AND COALESCE(PROTOCOLO,0)=0)
   BEGIN
      SELECT @VLR_COPA_VAR=ROUND(VALOR*(@PORCENTAJE/100),2) FROM AUTD WHERE IDAUT=@IDAUT AND NO_ITEM=@NOITEM
      UPDATE  AUTD SET VALORCOPAGO=(@VLR_COPA_VAR*CANTIDAD) WHERE IDAUT=@IDAUT AND NO_ITEM=@NOITEM
      UPDATE  AUTD SET VALOREXCEDENTE=(VALOR*CANTIDAD)-VALORCOPAGO WHERE IDAUT=@IDAUT AND NO_ITEM=@NOITEM
   END
   ELSE
   BEGIN
      UPDATE  AUTD SET VALOREXCEDENTE=(VALOR*CANTIDAD) WHERE IDAUT=@IDAUT AND NO_ITEM=@NOITEM
   END

END





