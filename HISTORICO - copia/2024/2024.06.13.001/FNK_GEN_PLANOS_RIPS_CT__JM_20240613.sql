IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FNK_GEN_PLANOS_RIPS_CT' AND XTYPE='FN')
BEGIN
   DROP FUNCTION DBO.FNK_GEN_PLANOS_RIPS_CT
END
GO
CREATE FUNCTION DBO.FNK_GEN_PLANOS_RIPS_CT( @ENVIO VARCHAR(6))
RETURNS VARCHAR(MAX)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @PLANO VARCHAR(MAX)
	,@NRODATOS_AC INT
	,@NRODATOS_AP INT
	,@NRODATOS_AT INT
	,@NRODATOS_AM INT
	,@NRODATOS_AN INT
	,@NRODATOS_AH INT
	,@NRODATOS_AU INT
	,@NRODATOS_US INT
	,@NRODATOS_AF INT
	,@IDPRESTADOR VARCHAR(20)
	,@FECHAREMISION VARCHAR(10)
	SET @PLANO=''
	--PRINT 'CONTANDO REGISTROS'
	--SELECT TOP 1 @IDPRESTADOR=IDPRESTADOR,@FECHAREMISION=CONVERT(VARCHAR,FECHAREMISION,103) 
	--FROM RRIPS_CT WHERE ENVIO=@ENVIO
   SELECT TOP 1 @IDPRESTADOR=COALESCE(TER.IDALTERNA2,CODHABILITA)
   FROM SED INNER JOIN TER ON SED.NIT=TER.NIT
   WHERE TER.IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')

   SELECT @FECHAREMISION=CONVERT(VARCHAR,FECHAENVIO,103) 
   FROM RIPS WHERE ENVIO=@ENVIO

	SELECT @NRODATOS_AC=COUNT(*) FROM RRIPS_AC WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AP=COUNT(*) FROM RRIPS_AP WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AT=COUNT(*) FROM RRIPS_AT WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AM=COUNT(*) FROM RRIPS_AM WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AN=COUNT(*) FROM RRIPS_AN WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AH=COUNT(*) FROM RRIPS_AH WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AF=COUNT(*) FROM RRIPS_AF WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_AU=COUNT(*) FROM RRIPS_AU WHERE ENVIO=@ENVIO
	SELECT @NRODATOS_US=COUNT(*) FROM RRIPS_US WHERE ENVIO=@ENVIO

	IF COALESCE(@NRODATOS_AC,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AC'+@ENVIO+','+CAST(@NRODATOS_AC AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AP,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AP'+@ENVIO+','+CAST(@NRODATOS_AP AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AT,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AT'+@ENVIO+','+CAST(@NRODATOS_AT AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AM,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AM'+@ENVIO+','+CAST(@NRODATOS_AM AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AN,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AN'+@ENVIO+','+CAST(@NRODATOS_AN AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AH,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AH'+@ENVIO+','+CAST(@NRODATOS_AH AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AF,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AF'+@ENVIO+','+CAST(@NRODATOS_AF AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_AU,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',AU'+@ENVIO+','+CAST(@NRODATOS_AU AS VARCHAR(10)),CHAR(32),'')+'|' 
	END
	IF COALESCE(@NRODATOS_US,0)>0
	BEGIN
		SET @PLANO+= REPLACE(@IDPRESTADOR+','+@FECHAREMISION+',US'+@ENVIO+','+CAST(@NRODATOS_US AS VARCHAR(10)),CHAR(32),'')+'|' 
	END

   IF LEN(@PLANO)>2
   BEGIN
      SELECT @PLANO=LEFT(@PLANO,LEN(@PLANO)-1)
      SELECT @PLANO=REPLACE(@PLANO,'|',+CHAR(13)+CHAR(10))
   END
	RETURN @PLANO
END




