CREATE OR ALTER PROCEDURE  DBO.SPQ_MCP_IMPRESION
@JSON  NVARCHAR(MAX)
WITH ENCRYPTION
AS  
DECLARE	 @PARAMETROS  NVARCHAR(MAX)     
         ,@MODELO    VARCHAR(100)         
         ,@METODO    VARCHAR(100)	
         ,@USUARIO      VARCHAR(12)
DECLARE @EXISTE INT
DECLARE @NROCOMPROBANTE VARCHAR(20)
DECLARE @PROCEDENCIA VARCHAR(10)
DECLARE @IDSEDE VARCHAR(5)
DECLARE @IDFIRMA VARCHAR(20)
DECLARE @USUARIOMCP VARCHAR(20)
DECLARE @EQUIPO VARCHAR(256)
DECLARE @FIMPRESION VARCHAR(70)
BEGIN  
	SET DATEFORMAT dmy
   SET LANGUAGE Spanish;
	SELECT *
	INTO #JSON
	FROM OPENJSON (@json)
	WITH (
		MODELO         VARCHAR(100)     '$.MODELO',
		METODO         VARCHAR(100)     '$.METODO',
		USUARIO        VARCHAR(12)      '$.USUARIO',
		PARAMETROS     NVARCHAR(MAX)  AS JSON
	)
	SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
	FROM #JSON
	DECLARE @TBLERRORES TABLE(ERROR VARCHAR(200)); 
   
	   SELECT @NROCOMPROBANTE =  NROCOMPROBANTE
	   FROM OPENJSON (@PARAMETROS)
	   WITH (NROCOMPROBANTE       VARCHAR(20)    '$.NROCOMPROBANTE')
   
   IF NOT EXISTS(SELECT  * FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE)
   BEGIN
      SELECT 'KO' KO,'Nro. Comprobante  no encontrado' ERROR
      RETURN 
   END
   PRINT 'EMPIEZO A ARMAR EL REPORTE...' 

   SELECT @IDFIRMA=IDFIRMA
   FROM MCP INNER JOIN USUSU ON MCP.USUARIO=USUSU.USUARIO
   WHERE MCP.NROCOMPROBANTE=@NROCOMPROBANTE

   SELECT @EQUIPO=COALESCE(SYS_COMPUTERNAME,HOST_NAME()) FROM USUSU WHERE USUARIO=@USUARIO

   SELECT @FIMPRESION= CAST(DAY(GETDATE())AS VARCHAR(2))+' de '+
          UPPER(DATENAME(MONTH,GETDATE()))+' '+
          CAST(YEAR(GETDATE()) AS VARCHAR(4))+'  Hora:'+RIGHT(CONVERT(VARCHAR(20),GETDATE(),100),7)



   SELECT 'OK' OK, MCP.NROCOMPROBANTE,CONVERT(VARCHAR,FECHACONTABLE,103)FECHA,TER.NIT,TER.RAZONSOCIAL,
          MCP.NOREFERENCIA,REFERENCIA1,MCP.COMPROBANTE,COM.NOMCOMPROBANTE,MCP.OBSERVACION,MCP.TOTALDEBITO,MCP.TOTALCREDITO,
          @EQUIPO EQUIPO,@FIMPRESION FIMPRESION,MCP.USUARIO,USUSU.NOMBRE,MCP.ESTADO,COALESCE(ANULADO,0)ANULADO,
          CASE WHEN EXISTS(SELECT DICOM FROM ARCHIVOS WHERE ID =@IDFIRMA ) 
            THEN  (SELECT DICOM FROM ARCHIVOS WHERE ID =@IDFIRMA)
            ELSE '' END DICOM
   FROM MCP INNER JOIN COM ON MCP.COMPROBANTE=COM.COMPROBANTE
            LEFT JOIN TER ON MCP.IDTERCERO=TER.IDTERCERO
            LEFT JOIN USUSU ON MCP.USUARIO=USUSU.USUARIO
   WHERE MCP.NROCOMPROBANTE=@NROCOMPROBANTE

   SELECT MCH.CUENTA,MCH.DETALLE,MCH.TIPO,MCH.VALOR
   FROM MCH INNER JOIN CUE ON MCH.CUENTA=CUE.CUENTA
            LEFT  JOIN TER ON MCH.IDTERCERO=TER.IDTERCERO
   WHERE MCH.NROCOMPROBANTE=@NROCOMPROBANTE
    
   IF DBO.FNK_VALORVARIABLE('FACTSEDE')='SI'
   BEGIN
      SELECT TER.RAZONSOCIAL,TER.NIT,TER.DIRECCION,TER.TELEFONOS,CIU.NOMBRE CIUDAD,TER.EMAIL,SED.CODHABILITA
      FROM SED INNER JOIN TER ON SED.NIT=TER.NIT
                 INNER JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
      WHERE IDSEDE=@IDSEDE
   END
   ELSE
   BEGIN
      SELECT 'SIN SEDE'
   END
   RETURN
END

