IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SPK_MCP_ACT_TER' AND TYPE='P')
BEGIN
   DROP PROCEDURE SPK_MCP_ACT_TER
END

GO
CREATE PROCEDURE DBO.SPK_MCP_ACT_TER 
@N_COMPROBANTE     VARCHAR(20),
@COMPANIA          VARCHAR(2),
@IDTERCERO_NEW     VARCHAR(20),
@SEDE              VARCHAR(5),
@USUARIO           VARCHAR(12),
@SYS_COMPUTERNAME  VARCHAR(512)
WITH ENCRYPTION
AS
DECLARE @ANO    VARCHAR(5)
DECLARE @MES    INT
DECLARE @ANULADO INT
DECLARE @ESTADO  INT
DECLARE @ANONEW  VARCHAR(5)
DECLARE @MESNEW  INT
DECLARE @COM     VARCHAR(5)
DECLARE @NROCOMPROBANTENEW VARCHAR(20)
DECLARE @IDMODELOCONT    VARCHAR(2)
DECLARE @PREFIJO_USCXS   VARCHAR(10)
DECLARE @NOREFERENCIA    VARCHAR(20)
DECLARE @PROCEDENCIA     VARCHAR(20)

BEGIN
	IF EXISTS( SELECT  B.BANCO, B.SUCURSAL, B.CTA_BCO, B.ITEM, B.NROCOMPROBANTE
				FROM MCP M INNER JOIN 
				BMOV B ON B.NROCOMPROBANTE = M.NROCOMPROBANTE 
				WHERE  M.PROCEDENCIA='BMOV' AND B.NROCOMPROBANTE=@N_COMPROBANTE)
   BEGIN 
      SELECT @ANO=ANO,@MES=MES,@ESTADO=ESTADO,@ANULADO=COALESCE(ANULADO,0),@ANONEW=YEAR(GETDATE()),@MESNEW=MONTH(GETDATE()),
             @COM=COMPROBANTE,@PROCEDENCIA=PROCEDENCIA,@NOREFERENCIA=NOREFERENCIA
      FROM MCP WHERE NROCOMPROBANTE=@N_COMPROBANTE
      IF (SELECT COALESCE(CERRADO,0) FROM PRI WHERE ANO=@ANO AND MES=@MES)=1 --SELECT * FROM PRI
      BEGIN 
         PRINT 'CREANDO NUEVO MCP'            
         IF NOT EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA = @COMPANIA AND ANO=@ANONEW AND MES=@MESNEW)
         BEGIN
            PRINT CAST(@ANO AS VARCHAR(4))+CAST(@MES AS VARCHAR(3))
		      RAISERROR('EL PERIODO CONTABLE NO EXISTEN', 16, 1)
		      RETURN
         END
         IF EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA = @COMPANIA AND ANO=@ANONEW AND MES=@MESNEW AND COALESCE(CERRADO,0)=1)
         BEGIN
            PRINT CAST(@ANO AS VARCHAR(4))+CAST(@MES AS VARCHAR(3))
		      RAISERROR('EL PERIODO ACTUAL CERRADO', 16, 1)
		      RETURN
         END
	      /***************************************************************************************************************/
		   SET @IDMODELOCONT = DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE')
	      /***************************************************************************************************************/
         SET @NROCOMPROBANTENEW = SPACE(20) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
         EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@MCP',@NROCOMPROBANTENEW OUTPUT -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
         PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTENEW,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
         SELECT @NROCOMPROBANTENEW = @SEDE + REPLACE(SPACE(8 - CASE WHEN LEN(@NROCOMPROBANTENEW) > 8 THEN 8 ELSE LEN(@NROCOMPROBANTENEW) END)+LTRIM(RTRIM(@NROCOMPROBANTENEW)),SPACE(1),0) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
         PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTENEW,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
         --GENERO EL CONSECUTIVO DEL TIPO DE COMPROBANTE
         SET @PREFIJO_USCXS='@COM'+@COM
         SET @NOREFERENCIA=SPACE(20)

         EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,@PREFIJO_USCXS,@NOREFERENCIA OUTPUT   
         SELECT @NOREFERENCIA = REPLACE(SPACE(8 - LEN(@NOREFERENCIA))+LTRIM(RTRIM(@NOREFERENCIA)),SPACE(1),0)
         PRINT 'Nuevo Comprobante: '+@COM+' '+@NOREFERENCIA
         PRINT 'Comprobante Contable (MCP)'
         
         INSERT INTO MCP(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,
			                TOTALCREDITO, REFERENCIA1, REFERENCIA2,REFERENCIA3, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO,
			                COMPROBANTE, IDTERCERO, ANULADO )
         SELECT @NROCOMPROBANTENEW, @COMPANIA, PROCEDENCIA, @NOREFERENCIA, @ANONEW, @MESNEW,DBO.FNK_FECHA_SIN_HORA(GETDATE()) ,
	             TOTALDEBITO, TOTALCREDITO,REFERENCIA1, REFERENCIA2,NROCOMPROBANTE, USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), LOTE,OBSERVACION, 
	             IDSEDE, 0, COMPROBANTE, @IDTERCERO_NEW,0 FROM MCP WHERE NROCOMPROBANTE=@N_COMPROBANTE
	      
         PRINT 'Se lleno MCP ' 
		            
         INSERT INTO MCH(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
						   REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
						   N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
		   SELECT @NROCOMPROBANTENEW,@COMPANIA,'DB',CUENTA,IDTERCERO,CCOSTO, DETALLE,VALOR,REFERENCIA1,REFERENCIA2,ITEMREF,
		          USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,0 ,PROCESO, GENERA,
				    N_FACTURA,F_FACTURAREF,F_VENCE,CLASE_GENERA ,PROCEDENCIA,REFERENCIA_PRO, CODUNG,CODPRG 
				    FROM MCH WHERE NROCOMPROBANTE=@N_COMPROBANTE AND TIPO='CR'
		   PRINT ' SE LLENO DB'
		   
         INSERT INTO MCH(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
						   REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA,
						   N_FACTURA,F_FACTURAREF, F_VENCE, CLASE_GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
		   SELECT @NROCOMPROBANTENEW,@COMPANIA,'CR',CUENTA,@IDTERCERO_NEW,CCOSTO, DETALLE,VALOR,REFERENCIA1,REFERENCIA2,ITEMREF,
		          USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,0 ,PROCESO, GENERA,
				    N_FACTURA,F_FACTURAREF,F_VENCE,CLASE_GENERA ,PROCEDENCIA,REFERENCIA_PRO, CODUNG,CODPRG 
				    FROM MCH WHERE NROCOMPROBANTE=@N_COMPROBANTE AND TIPO='CR'		
		   	     
		  EXEC SPK_REVISAR_COMPROBANTE @COMPANIA,@NROCOMPROBANTENEW
        EXEC SPK_SUMA_DBCR @NROCOMPROBANTENEW					    
      END
      ELSE
      BEGIN
      IF (SELECT ESTADO FROM MCP WHERE NROCOMPROBANTE=@N_COMPROBANTE)=2
       BEGIN 
         
        EXEC SPK_NC_CONFIRMAR_CONTAB @N_COMPROBANTE,@USUARIO,@COMPANIA,@SEDE,@SYS_COMPUTERNAME,@ANO,@MES,@PROCEDENCIA,@NOREFERENCIA,'DESCONTABILIZAR'
                     
  	     UPDATE MCH SET IDTERCERO=@IDTERCERO_NEW  
        FROM  MCH H INNER JOIN MCP P ON
	            H.NROCOMPROBANTE = P.NROCOMPROBANTE 
        WHERE P.NROCOMPROBANTE=@N_COMPROBANTE  AND P.COMPANIA = @COMPANIA   
         
        UPDATE MCP SET IDTERCERO=@IDTERCERO_NEW 
        WHERE NROCOMPROBANTE=@N_COMPROBANTE  AND COMPANIA = @COMPANIA
         
        EXEC SPK_REVISAR_COMPROBANTE @COMPANIA,@N_COMPROBANTE
        EXEC SPK_SUMA_DBCR  @N_COMPROBANTE     
         
       END
      ELSE
       BEGIN 
         UPDATE MCH SET IDTERCERO=@IDTERCERO_NEW  
         FROM  MCH H INNER JOIN MCP P ON
	            H.NROCOMPROBANTE = P.NROCOMPROBANTE 
         WHERE P.NROCOMPROBANTE=@N_COMPROBANTE  AND P.COMPANIA = @COMPANIA   
         
         UPDATE MCP SET IDTERCERO=@IDTERCERO_NEW 
         WHERE NROCOMPROBANTE=@N_COMPROBANTE  AND COMPANIA = @COMPANIA
         
         EXEC SPK_REVISAR_COMPROBANTE @COMPANIA,@N_COMPROBANTE
         EXEC SPK_SUMA_DBCR  @N_COMPROBANTE 
       END
      END
   END
END


