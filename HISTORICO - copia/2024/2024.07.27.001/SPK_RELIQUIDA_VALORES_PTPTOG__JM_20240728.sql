IF EXISTS (SELECT name FROM sysobjects 
         WHERE name = 'SPK_RELIQUIDA_VALORES_PTPTOG' AND type = 'P')
   DROP PROCEDURE SPK_RELIQUIDA_VALORES_PTPTOG
GO
CREATE PROCEDURE DBO.SPK_RELIQUIDA_VALORES_PTPTOG 
@CONSECUTIVO  VARCHAR(20),  
@FECHAINICIAL DATETIME
WITH ENCRYPTION
AS  
DECLARE @EXISTE INT
BEGIN  
   EXEC SPK_QUITA_NULL_PTPTOG @CONSECUTIVO
   ALTER TABLE PTPTOG DISABLE TRIGGER ALL

   ALTER TABLE PTCDPD DISABLE TRIGGER ALL
   UPDATE PTCDPD SET  RUBRO_ID=PTRUB.RUBRO_ID
   FROM PTCDPD INNER JOIN PTRUB ON PTCDPD.RUBRO=PTRUB.RUBRO AND PTCDPD.CLASE=PTRUB.CLASE AND PTCDPD.CONSECUTIVO=PTRUB.CONSECUTIVO
   WHERE COALESCE(PTCDPD.RUBRO_ID,0)<>PTRUB.RUBRO_ID
   ALTER TABLE PTCDPD ENABLE TRIGGER ALL

   ALTER TABLE PTRPD DISABLE TRIGGER ALL
   UPDATE PTRPD SET  RUBRO_ID=PTRUB.RUBRO_ID
   FROM PTRPD INNER JOIN PTRUB ON PTRPD.RUBRO=PTRUB.RUBRO AND PTRPD.CLASE=PTRUB.CLASE AND PTRPD.CONSECUTIVO=PTRUB.CONSECUTIVO
   WHERE PTRPD.RUBRO_ID<>PTRUB.RUBRO_ID

   UPDATE PTRPD SET ITEMCDPD=PTCDPD.ITEM
   FROM PTRPD INNER JOIN PTCDPD ON PTRPD.CONSECUTIVO=PTCDPD.CONSECUTIVO
   AND PTRPD.CDP=PTCDPD.CDP
   AND PTCDPD.RUBRO=PTRPD.RUBRO
   AND PTCDPD.RUBRO_ID=PTRPD.RUBRO_ID
   WHERE PTRPD.CONSECUTIVO=@CONSECUTIVO
   AND COALESCE(PTRPD.ITEMCDPD,0)<>PTCDPD.ITEM

   ALTER TABLE PTCXPD DISABLE TRIGGER ALL
   UPDATE PTCXPD SET  RUBRO_ID=PTRUB.RUBRO_ID
   FROM PTCXPD INNER JOIN PTRUB ON PTCXPD.RUBRO=PTRUB.RUBRO AND PTCXPD.CLASE=PTRUB.CLASE AND PTCXPD.CONSECUTIVO=PTRUB.CONSECUTIVO
   WHERE PTCXPD.RUBRO_ID<>PTRUB.RUBRO_ID

   UPDATE PTCXPD SET ITEMCDPD=PTRPD.ITEMCDPD
   FROM PTCXPD INNER JOIN PTRPD ON PTCXPD.CONSECUTIVO=PTRPD.CONSECUTIVO
   AND PTCXPD.CDP=PTRPD.CDP
   AND PTCXPD.RP=PTRPD.RP
   AND PTCXPD.RUBRO=PTRPD.RUBRO
   AND PTCXPD.RUBRO_ID=PTRPD.RUBRO_ID
   AND PTCXPD.VALOR=PTRPD.VALOR
   AND PTCXPD.CLASE=PTRPD.CLASE
   WHERE PTCXPD.CONSECUTIVO=@CONSECUTIVO
   AND COALESCE(PTRPD.ITEMCDPD,0)<>PTCXPD.ITEMCDPD

   ALTER TABLE PTPAGD DISABLE TRIGGER ALL
   UPDATE PTPAGD SET  RUBRO_ID=PTRUB.RUBRO_ID
   FROM PTPAGD INNER JOIN PTRUB ON PTPAGD.RUBRO=PTRUB.RUBRO AND PTPAGD.CLASE=PTRUB.CLASE AND PTPAGD.CONSECUTIVO=PTRUB.CONSECUTIVO
   WHERE COALESCE(PTPAGD.RUBRO_ID,0)<>PTRUB.RUBRO_ID


   UPDATE PTPAGD SET ITEMCDPD=PTCXPD.ITEMCDPD
   FROM PTPAGD INNER JOIN PTCXPD ON PTPAGD.CONSECUTIVO=PTCXPD.CONSECUTIVO
   AND PTPAGD.CDP=PTCXPD.CDP
   AND PTPAGD.RP=PTCXPD.RP
   AND PTPAGD.RUBRO=PTCXPD.RUBRO
   AND PTPAGD.RUBRO_ID=PTCXPD.RUBRO_ID
   AND PTPAGD.CLASE=PTCXPD.CLASE
   WHERE PTPAGD.CONSECUTIVO=@CONSECUTIVO
   AND COALESCE(PTPAGD.ITEMCDPD,0)<>PTCXPD.ITEMCDPD


    UPDATE PTCXPD
    SET VALOR_PAG = ISNULL(B.VALOR,0)
    FROM PTCXPD  LEFT JOIN  
    (SELECT A.COMPANIA, A.CONSECUTIVO, A.CDP, A.RP, A.CNSCXP, A.CLASE, A.RUBRO, B.CCOSTO,A.ITEMCDPD, SUM(A.VALOR) VALOR 
       FROM PTPAGD A INNER JOIN
            PTPAG  B ON A.COMPANIA=B.COMPANIA AND A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP AND A.RP=B.RP AND 
                        A.CNSCXP=B.CNSCXP AND A.CNSPAGO=B.CNSPAGO
       WHERE B.ESTADO = 'Confirmado'
       AND A.CONSECUTIVO=@CONSECUTIVO
       GROUP BY A.COMPANIA, A.CONSECUTIVO, A.CDP, A.RP, A.CNSCXP, A.CLASE, A.RUBRO, B.CCOSTO,A.ITEMCDPD) B ON
        PTCXPD.COMPANIA=B.COMPANIA AND PTCXPD.CONSECUTIVO=B.CONSECUTIVO AND PTCXPD.CDP=B.CDP AND PTCXPD.RP=B.RP 
        AND PTCXPD.CNSCXP = B.CNSCXP AND PTCXPD.CLASE=B.CLASE AND PTCXPD.RUBRO=B.RUBRO  AND PTCXPD.ITEMCDPD =B.ITEMCDPD
       WHERE PTCXPD.CONSECUTIVO=@CONSECUTIVO

      UPDATE PTCXPD SET VLR_LIBERADO = 0 WHERE CONSECUTIVO=@CONSECUTIVO

      UPDATE PTCXPD SET VLR_LIBERADO=CXPM.VLR_LIBERADO
      FROM PTCXPD LEFT JOIN (SELECT PTCXPD.CONSECUTIVO,PTCXPD.RUBRO,PTCXPD.CDP,PTCXPD.RP, PTCXPD.CNSCXP,PTCXPD.ITEMCDPD,
            SUM(COALESCE(PTCDPDR.VALOR,0)) VLR_LIBERADO
            FROM PTCXPD INNER JOIN PTCXP ON PTCXPD.CONSECUTIVO=PTCXP.CONSECUTIVO AND PTCXPD.CDP=PTCXP.CDP AND PTCXPD.RP=PTCXP.RP
                                            AND PTCXPD.CNSCXP=PTCXP.CNSCXP
            LEFT JOIN PTCDPDR ON PTCXPD.CONSECUTIVO=PTCDPDR.CONSECUTIVO AND PTCXPD.RUBRO=PTCDPDR.RUBRO
                                    AND PTCXPD.CDP=PTCDPDR.CDP AND PTCXPD.RP=PTCDPDR.PTRP 
                                    AND  PTCXPD.CNSCXP=PTCDPDR.PTCXP
                                    AND PTCXPD.ITEMCDPD=PTCDPDR.ITEMCDPD
            WHERE PTCXP.CONSECUTIVO=@CONSECUTIVO
            AND PTCXP.ESTADO='Confirmado'
            AND PTCDPDR.PROCEDENCIA ='PTCXP'
            AND PTCDPDR.ESTADO='Confirmado'
            GROUP BY PTCXPD.CONSECUTIVO,PTCXPD.RUBRO,PTCXPD.CDP,PTCXPD.RP, PTCXPD.CNSCXP,PTCXPD.ITEMCDPD
                                    ) CXPM ON PTCXPD.CONSECUTIVO=CXPM.CONSECUTIVO AND PTCXPD.RUBRO=CXPM.RUBRO
                                    AND PTCXPD.CDP=CXPM.CDP  AND PTCXPD.RP=CXPM.RP AND PTCXPD.CNSCXP=CXPM.CNSCXP
      WHERE PTCXPD.CONSECUTIVO=@CONSECUTIVO


      UPDATE PTCXPD SET SALDO = VALOR-COALESCE(VALOR_PAG,0)-COALESCE(VLR_LIBERADO,0) WHERE CONSECUTIVO=@CONSECUTIVO

     UPDATE PTCXP SET VALOR = ISNULL(PTCXPD.VALOR,0), SALDO = ISNULL(PTCXPD.SALDO,0)
     FROM PTCXP LEFT JOIN
       (SELECT COMPANIA, CONSECUTIVO, CDP, RP, CNSCXP, SUM(VALOR) VALOR, SUM(SALDO) SALDO
        FROM PTCXPD 
        WHERE PTCXPD.CONSECUTIVO=@CONSECUTIVO
        GROUP BY COMPANIA, CONSECUTIVO, CDP, RP, CNSCXP) PTCXPD ON 
         PTCXP.COMPANIA = PTCXPD.COMPANIA AND PTCXP.CONSECUTIVO=PTCXPD.CONSECUTIVO AND 
         PTCXP.CDP=PTCXPD.CDP AND PTCXP.RP=PTCXPD.RP AND PTCXP.CNSCXP=PTCXPD.CNSCXP
     WHERE PTCXP.CONSECUTIVO=@CONSECUTIVO
     AND PTCXP.ESTADO='Confirmado'


     UPDATE PTRPD
      SET VALOR_CXP = ISNULL(B.VALOR,0)
      FROM PTRPD A  LEFT JOIN
      (SELECT A.COMPANIA, A.CONSECUTIVO, A.CDP, A.RP, A.CLASE, A.RUBRO, B.CCOSTO,A.ITEMCDPD, SUM(A.VALOR) VALOR 
       FROM PTCXPD A INNER JOIN
            PTCXP  B ON A.COMPANIA=B.COMPANIA AND A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP AND A.RP=B.RP AND 
                        A.CNSCXP=B.CNSCXP
       WHERE B.ESTADO = 'Confirmado'
       AND B.CONSECUTIVO=@CONSECUTIVO
       GROUP BY A.COMPANIA, A.CONSECUTIVO, A.CDP, A.RP, A.CLASE, A.RUBRO, B.CCOSTO,A.ITEMCDPD) B ON
        A.COMPANIA=B.COMPANIA AND A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP AND A.RP=B.RP AND
        A.CLASE=B.CLASE AND A.RUBRO=B.RUBRO  AND A.ITEMCDPD=B.ITEMCDPD

         UPDATE PTRPD SET VLR_LIBERADO = 0 WHERE CONSECUTIVO=@CONSECUTIVO

         UPDATE PTRPD SET VLR_LIBERADO=COALESCE(PTCDPDR.VALOR,0),VR_LIBECXP=COALESCE(PTCDPDR.VALORCXP,0)
         FROM PTRPD LEFT JOIN (SELECT CONSECUTIVO,CDP,PTRP,RUBRO,ITEMCDPD,SUM(CASE WHEN PROCEDENCIA='PTRP' THEN  VALOR ELSE 0 END) VALOR,
                                SUM(CASE WHEN PROCEDENCIA='PTCXP' THEN  VALOR ELSE 0 END) VALORCXP    
                                FROM PTCDPDR 
                                WHERE CONSECUTIVO=@CONSECUTIVO 
                                AND ESTADO='Confirmado'
                                AND PROCEDENCIA IN('PTRP','PTCXP')
                                GROUP BY CONSECUTIVO,CDP,PTRP,RUBRO,ITEMCDPD ) PTCDPDR  ON PTRPD.CONSECUTIVO=PTCDPDR.CONSECUTIVO AND PTRPD.RUBRO=PTCDPDR.RUBRO
                                         AND PTRPD.CDP=PTCDPDR.CDP AND PTRPD.RP=PTCDPDR.PTRP AND PTRPD.ITEMCDPD=PTCDPDR.ITEMCDPD
         WHERE PTRPD.CONSECUTIVO=@CONSECUTIVO
         
         UPDATE PTRPD SET SALDO = VALOR - (VALOR_CXP+COALESCE(VLR_LIBERADO,0)) WHERE CONSECUTIVO=@CONSECUTIVO
         --UPDATE PTRPD SET VALOR_CXP=VALOR_CXP-COALESCE(PTCDPDR.VALOR,0)
         --FROM PTRPD LEFT JOIN PTCDPDR ON PTRPD.CONSECUTIVO=PTCDPDR.CONSECUTIVO AND PTRPD.RUBRO=PTCDPDR.RUBRO
         --                                AND PTRPD.CDP=PTCDPDR.CDP AND PTRPD.RP=PTCDPDR.PTRP AND PTRPD.ITEMCDPD=PT
         --WHERE PTRPD.CONSECUTIVO=@CONSECUTIVO
         --AND PTCDPDR.PROCEDENCIA ='PTCXP'


        UPDATE PTRP SET VALOR = ISNULL(PTRPD.VALOR,0), SALDO = ISNULL(PTRPD.SALDO,0)
        FROM PTRP INNER JOIN
             (SELECT COMPANIA, CONSECUTIVO, CDP, RP, SUM(VALOR) VALOR, SUM(SALDO) SALDO
              FROM PTRPD 
              GROUP BY COMPANIA, CONSECUTIVO, CDP, RP) PTRPD ON 
               PTRP.COMPANIA = PTRPD.COMPANIA AND PTRP.CONSECUTIVO=PTRPD.CONSECUTIVO AND 
               PTRP.CDP=PTRPD.CDP AND PTRP.RP=PTRPD.RP 
         WHERE PTRP.CONSECUTIVO=@CONSECUTIVO
         AND PTRP.ESTADO='Confirmado'

         ALTER TABLE PTCDP DISABLE TRIGGER ALL
         ALTER TABLE PTCDPD DISABLE TRIGGER ALL

          UPDATE PTCDPD  
          SET VALOR_RP = ISNULL(B.VALOR,0)  
          FROM PTCDPD A INNER JOIN PTCDP D ON A.CDP = D.CDP
                                          AND A.COMPANIA = D.COMPANIA
                                          AND A.CONSECUTIVO = D.CONSECUTIVO
                        INNER JOIN (SELECT A.COMPANIA, A.CONSECUTIVO, A.CDP, A.CLASE, A.RUBRO, B.CCOSTO,A.ITEMCDPD, SUM(A.VALOR) VALOR   
                                   FROM   PTRPD A INNER JOIN PTRP  B ON A.COMPANIA=B.COMPANIA 
                                                                    AND A.CONSECUTIVO=B.CONSECUTIVO 
                                                                    AND A.CDP=B.CDP 
                                                                    AND A.RP=B.RP  
                                   WHERE B.ESTADO = 'Confirmado'  
                                   AND A.CONSECUTIVO=@CONSECUTIVO
                                   GROUP BY A.COMPANIA, A.CONSECUTIVO, A.CDP, A.CLASE, A.RUBRO, B.CCOSTO,A.ITEMCDPD) B ON A.COMPANIA=B.COMPANIA 
                                                                                                  AND A.CONSECUTIVO=B.CONSECUTIVO 
                                                                                                  AND A.CDP=B.CDP 
                                                                                                  AND A.CLASE=B.CLASE 
                                                                                                  AND A.RUBRO=B.RUBRO 
                                                                                                  AND D.CCOSTO = B.CCOSTO 
                                                                                                  AND A.ITEM=B.ITEMCDPD
         WHERE A.CONSECUTIVO=@CONSECUTIVO
         AND D.ESTADO='Confirmado'


         UPDATE PTCDPD SET VLR_LIBERADO=0  WHERE CONSECUTIVO=@CONSECUTIVO 

         UPDATE PTCDPD SET VLR_LIBERADO= COALESCE(PTCDPDR.VALOR,0),VR_LIBERP= COALESCE(PTCDPDR.VALORRP,0),VR_LIBECXP= COALESCE(PTCDPDR.VALORCXP,0)
         FROM PTCDPD LEFT JOIN (SELECT CONSECUTIVO,RUBRO,IDTIPOMOV,CLASE,CDP,SUM( CASE WHEN PTCDPDR.PROCEDENCIA='CDP' THEN VALOR ELSE 0 END) VALOR, 
                                 SUM( CASE WHEN PTCDPDR.PROCEDENCIA='PTRP' THEN VALOR ELSE 0 END) VALORRP,
                                 SUM( CASE WHEN PTCDPDR.PROCEDENCIA='PTCXP' THEN VALOR ELSE 0 END) VALORCXP
                                 FROM PTCDPDR WHERE CONSECUTIVO=@CONSECUTIVO 
                                 AND PTCDPDR.PROCEDENCIA IN('CDP','PTRP','PTCXP')
                                 AND PTCDPDR.ESTADO='Confirmado'
                                 GROUP BY CONSECUTIVO,RUBRO,IDTIPOMOV,CLASE,CDP) PTCDPDR ON PTCDPD.CONSECUTIVO=PTCDPDR.CONSECUTIVO AND PTCDPD.RUBRO=PTCDPDR.RUBRO
                                           AND PTCDPD.IDTIPOMOV=PTCDPDR.IDTIPOMOV AND PTCDPD.CLASE=PTCDPDR.CLASE
                                           AND PTCDPD.CDP=PTCDPDR.CDP
         WHERE PTCDPD.CONSECUTIVO=@CONSECUTIVO

         --UPDATE PTCDPD SET VALOR_RP=VALOR_RP-COALESCE(PTCDPDR.VALOR,0)
         --FROM PTCDPD LEFT JOIN (SELECT CONSECUTIVO,RUBRO,IDTIPOMOV,CLASE,CDP,SUM(VALOR)VALOR 
         --                        FROM PTCDPDR WHERE CONSECUTIVO=@CONSECUTIVO 
         --                        AND PTCDPDR.PROCEDENCIA IN('PTRP','PTCXP')
         --                        GROUP BY CONSECUTIVO,RUBRO,IDTIPOMOV,CLASE,CDP) PTCDPDR ON PTCDPD.CONSECUTIVO=PTCDPDR.CONSECUTIVO AND PTCDPD.RUBRO=PTCDPDR.RUBRO
         --                                  AND PTCDPD.IDTIPOMOV=PTCDPDR.IDTIPOMOV AND PTCDPD.CLASE=PTCDPDR.CLASE
         --                                  AND PTCDPD.CDP=PTCDPDR.CDP
         --WHERE PTCDPD.CONSECUTIVO=@CONSECUTIVO


		  UPDATE PTCDPD SET SALDO = VALOR - (VALOR_RP+COALESCE(VLR_LIBERADO,0)) WHERE CONSECUTIVO=@CONSECUTIVO

		   UPDATE PTCDP SET VALOR = ISNULL(P2.VALOR,0), SALDO = ISNULL(P2.SALDO,0)
		   FROM PTCDP 	INNER JOIN (SELECT COMPANIA,CONSECUTIVO,CDP,SUM(VALOR)VALOR,SUM(SALDO)SALDO 
                                    FROM PTCDPD WHERE CONSECUTIVO=@CONSECUTIVO
                                    GROUP BY COMPANIA,CONSECUTIVO,CDP ) P2 ON PTCDP.COMPANIA=P2.COMPANIA 
                                                                           AND PTCDP.CONSECUTIVO=P2.CONSECUTIVO 
                                                                           AND PTCDP.CDP=P2.CDP
         WHERE PTCDP.CONSECUTIVO=@CONSECUTIVO
         AND PTCDP.ESTADO='Confirmado'


   ALTER TABLE PTRPD ENABLE TRIGGER ALL
   ALTER TABLE PTCXPD ENABLE TRIGGER ALL
   ALTER TABLE PTPAGD ENABLE TRIGGER ALL


   UPDATE PTPTOG SET RUBRO_ID=PTRUB.RUBRO_ID
   FROM PTPTOG INNER JOIN PTRUB ON PTPTOG.RUBRO=PTRUB.RUBRO AND PTPTOG.CLASE=PTRUB.CLASE AND  PTPTOG.CONSECUTIVO=PTRUB.CONSECUTIVO
   WHERE COALESCE(PTPTOG.RUBRO_ID,0)<>PTRUB.RUBRO_ID


   SELECT RUBRO,
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=1  AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) CDP01,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=1  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA01,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=2  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP02,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=2  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA02,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=3  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP03,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=3  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA03,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=4  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP04,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=4  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA04,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=5  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP05,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=5  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA05,  
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=6  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP06, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=6  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA06, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=7  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP07, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=7  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA07, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=8  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP08, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=8  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA08, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=9  AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CDP09, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=9  AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CDPA09, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=10 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) CDP10, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=10 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) CDPA10, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=11 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) CDP11, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=11 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) CDPA11, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=12 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) CDP12, 
   SUM(CASE WHEN MONTH(A.FECHAEXPEDICION)=12 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) CDPA12 
   INTO #F
   FROM PTCDP A INNER JOIN PTCDPD B ON  A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP 
   WHERE  A.CONSECUTIVO=@CONSECUTIVO AND A.ESTADO='Confirmado' AND  FECHAEXPEDICION>=@FECHAINICIAL
   GROUP BY RUBRO

   UPDATE PTPTOG SET 
   CDP01=COALESCE(A.CDP01,0),
   CDPA01=COALESCE(A.CDPA01,0),
   CDP02=COALESCE(A.CDP02,0),
   CDPA02=COALESCE(A.CDPA02,0),
   CDP03=COALESCE(A.CDP03,0),
   CDPA03=COALESCE(A.CDPA03,0),
   CDP04=COALESCE(A.CDP04,0),
   CDPA04=COALESCE(A.CDPA04,0),
   CDP05=COALESCE(A.CDP05,0),
   CDPA05=COALESCE(A.CDPA05,0),
   CDP06=COALESCE(A.CDP06,0),
   CDPA06=COALESCE(A.CDPA06,0),
   CDP07=COALESCE(A.CDP07,0),
   CDPA07=COALESCE(A.CDPA07,0),
   CDP08=COALESCE(A.CDP08,0),
   CDPA08=COALESCE(A.CDPA08,0),
   CDP09=COALESCE(A.CDP09,0),
   CDPA09=COALESCE(A.CDPA09,0),
   CDP10=COALESCE(A.CDP10,0),
   CDPA10=COALESCE(A.CDPA10,0),
   CDP11=COALESCE(A.CDP11,0),
   CDPA11=COALESCE(A.CDPA11,0),
   CDP12=COALESCE(A.CDP12,0),
   CDPA12=COALESCE(A.CDPA12,0)
   FROM PTPTOG LEFT JOIN #F  A ON PTPTOG.RUBRO=A.RUBRO
   WHERE PTPTOG.CONSECUTIVO=@CONSECUTIVO

   SELECT B.RUBRO,
   SUM(CASE WHEN MONTH(A.FECHARP)=1 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) RP01,  
   SUM(CASE WHEN MONTH(A.FECHARP)=1 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA01,  
   SUM(CASE WHEN MONTH(A.FECHARP)=2 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP02,  
   SUM(CASE WHEN MONTH(A.FECHARP)=2 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA02,  
   SUM(CASE WHEN MONTH(A.FECHARP)=3 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP03,  
   SUM(CASE WHEN MONTH(A.FECHARP)=3 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA03,  
   SUM(CASE WHEN MONTH(A.FECHARP)=4 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP04,  
   SUM(CASE WHEN MONTH(A.FECHARP)=4 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA04,  
   SUM(CASE WHEN MONTH(A.FECHARP)=5 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP05,  
   SUM(CASE WHEN MONTH(A.FECHARP)=5 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA05,  
   SUM(CASE WHEN MONTH(A.FECHARP)=6 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP06, 
   SUM(CASE WHEN MONTH(A.FECHARP)=6 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA06, 
   SUM(CASE WHEN MONTH(A.FECHARP)=7 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP07, 
   SUM(CASE WHEN MONTH(A.FECHARP)=7 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA07, 
   SUM(CASE WHEN MONTH(A.FECHARP)=8 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP08, 
   SUM(CASE WHEN MONTH(A.FECHARP)=8 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA08, 
   SUM(CASE WHEN MONTH(A.FECHARP)=9 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP09, 
   SUM(CASE WHEN MONTH(A.FECHARP)=9 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA09, 
   SUM(CASE WHEN MONTH(A.FECHARP)=10 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP10, 
   SUM(CASE WHEN MONTH(A.FECHARP)=10 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA10, 
   SUM(CASE WHEN MONTH(A.FECHARP)=11 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP11, 
   SUM(CASE WHEN MONTH(A.FECHARP)=11 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA11, 
   SUM(CASE WHEN MONTH(A.FECHARP)=12 AND COALESCE(VIGENCIA,'Actual')='Actual'THEN B.VALOR ELSE 0 END) RP12, 
   SUM(CASE WHEN MONTH(A.FECHARP)=12 AND COALESCE(VIGENCIA,'Actual')='Anterior'THEN B.VALOR ELSE 0 END) RPA12 
   INTO #G
   FROM PTRP A INNER JOIN PTRPD B  ON A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP AND A.RP=B.RP
               LEFT JOIN PTCDPD C ON B.CONSECUTIVO=C.CONSECUTIVO AND B.CDP=C.CDP AND B.RUBRO=C.RUBRO AND B.ITEMCDPD=C.ITEM AND B.RUBRO_ID=C.RUBRO_ID
   WHERE  A.CONSECUTIVO=@CONSECUTIVO AND A.ESTADO='Confirmado' --AND  FECHARP>=@FECHAINICIAL
   GROUP BY B.RUBRO

   UPDATE PTPTOG
   SET 
   RP01=COALESCE(A.RP01,0),
   RPA01=COALESCE(A.RPA01,0),
   RP02=COALESCE(A.RP02,0),
   RPA02=COALESCE(A.RPA02,0),
   RP03=COALESCE(A.RP03,0),
   RPA03=COALESCE(A.RPA03,0),
   RP04=COALESCE(A.RP04,0),
   RPA04=COALESCE(A.RPA04,0),
   RP05=COALESCE(A.RP05,0),
   RPA05=COALESCE(A.RPA05,0),
   RP06=COALESCE(A.RP06,0),
   RPA06=COALESCE(A.RPA06,0),
   RP07=COALESCE(A.RP07,0),
   RPA07=COALESCE(A.RPA07,0),
   RP08=COALESCE(A.RP08,0),
   RPA08=COALESCE(A.RPA08,0),
   RP09=COALESCE(A.RP09,0),
   RPA09=COALESCE(A.RPA09,0),
   RP10=COALESCE(A.RP10,0),
   RPA10=COALESCE(A.RPA10,0),
   RP11=COALESCE(A.RP11,0),
   RPA11=COALESCE(A.RPA11,0),
   RP12=COALESCE(A.RP12,0),
   RPA12=COALESCE(A.RPA12,0)
   FROM PTPTOG LEFT JOIN #G  A ON PTPTOG.RUBRO=A.RUBRO
   WHERE PTPTOG.CONSECUTIVO=@CONSECUTIVO


   SELECT B.RUBRO,
   SUM(CASE WHEN MONTH(A.FECHA)=1 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP01,  
   SUM(CASE WHEN MONTH(A.FECHA)=1 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA01,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP02,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA02,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP03,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA03,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP04,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA04,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP05,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA05,  
   SUM(CASE WHEN MONTH(A.FECHA)=6 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP06, 
   SUM(CASE WHEN MONTH(A.FECHA)=6 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA06, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP07, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA07, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP08, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA08, 
   SUM(CASE WHEN MONTH(A.FECHA)=9 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP09, 
   SUM(CASE WHEN MONTH(A.FECHA)=9 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA09, 
   SUM(CASE WHEN MONTH(A.FECHA)=10 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP10, 
   SUM(CASE WHEN MONTH(A.FECHA)=10 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA10, 
   SUM(CASE WHEN MONTH(A.FECHA)=11 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP11, 
   SUM(CASE WHEN MONTH(A.FECHA)=11 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA11, 
   SUM(CASE WHEN MONTH(A.FECHA)=12 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) CXP12,
   SUM(CASE WHEN MONTH(A.FECHA)=12 AND COALESCE(VIGENCIA,'Actual')='Anterior' THEN B.VALOR ELSE 0 END) CXPA12
   INTO #H
   FROM PTCXP A INNER JOIN PTCXPD B ON  A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP  AND A.RP=B.RP AND A.CNSCXP=B.CNSCXP
                LEFT JOIN PTCDPD C ON B.CONSECUTIVO=C.CONSECUTIVO AND B.CDP=C.CDP AND B.RUBRO=C.RUBRO AND B.ITEMCDPD=C.ITEM AND B.RUBRO_ID=C.RUBRO_ID
   WHERE  A.CONSECUTIVO=@CONSECUTIVO AND A.ESTADO='Confirmado' AND  FECHA>=@CONSECUTIVO
   GROUP BY B.RUBRO

   UPDATE PTPTOG
   SET 
   CXP01=COALESCE(A.CXP01,0),
   CXPA01=COALESCE(A.CXPA01,0),
   CXP02=COALESCE(A.CXP02,0),
   CXPA02=COALESCE(A.CXPA02,0),
   CXP03=COALESCE(A.CXP03,0),
   CXPA03=COALESCE(A.CXPA03,0),
   CXP04=COALESCE(A.CXP04,0),
   CXPA04=COALESCE(A.CXPA04,0),
   CXP05=COALESCE(A.CXP05,0),
   CXPA05=COALESCE(A.CXPA05,0),
   CXP06=COALESCE(A.CXP06,0),
   CXPA06=COALESCE(A.CXPA06,0),
   CXP07=COALESCE(A.CXP07,0),
   CXPA07=COALESCE(A.CXPA07,0),
   CXP08=COALESCE(A.CXP08,0),
   CXPA08=COALESCE(A.CXPA08,0),
   CXP09=COALESCE(A.CXP09,0),
   CXPA09=COALESCE(A.CXPA09,0),
   CXP10=COALESCE(A.CXP10,0),
   CXPA10=COALESCE(A.CXPA10,0),
   CXP11=COALESCE(A.CXP11,0),
   CXPA11=COALESCE(A.CXPA11,0),
   CXP12=COALESCE(A.CXP12,0),
   CXPA12=COALESCE(A.CXPA12,0)
   FROM PTPTOG LEFT JOIN #H  A ON PTPTOG.RUBRO=A.RUBRO
   WHERE PTPTOG.CONSECUTIVO=@CONSECUTIVO

   SELECT B.RUBRO,
   SUM(CASE WHEN MONTH(A.FECHA)=1 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) PAG01,  
   SUM(CASE WHEN MONTH(A.FECHA)=1 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA01,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) PAG02,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA02,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 AND COALESCE(VIGENCIA,'Actual')='Actual' THEN B.VALOR ELSE 0 END) PAG03,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA03,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG04,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA04,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG05,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA05,  
   SUM(CASE WHEN MONTH(A.FECHA)=6 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG06, 
   SUM(CASE WHEN MONTH(A.FECHA)=6 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA06, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG07, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA07, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG08, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA08, 
   SUM(CASE WHEN MONTH(A.FECHA)=9 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG09, 
   SUM(CASE WHEN MONTH(A.FECHA)=9 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA09, 
   SUM(CASE WHEN MONTH(A.FECHA)=10 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG10, 
   SUM(CASE WHEN MONTH(A.FECHA)=10 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA10, 
   SUM(CASE WHEN MONTH(A.FECHA)=11 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG11, 
   SUM(CASE WHEN MONTH(A.FECHA)=11 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA11,  
   SUM(CASE WHEN MONTH(A.FECHA)=12 AND COALESCE(VIGENCIA,'Actual')='Actual'  THEN B.VALOR ELSE 0 END) PAG12,
   SUM(CASE WHEN MONTH(A.FECHA)=12 AND COALESCE(VIGENCIA,'Actual')='Anterior'  THEN B.VALOR ELSE 0 END) PAGA12
   INTO #J
   FROM PTPAG A INNER JOIN PTPAGD B ON  A.CONSECUTIVO=B.CONSECUTIVO AND A.CDP=B.CDP  AND A.RP=B.RP AND A.CNSCXP=B.CNSCXP AND A.CNSPAGO=B.CNSPAGO
                LEFT JOIN PTCDPD C ON B.CONSECUTIVO=C.CONSECUTIVO AND B.CDP=C.CDP AND B.RUBRO=C.RUBRO AND B.ITEMCDPD=C.ITEM AND B.RUBRO_ID=C.RUBRO_ID
   WHERE  A.CONSECUTIVO=@CONSECUTIVO AND A.ESTADO='Confirmado' AND  FECHA>=@CONSECUTIVO
   GROUP BY B.RUBRO

   UPDATE PTPTOG
   SET 
   PAG01=COALESCE(A.PAG01,0),
   PAGA01=COALESCE(A.PAGA01,0),
   PAG02=COALESCE(A.PAG02,0),
   PAGA02=COALESCE(A.PAGA02,0),
   PAG03=COALESCE(A.PAG03,0),
   PAGA03=COALESCE(A.PAGA03,0),
   PAG04=COALESCE(A.PAG04,0),
   PAGA04=COALESCE(A.PAGA04,0),
   PAG05=COALESCE(A.PAG05,0),
   PAGA05=COALESCE(A.PAGA05,0),
   PAG06=COALESCE(A.PAG06,0),
   PAGA06=COALESCE(A.PAGA06,0),
   PAG07=COALESCE(A.PAG07,0),
   PAGA07=COALESCE(A.PAGA07,0),
   PAG08=COALESCE(A.PAG08,0),
   PAGA08=COALESCE(A.PAGA08,0),
   PAG09=COALESCE(A.PAG09,0),
   PAGA09=COALESCE(A.PAGA09,0),
   PAG10=COALESCE(A.PAG10,0),
   PAGA10=COALESCE(A.PAGA10,0),
   PAG11=COALESCE(A.PAG11,0),
   PAGA11=COALESCE(A.PAGA11,0),
   PAG12=COALESCE(A.PAG12,0),
   PAGA12=COALESCE(A.PAGA12,0)
   FROM PTPTOG LEFT JOIN #J  A ON PTPTOG.RUBRO=A.RUBRO
   WHERE PTPTOG.CONSECUTIVO=@CONSECUTIVO

   SELECT RUBRO,
   SUM(CASE WHEN MONTH(A.FECHA)=1 THEN A.VALOR ELSE 0 END) CDPR01,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 THEN A.VALOR ELSE 0 END) CDPR02,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 THEN A.VALOR ELSE 0 END) CDPR03,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 THEN A.VALOR ELSE 0 END) CDPR04,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 THEN A.VALOR ELSE 0 END) CDPR05,  
   SUM(CASE WHEN MONTH(A.FECHA)=6 THEN A.VALOR ELSE 0 END) CDPR06, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 THEN A.VALOR ELSE 0 END) CDPR07, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 THEN A.VALOR ELSE 0 END) CDPR08,
   SUM(CASE WHEN MONTH(A.FECHA)=9 THEN A.VALOR ELSE 0 END) CDPR09,
   SUM(CASE WHEN MONTH(A.FECHA)=10 THEN A.VALOR ELSE 0 END) CDPR10,
   SUM(CASE WHEN MONTH(A.FECHA)=11 THEN A.VALOR ELSE 0 END) CDPR11,
   SUM(CASE WHEN MONTH(A.FECHA)=12 THEN A.VALOR ELSE 0 END) CDPR12,
   SUM(CASE WHEN MONTH(A.FECHA)=1 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES01,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES02,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES03,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES04,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES05,  
   SUM(CASE WHEN MONTH(A.FECHA)=6 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES06, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES07, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES08,
   SUM(CASE WHEN MONTH(A.FECHA)=9 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES09,
   SUM(CASE WHEN MONTH(A.FECHA)=10 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES10,
   SUM(CASE WHEN MONTH(A.FECHA)=11 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES11,
   SUM(CASE WHEN MONTH(A.FECHA)=12 AND PROCEDENCIA='PTRP' THEN A.VALOR ELSE 0 END) PTRES12,
   SUM(CASE WHEN MONTH(A.FECHA)=1 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR01,  
   SUM(CASE WHEN MONTH(A.FECHA)=2 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR02,  
   SUM(CASE WHEN MONTH(A.FECHA)=3 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR03,  
   SUM(CASE WHEN MONTH(A.FECHA)=4 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR04,  
   SUM(CASE WHEN MONTH(A.FECHA)=5 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR05,  
   SUM(CASE WHEN MONTH(A.FECHA)=6 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR06, 
   SUM(CASE WHEN MONTH(A.FECHA)=7 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR07, 
   SUM(CASE WHEN MONTH(A.FECHA)=8 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR08,
   SUM(CASE WHEN MONTH(A.FECHA)=9 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END)  PTCXPR09,
   SUM(CASE WHEN MONTH(A.FECHA)=10 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END) PTCXPR10,
   SUM(CASE WHEN MONTH(A.FECHA)=11 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END) PTCXPR11,
   SUM(CASE WHEN MONTH(A.FECHA)=12 AND PROCEDENCIA='PTCXP' THEN A.VALOR ELSE 0 END) PTCXPR12
   INTO #I
   FROM PTCDPDR A
   WHERE CONSECUTIVO=@CONSECUTIVO
   AND ESTADO='Confirmado'
   GROUP BY RUBRO

   UPDATE PTPTOG
   SET 
   CDPR01=COALESCE(A.CDPR01,0),
   CDPR02=COALESCE(A.CDPR02,0),
   CDPR03=COALESCE(A.CDPR03,0),
   CDPR04=COALESCE(A.CDPR04,0),
   CDPR05=COALESCE(A.CDPR05,0),
   CDPR06=COALESCE(A.CDPR06,0),
   CDPR07=COALESCE(A.CDPR07,0),
   CDPR08=COALESCE(A.CDPR08,0),
   CDPR09=COALESCE(A.CDPR09,0),
   CDPR10=COALESCE(A.CDPR10,0),
   CDPR11=COALESCE(A.CDPR11,0),
   CDPR12=COALESCE(A.CDPR12,0),
   PTRES01=COALESCE(A.PTRES01,0),
   PTRES02=COALESCE(A.PTRES02,0),
   PTRES03=COALESCE(A.PTRES03,0),
   PTRES04=COALESCE(A.PTRES04,0),
   PTRES05=COALESCE(A.PTRES05,0),
   PTRES06=COALESCE(A.PTRES06,0),
   PTRES07=COALESCE(A.PTRES07,0),
   PTRES08=COALESCE(A.PTRES08,0),
   PTRES09=COALESCE(A.PTRES09,0),
   PTRES10=COALESCE(A.PTRES10,0),
   PTRES11=COALESCE(A.PTRES11,0),
   PTRES12=COALESCE(A.PTRES12,0),
   PTCXPR01=COALESCE(A.PTCXPR01,0),
   PTCXPR02=COALESCE(A.PTCXPR02,0),
   PTCXPR03=COALESCE(A.PTCXPR03,0),
   PTCXPR04=COALESCE(A.PTCXPR04,0),
   PTCXPR05=COALESCE(A.PTCXPR05,0),
   PTCXPR06=COALESCE(A.PTCXPR06,0),
   PTCXPR07=COALESCE(A.PTCXPR07,0),
   PTCXPR08=COALESCE(A.PTCXPR08,0),
   PTCXPR09=COALESCE(A.PTCXPR09,0),
   PTCXPR10=COALESCE(A.PTCXPR10,0),
   PTCXPR11=COALESCE(A.PTCXPR11,0),
   PTCXPR12=COALESCE(A.PTCXPR12,0)
   FROM PTPTOG LEFT JOIN #I  A ON PTPTOG.RUBRO=A.RUBRO
   WHERE PTPTOG.CONSECUTIVO=@CONSECUTIVO




   DROP TABLE #F
   DROP TABLE #G
   DROP TABLE #H
   DROP TABLE #I
   DROP TABLE #J

   ALTER TABLE PTCDP ENABLE TRIGGER ALL
   ALTER TABLE PTCDPD ENABLE TRIGGER ALL
   ALTER TABLE PTCDPDR ENABLE TRIGGER ALL
   ALTER TABLE PTRP ENABLE TRIGGER ALL
   ALTER TABLE PTRPD ENABLE TRIGGER ALL
   ALTER TABLE PTCXP ENABLE TRIGGER ALL
   ALTER TABLE PTCXPD ENABLE TRIGGER ALL
   ALTER TABLE PTPAG ENABLE TRIGGER ALL
   ALTER TABLE PTPAGD ENABLE TRIGGER ALL
   ALTER TABLE PTPTOG ENABLE TRIGGER ALL

   ALTER TABLE PTPTOG ENABLE TRIGGER ALL
END



