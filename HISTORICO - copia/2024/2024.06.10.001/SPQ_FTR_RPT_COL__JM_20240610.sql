CREATE OR ALTER PROCEDURE DBO.SPQ_FTR_RPT_COL @JSON NVARCHAR(MAX)
	WITH ENCRYPTION
AS
SET DATEFORMAT dmy
DECLARE @TBLERRORES TABLE (ERROR VARCHAR(MAX))
DECLARE  @PARAMETROS NVARCHAR(MAX)			,@MODELO VARCHAR(100)			   ,@METODO VARCHAR(100)
		,@USUARIO VARCHAR(12)				   ,@COMPANIA VARCHAR(2)		      ,@IDSEDE      VARCHAR(5)		
      ,@SYS_COMPUTERNAME VARCHAR(200)     ,@DATOS    VARCHAR(MAX)
      ,@PROCESO VARCHAR(20)               ,@F_INICIAL DATETIME               ,@F_FINAL DATETIME
      ,@IDTERCERO VARCHAR(20)             ,@IDPLAN VARCHAR(20)              ,@PARTICULAR VARCHAR(20)
      ,@IDSEDEF VARCHAR(20)               ,@PROCEDENCIA VARCHAR(20)         ,@USUARIOFACTU VARCHAR(20)
      ,@TERCONTABLE VARCHAR(20)           ,@AREAFUNCIONAL VARCHAR(20)       ,@PREFIJO VARCHAR(20)
      ,@IDSERVICIO VARCHAR(20)            ,@PART VARCHAR(MAX)               ,@SQL VARCHAR(MAX)
      ,@ESTFTR VARCHAR(120)               ,@WHERE VARCHAR(MAX)              ,@SELECT VARCHAR(MAX)
BEGIN
	SELECT *
	INTO #JSON
	FROM OPENJSON(@json) WITH (
			MODELO VARCHAR(100) '$.MODELO'
			,METODO VARCHAR(100) '$.METODO'
			,USUARIO VARCHAR(12) '$.USUARIO'
			,PARAMETROS NVARCHAR(MAX) AS JSON
	)

	SELECT   @MODELO = MODELO			,@METODO = METODO
			,@PARAMETROS = PARAMETROS	,@USUARIO = USUARIO
	FROM #JSON
   IF @METODO='GENERAR_RPT'     
   BEGIN         
      SELECT @PROCESO=PROCESO, @DATOS=DATOS        
      FROM   OPENJSON (@PARAMETROS)
      WITH ( 
         PROCESO VARCHAR(20) '$.PROCESO',
         DATOS NVARCHAR(MAX) AS JSON 
            )           
      
         SELECT  @F_INICIAL=F_INICIAL, @F_FINAL=F_FINAL, @IDTERCERO=IDTERCERO, @IDPLAN=IDPLAN, @PARTICULAR=PARTICULAR, @IDSEDEF=IDSEDEF,
         @PROCEDENCIA=CASE WHEN PROCEDENCIA<>'Todas' THEN CASE PROCEDENCIA WHEN 'Asistencial' THEN 'SALUD' WHEN 'Citas' THEN 'CI' WHEN 'Ordenes CE' THEN 'CE'
         WHEN 'Financieras' THEN 'FINANCIERO' WHEN 'Inventario' THEN 'INVENTARIO' WHEN 'Caja' THEN 'CAJA' ELSE '' END ELSE PROCEDENCIA END, @USUARIOFACTU=USUARIOFACTU, @TERCONTABLE=TERCONTABLE, @AREAFUNCIONAL=AREAFUNCIONAL,  @PREFIJO=PREFIJO,
         @IDSERVICIO=IDSERVICIO     
         FROM   OPENJSON (@DATOS)
         WITH   (  
         F_INICIAL DATE            '$.F_INICIAL',
         F_FINAL DATE              '$.F_FINAL',
         IDTERCERO VARCHAR(20)     '$.IDTERCERO',
         IDPLAN VARCHAR(6)         '$.IDPLAN',
         PARTICULAR VARCHAR(20)    '$.PARTICULAR',
         IDSEDEF VARCHAR(6)        '$.IDSEDE',
         PROCEDENCIA VARCHAR(20)   '$.PROCEDENCIA',
         USUARIOFACTU VARCHAR(20)  '$.USUARIOFACTU',
         TERCONTABLE VARCHAR(20)   '$.TERCONTABLE',
         AREAFUNCIONAL VARCHAR(20) '$.AREAFUNCIONAL',
         PREFIJO VARCHAR(20)       '$.PREFIJO',
         IDSERVICIO VARCHAR(20)    '$.IDSERVICIO'       
         )   
      IF (OBJECT_ID('tempdb.dbo.#FTR','U')) IS NULL
      BEGIN
         CREATE TABLE #FTR(N_FACTURA VARCHAR(20) COLLATE database_default)
      END
      ELSE
      BEGIN
         DELETE #FTR
      END
      IF  DBO.FNK_VALORVARIABLE('SEPARA_NC_RPT_FACT')<>'NO' AND @PROCESO <> 'NotasCr'
      BEGIN
         INSERT INTO #FTR(N_FACTURA)
         SELECT DISTINCT FTR.N_FACTURA 
         FROM FTR INNER JOIN FNOT ON FTR.N_FACTURA = FNOT.N_FACTURA
         WHERE COALESCE(TIPOANULACION, '') = 'NC'
         AND F_FACTURA>=CONVERT(VARCHAR(10),@F_INICIAL,103)
         AND F_FACTURA< CONVERT(VARCHAR(10),@F_FINAL + 1,103)
      END
      --ARMADO DE CLAUSULA PARTICULARES
      SELECT @PART = ''
      IF LEFT(@PARTICULAR,1) = '1'
      BEGIN
         SELECT @PART = ' AND  FTR.IDPLAN NOT IN( SELECT DATO FROM USVGS WHERE IDVARIABLE IN
         (''IDPLANPART'',''IDPLANPART2'',''IDPLANPART3'',''IDPLANPART4'',''IDPLANPART5''))'
      END
      ELSE IF  LEFT(@PARTICULAR,1) = '2'
      BEGIN
         SELECT @PART = ' AND  FTR.IDPLAN IN( SELECT DATO FROM USVGS WHERE IDVARIABLE IN
         (''IDPLANPART'',''IDPLANPART2'',''IDPLANPART3'',''IDPLANPART4'',''IDPLANPART5''))'
      END
      ELSE
      BEGIN
         SELECT @PART = ''
      END
      SELECT @ESTFTR=''
      IF @PROCESO='Anuladas'
      BEGIN 
         SELECT @ESTFTR=' AND FTR.ESTADO=''A'' '
      END
      ELSE
      BEGIN
         IF @PROCESO='NotasCr'
         BEGIN 
            SELECT @ESTFTR=' AND COALESCE(FTR.TIPOANULACION,'''')=''NC'' '
         END
         ELSE
         BEGIN
            IF UPPER(@PROCESO) <> 'GENERAL'
            BEGIN
               SELECT @ESTFTR='  AND FTR.ESTADO=''P'' AND COALESCE(FTR.TIPOANULACION,'''')<>''NC'' '
            END 
            ELSE
            BEGIN
               SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
            END
         END
      END

      PRINT '@PROCESO='+@PROCESO
      IF UPPER(@PROCESO) IN('FACTURADO','TERCERO','IDPLAN','TERCONTA','ANULADAS','NOTACR','USUARIO')
      BEGIN
         IF UPPER(@PROCESO)='TERCERO' 
         BEGIN
            IF  COALESCE(@IDTERCERO,'')=''
            BEGIN
               SELECT @SQL=
                  'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
                  SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
                  SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
                  SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
                  FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  ' +@PART+@ESTFTR+
                  ' GROUP BY FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,'''') ' 
               PRINT @SQL
               SELECT 'OK' OK
               EXECUTE(@SQL)
            END
            ELSE
            BEGIN
               PRINT 'DETALLE POR TERCERO'
               SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
               SELECT @SQL=
                  'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
                  FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
                  FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
                  CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
                  CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
                  WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
                  FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                             LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                             LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  ' +@PART+@ESTFTR
                  PRINT @SQL
                  SELECT 'OK' OK
                  EXECUTE(@SQL)
            END
         END
         IF UPPER(@PROCESO)='IDPLAN'  
         BEGIN
            IF COALESCE(@IDPLAN,'')=''
            BEGIN
               SELECT @SQL=
                  'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
                  SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
                  SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
                  SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
                  FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                             LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  ' +@PART+@ESTFTR+
                  ' GROUP BY FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,''''),FTR.IDPLAN,PLN.DESCPLAN ' 
               PRINT @SQL
               SELECT 'OK' OK
               EXECUTE(@SQL)
            END
            ELSE
            BEGIN
               PRINT 'DETALLE POR TERCERO Y PLAN '
               SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
               SELECT @SQL=
                  'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
                  FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
                  FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
                  CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
                  CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
                  WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
                  FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                             LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                             LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                             LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
                  ' +@PART+@ESTFTR
                  PRINT @SQL
                  SELECT 'OK' OK
                  EXECUTE(@SQL)
             END
         END
         IF UPPER(@PROCESO)='TERCONTA'  
         BEGIN
            IF COALESCE(@TERCONTABLE,'')=''
            BEGIN
               SELECT @SQL=
                  'SELECT COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
                  SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
                  SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
                  SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
                  FROM   FTR LEFT JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO 
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  ' +@PART+@ESTFTR+
                  ' GROUP BY FTR.TIPOTTEC,TTEC.DETALLE,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,'''')' 
               PRINT @SQL
               SELECT 'OK' OK
               EXECUTE(@SQL)
            END
            ELSE
            BEGIN
               PRINT 'DETALLE POR TIPO DE TERCERO '
               SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
               SELECT @SQL=
                  'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE,FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
                  FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
                  FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
                  CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
                  CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
                  WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
                  FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                             LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                             LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                             LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                             LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  ' +@PART+@ESTFTR
                  PRINT @SQL
                  SELECT 'OK' OK
                  EXECUTE(@SQL)
             END
         END
         IF UPPER(@PROCESO)='USUARIO'  
         BEGIN
            IF COALESCE(@USUARIOFACTU,'')=''
            BEGIN
               SELECT @SQL=
                  'SELECT FTR.USUARIOFACTURA,USUSU.NOMBRE, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
                  SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
                  SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
                  SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
                  SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
                  FROM   FTR LEFT JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  ' +@PART+@ESTFTR+
                  ' GROUP BY FTR.USUARIOFACTURA,USUSU.NOMBRE,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,'''')' 
               PRINT @SQL
               SELECT 'OK' OK
               EXECUTE(@SQL)
            END
            ELSE
            BEGIN
               PRINT 'DETALLE POR USUARIO FACTURA '
               SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
               SELECT @SQL=
                  'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE,
                   FTR.USUARIOFACTURA,USUSU.NOMBRE, FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
                  FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
                  FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
                  CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
                  CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
                  WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
                  FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                             LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                             LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                             LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                             LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
                  ' +@PART+@ESTFTR
                  PRINT @SQL
                  SELECT 'OK' OK
                  EXECUTE(@SQL)
             END
         END
      END
      IF UPPER(@PROCESO) ='PREFIJO' --,'SERVICIO','IDAREA')
      BEGIN
         PRINT 'INGRESO A PREFIJO'
         SELECT @SQL=
         ' SELECT FTRD.PREFIJO, COALESCE(PRE.NOM_PREFIJO,PLN.DESCPLAN) DESCRIPCION,SUM(COALESCE(FTRD.VLR_SERVICI,0)) VALORSERVICIOS,
           SUM(CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END) VLRCOPAGOS,
           SUM(FTRD.VLR_SERVICI-CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END)VR_TOTAL
           FROM FTRD LEFT JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                     LEFT JOIN PRE ON SER.PREFIJO=PRE.PREFIJO
                     LEFT JOIN PLN ON FTRD.REFERENCIA=PLN.IDPLAN
          WHERE EXISTS('+
         ' SELECT *  FROM   FTR                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
                  ' +@PART+@ESTFTR+
          ' AND FTR.N_FACTURA=FTRD.N_FACTURA)
            AND FTRD.PREFIJO = CASE WHEN COALESCE('''+COALESCE(@PREFIJO,'')+''','''')='''' THEN FTRD.PREFIJO ELSE '''+COALESCE(@PREFIJO,'')+''' END 
          GROUP BY  FTRD.PREFIJO, COALESCE(PRE.NOM_PREFIJO,PLN.DESCPLAN)'
          SELECT 'OK' OK
          EXECUTE(@SQL)
      END
      IF UPPER(@PROCESO) ='IDAREA'
      BEGIN
         PRINT 'INGRESO A IDAREA'
         SELECT @SQL=
         ' SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.N_FACTURA,SUM(COALESCE(FTRD.VLR_SERVICI,0)) VALORSERVICIOS,
           SUM(CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END) VLRCOPAGOS,
           SUM(FTRD.VLR_SERVICI-CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END)VR_TOTAL
           FROM FTRD LEFT JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
          WHERE EXISTS('+
         ' SELECT *  FROM   FTR                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
                  ' +@PART+@ESTFTR+
          ' AND FTR.N_FACTURA=FTRD.N_FACTURA)
            AND FTRD.AREAPRESTACION = CASE WHEN COALESCE('''+COALESCE(@AREAFUNCIONAL,'')+''','''')='''' THEN FTRD.AREAPRESTACION ELSE '''+COALESCE(@AREAFUNCIONAL,'')+''' END 
          GROUP BY  FTRD.AREAPRESTACION, AFU.DESCRIPCION,FTRD.N_FACTURA'
          SELECT 'OK' OK
          EXECUTE(@SQL)
      END
      IF UPPER(@PROCESO) ='SERVICIO'
      BEGIN
         PRINT 'INGRESO A SERVICIO'
         SELECT @SQL=
         ' SELECT FTRD.REFERENCIA,FTRD.ANEXO,SUM(FTRD.CANTIDAD)CANTIDAD,SUM(COALESCE(FTRD.VALOR,0)) VLR_UNITARIO,SUM(FTRD.CANTIDAD*COALESCE(FTRD.VALOR,1))VLR_BRUTO,
           SUM(CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END) VLRCOPAGOS,
           SUM(FTRD.VLR_SERVICI-CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END)VR_TOTAL
           FROM FTRD 
          WHERE EXISTS('+
         ' SELECT *  FROM   FTR                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
                  AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
                  AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
                  AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
                  AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
                  AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
                  AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
                  AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
                  AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
                  ' +@PART+@ESTFTR+
          ' AND FTR.N_FACTURA=FTRD.N_FACTURA)
            AND FTRD.REFERENCIA = CASE WHEN COALESCE('''+COALESCE(@IDSERVICIO,'')+''','''')='''' THEN FTRD.REFERENCIA ELSE '''+COALESCE(@IDSERVICIO,'')+''' END 
          GROUP BY  FTRD.REFERENCIA, FTRD.ANEXO
          ORDER BY FTRD.REFERENCIA'
          SELECT 'OK' OK
          EXECUTE(@SQL)
      END
      IF UPPER(@PROCESO) IN('TODO','ANULADAS','NOTASCR')
      BEGIN
         SELECT @SQL=
            'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE,
               FTR.USUARIOFACTURA,USUSU.NOMBRE, FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
            FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
            FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
            CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
            CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
            WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN 
            FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                        LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                        LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                        LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                        LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
            WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
            AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
            AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
            AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
            AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
            AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
            AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
            AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
            AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
            ' +@PART+@ESTFTR
            PRINT @SQL
            SELECT 'OK' OK
            EXECUTE(@SQL)
      END
   END   
END



