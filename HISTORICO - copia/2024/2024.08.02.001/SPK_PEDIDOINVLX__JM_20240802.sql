IF EXISTS (SELECT name FROM sysobjects WHERE name = 'SPK_PEDIDOINVLX' AND type = 'P')
   DROP PROCEDURE SPK_PEDIDOINVLX  
GO
CREATE PROCEDURE DBO.SPK_PEDIDOINVLX
   @NORDEN			 VARCHAR(20),
   @COMPANIA         VARCHAR(2),
   @SEDE             VARCHAR(5),
   @USUARIO          VARCHAR(12),
   @SYS_COMPUTERNAME VARCHAR(254)
WITH ENCRYPTION
AS
DECLARE @NVOCONSEC      VARCHAR(20)
DECLARE @NOINGRESO      VARCHAR(20)
DECLARE @IDITAR         VARCHAR(2)   
DECLARE @IDTIPOMOV      VARCHAR(2)
DECLARE @CCOSTO         VARCHAR(20)
DECLARE @IDAREAH        VARCHAR(20)
DECLARE @IDAREA         VARCHAR(20)
DECLARE @NA             VARCHAR(5) 
DECLARE @ESTRANSITO     SMALLINT
DECLARE @IDTERCERO      VARCHAR(20)
DECLARE @TMB            VARCHAR(1)
DECLARE @IDBODEGA       VARCHAR(20)
DECLARE @IDBODEGA2      VARCHAR(20)
DECLARE @PEDIDOINV		BIT
DECLARE @TIPOINGRESO	VARCHAR(1)
DECLARE @NOADMISION		VARCHAR(20)
DECLARE @NOPRESTACION   VARCHAR(20)
DECLARE @IDAFILIADO     VARCHAR(20)
BEGIN
	--Capturo datos
	SELECT @NOINGRESO=NOINGRESO, @PEDIDOINV=ISNULL(PEDIDOINV,0) FROM LORD WHERE NORDEN=@NORDEN

   IF @PEDIDOINV = 1
      RETURN
   IF NOT EXISTS (SELECT 1 FROM LORDI WHERE NORDEN=@NORDEN)
      RETURN
   
	
   SELECT @IDTERCERO=IDTERCERO, @TIPOINGRESO=TIPOINGRESO, @NOADMISION=NOADMISION, @NOPRESTACION=NOPRESTACION, @IDAFILIADO=IDAFILIADO
   FROM LING WHERE NOINGRESO=@NOINGRESO

   SELECT @CCOSTO=CCOSTO, @IDAREA=IDAREA, @IDAREAH=IDAREAH, @TMB=TIPOMANEJOBODEGA, @IDBODEGA=IDBODEGA, @IDBODEGA2=IDBODEGA2 
   FROM UBEQ 
   WHERE COMPANIA=@COMPANIA AND SYS_COMPUTERNAME=@SYS_COMPUTERNAME
   
   IF @TMB = 'A'     
      SELECT @IDBODEGA=BODEGADIA, @IDBODEGA2=BODEGADIA2 FROM AFU WHERE IDAREA=@IDAREA


	IF (SELECT DATO FROM USVGS WHERE IDVARIABLE='PEDIDOHPREAIZSOL')='SI' --AND @TIPOINGRESO='A'
	BEGIN
		PRINT 'Pido por IZSOL'
		DECLARE 
		   @CNSIZSOL   VARCHAR(20), 
           @CNSIZSOLD  VARCHAR(20), 
		   @SECTOR	   VARCHAR(20),
           @FIX        INT,
           @FIX_TO     INT,
           @CONFAUT    SMALLINT, 
           @TIPOBODEGA VARCHAR(12)
        DECLARE @IZSOLD TABLE (ID INT IDENTITY(1,1), IDARTICULO VARCHAR(20), IDSERVICIO VARCHAR(20), CANTIDAD DECIMAL(14,2))
        
        EXEC SPK_GENCONSECUTIVO '01', @SEDE, '@IZSOL', @CNSIZSOL OUTPUT  
        SET @CNSIZSOL = @SEDE + REPLACE(SPACE(10 - LEN(@CNSIZSOL))+LTRIM(RTRIM(@CNSIZSOL)),SPACE(1),0)
		PRINT '@CNSIZSOL == '+@CNSIZSOL
        
		SELECT @SECTOR=HHAB.SECTOR 
		FROM HADM INNER JOIN HHAB ON HADM.HABCAMA=HHAB.HABCAMA
		WHERE HADM.NOADMISION=@NOADMISION 
        
		INSERT INTO IZSOL (CNSIZSOL, CNSMOV, FECHASOL, USUARIOSOL, ESTADO, IDBODEGAATIENDE, SECTOR, CLASE, NOADMISION, CNSIZSOLM)
        SELECT @CNSIZSOL, @NORDEN, dbo.FNK_FECHA_SIN_MLS(GETDATE()), @USUARIO, 1, @IDBODEGA, @SECTOR, 'APOYODX', @NOADMISION, @IDAFILIADO
        
        INSERT INTO @IZSOLD (IDARTICULO, CANTIDAD)
        SELECT IDARTICULO, CANTIDADPEDIDA
        FROM LORDI 
        WHERE NORDEN=@NORDEN AND ISNULL(PEDIDOINV,0)=0
        
        --SELECT @FIX=1, @FIX_TO=COUNT(1) FROM @IZSOLD
        
        --WHILE @FIX <= @FIX_TO
        --BEGIN
        --   EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@IZSOLD', @CNSIZSOLD OUTPUT  
        --   SELECT @CNSIZSOLD = @SEDE + REPLACE(SPACE(10 - LEN(@CNSIZSOLD))+LTRIM(RTRIM(@CNSIZSOLD)),SPACE(1),0)  
        
        --   INSERT INTO IZSOLD (CNSIZSOLD, CNSIZSOL, IDARTICULO, CANTIDADSOL, ESTADO, CANTIDAD, 
        --      FRECUENCIA, NUMDOSIS, CANTIDADBOLO, QIMPREGNACION, DURACION, IDSERVICIO, CNSHBALI, IDPRINCIPIO) 
        --   SELECT @CNSIZSOLD, @CNSIZSOL, A.IDARTICULO, A.CANTIDAD, 1, A.CANTIDAD, 24, 0, 0, 0, 24, IART.IDSERVICIO, @NOPRESTACION, IART.IDSERVICIO
        --   FROM @IZSOLD A INNER JOIN IART ON A.IDARTICULO=IART.IDARTICULO
        --   WHERE A.ID=@FIX
        
        --   SET @FIX += 1
        --END

       INSERT INTO IZSOLD (CNSIZSOL, IDARTICULO, CANTIDADSOL, ESTADO, CANTIDAD, 
         FRECUENCIA, NUMDOSIS, CANTIDADBOLO, QIMPREGNACION, DURACION, IDSERVICIO, CNSHBALI, IDPRINCIPIO) 
       SELECT @CNSIZSOL, A.IDARTICULO, A.CANTIDAD, 1, A.CANTIDAD, 24, 0, 0, 0, 24, IART.IDSERVICIO, @NOPRESTACION, IART.IDSERVICIO
       FROM @IZSOLD A INNER JOIN IART ON A.IDARTICULO=IART.IDARTICULO

        DELETE @IZSOLD WHERE 1=1 
        
        UPDATE LORDI SET PEDIDOINV=1 WHERE NORDEN=@NORDEN
        
        SELECT @CONFAUT=COALESCE(CONFIRMAAUTOMDESDEQX,0), @TIPOBODEGA=TIPOBODEGA 
        FROM IBOD WHERE IDBODEGA=@IDBODEGA
        IF @CONFAUT = 1 AND @TIPOBODEGA='Virtual'
           EXEC SPK_INSERTA_IZOLDT_AUT @CNSIZSOL, @IDBODEGA, @SEDE, @USUARIO
	END
	ELSE
	BEGIN
		PRINT 'Pido por IMOV'
		DECLARE @ITAR TABLE (IDITAR VARCHAR(2))

		INSERT INTO @ITAR (IDITAR)
		SELECT DISTINCT IART.IDITAR 
		FROM LORDI 
			INNER JOIN IART ON LORDI.IDARTICULO=IART.IDARTICULO
		WHERE LORDI.NORDEN=@NORDEN 
   
		SELECT @IDTIPOMOV=DATO FROM USVGS WHERE IDVARIABLE='IDINVMOVLX'
		SELECT @ESTRANSITO=GENTRANSITO FROM ITMO WHERE IDTIPOMOV=@IDTIPOMOV 
   
		DECLARE IMOV_CURSOR CURSOR FOR  
		SELECT IDITAR FROM @ITAR 
		OPEN IMOV_CURSOR  
		FETCH NEXT FROM IMOV_CURSOR  
		INTO  @IDITAR
		WHILE @@FETCH_STATUS = 0  
		BEGIN  
				EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@MOV',@NVOCONSEC OUTPUT  
				SELECT @NVOCONSEC = @SEDE + REPLACE(SPACE(8 - LEN(@NVOCONSEC))+LTRIM(RTRIM(@NVOCONSEC)),SPACE(1),0)
				INSERT INTO IMOV(CNSMOV, IDBODEGA, IDTIPOMOV, NODOCUMENTO, TIPODOCU,
									  FECHAMOV, CCOSTO, IDSOLICITA, IDTERCERO, IDFUNCIONARIO,
									  IDRECIBE, FACTORVENTA, ESTADO, IDBODEGAEXTERNA, cnstran,
									  OBSERVACION, CNSFCOM, SUBIOCOMPRA, NOPRESTACION, IDAREA,
									  CONTABILIZADA, NROCOMPROBANTE, PROCEDENCIA, USUARIO,
									  USUARIOCONF, FECHACONF, PARCIAL, IDAREAH, NIVELATENCION, 
									  SYS_ComputerName, TIENECAMBIO, IDITAR, ESTRANSITO, CNSREP)  
				SELECT @NVOCONSEC,@IDBODEGA,@IDTIPOMOV, @NOINGRESO, NULL, dbo.FNK_FECHA_SIN_MLS(GETDATE()),
						 @CCOSTO, @USUARIO, @IDTERCERO, @USUARIO, NULL, NULL, '0', NULL, NULL,
						 '',NULL, 0, @NORDEN, @IDAREA,0, NULL, 'LX', @USUARIO,
						 NULL, NULL, 0, @IDAREAH, @NA, @SYS_COMPUTERNAME, 0, @IDITAR, @ESTRANSITO, NULL  

				INSERT INTO IMOVH(CNSMOV, IDARTICULO, EXISTENCIA, CANTIDAD, CANTPEDIDA, PCOSTO,
										NOLOTE, NOLOTEPEDIDO, ESTADO, IDARTICULOTF,
										CANTIDADTF, PCOSTOANTES, CNSTRAN, ITEM, PVENTA, USUARIO,        
										USUARIOCONF, FECHACONF, PRIEXI, FECHAREPOSI, IDARTICULOORI,
										CANTIDADORI, TIENECAMBIO)
				SELECT @NVOCONSEC, LORDI.IDARTICULO, IART.EXISTOTAL, 0, LORDI.CANTIDADPEDIDA, IART.PCOSTO,  
						 LORDI.IDARTICULO, NULL ,0 , NULL, NULL, NULL, NULL, NULL, 0, 
						 @USUARIO, NULL, NULL, 0, NULL, NULL, NULL, 0      
				FROM   LORDI INNER JOIN IART ON LORDI.IDARTICULO = IART.IDARTICULO
				WHERE  LORDI.NORDEN = @NORDEN 
				AND    IART.IDITAR  = @IDITAR
				/*****************************************************************/
				/* INGRESO DEL NUMERO DE MOVIMIENTO DE INVENTARIO EN LORD       */
				/*****************************************************************/

				/* AQUI DEBERIA IR */

				/*****************************************************************/
				/* CONFIRMACION AUTOMATICA DE INVENTARIOS                        */
				/*****************************************************************/
				IF (SELECT LEFT(DATO,20) FROM USVGS WHERE IDVARIABLE = 'INVPIDEAUTOMLX') = 'SI'
					EXEC SPK_CONFIRMARSALIDAS @IDBODEGA, @NVOCONSEC, @USUARIO, 	@COMPANIA, 	@SEDE
           
				FETCH NEXT FROM IMOV_CURSOR  
				INTO @IDITAR 
		END   
		CLOSE IMOV_CURSOR  
		DEALLOCATE IMOV_CURSOR
   END --Cierro else
   
	UPDATE LORD SET PEDIDOINV=1 WHERE NORDEN=@NORDEN  
END