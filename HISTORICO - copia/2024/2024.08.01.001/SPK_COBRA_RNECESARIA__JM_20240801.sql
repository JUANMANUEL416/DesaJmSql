IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_COBRA_RNECESARIA' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_COBRA_RNECESARIA
END
GO
CREATE PROC DBO.SPK_COBRA_RNECESARIA
@NOADMISION        VARCHAR(16), 
@IDSEDE            VARCHAR(5),
@USUARIO           VARCHAR(12),
@CONSECUTIVO       VARCHAR(13),
@SYS_COMPUTERNAME  VARCHAR(254),
@IDSERVICIO        VARCHAR(20)
AS
DECLARE @CNSIZSOL         VARCHAR(20)
DECLARE @IDBODEGAATIENDE  VARCHAR(20)
DECLARE @FECHAHC          DATETIME
DECLARE @SECTOR           VARCHAR(30)
DECLARE @CNSIZSOLD        VARCHAR(20)
DECLARE @QTOTDOSIS        DECIMAL(14,2)
DECLARE @CODOM            VARCHAR(10)
DECLARE @FRECUENCIA       DECIMAL(14,2)
DECLARE @DURACION         DECIMAL(14,2)
DECLARE @IDSERVICIONEW    VARCHAR(20)
DECLARE @IDARTICULONEW    VARCHAR(20)
DECLARE @CANTIDADNEW      DECIMAL(14,2)
DECLARE @IDSERVICIOMEZ    VARCHAR(20)
DECLARE @QMEZCLA          DECIMAL(14,2)
DECLARE @IDJERQUIA        VARCHAR(10)
DECLARE @IDARTMEZ         VARCHAR(20)
DECLARE @CANTDILUYE       INT
DECLARE @CONFAUT SMALLINT
DECLARE @TIPOBODEGA VARCHAR(10)
BEGIN
	SELECT @FECHAHC = FECHA FROM HCA WHERE NOADMISION = @NOADMISION AND CONSECUTIVO = @CONSECUTIVO 

	SELECT @SECTOR = SECTOR
	FROM   HHAB
	WHERE  NOADMISION = @NOADMISION

	SELECT @QTOTDOSIS = CANTIDAD, @CODOM = CODOM, @FRECUENCIA = FRECUENCIA, @DURACION = DURACION FROM HCATD WHERE CONSECUTIVO = @CONSECUTIVO AND IDSERVICIO = @IDSERVICIO 

	SELECT @CNSIZSOL = ''
	EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@IZSOL', @CNSIZSOL OUTPUT  
	SELECT @CNSIZSOL = @IDSEDE + REPLACE(SPACE(10 - LEN(@CNSIZSOL))+LTRIM(RTRIM(@CNSIZSOL)),SPACE(1),0)  
	IF (SELECT DBO.FNK_VALORVARIABLE('IDBODEGAIZSOLENF'))='UBEQ'
	BEGIN
		SELECT @IDBODEGAATIENDE = IDBODEGA FROM UBEQ WHERE SYS_ComputerName = @SYS_COMPUTERNAME                
	END
	ELSE
	BEGIN
		SELECT @IDBODEGAATIENDE=DBO.FNK_BUSCA_BODEGA_IZSOL(@IDSEDE,@SECTOR)
	END
	INSERT INTO IZSOL (CNSIZSOL, FECHASOL, USUARIOSOL, ESTADO, IDBODEGAATIENDE, SECTOR, CLASE, NOADMISION, CONSECUTIVOHCA)
	SELECT @CNSIZSOL, GETDATE(), @USUARIO, 1, @IDBODEGAATIENDE, @SECTOR, 'SENFER', @NOADMISION, @CONSECUTIVO


	DECLARE SER_C CURSOR FOR
	SELECT HHOM.IDSERVICIO, HHOM.CANTIDAD, SER.IDARTICULO,COALESCE(HHOM.IDSERVICIOMEZCLA,''),COALESCE(QMEZCLA, 0)
	FROM HHOM INNER JOIN SER ON HHOM.IDSERVICIO = SER.IDSERVICIO
	WHERE NOADMISION = @NOADMISION
	AND HHOM.IDSERVICIO = @IDSERVICIO
	AND COALESCE(HHOM.RAZONNEC,0)=1
	OPEN SER_C
	FETCH NEXT FROM SER_C
	INTO @IDSERVICIONEW, @CANTIDADNEW, @IDARTICULONEW,@IDSERVICIOMEZ,@QMEZCLA
	
	WHILE @@FETCH_STATUS = 0
	BEGIN   
		--SELECT @CNSIZSOLD = ''
		--EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@IZSOLD', @CNSIZSOLD OUTPUT  
		--SELECT @CNSIZSOLD = @IDSEDE + REPLACE(SPACE(10 - LEN(@CNSIZSOLD))+LTRIM(RTRIM(@CNSIZSOLD)),SPACE(1),0)  
		INSERT INTO IZSOLD (CNSIZSOL , IDARTICULO , CANTIDADSOL , ESTADO, CODOM, CANTIDAD, FRECUENCIA, NUMDOSIS,
					CANTIDADBOLO, QIMPREGNACION, DURACION, IDSERVICIO, IDPRINCIPIO)
		SELECT @CNSIZSOL, @IDARTICULONEW, CASE COALESCE(SER.MDOSIF,0) WHEN 1 THEN CEILING(@CANTIDADNEW/SER.EQUICC) ELSE @CANTIDADNEW END, 
				1, @CODOM, @CANTIDADNEW, @FRECUENCIA, 1, 0, 0, @FRECUENCIA, @IDSERVICIONEW, IART.IDSERVICIO
		FROM   SER LEFT JOIN IART ON IART.IDARTICULO=SER.IDARTICULO
		WHERE  SER.IDSERVICIO = @IDSERVICIO
		
		IF COALESCE(@IDSERVICIOMEZ,'')<>''
		BEGIN 
			--SELECT @CNSIZSOLD = ''
			SELECT @IDJERQUIA=IDJERARQUIA FROM SER WHERE IDSERVICIO=@IDSERVICIOMEZ
			SELECT TOP 1 @IDARTMEZ=IDSERVICIO FROM SER WHERE IDJERARQUIA=@IDJERQUIA AND EQUICC>=@QMEZCLA
			IF COALESCE(@IDARTMEZ,'')=''
			BEGIN
				SELECT TOP 1 @IDARTMEZ=IDSERVICIO FROM SER WHERE IDJERARQUIA=@IDJERQUIA ORDER BY EQUICC DESC
				SELECT  @CANTDILUYE=CEILING(@QMEZCLA/SER.EQUICC) FROM SER WHERE IDSERVICIO=@IDARTMEZ
			END
			ELSE
			BEGIN
				SELECT @CANTDILUYE=1
			END
			--EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@IZSOLD', @CNSIZSOLD OUTPUT  
			--SELECT @CNSIZSOLD = @IDSEDE + REPLACE(SPACE(10 - LEN(@CNSIZSOLD))+LTRIM(RTRIM(@CNSIZSOLD)),SPACE(1),0)  
			INSERT INTO IZSOLD (CNSIZSOL , IDARTICULO , CANTIDADSOL , ESTADO, CODOM, CANTIDAD, FRECUENCIA, NUMDOSIS,
					CANTIDADBOLO, QIMPREGNACION, DURACION, IDSERVICIO, IDPRINCIPIO)
			SELECT @CNSIZSOL, SER.IDARTICULO, @CANTDILUYE,1, @CODOM, @QMEZCLA, @FRECUENCIA, 1, 0, 0, @FRECUENCIA, SER.IDSERVICIO, IART.IDSERVICIO
			FROM   SER LEFT JOIN IART ON IART.IDARTICULO=SER.IDARTICULO
			WHERE  SER.IDSERVICIO = @IDARTMEZ
		END
		FETCH NEXT FROM SER_C
		INTO @IDSERVICIONEW, @CANTIDADNEW, @IDARTICULONEW,@IDSERVICIOMEZ,@QMEZCLA
	END
	CLOSE SER_C
	DEALLOCATE SER_C
	
	SELECT  @CONFAUT=CONFIRMAAUTOMDESDEQX ,@TIPOBODEGA=TIPOBODEGA FROM IBOD WHERE IDBODEGA=@IDBODEGAATIENDE
	IF @CONFAUT = 1 AND @TIPOBODEGA='Virtual'
	BEGIN
		IF EXISTS(SELECT * FROM IZSOL WHERE CNSIZSOL=@CNSIZSOL)
		BEGIN
			PRINT 'VOY A CONFIRMAR AUTOMATICO....'
			EXEC SPK_INSERTA_IZOLDT_AUT @CNSIZSOL,@IDBODEGAATIENDE,@IDSEDE,@USUARIO
		END
	END
END

