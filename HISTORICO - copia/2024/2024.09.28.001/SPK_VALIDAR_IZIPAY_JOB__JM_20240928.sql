CREATE OR ALTER PROCEDURE DBO.SPK_VALIDAR_IZIPAY_JOB
WITH ENCRYPTION
AS 
DECLARE @IDKPAGE INT
DECLARE @paymentOrderId VARCHAR(20)
DECLARE @NOADMISION VARCHAR(20)
DECLARE @DPR VARCHAR(20)
DECLARE @SEDE VARCHAR(6)
DECLARE @SEDEV VARCHAR(6) --SEDE FACTURA LINK
DECLARE @USUARIO VARCHAR(20)
DECLARE @IDTERCERO VARCHAR(20)
DECLARE @TIPOFAC   VARCHAR(10)
DECLARE @FECHAFACT  DATETIME
DECLARE @COMPANIA   VARCHAR(2)
DECLARE @PROCEDENCIA VARCHAR(20)
DECLARE @TABLA       VARCHAR(20)
DECLARE @VALOR       DECIMAL(14,2)
DECLARE @FACTURA     VARCHAR(20)
DECLARE @ESTADO      VARCHAR(20)
BEGIN
   SELECT @DPR=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'),@COMPANIA='01',@SEDEV=DBO.FNK_VALORVARIABLE('IDSEDE_FACTURA_LINK')
   SELECT @TIPOFAC='Boleta',@FECHAFACT=DBO.FNK_GETDATE()

   DECLARE PG_CURSOR CURSOR FOR 
   SELECT IDKPAGE,CONSECUTIVO,USUCOBRA,RESPONSABLEPAGO,PROCEDENCIA,TABLA,paymentOrderId,VALOR,ESTADO 
   FROM 
   KPAGE 
   WHERE ESTADO IN('SEND','RUNNING','PAID')
   AND 1=CASE WHEN ESTADO IN('SEND','RUNNING') THEN 1 ELSE CASE WHEN COALESCE(REF_PAGO,'')='' THEN 1 ELSE 0 END END
   ORDER BY IDKPAGE
   OPEN PG_CURSOR    
   FETCH NEXT FROM PG_CURSOR    
   INTO @IDKPAGE,@NOADMISION,@USUARIO,@IDTERCERO,@PROCEDENCIA,@TABLA,@paymentOrderId,@VALOR,@ESTADO
   WHILE @@FETCH_STATUS = 0    
   BEGIN 
      PRINT 'Valido el kpage'
      IF @ESTADO<>'PAID'
      BEGIN
         BEGIN TRY           
            EXEC DBO.SPK_GENERA_ORDENPAGO_IZIPAY @NOADMISION,@TABLA,@PROCEDENCIA,@IDTERCERO,@VALOR,'',@USUARIO,@IDKPAGE,'VALIDAR'                 
         END TRY
         BEGIN CATCH
               FETCH NEXT FROM PG_CURSOR    
               INTO @IDKPAGE,@NOADMISION,@USUARIO,@IDTERCERO,@PROCEDENCIA,@TABLA,@paymentOrderId,@VALOR,@ESTADO
               CONTINUE
         END CATCH
      END
      PRINT 'Valido el kpage'
      IF EXISTS(SELECT * FROM KPAGE WHERE IDKPAGE=@IDKPAGE AND ESTADO='PAID' AND COALESCE(REF_PAGO,'')='')
      BEGIN 
         PRINT 'Voy a Generar la Boleta'
         IF NOT EXISTS(SELECT * FROM SED WHERE IDSEDE=@SEDEV)
         BEGIN
            IF @TABLA='CIT'
            BEGIN
               SELECT @SEDE=IDSEDE,@SEDEV=IDSEDE,@IDTERCERO=IDAFILIADO FROM CIT WHERE CONSECUTIVO=@NOADMISION
            END
         END
         ELSE
         BEGIN
            IF @TABLA='CIT'
            BEGIN
                SELECT @SEDE=IDSEDE,@IDTERCERO=IDAFILIADO  FROM CIT WHERE CONSECUTIVO=@NOADMISION
            END
         END
         EXEC SPK_FACTURACE_PERU_COPA @NOADMISION,@DPR,@COMPANIA,@SEDEV, @USUARIO,'','','','','','CI','', 'FALSE', NULL,@FECHAFACT,@TIPOFAC, @IDTERCERO   
         SELECT @FACTURA=NULL
         IF @TABLA='CIT'
         BEGIN
            SELECT @FACTURA=COALESCE(NFACTURA,N_FACTURA) FROM CIT WHERE CONSECUTIVO=@NOADMISION
         END
         IF COALESCE(@FACTURA,'')<>''
         BEGIN
            UPDATE FTR SET IDSEDE=@SEDE WHERE N_FACTURA=@FACTURA
            UPDATE KPAGE SET FACTURADO='Si',REF_PAGO=@FACTURA WHERE IDKPAGE=@IDKPAGE
         END
      END
      FETCH NEXT FROM PG_CURSOR    
      INTO @IDKPAGE,@NOADMISION,@USUARIO,@IDTERCERO,@PROCEDENCIA,@TABLA,@paymentOrderId,@VALOR,@ESTADO
   END
   CLOSE PG_CURSOR
   DEALLOCATE PG_CURSOR

END