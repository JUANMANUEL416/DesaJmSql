CREATE OR ALTER FUNCTION dbo.FNK_GENERAR_CUFE_CUDE (
	@TIPO_DOC VARCHAR(2),-- FV: Factura de Venta, NC: Nota de Crédito, ND: Nota de Débito, DE: Documento Equivalente
	@CNSDOC VARCHAR(100),-- FTR.CNSFCT, FNOT.CNSFNOT, FCXP.CNSFCXP
	@NIT_FACTURADOR VARCHAR(100),
	@CLAVETECNICA VARCHAR(100),
	@NFACTE VARCHAR(100),
	@TIPO_AMBIENTE INT -- 1.- Producción, 2.- Pruebas
	)
RETURNS VARCHAR(max)
	WITH ENCRYPTION
AS
BEGIN
	DECLARE @RETURN VARCHAR(max)
	DECLARE @CUFE VARCHAR(MAX) = ''
	DECLARE @ESPACIO VARCHAR(1) = ''
	DECLARE @ICA DECIMAL(14,2)
	DECLARE @VLRIMPCONSUMO DECIMAL(14,2)
	DECLARE @PIN VARCHAR(20) = ''
	DECLARE @IPS BIT=0
	DECLARE @COPAGOIPS BIT=0
	DECLARE @NOREFERENCIA VARCHAR(20)
	DECLARE @IDSEDE VARCHAR(5)
	DECLARE @ITEM VARCHAR(5)
	DECLARE @DESCUENTO DECIMAL(14,2)

	IF @TIPO_DOC = 'FV' -- Factura de Venta (FTR)
	BEGIN
		SELECT @NOREFERENCIA=NOREFERENCIA, @IDSEDE=IDSEDE FROM FTR WHERE CNSFCT=@CNSDOC
		SELECT @IPS=IPS FROM SED WHERE IDSEDE=@IDSEDE
		IF @IPS=1 SET @COPAGOIPS=1
		IF COALESCE(@NOREFERENCIA,'') IN ('CEUNIFPE','VARIOS','CEUNIFICADO', 'MASIVA') SET @IPS = 0

		DECLARE @BASE_IVA_SERVICIOS VARCHAR(120)

		SELECT @BASE_IVA_SERVICIOS = DATO
		FROM USVGS
		WHERE IDVARIABLE = 'BASE_IVA_SERVICIOS'

		SELECT @CUFE = FACTURA + @ESPACIO + FECHA + @ESPACIO + HORA + @ESPACIO + NETO + @ESPACIO + CODIMP1 + @ESPACIO + VALIMP1 + @ESPACIO + CODIMP2 + @ESPACIO + VALIMP2 + @ESPACIO + CODIMP3 + @ESPACIO + VALIMP3 + @ESPACIO + IMPORTE + @ESPACIO + NITFE + @ESPACIO + NUMADQUIRIENTE + @ESPACIO + CLAVETECNICA + @ESPACIO + CAST(@TIPO_AMBIENTE AS VARCHAR)
		FROM (
			SELECT @NFACTE FACTURA, FECHA ,HORA
				,CASE WHEN @BASE_IVA_SERVICIOS = 'SINIVA'
						THEN CAST(VR_TOTAL AS VARCHAR)
					ELSE CAST(VR_TOTAL - VALIMP1 - VALIMP2 - VALIMP3 AS VARCHAR)
					END NETO
				--,DESCUENTO = CASE WHEN DESCUENTO > 0 THEN CAST(DESCUENTO AS VARCHAR) ELSE '' END
				--,CAST(VR_TOTAL AS VARCHAR) NETO
				,CODIMP1
				,CAST(VALIMP1 AS VARCHAR) VALIMP1
				,CODIMP2
				,CAST(VALIMP2 AS VARCHAR) VALIMP2
				,CODIMP3
				,CAST(VALIMP3 AS VARCHAR) VALIMP3
				,CASE 
					WHEN @BASE_IVA_SERVICIOS = 'SINIVA'
						THEN CAST(VR_TOTAL - DESCUENTO + VALIMP1 + VALIMP2 + VALIMP3 - IIF(@COPAGOIPS = 1, 
							CASE 
							WHEN COALESCE(CAPITADA, 0) = 0
								THEN COALESCE(VALORCOPAGO, 0)
							ELSE CASE 
									WHEN COALESCE(COPAPROPIO, 0) = 1
										THEN CP_VLR_COPAGOS
									ELSE COALESCE(VALORCOPAGO, 0)
									END
							END, 0) AS VARCHAR)
					ELSE CAST(VR_TOTAL - DESCUENTO 
							- CASE 
								WHEN COALESCE(CAPITADA, 0) = 0
									THEN COALESCE(VALORCOPAGO, 0)
								ELSE CASE 
										WHEN COALESCE(COPAPROPIO, 0) = 1
											THEN CP_VLR_COPAGOS
										ELSE COALESCE(VALORCOPAGO, 0)
										END
								END 
								AS VARCHAR
							)
					END AS IMPORTE
				,@NIT_FACTURADOR AS NITFE
				,NUMADQUIRIENTE
				,@CLAVETECNICA AS CLAVETECNICA
			FROM (
				SELECT REPLACE(CONVERT(VARCHAR, COALESCE(FTR.F_FACTURA, FTR.FECHAFAC), 102), '.', '-') AS FECHA
					,CONVERT(VARCHAR, COALESCE(FTR.F_FACTURA, FTR.FECHAFAC), 108) + '-05:00' AS HORA
					--,CAST(VR_TOTAL AS DECIMAL(14,2)) VR_TOTAL  -- EZ 02.12.2019 SE CAMBIO EL VR_TOTAL DEBIDO A QUE CUANDO HACEN NOTAS ESTO CAMBIA DE VALOR, Y PUEDE QUE CUANDO HAGAN LA NOTA AUN NO SE HAYA ENVIADO A LA DIAN
					--,CAST(CASE WHEN @BASE_IVA_SERVICIOS = 'SINIVA' THEN VR_TOTAL ELSE VALORSERVICIOS END AS DECIMAL(14,2)) VR_TOTAL -- EZ 09.03.2020 CUANDO ESTA VARIABLE TIENE EL VALOR SINIVA LA SUMA DE LOS ITEMS QUE ESTAN EN VALORSERVICIOS NO TIENE INCLUIDO EL IVA
					,CAST(CASE 
							WHEN @BASE_IVA_SERVICIOS = 'SINIVA'
								THEN coalesce(VALORSERVICIOS, 0)
							ELSE coalesce(VALORSERVICIOS, 0)
							END AS DECIMAL(14, 2)) AS VR_TOTAL -- EZ 23.05.2020 
					,'01' CODIMP1 -- Valor Fijo
					,CAST(COALESCE(VIVA, 0) AS DECIMAL(14, 2)) VALIMP1
					,'04' CODIMP2 -- Valor Fijo
					,CAST(0 AS DECIMAL(14, 2)) VALIMP2
					,'03' CODIMP3 -- Valor Fijo
					,CAST(0 AS DECIMAL(14, 2)) VALIMP3
					,DBO.FNK_LIMPIATEXTO(NIT, '0-9a-z') AS NUMADQUIRIENTE
					,VALORCOPAGO	=COALESCE(VALORCOPAGO, 0)
					,CP_VLR_COPAGOS	=COALESCE(CP_VLR_COPAGOS,0)
					,COPAPROPIO	=COALESCE(COPAPROPIO,0)
					,CAPITADA	=COALESCE(CAPITADA,0)
					,DESCUENTO	=COALESCE(FTR.DESCUENTO, 0)
				FROM FTR
				LEFT JOIN TER ON FTR.IDTERCERO = TER.IDTERCERO
				WHERE CNSFCT = @CNSDOC
				) AS #T
			) AS #T
	END
	
	IF @TIPO_DOC IN ('NC','ND') -- Nota de Crédito/Debito (FNOT)
	BEGIN
		DECLARE @CNSRESOL VARCHAR(50)
		DECLARE @PREFIJO VARCHAR(20)
		DECLARE @N_FACTURAE VARCHAR(20)
		DECLARE @SIN_FACTURA SMALLINT

		/* OSOLANO 20240730 SE CAMBIA PREFIJO POR EL DE LA FACTURA Y EN EL CASO DE NO ENCONTRARLA TOMA UN PREFIJO AL AZAR, 
			YA QUE FACTURA DE SALDOS INICIALES NO TIENNE PREFIJOS PERO SI DEBO REPORTAR LAS NOTAS CREDITOS A LA DIAN SEGUN RESOLUCION (NO ME ACUERDO) ANEXO TECNICO 1.9*/
		SELECT TOP 1 @PREFIJO=FDIAN.PREFIJO, @SIN_FACTURA=COALESCE(NOTA_SIN_FACTURA,'')
		FROM FNOT  
			INNER JOIN FTR ON FTR.N_FACTURA=FNOT.N_FACTURA 
			INNER JOIN FDIAN ON FDIAN.CNSRESOL=FTR.CNSRESOL
		WHERE FNOT.CNSFNOT=@CNSDOC

		IF COALESCE(@SIN_FACTURA,0)=1 OR @PREFIJO IS NULL
			SELECT TOP 1 @PREFIJO = PREFIJO FROM FDIAN WHERE PROCEDENCIA='FTR' AND COALESCE(VENCIDA,0)=0 
      
		SELECT @CUFE = PREFIJO + @ESPACIO +
			--+FACTURA
			CNSFNOT + @ESPACIO + FECHA + @ESPACIO + HORA + @ESPACIO + NETO + @ESPACIO + CODIMP1 + @ESPACIO + VALIMP1 + @ESPACIO + CODIMP2 + 
			@ESPACIO + VALIMP2 + @ESPACIO + CODIMP3 + @ESPACIO + VALIMP3 + @ESPACIO + IMPORTE + @ESPACIO + NITFE + @ESPACIO + NUMADQUIRIENTE + 
			@ESPACIO + PIN + @ESPACIO + CAST(@TIPO_AMBIENTE AS VARCHAR)
		FROM (
			SELECT FECHA
				,HORA
				,CAST(VR_TOTAL - VALIMP1 - VALIMP2 - VALIMP3 AS VARCHAR) NETO
				,CODIMP1
				,CAST(VALIMP1 AS VARCHAR) VALIMP1
				,CODIMP2
				,CAST(VALIMP2 AS VARCHAR) VALIMP2
				,CODIMP3
				,CAST(VALIMP3 AS VARCHAR) VALIMP3
				,CAST(VR_TOTAL AS VARCHAR) AS IMPORTE
				,@NIT_FACTURADOR AS NITFE
				,NUMADQUIRIENTE
				,PIN
				,PREFIJO
				,CNSFNOT
			FROM (
				SELECT @PREFIJO PREFIJO
					,FNOT.CNSFNOT
					--,REPLACE(CONVERT(VARCHAR,COALESCE(FTR.F_FACTURA,FTR.FECHAFAC),102),'.','-') AS FECHA
					,REPLACE(CONVERT(VARCHAR, FNOT.F_NOTA, 102), '.', '-') AS FECHA
					--,CONVERT(VARCHAR,COALESCE(FTR.F_FACTURA,FTR.FECHAFAC),108)+'-05:00' AS HORA 
					,CONVERT(VARCHAR, FNOT.F_NOTA, 108) + '-05:00' AS HORA
					,CAST(FNOT.VR_TOTAL AS DECIMAL(14, 2)) VR_TOTAL
					,'01' CODIMP1 -- Valor Fijo
					,CAST((SELECT SUM(COALESCE(VALORIVA,0)) FROM FNOTD WHERE CNSFNOT=@CNSDOC) AS DECIMAL(14, 2)) VALIMP1
					,'04' CODIMP2 -- Valor Fijo
					,CAST(0 AS DECIMAL(14, 2)) VALIMP2
					,'03' CODIMP3 -- Valor Fijo
					,CAST(0 AS DECIMAL(14, 2)) VALIMP3
					,DBO.FNK_LIMPIATEXTO(NIT, '0-9a-z') AS NUMADQUIRIENTE
					,(
						SELECT LTRIM(RTRIM(DESCRIPCION))
						FROM TGEN
						WHERE TABLA = 'FDIAN'
							AND CAMPO = 'SOFTWARE'
							AND CODIGO = 'PIN'
						) PIN
				FROM FNOT 
				INNER JOIN FTR ON FTR.N_FACTURA = FNOT.N_FACTURA
				LEFT JOIN TER ON FNOT.IDTERCERO = TER.IDTERCERO
				WHERE CNSFNOT = @CNSDOC
				) AS #T
			) AS #T
	END
	
	IF @TIPO_DOC = 'DS' -- Documento de Soporte (FCXP)
	BEGIN
		--SELECT @ICA = SUM(VALOR) FROM FCXPI WHERE IDIMPUESTO IN (SELECT IDIMPUESTO FROM FIMP WHERE TIPO='ReteIca') AND CNSFCXP=@CNSDOC
		--SELECT @VLRIMPCONSUMO = VLRIMPCONSUMO FROM FCXPD WHERE CNSFCXP=@CNSDOC AND COALESCE(MIMPCONSUMO, 0) = 1
		--IF @ICA IS NULL SET @ICA = 0
		--IF @VLRIMPCONSUMO IS NULL SET @VLRIMPCONSUMO = 0
		
		SELECT @PIN = LTRIM(RTRIM(DESCRIPCION))
		FROM TGEN 
		WHERE TABLA = 'FDIAN' AND CAMPO = 'SOFTWARE' AND CODIGO = 'PIN'

		SELECT @CUFE = CONCAT(
			NumFac,	FecFac,	HorFac,	CAST(ValFac AS VARCHAR)
			,CodImp1	,CAST(ValImp1 AS VARCHAR)
			--,CodImp2	,CAST(ValImp2 AS VARCHAR) --Resol 0167 31 dic 2021 Pag 237 de 290 Solo un Impuesto
			--,CodImp3	,CAST(ValImp3 AS VARCHAR)
			,ValTot		,NitFE		,NumAdq
			,@PIN		,@TIPO_AMBIENTE
			) 
		FROM (
		SELECT N_FACTURA NumFac
			,REPLACE(CONVERT(VARCHAR, FCXP.FECHA, 102), '.', '-') AS FecFac
			,CONVERT(VARCHAR, FCXP.FECHA, 108) + '-05:00' AS HorFac
			,CAST(VALOR AS DECIMAL(14,2)) AS ValFac
			,'01' AS CodImp1
			,CAST(COALESCE(VLR_IVA,0) AS DECIMAL(14,2)) AS ValImp1
			--,'04' AS CodImp2
			--,@VLRIMPCONSUMO AS ValImp2
			--,'03' AS CodImp3
			--,@ICA AS ValImp3
			,CAST(VALOR + COALESCE(VLR_IVA,0) AS DECIMAL(14,2)) AS ValTot
			,DBO.FNK_LIMPIATEXTO(TER.NIT, '0-9') NitFE
			,DBO.FNK_LIMPIATEXTO(ADQ.NIT, '0-9') NumAdq
		FROM FCXP INNER JOIN TER ON TER.IDTERCERO=FCXP.IDTERCERO 
		LEFT JOIN TER ADQ ON ADQ.IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')
		WHERE CNSFCXP=@CNSDOC
		) AS #T
	END

	IF @TIPO_DOC = 'NA' -- Nota de Ajuste (FCXPDBCR)
	BEGIN
		--SELECT @NOREFERENCIA = LEFT(@CNSDOC,14), @ITEM = CONVERT(INT, RIGHT(@CNSDOC, LEN(@CNSDOC) - 14))
		SELECT @ITEM = RIGHT(@CNSDOC, 1), @NOREFERENCIA = LEFT(@CNSDOC, LEN(@CNSDOC)-1) 

		SELECT @PIN = LTRIM(RTRIM(DESCRIPCION))
		FROM TGEN 
		WHERE TABLA = 'FDIAN' AND CAMPO = 'SOFTWARE' AND CODIGO = 'PIN'

		SELECT @CUFE = CONCAT(
			NumFac,	FecFac,	HorFac,	CAST(ValFac AS VARCHAR)
			,CodImp1	,CAST(ValImp1 AS VARCHAR)
			--,CodImp2	,CAST(ValImp2 AS VARCHAR) -- Resol 0167 31 dic 2021 Pag 237 de 290 Solo un Impuesto
			--,CodImp3	,CAST(ValImp3 AS VARCHAR)
			,ValTot		,NitFE		,NumAdq
			,@PIN		,@TIPO_AMBIENTE
			) 
		FROM (
		SELECT COALESCE(@CNSDOC,'') NumFac
			,REPLACE(CONVERT(VARCHAR, FCXPDBCR.FECHA, 102), '.', '-') AS FecFac
			,CONVERT(VARCHAR, FCXPDBCR.FECHA, 108) + '-05:00' AS HorFac
			,CAST(COALESCE(FCXPDBCR.VALOR,0) AS DECIMAL(14,2)) AS ValFac
			,'01' AS CodImp1
			,CAST(COALESCE(FCXPDBCR.VALORIVA,0) AS DECIMAL(14,2)) AS ValImp1
			--,'04' AS CodImp2
			--,@VLRIMPCONSUMO AS ValImp2
			--,'03' AS CodImp3
			--,@ICA AS ValImp3
			,CAST(COALESCE(FCXPDBCR.VALOR,0) + COALESCE(FCXPDBCR.VALORIVA,0) AS DECIMAL(14,2)) AS ValTot
			,DBO.FNK_LIMPIATEXTO(COALESCE(TER.NIT,''), '0-9') NitFE
			,DBO.FNK_LIMPIATEXTO(COALESCE(ADQ.NIT,''), '0-9') NumAdq
		FROM FCXPDBCR INNER JOIN FCXP ON FCXP.CNSFCXP=FCXPDBCR.CNSFCXP
		INNER JOIN TER ON TER.IDTERCERO=FCXP.IDTERCERO 
		LEFT JOIN TER ADQ ON ADQ.IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')
		WHERE FCXPDBCR.CNSFCXP=@NOREFERENCIA AND ITEM=@ITEM
		) AS #T
	END

	--SELECT @RETURN = LOWER(CONVERT(VARCHAR(MAX),HASHBYTES('SHA1', @CUFE),2))
	RETURN @CUFE
END



