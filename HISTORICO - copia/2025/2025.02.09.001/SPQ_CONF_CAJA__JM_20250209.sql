CREATE OR ALTER PROCEDURE DBO.SPQ_CONF_CAJA
@JSON  NVARCHAR(MAX) 
WITH
ENCRYPTION
AS
DECLARE  @PARAMETROS      NVARCHAR(MAX) ,@MODELO           VARCHAR(100) ,@METODO            VARCHAR(100)  ,@USUARIO         VARCHAR(12),
			@GRUPO           VARCHAR(8)    ,@SYS_COMPUTERNAME VARCHAR(254) ,@IDSEDE            VARCHAR(5)    ,@USUNOMBRE       VARCHAR(100),
			@FECHA           VARCHAR(10)   ,@IDEMEDICA        VARCHAR(4)	,@FECHA1            DATETIME		 ,@SQL             VARCHAR(MAX),
			@IDMEDICO        VARCHAR(20)	 ,@HORA             VARCHAR(10)	,@IDDX              VARCHAR(10)	 ,@CONSECUTIVO     VARCHAR(20),
			@IDAFILIADO      VARCHAR(20)   ,@IDPLAN           VARCHAR(10)  ,@IDTERCERO         VARCHAR(20)   ,@IDSERVICIO      VARCHAR(20),
			@NOMBREACOMPA    VARCHAR(120)  ,@TELEFONOACOMPA   VARCHAR(20)  ,@PARENTESCOACOMPA  VARCHAR(20)   ,@MODELOCITA      VARCHAR(50),
			@CLASEORDEN      VARCHAR(20)   ,@IDPESPECIAL      VARCHAR(20)  ,@IDTERCEROCA       VARCHAR(20)   ,@NOAUTORIZACION  VARCHAR(20),
		   @FECHA2          DATE          ,@CONSECUTIVOANT   VARCHAR(20)  ,@CONSECUTIVONUE    VARCHAR(20)   ,@TIPOCITA        VARCHAR(20),
		   @NOMBRE          VARCHAR(100)  ,@ATENCION         VARCHAR(50)  ,@CCOSTO            VARCHAR(570)  ,@PARTICULAR      BIT,
		   @FECHAINCIO      DATETIME      ,@FECHAFINAL       DATETIME     ,@COMPANIA          VARCHAR(2)	,@ITEM		INT ,
         @IDAUT           VARCHAR(20)   ,@NO_ITEM          SMALLINT     ,@PYP               SMALLINT      ,@ALTOCOSTO       SMALLINT,
		   @VALORAUTD       DECIMAL(12,4) ,@FECHAAUT         DATETIME     ,@COPAGOPROPIO      SMALLINT      ,@SOAT            SMALLINT,
		   @PROCEDENCIA     VARCHAR(20)   ,@IDPROVEEDOR      VARCHAR(20)  ,@IDAREA            VARCHAR(20)   ,@PARTICULAR_TIME DECIMAL(14,2),
         @FECHAINI        DATE          ,@FECHAFIN         DATE         ,@IDESPECIALIDAD    VARCHAR(20),   
         @I               INT           ,@I_TO             INT		      ,@OBSERVCION        VARCHAR(200)	 ,@CAUSA           VARCHAR(20),
         @OBSERVACION     VARCHAR(200)  ,@HOY              SMALLDATETIME=GETDATE()                        ,@VLR_UNIT        INT, 
         @CANTIDAD        INT           ,@UNS              VARCHAR(20)  ,@CONDICIONAL       VARCHAR(10),
         @CODCAJA         VARCHAR(10)   ,@DATO             VARCHAR(100) ,@CODCAJERO         VARCHAR(20)   ,@CODTURNO        VARCHAR(4)       ,@CNSFACJ   VARCHAR(20)
        ,@CNSACJ          VARCHAR(20)   ,@NOADMISION       VARCHAR(20)  ,@CONCEPTO          VARCHAR(30)   ,@TOTAL           DECIMAL(20,4)   
        ,@TOTALFCJ        DECIMAL(12,4) ,@FALTANTE         DECIMAL(14,2),@CERRADA           SMALLINT      ,@CNSPCJ          VARCHAR(20)   
        ,@AUX             NVARCHAR(MAX) ,@PROCESO          VARCHAR(20)  ,@VALOR             DECIMAL(12,4) ,@SELECCIONADOS   VARCHAR(1000)
        ,@CNSFACJDEP      VARCHAR(50)   ,@CODCAJADEP       NVARCHAR(MAX),@CTA_BCO           VARCHAR(40)   ,@NUMEROAUTORIZA  VARCHAR(20)
        ,@NUMERODOCUMENTO VARCHAR(20)   ,@SUCURSAL         VARCHAR(20)  ,@TERCERO           NVARCHAR(MAX) ,@TIPOPAGO        NVARCHAR(MAX)
        ,@TIPO_TERCERO    NVARCHAR(MAX) ,@BANCODATO        NVARCHAR(MAX),@CNSDOC            VARCHAR(20)   ,@NUM_CUENTA      NVARCHAR(MAX)		,@NUMERO_CUENTA VARCHAR(20)
        ,@N_FACTURA       VARCHAR(16)   ,@ESTADO           VARCHAR(1)   ,@FECHAFCJ          DATE          ,@NROCOMPROBANTE  VARCHAR(20)
	     ,@FORMAPAGO       VARCHAR(20)	 ,@DESCRIPCION      VARCHAR(200)	,@DATOS             NVARCHAR(MAX) ,@DATOD           NVARCHAR(MAX)	   ,@TIPO VARCHAR(20)
	     ,@RECAUDO         BIT		       ,@NOMBREAFI        VARCHAR(200)	,@DESC_NUMDOCUMENTO VARCHAR(20)	 ,@PAG_IDPAGARE VARCHAR(20),@IDCJFPAEFECTIVO VARCHAR(10)
        ,@CLASE_FAC       VARCHAR(5)
        ,@TRASLADO_CNSFACJ VARCHAR(20) ,@CERRADO_PRI SMALLINT ,@ESTADO_MCP VARCHAR(1) ,@CNSRESOL_FCJ VARCHAR(50) ,@N_FACTURA_FCJ VARCHAR(16),
       @ANOMES_MCP       VARCHAR(30) ,@CONTABILIZADA_FCJ SMALLINT ,@CLASE_CAJ VARCHAR(9)
DECLARE @FECHA_AUT DATETIME, @FECHAI    VARCHAR(10)

DECLARE @TABLERRR		TABLE (ERROR VARCHAR(200))

BEGIN 
	SET LANGUAGE Spanish;  
	SET DATEFORMAT dmy
	SELECT *
	INTO #JSON
	FROM OPENJSON (@json)
	WITH (
		MODELO         VARCHAR(100)     '$.MODELO',
		METODO         VARCHAR(100)     '$.METODO',
		USUARIO        VARCHAR(12)      '$.USUARIO',
		PARAMETROS     NVARCHAR(MAX)  AS JSON
	)

	SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
	FROM #JSON
	--DEFINICION DE TABLA DE ERRORES
	DECLARE @TBLERRORES TABLE(ERROR VARCHAR(200));
	-- TOMA DEL GRUPO, SYS_COMPUTERNAME, SEDE   DE ACUERDO AL USUARIOpl,   --PRINT 'USUARIO:'+@USUARIO
	SELECT @GRUPO = DBO.FNK_DESCIFRAR(GRUPO), @USUNOMBRE = NOMBRE FROM USUSU WHERE USUARIO = @USUARIO
	SELECT @SYS_COMPUTERNAME = SYS_COMPUTERNAME, @COMPANIA = COMPANIA, @CODCAJERO= CODCAJERO FROM USUSU WHERE USUARIO = @USUARIO
	SELECT @IDSEDE = IDSEDE , @IDAREA=  IDAREA ,  @CCOSTO =CCOSTO FROM UBEQ WHERE SYS_ComputerName = @SYS_COMPUTERNAME
	PRINT '@USUARIO='+@USUARIO

   IF @METODO = 'INFO_CAJA'
   BEGIN
      SELECT @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(10)    '$.CODCAJA' 
      )
	   /*BEGIN --CODTURNO
      SELECT CAJ.CODCAJA, CAJ.DESCRIPCION, CAJ.TIPO,CAJ.CNSACJ, CAJ.CLASE,CAJ.FOFI,CAJ.ESTADO, CAJ.ABIERTA,
            CASE WHEN CAJ.ABIERTA = 1 THEN CASE WHEN (SELECT COUNT(1) FROM ACJ WHERE CAJ.CNSACJ = ACJ.CNSACJ ) = 1 
                                                       THEN 'Abierta'
                                                       ELSE 'ABIERTA ERROR'
                                                  END
                                             ELSE 'Cerrada'
                   END  [ESTACAJA]
            , (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO) [CODCAJERO] , (SELECT DESCRIPCION FROM CJR WHERE  CODCAJERO = (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)) [CAJNOMBRE]
            , CXT.CODTURNO, TUR.DESCRIPCION [TURDESC],  GETDATE() AS TODAY
         FROM CAJ 
            LEFT JOIN CXT ON CAJ.CODCAJA = CXT.CODCAJA AND CXT.CODCAJERO =  (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)
            LEFT JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO
         WHERE  CAJ.CODCAJA = @CODCAJA
	   END*/
      IF (SELECT COUNT(*) FROM CAJ WHERE CODCAJA = @CODCAJA AND 1=2) > 0
      BEGIN
		
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No valida aun.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF ( SELECT  COALESCE(DATO,'') FROM USVGS WHERE  IDVARIABLE = 'IDCJAPERTURACAJA' ) = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Variable del Sistema IDCJAPERTURACAJA sin Definici?.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      ELSE
      BEGIN
         IF  (SELECT COUNT(*) FROM CPCJ INNER JOIN USVGS ON CPCJ.CODIGO = USVGS.DATO WHERE  IDVARIABLE = 'IDCJAPERTURACAJA') = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Concepto de Caja definido en la variable del Sistema IDCJAPERTURACAJA, No existe en la tabla conceptos de caja'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
      END

      BEGIN TRY
          SELECT 'OK' OK, CAJ.CODCAJA, CAJ.DESCRIPCION, CAJ.TIPO,CAJ.CNSACJ, CAJ.CLASE,CAJ.FOFI,CAJ.ESTADO, CAJ.ABIERTA,
            CASE WHEN CAJ.ABIERTA = 1 THEN CASE WHEN (SELECT COUNT(1) FROM ACJ WHERE CAJ.CNSACJ = ACJ.CNSACJ ) = 1 
                                                       THEN 'Abierta'
                                                       ELSE 'ABIERTA ERROR'
                                                  END
                                             ELSE 'Cerrada'
                   END  [ESTACAJA]
            , (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO) [CODCAJERO] , (SELECT DESCRIPCION FROM CJR WHERE  CODCAJERO = (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)) [CAJNOMBRE]
            , CXT.CODTURNO, TUR.DESCRIPCION [TURDESC],  GETDATE() AS TODAY
         FROM CAJ 
            LEFT JOIN CXT ON CAJ.CODCAJA = CXT.CODCAJA AND CXT.CODCAJERO =  (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)
            LEFT JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO
         WHERE  CAJ.CODCAJA = @CODCAJA      
      END TRY
      BEGIN CATCH
         INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
      END CATCH
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END

      SELECT 'OK' OK
      RETURN


   END
   IF @METODO = 'VALIDA_INGRESO_PANTALLA'
   BEGIN
      SELECT @PROCEDENCIA = TFCJ.PROCEDENCIA, @IDPLAN = TFCJ.IDPLAN ,@NOADMISION = NOADMISION, @CNSFACJ = CNSFACJ FROM TFCJ WHERE  NOADMISION = @CONSECUTIVO
      SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO

      IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 0
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No es Cajero.'
       END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 1
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja no existe.'
       END
       /*IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 2
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Caja Cerrada.'
       END*/
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 3
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Cajero diferente al que abrio la caja.'
       END
       --IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 4
       --BEGIN
       --  INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno asignado.'
       --END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 5
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El equipo no es caja.'
       END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 6
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno para este horario.'
       END
     /* IF (SELECT COUNT(*) FROM CAJ INNER JOIN ACJ ON CAJ.CNSACJ = ACJ.CNSACJ AND CAJ.CODCAJA = ACJ.CODCAJA WHERE CAJ.CODCAJA = @CODCAJA AND ACJ.CNSACJ = @CNSACJ AND ACJ.ABIERTA = 1 AND CAJ.ESTADO = 'Activo' AND CAJ.ABIERTA = 1 ) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Error de configuracion.'
      END*/
      IF (SELECT COUNT(*) FROM CAJ WHERE CODCAJA = @CODCAJA AND 1=2) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No valida aun.'
      END
      IF ( SELECT  COALESCE(DATO,'') FROM USVGS WHERE  IDVARIABLE = 'IDCJAPERTURACAJA' ) = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Variable del Sistema IDCJAPERTURACAJA sin Definici?.'
      END
      ELSE
      BEGIN
         IF  (SELECT COUNT(*) FROM CPCJ INNER JOIN USVGS ON CPCJ.CODIGO = USVGS.DATO WHERE  IDVARIABLE = 'IDCJAPERTURACAJA') = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Concepto de Caja definido en la variable del Sistema IDCJAPERTURACAJA, No existe en la tabla conceptos de caja'
         END
      END
      --IF (SELECT COUNT(1)  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) = 0
      --BEGIN
      --   INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turnos configurados.'
      --END
      IF (SELECT DATEPART ( dw,getdate())) = 1 
      BEGIN
         IF  (SELECT TUR.LUNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0)
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Lunes.'
         END
      END
      IF (SELECT DATEPART ( dw,getdate())) = 2 
      BEGIN
         IF  (SELECT TUR.MARTES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Martes.'
         END
      END
      IF (SELECT DATEPART ( dw,getdate())) = 3 
      BEGIN
         IF  (SELECT TUR.MIERCOLES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Miercoles.'
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 4 
      BEGIN
         IF  (SELECT TUR.JUEVES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Jueves.'
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 5 
      BEGIN
         IF  (SELECT TUR.VIERNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Viernes.'
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 6 
      BEGIN
         IF  (SELECT TUR.SABADO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0)
         --IF  1= 1
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Sabado.'
         END
      END
      IF (SELECT DATEPART ( dw,getdate())) = 7 
      BEGIN
         IF  (SELECT TUR.DOMINGO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Domingo.'
         END
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		ELSE
		BEGIN
			SELECT 'OK' OK
		END

      RETURN


   END
   IF @METODO = 'INFO_CAJA_VALIDAR'
   BEGIN
      SELECT @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(10)    '$.CODCAJA' 
      )
       SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO

       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 0
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No es Cajero.'
       END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 1
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja no existe.'
       END
	   --IF EXISTS(SELECT  * FROM CAJ WHERE CODCAJA = @CODCAJA AND COALESCE(ABIERTA,0) = 0)
	   --BEGIN
    --     INSERT INTO @TBLERRORES(ERROR) SELECT 'Caja Cerrada....'
    --   END
       --IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 2
       --BEGIN
       --  INSERT INTO @TBLERRORES(ERROR) SELECT 'Caja Cerrada.'
       --END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 3
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Cajero diferente al que abrio la caja.'
       END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 4
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno asignado.'
       END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 5
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El equipo no es caja.'
       END
       IF (SELECT DBO.FNK_VALIDA_TURNO_CAJA(@USUARIO,@SYS_COMPUTERNAME ) ) = 6
       BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno para este horario.'
       END
      /*IF (SELECT COUNT(*) FROM CAJ INNER JOIN ACJ ON CAJ.CNSACJ = ACJ.CNSACJ AND CAJ.CODCAJA = ACJ.CODCAJA WHERE CAJ.CODCAJA = @CODCAJA AND ACJ.CNSACJ = @CNSACJ AND ACJ.ABIERTA = 1 AND CAJ.ESTADO = 'Activo' AND CAJ.ABIERTA = 1 ) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Error de configuracion.'
      END*/
      IF (SELECT COUNT(*) FROM CAJ WHERE CODCAJA = @CODCAJA AND 1=2) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No valida aun.'
      END
      IF ( SELECT  COALESCE(DATO,'') FROM USVGS WHERE  IDVARIABLE = 'IDCJAPERTURACAJA' ) = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Variable del Sistema IDCJAPERTURACAJA sin Definición.'
      END
      ELSE
      BEGIN
         IF  (SELECT COUNT(*) FROM CPCJ INNER JOIN USVGS ON CPCJ.CODIGO = USVGS.DATO WHERE  IDVARIABLE = 'IDCJAPERTURACAJA') = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Concepto de Caja definido en la variable del Sistema IDCJAPERTURACAJA, No existe en la tabla conceptos de caja'
         END
      END
      IF (SELECT COUNT(1)  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turnos configurados.'
      END
      IF (SELECT DATEPART ( dw,getdate())) = 1 
      BEGIN
         IF  (SELECT TUR.LUNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0)
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Lunes.'
         END
      END
      IF (SELECT DATEPART ( dw,getdate())) = 2 
      BEGIN
         IF  (SELECT TUR.MARTES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Martes.'
         END
      END
      IF (SELECT DATEPART ( dw,getdate())) = 3 
      BEGIN
         IF  (SELECT TUR.MIERCOLES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Miercoles.'
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 4 
      BEGIN
         IF  (SELECT TUR.JUEVES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Jueves.'
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 5 
      BEGIN
         IF  (SELECT TUR.VIERNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Viernes.'
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 6 
      BEGIN
         IF  (SELECT TUR.SABADO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0)
         --IF  1= 1
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Sabado.'
         END
      END
      IF (SELECT DATEPART ( dw,getdate())) = 7 
      BEGIN
         IF  (SELECT TUR.DOMINGO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Domingo.'
         END
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		ELSE
		BEGIN --CAJR
			SELECT 'OK' OK, CAJ.CODCAJA, CAJ.DESCRIPCION, CAJ.TIPO,CAJ.CNSACJ, CAJ.CLASE,CAJ.FOFI,CAJ.ESTADO, CAJ.ABIERTA,
            CASE WHEN CAJ.ABIERTA = 1 THEN CASE WHEN (SELECT COUNT(1) FROM ACJ WHERE CAJ.CNSACJ = ACJ.CNSACJ ) = 1 
                                                       THEN 'Abierta'
                                                       ELSE 'ABIERTA ERROR'
                                                  END
                                             ELSE 'Cerrada'
                   END  [ESTACAJA]
            , (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO) [CODCAJERO] , (SELECT DESCRIPCION FROM CJR WHERE  CODCAJERO = (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)) [CAJNOMBRE]
            , CXT.CODTURNO, TUR.DESCRIPCION [TURDESC],  GETDATE() AS TODAY, COALESCE(CAJR.VALOR,0) VALOR
         FROM   CAJ LEFT JOIN CXT  ON CAJ.CODCAJA = CXT.CODCAJA 
                                AND CXT.CODCAJERO =  (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)
                  LEFT JOIN TUR  ON CXT.CODTURNO  = TUR.CODTURNO
			         LEFT JOIN CAJR ON CAJ.CODCAJA   = CAJR.CODCAJA
         WHERE  CAJ.CODCAJA = @CODCAJA  
		END
      RETURN
   END
	IF @METODO = 'VALIDA_INGRESO_CAJA'
	BEGIN
		SELECT @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' 
      )


		IF ( SELECT COUNT(1) FROM ACJ WHERE  CODCAJA = @CODCAJA )> 0
		BEGIN
			PRINT 'ERROR: La caja no cuenta con horarios configurados.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'La caja no cuenta con horarios configurados.'
		END

		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		ELSE
		BEGIN
			SELECT 'OK'OK
		END
		RETURN
   END
	IF @METODO = 'ABRIR_CAJA'
	BEGIN
    SELECT @CODCAJA = CODCAJA, @CODTURNO = CODTURNO, @CODCAJERO = CODCAJERO
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(10)    '$.CODCAJA' ,
	   CODTURNO     VARCHAR(4)    '$.CODTURNO' ,
	   CODCAJERO     VARCHAR(20)    '$.CODCAJERO' 
      )
      SELECT @CODCAJERO = (SELECT CODCAJERO FROM USUSU WHERE  USUARIO = @USUARIO)
      IF ( SELECT  COALESCE(DATO,'') FROM USVGS WHERE  IDVARIABLE = 'IDCJAPERTURACAJA' ) = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Variable del Sistema IDCJAPERTURACAJA sin Definici?.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      ELSE
      BEGIN
         IF  (SELECT COUNT(*) FROM CPCJ INNER JOIN USVGS ON CPCJ.CODIGO = USVGS.DATO WHERE  IDVARIABLE = 'IDCJAPERTURACAJA') = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Concepto de Caja definido en la variable del Sistema IDCJAPERTURACAJA, No existe en la tabla conceptos de caja'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
      END
      IF (SELECT COUNT(*) FROM CAJ WHERE CODCAJA = @CODCAJA AND ABIERTA = 1 ) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja ya esta abierta.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF @CODCAJA = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Cajero sin Configuraci?.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF (SELECT COUNT(1)  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turnos configurados.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF (SELECT DATEPART ( dw,getdate())) = 1 
         BEGIN
            IF  (SELECT TUR.LUNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0)
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Lunes.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
      IF (SELECT DATEPART ( dw,getdate())) = 2 
         BEGIN
            IF  (SELECT TUR.MARTES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Martes.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
      IF (SELECT DATEPART ( dw,getdate())) = 3 
         BEGIN
            IF  (SELECT TUR.MIERCOLES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Miercoles.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
      IF (SELECT DATEPART ( dw,getdate())) = 4 
         BEGIN
            IF  (SELECT TUR.JUEVES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0) 
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Jueves.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
      IF (SELECT DATEPART ( dw,getdate())) = 5 
         BEGIN
            IF  (SELECT TUR.VIERNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Viernes.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
      IF (SELECT DATEPART ( dw,getdate())) = 6 
         BEGIN
            IF  (SELECT TUR.SABADO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0)
            --IF  1= 1
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Sabado.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
      IF (SELECT DATEPART ( dw,getdate())) = 7 
         BEGIN
            IF  (SELECT TUR.DOMINGO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Domingo.'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
          END
         

         BEGIN TRY
            PRINT 'Entro por aqui==>'
            SELECT 'OK' OK
            EXEC SPK_APERTURA_DE_CAJA @CODCAJA,@CODCAJERO,@CODTURNO,@SYS_COMPUTERNAME,@IDSEDE,@COMPANIA, @USUARIO            
         END TRY
         BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END

         SELECT 'OK' OK
         RETURN
   END
	IF @METODO = 'CERRAR_CAJA'
	BEGIN
    SELECT @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(10)    '$.CODCAJA' 
      )

      --IF (SELECT COUNT(*) FROM CAJ INNER JOIN ACJ ON CAJ.CNSACJ = ACJ.CNSACJ AND CAJ.CODCAJA = ACJ.CODCAJA WHERE CAJ.CODCAJA = @CODCAJA AND ACJ.CNSACJ = @CNSACJ AND ACJ.ABIERTA = 1 AND CAJ.ESTADO = 'Activo' AND CAJ.ABIERTA = 1 ) = 0
      --BEGIN
      --   INSERT INTO @TBLERRORES(ERROR) SELECT 'Error de configuracion.'
      --   SELECT 'KO' OK
      --   SELECT ERROR FROM @TBLERRORES
      --   RETURN
      --END
	  IF EXISTS(SELECT * FROM CAJ WHERE  CAJ.CODCAJA = @CODCAJA AND COALESCE(ABIERTA,0) = 0)
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La Caja se encuentra cerrada'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF (SELECT COUNT(*) FROM CAJ WHERE CODCAJA = @CODCAJA AND 1=2) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No valida aun.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF ( SELECT  COALESCE(DATO,'') FROM USVGS WHERE  IDVARIABLE = 'IDCJAPERTURACAJA' ) = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Variable del Sistema IDCJAPERTURACAJA sin Definici?.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      ELSE
      BEGIN
         IF  (SELECT COUNT(*) FROM CPCJ INNER JOIN USVGS ON CPCJ.CODIGO = USVGS.DATO WHERE  IDVARIABLE = 'IDCJAPERTURACAJA') = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Concepto de Caja definido en la variable del Sistema IDCJAPERTURACAJA, No existe en la tabla conceptos de caja'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
      END
      PRINT 'SE ADICIONA VALIDACION DE CONTABILIDAD ANTES DEL CIERRE'
      IF EXISTS(SELECT * FROM CAJ WHERE CODCAJA=@CODCAJA AND CLASE<>'Menor')
      BEGIN
         SELECT @CNSACJ = CNSACJ FROM CAJ WHERE CODCAJA = @CODCAJA
         IF EXISTS(SELECT * FROM CAJ WHERE CODCAJA = @CODCAJA AND @CNSACJ = CNSACJ AND ABIERTA = 1 AND COALESCE(NOCONTAB,0)<>1 ) --STORRES
            BEGIN 
               IF EXISTS(SELECT * FROM FCJ WHERE CNSACJ=@CNSACJ AND DEAPERTURA=0 AND ESTADO='P' AND CERRADA=1 AND COALESCE(CONTABILIZADA,0)<>1 )
               BEGIN
                  INSERT INTO @TBLERRORES(ERROR) SELECT 'CERRAR CAJA: Existen Recibos de Caja con Errores Contables, No se puede Continuar con el Cierre'
                  SELECT 'KO' OK
                  SELECT ERROR FROM @TBLERRORES
                  RETURN         
               END
            END --STORRES
      END
      BEGIN TRY
         EXEC SPK_CIERRE_DE_CAJA @CODCAJA, @SYS_COMPUTERNAME,@IDSEDE,@COMPANIA          
      END TRY
      BEGIN CATCH
         INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
      END CATCH
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END

      SELECT 'OK' OK
      RETURN
   END
	IF @METODO = 'TRAER_COMPROBANTE'
	BEGIN
       SELECT @CNSFACJ = CNSFACJ, @CNSACJ = CNSACJ, @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' 
      )
	  
      SELECT @PROCEDENCIA = TFCJ.PROCEDENCIA, @IDPLAN = TFCJ.IDPLAN ,@NOADMISION = NOADMISION  FROM TFCJ WHERE  @CNSFACJ = CNSFACJ
      SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO  FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO
	IF COALESCE(@CODCAJA,'') = ''
		SELECT @CODCAJA = CODCAJA  FROM  USUSU
			INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
			INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
		WHERE  USUARIO = @USUARIO

      IF ( SELECT  COALESCE(DATO,'') FROM USVGS WHERE  IDVARIABLE = 'IDCJAPERTURACAJA' ) = ''
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Variable del Sistema IDCJAPERTURACAJA sin Definici?.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      ELSE
      BEGIN
         IF  (SELECT COUNT(*) FROM CPCJ INNER JOIN USVGS ON CPCJ.CODIGO = USVGS.DATO WHERE  IDVARIABLE = 'IDCJAPERTURACAJA') = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'ABRIR CAJA: Concepto de Caja definido en la variable del Sistema IDCJAPERTURACAJA, No existe en la tabla conceptos de caja'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
      END
      IF (SELECT COUNT(*) FROM CAJ WHERE CODCAJA = @CODCAJA AND 1=2) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No valida aun.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF (SELECT COUNT(1)  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turnos configurados.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      IF (SELECT DATEPART ( dw,getdate())) = 1 
      BEGIN
         IF  (SELECT TUR.LUNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0)
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Lunes.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 2 
      BEGIN
         IF  (SELECT TUR.MARTES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Martes.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 3 
      BEGIN
         IF  (SELECT TUR.MIERCOLES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Miercoles.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 4 
      BEGIN
         IF  (SELECT TUR.JUEVES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Jueves.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 5 
      BEGIN
         IF  (SELECT TUR.VIERNES  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Viernes.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 6 
      BEGIN
         IF  (SELECT TUR.SABADO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO)IN (NULL, '', 0)
         --IF  1= 1
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Sabado.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END
      IF (SELECT DATEPART ( dw,getdate())) = 7 
      BEGIN
         IF  (SELECT TUR.DOMINGO  FROM     CXT INNER JOIN TUR ON CXT.CODTURNO = TUR.CODTURNO WHERE  CODCAJA = @CODCAJA AND CODCAJERO =@CODCAJERO) IN (NULL, '', 0) 
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No tiene turno configurado para hoy Domingo.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         END

      IF @IDPLAN IN (DBO.FNK_VALORVARIABLE('IDPLANPART'),DBO.FNK_VALORVARIABLE('IDPLANPART2'),DBO.FNK_VALORVARIABLE('IDPLANPART3')
              ,DBO.FNK_VALORVARIABLE('IDPLANPART4'),DBO.FNK_VALORVARIABLE('IDPLANPART5'))
      BEGIN
         IF @PROCEDENCIA = 'CITAS'
         BEGIN
            IF (SELECT COUNT(*) FROM FTR WHERE NOREFERENCIA= @NOADMISION AND PROCEDENCIA='CI' AND ESTADO='P') <= 0
            BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La Cita No Ha sido Facturada... Es Particular Debe Facturar Primero'
               SELECT 'KO' OK
               SELECT ERROR FROM @TBLERRORES
               RETURN
            END
         END
         IF @PROCEDENCIA='CE'
         BEGIN
            SELECT @CONCEPTO = CASE WHEN DBO.FNK_VALORVARIABLE('IDCJDEPOSITO')= CONCEPTO THEN 'DEPOSITO' ELSE '' END FROM TFCJD WHERE CNSFACJ= @CNSFACJ
            IF @CONCEPTO <>'DEPOSITO'
            BEGIN
               IF (SELECT COUNT(*) FROM FTR WHERE NOREFERENCIA= @NOADMISION AND PROCEDENCIA='CE' AND ESTADO='P') <= 0
               BEGIN
                  INSERT INTO @TBLERRORES(ERROR) SELECT 'La Orden  No Ha sido Facturada... Es Particular Debe Facturar Primero'
                  SELECT 'KO' OK
                  SELECT ERROR FROM @TBLERRORES
                  RETURN
               END
            END
         END
      END
      IF  (SELECT count(1)FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO AND CAJ.ABIERTA = 1) <> 1
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja se encuentra cerrada, revisar'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      BEGIN TRY
	
         EXEC SPK_TRAERECIB_CAJA @CNSFACJ,@CNSACJ, @SYS_COMPUTERNAME, '01',@IDSEDE,@USUARIO , 'COBRO'     
      END TRY
      BEGIN CATCH
         INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
      END CATCH
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END

      SELECT 'OK' OK
      RETURN
   END
	IF @METODO = 'VALIDA_INSERT_FPA'
	BEGIN
		SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' 
      )
      SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO  
      FROM   USUSU INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
                   INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
      WHERE  USUARIO = @USUARIO
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      SELECT @TOTAL = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      --SELECT @TOTALFCJ
      IF (SELECT COUNT(*) FROM FCJ WHERE  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ= @CNSFACJ AND FCJ.CERRADA = 1)>0
      BEGIN
			PRINT 'ERROR: El recibo ya se encuentra cerrado.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'El recibo ya se encuentra cerrado.'
		END
--  1. Validaci? si se cumplio con el monto total:
		IF @TOTAL >= @TOTALFCJ
		BEGIN
			PRINT 'ERROR: No se puede insertar, la sumatoria ya cumplio con el monto total.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'No se puede insertar, la sumatoria ya cumplio con el monto total.'
		END

--  2. Validaci? si FCJ tiene un Valor Total
		IF @TOTALFCJ <= 0
		BEGIN
			PRINT 'ERROR: El registro no tiene un Valor Total.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'El registro no tiene un Valor Total.'
		END

		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		ELSE
		BEGIN
			SELECT 'OK'OK
		END
		RETURN
   END  
	IF @METODO = 'VALIDA_EDIT_FPA_EGRESO'
	BEGIN
		SELECT @CNSFACJ = CNSFACJ, @CNSPCJ = CNSPCJ, @CNSACJ = CNSACJ, @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CNSPCJ     VARCHAR(20)    '$.CNSPCJ' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' 
      )
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      SELECT @TOTAL = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      --SELECT @TOTALFCJ
      IF (SELECT COUNT(*) FROM FCJ WHERE  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ= @CNSFACJ AND FCJ.CERRADA = 1)>0
      BEGIN
			PRINT 'ERROR: El recibo ya se encuentra cerrado.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'El recibo ya se encuentra cerrado.'
		END

		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		ELSE
		BEGIN
			SELECT 'OK'OK, CASE WHEN DBO.FNK_VALORVARIABLE('IDCJ_TRASLADOENCAJAS') = FCJD.CONCEPTO THEN 'EGRESO' ELSE 'PAGO' END TIPO FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ

		END
		RETURN
   END
	IF @METODO = 'VALIDA_INSERT_FPA_EGRESO'
	BEGIN
		SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' 
      )
      SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      SELECT @TOTAL = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      --SELECT @TOTALFCJ
      IF NOT EXISTS(SELECT  * FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      BEGIN
			PRINT 'ERROR: Genere un Movimiento de detalle.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'Genere un Movimiento de detalle.'
		END

		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		ELSE
		BEGIN
			SELECT 'OK'OK, CASE WHEN DBO.FNK_VALORVARIABLE('IDCJ_TRASLADOENCAJAS') = FCJD.CONCEPTO THEN 'EGRESO' ELSE 'PAGO' END TIPO
			, CAJ.CLASE, SUM(FCJD.CANTIDAD * FCJD.VALORUNITARIO) MONTO
			FROM FCJD 
				LEFT JOIN CAJ ON FCJD.CODCAJA = CAJ.CODCAJA
			WHERE  FCJD.CODCAJA = @CODCAJA AND FCJD.CNSFACJ = @CNSFACJ
			GROUP BY FCJD.CONCEPTO, CAJ.CLASE


			--SELECT CODIGO value, DESCRIPCION label FROM TGEN WHERE TABLA = @CODCAJA AND CAMPO = 'FORMAPAGO'
			SELECT
			FPA.FORMAPAGO value
			,FPA.DESCRIPCION label
			,FISICO = CAST(FISICO AS BIT)
			,REQBCO = CAST(REQBCO AS BIT)
			,REQDOC = CAST(REQDOC AS BIT)
			,REQAUT = CAST(REQAUT AS BIT)
			,CXC = CAST(CXC AS BIT)
			,AUTINT = CAST(AUTINT AS BIT)
			,MEDIOPAGO  = CAST(MEDIOPAGO AS BIT)
			,TEDEVOLUCION = CAST(TEDEVOLUCION AS BIT)
			,CUENTA
			,CEROENAPERTURA = CAST(CEROENAPERTURA AS BIT)
			,USAR_CUENTACAJA = CAST(USAR_CUENTACAJA AS BIT)  
			,REQCTA_BCO_DEP = CAST(REQCTA_BCO_DEP AS BIT)
			,GENCHEQUE = CAST(GENCHEQUE AS BIT)
			,COMPROBANTE_EGR
			,DATAFONO = CAST(COALESCE(DATAFONO,0) AS BIT)
			,PAGARE = CAST(CASE WHEN U1.DATO = FPA.FORMAPAGO THEN 1 ELSE 0 END AS BIT)
			,DESCUENTO_NOMINA = CAST(CASE WHEN U2.DATO = FPA.FORMAPAGO THEN 1 ELSE 0 END AS BIT)
			,TERCEROS = (SELECT TER.IDTERCERO value, TER.RAZONSOCIAL label FROM BCO INNER JOIN TER ON BCO.IDTERCERO = TER.IDTERCERO WHERE CAST(REQBCO AS BIT) = 1 FOR JSON PATH)
		FROM FPA
			INNER JOIN TGEN ON FPA.FORMAPAGO = TGEN.CODIGO AND TGEN.CAMPO = 'FORMAPAGO' AND TGEN.TABLA = @CODCAJA
			LEFT JOIN USVGS U1 ON U1.IDVARIABLE = 'IDFPAPAGARE'
			LEFT JOIN USVGS U2 ON U2.IDVARIABLE = 'IDCJFPADESCUENT_NOMI'

			SELECT CODIGO value, DESCRIPCION label FROM TGEN  WHERE TABLA = @CODCAJA AND CAMPO = 'FORMAPAGO' AND CODIGO = DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO') 

		END
		RETURN
   END
	IF @METODO = 'ELIMINA_FPA'
	BEGIN
      SELECT @CNSPCJ = CNSPCJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSPCJ     VARCHAR(20)    '$.CNSPCJ' 
      )

      SELECT @CODCAJA = CODCAJA , @CNSFACJ = CNSFACJ FROM PCJ WHERE PCJ.CNSPCJ = @CNSPCJ
	  
	  IF EXISTS(SELECT * FROM FCJ INNER JOIN PCJ ON FCJ.CODCAJA = PCJ.CODCAJA AND FCJ.CNSFACJ = PCJ.CNSFACJ WHERE PCJ.CNSPCJ = @CNSPCJ AND FCJ.CERRADA = 1)
      BEGIN
			PRINT 'ERROR: El recibo ya se encuentra cerrado.'
			INSERT INTO @TBLERRORES(ERROR)
			SELECT 'El recibo ya se encuentra cerrado.'
	  END
      IF 1=2
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Error aun por definir'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END

      BEGIN TRY
         DELETE FROM  PCJ WHERE  CNSPCJ = @CNSPCJ
      END TRY
      BEGIN CATCH
         INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
      END CATCH
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      SELECT @TOTAL    = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      SELECT @CERRADA  = CERRADA FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
      SELECT @FALTANTE = @TOTALFCJ - @TOTAL
      SELECT 'OK' OK ,@TOTALFCJ VALORCOPAGO ,@FALTANTE VALORFALTANTE ,@TOTAL VALORPAGADO ,@CERRADA CERRADA
      RETURN
   END
	IF @METODO = 'ELIMINA_FPA_EGRESO'
	BEGIN
      SELECT @CNSPCJ = CNSPCJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSPCJ     VARCHAR(20)    '$.CNSPCJ' 
      )
	   SELECT @VALOR = VALOR,@CODCAJA = CODCAJA,@CNSFACJ = CNSFACJ FROM PCJ WHERE  CNSPCJ = @CNSPCJ
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJD WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )

      IF NOT EXISTS(SELECT  * FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Genere un Movimiento de detalle.'
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
--QUERY2
      BEGIN TRY
		IF (SELECT COALESCE(VALORTOTAL,0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ  )>0
		BEGIN
			IF DBO.FNK_VALORVARIABLE('IDCJTECXP') <> (SELECT TIPOEGRESO FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ)
				AND NOT EXISTS (SELECT  * FROM CAJ WHERE CAJ.CODCAJA = @CODCAJA AND CAJ.CLASE ='Menor')
			BEGIN
				UPDATE FCJD SET VALORTOTAL = @TOTALFCJ-@VALOR, VALORUNITARIO=@TOTALFCJ- @VALOR  WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
				UPDATE FCJ SET VALORTOTAL = @TOTALFCJ-@VALOR WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
			END
		END
         
         --UPDATE CAJR SET VALOR = VALOR  + (SELECT SUM(VALOR) FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ) WHERE  CAJR.CODCAJA = @CODCAJA AND CAJR.FORMAPAGO IN (SELECT TIPOPAGO FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ)  
         
         UPDATE PCJ SET TRASLADO_CNSFACJ =  NULL, TRASLADADO = NULL WHERE TRASLADO_CNSFACJ = @CNSFACJ AND TRASLADADO = 1 
         DELETE FROM  PCJ WHERE  CNSPCJ = @CNSPCJ
      END TRY
      BEGIN CATCH
         INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
      END CATCH
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
      SELECT 'OK' OK
      RETURN
   END
   IF @METODO = 'CRUDFPA_EGRESO'
	BEGIN
     SELECT @AUX = DATOS , @SELECCIONADOS = SELECCIONADOS, @CONDICIONAL = CONDICIONAL
     FROM OPENJSON(@PARAMETROS) WITH  (DATOS       NVARCHAR(MAX) AS JSON,
                                        SELECCIONADOS     VARCHAR(1000)    '$.SELECCIONADOS' ,
                                        CONDICIONAL     VARCHAR(10)    '$.CONDICIONAL' )
     
     SELECT    @PROCESO        =   PROCESO ,
               @CNSFACJ        =   CNSFACJ ,
               @CNSFACJDEP        =   CNSFACJDEP ,
               @CNSPCJ        =   CNSPCJ ,
               @CNSACJ        = CNSACJ,
               @CODCAJA        =   CODCAJA ,
               @CODCAJADEP        =   (SELECT VALOR FROM OPENJSON(CODCAJADEP )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @CTA_BCO        =   CTA_BCO ,
               @NUMEROAUTORIZA        =   NUMEROAUTORIZA ,
               @NUMERODOCUMENTO        =   NUMERODOCUMENTO ,
               @NUM_CUENTA          = (SELECT VALOR FROM OPENJSON(NUM_CUENTA   )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @VALOR        =   VALOR ,
               @SUCURSAL        =   SUCURSAL ,
               @CNSDOC        =     CNSDOC,
               @BANCODATO     =     (SELECT VALOR FROM OPENJSON(BANCODATO )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @TERCERO        =    (SELECT VALOR FROM OPENJSON(TERCERO )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @TIPOPAGO       =   (SELECT VALOR FROM OPENJSON(TIPOPAGO )    WITH (VALOR VARCHAR(20) '$.value'))  ,  
               @TIPO_TERCERO       =   (SELECT VALOR FROM OPENJSON(TIPO_TERCERO )    WITH (VALOR VARCHAR(20) '$.value'))  
      FROM OPENJSON(@AUX) 
      WITH (	
            PROCESO          VARCHAR(30)   '$.PROCESO' ,
            CNSFACJ         VARCHAR(20)   '$.CNSFACJ' , 
            CNSFACJDEP         VARCHAR(50)   '$.CNSFACJDEP' , 
            CNSPCJ         VARCHAR(20)   '$.CNSPCJ' , 
            CNSACJ         VARCHAR(20)   '$.CNSACJ' , 
            CODCAJA         VARCHAR(10)   '$.CODCAJA' , 
            CODCAJADEP        NVARCHAR(MAX)   AS JSON, 
            CTA_BCO         VARCHAR(40)   '$.CTA_BCO' , 
            NUMEROAUTORIZA         VARCHAR(20)   '$.NUMEROAUTORIZA' , 
            NUMERODOCUMENTO         VARCHAR(20)   '$.NUMERODOCUMENTO' , 
            VALOR         DECIMAL(12,4)   '$.VALOR' , 
            SUCURSAL         VARCHAR(20)   '$.SUCURSAL' , 
            CNSDOC         VARCHAR(20)   '$.CNSDOC' , 
            NUM_CUENTA        NVARCHAR(MAX)   AS JSON,
            BANCODATO        NVARCHAR(MAX)   AS JSON,
            TERCERO        NVARCHAR(MAX)   AS JSON,
            TIPOPAGO        NVARCHAR(MAX)   AS JSON,
            TIPO_TERCERO        NVARCHAR(MAX)   AS JSON
              )
		PRINT '11111 ==>'
         SELECT @IDCJFPAEFECTIVO=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO')
	
			SELECT @TOTAL = SUM(COALESCE(PCJ.VALOR,0)) FROM FCJ
				  INNER JOIN PCJ ON FCJ.CNSFACJ = PCJ.CNSFACJ AND FCJ.CNSACJ = PCJ.CNSACJ
				  INNER JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
			WHERE  FCJ.CERRADA = 1 AND  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSACJ = @CNSACJ AND FPA.FORMAPAGO = @IDCJFPAEFECTIVO
		PRINT '222222 ==>'
	
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJD WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      --SELECT @TOTAL = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
	  --select @TOTALFCJ
	  --select @TOTAL
   
     IF UPPER(@PROCESO) = 'INSERTAR'
     BEGIN
         --IF @TOTAL < @TOTALFCJ + @VALOR
         --BEGIN
         --   INSERT INTO @TBLERRORES(ERROR) SELECT 'El monto total de las formas de pago, supera el monto de la caja.'
         --   SELECT 'KO' OK
         --   SELECT ERROR FROM @TBLERRORES
         --   RETURN
         --END
         IF NOT EXISTS(SELECT  * FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'Genere un Movimiento de detalle'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END

         BEGIN TRY
            SELECT @CNSPCJ = NULL
				EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE,'@PCJ', @CNSPCJ OUTPUT  
				SELECT @CNSPCJ = @IDSEDE+REPLACE(SPACE(8 - LEN(@CNSPCJ))+LTRIM(RTRIM(@CNSPCJ)),SPACE(1),0)
  
            IF @TIPOPAGO = @IDCJFPAEFECTIVO -- NO PUEDE ESTAR QUEMADO OJO--
            BEGIN
               IF EXISTS (SELECT * FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TIPOPAGO = @IDCJFPAEFECTIVO  )
               BEGIN
				PRINT 'POR 11111111'
                 --UPDATE CAJR SET VALOR = VALOR  + (SELECT SUM(VALOR) FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.TRASLADO_CNSFACJ = @CNSFACJ) WHERE  CAJR.CODCAJA = @CODCAJA AND CAJR.FORMAPAGO IN (SELECT TIPOPAGO FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.TRASLADO_CNSFACJ = @CNSFACJ)  
                 UPDATE PCJ SET VALOR = VALOR + @VALOR WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TIPOPAGO = @IDCJFPAEFECTIVO
				      --UPDATE FCJD SET VALORTOTAL = @TOTALFCJ + @VALOR,VALORUNITARIO= @TOTALFCJ + @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ -- ACTUALZIAR VLR UNITARIO
					UPDATE FCJD SET VALORTOTAL = @TOTALFCJ + @VALOR,VALORUNITARIO= @TOTALFCJ + @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ -- ACTUALZIAR VLR UNITARIO
					UPDATE FCJ SET VALORTOTAL = @TOTALFCJ + @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
               END
               ELSE
               BEGIN
				PRINT 'POR 22222222'
					
                   INSERT INTO PCJ (CODCAJA, CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, NUMEROAUTORIZA,
								    FECHA, CNSACJ, IDTERCERO, IMPRESO, CODCAJADEP, CNSFACJDEP, DOCORIGEN, BANCO_DEP, CTA_BCO_DEP, CUENTA,
								    VLR_DEVUELTO, VARIOS, TRASLADADO, TRASLADO_CNSFACJ, VALORREINTEGRO)
				      SELECT @CODCAJA, @CNSPCJ, @CNSFACJ, @TIPOPAGO, @VALOR, @BANCODATO, (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA), (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)
                        , @CNSDOC, @NUMERODOCUMENTO, @NUMEROAUTORIZA,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					            @CNSACJ, @TERCERO, 0, @CODCAJADEP, @CNSFACJDEP, 0, '', '', @TIPO_TERCERO, 0, 0, '', '', 0

				IF (SELECT COALESCE(VALORTOTAL,0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )> 0
				BEGIN
					UPDATE FCJD SET VALORTOTAL = @TOTALFCJ  ,VALORUNITARIO=@TOTALFCJ   WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ -- ACTUALIZAR FCJD VLR_UNITARIO
				END
				IF (SELECT COALESCE(VALORTOTAL,0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ ) = 0
				BEGIN
					UPDATE FCJD SET VALORTOTAL = @TOTALFCJ+ @VALOR ,VALORUNITARIO=@TOTALFCJ+ @VALOR   WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ -- ACTUALIZAR FCJD VLR_UNITARIO
					UPDATE FCJ SET VALORTOTAL = @TOTALFCJ + @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
				END

               END
            END
            ELSE
            BEGIN
                  PRINT 'POR ////////>' --FCJD
				PRINT 'POR 333333333'

                  INSERT INTO PCJ (CODCAJA, CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, NUMEROAUTORIZA,
								    FECHA, CNSACJ, IDTERCERO, IMPRESO, CODCAJADEP, CNSFACJDEP, DOCORIGEN, BANCO_DEP, CTA_BCO_DEP, CUENTA,
								    VLR_DEVUELTO, VARIOS, TRASLADADO, TRASLADO_CNSFACJ, VALORREINTEGRO)
				      SELECT @CODCAJA, @CNSPCJ, @CNSFACJ, @TIPOPAGO, @VALOR, @BANCODATO, (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA), (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)
                        , @CNSDOC, @NUMERODOCUMENTO, @NUMEROAUTORIZA,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					            @CNSACJ, @TERCERO, 0, @CODCAJADEP, @CNSFACJDEP, 0, '', '', @TIPO_TERCERO, 0, 0, '', '', 0

					--UPDATE FCJD SET VALORTOTAL = @TOTALFCJ + @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ  -- VLR UNITARIO
					--UPDATE FCJ SET VALORTOTAL = @TOTALFCJ + @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
            END
            IF @SELECCIONADOS IS NOT NULL
            BEGIN
               DECLARE @TTABLE2 TABLE ( CONSECUTIVO VARCHAR(13) )
               INSERT INTO @TTABLE2( CONSECUTIVO )
	            SELECT VALUE from string_split(@SELECCIONADOS,',')SELECCIONADOS
               UPDATE PCJ SET TRASLADADO = 1 , TRASLADO_CNSFACJ =   @CNSFACJ WHERE CNSPCJ IN (SELECT CONSECUTIVO FROM @TTABLE2)
               --UPDATE CAJR SET VALOR = VALOR - (SELECT  SUM(PCJ.VALOR) FROM PCJ WHERE  CNSPCJ IN (SELECT CONSECUTIVO FROM @TTABLE2)) WHERE  CAJR.CODCAJA = @CODCAJA AND CAJR.FORMAPAGO = '01'
            END
         END TRY
         BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END

         SELECT 'OK' OK
         RETURN
      END
      IF UPPER(@PROCESO) = 'EDITAR'
      BEGIN
         IF 1=2
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'Editar de prueba.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         IF NOT EXISTS(SELECT  * FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'Genere un Movimiento de detalle'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END

         BEGIN TRY
             UPDATE CAJR SET VALOR = VALOR  + (SELECT SUM(VALOR) FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.TRASLADO_CNSFACJ = @CNSFACJ) WHERE  CAJR.CODCAJA = @CODCAJA AND CAJR.FORMAPAGO IN (SELECT TIPOPAGO FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.TRASLADO_CNSFACJ = @CNSFACJ)  

            UPDATE PCJ SET    TIPOPAGO = @TIPOPAGO  ,  VALOR = @VALOR,  BANCO = @BANCODATO   ,SUCURSAL  = (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA) 
                     ,CTA_BCO = (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA), CNSDOC = @CNSDOC, NUMERODOCUMENTO = CASE WHEN @TIPOPAGO = @IDCJFPAEFECTIVO THEN NULL ELSE  @NUMERODOCUMENTO END, NUMEROAUTORIZA = @NUMEROAUTORIZA
                     ,FECHA = DBO.FNK_FECHA_SIN_MLS(GETDATE()), CNSACJ = @CNSACJ, IDTERCERO = @TERCERO, IMPRESO = 0, CODCAJADEP = @CODCAJADEP, CNSFACJDEP = @CNSFACJDEP
                     ,CUENTA = @TIPO_TERCERO
            WHERE  CNSPCJ = @CNSPCJ


			   UPDATE FCJD SET VALORTOTAL =  @VALOR,VALORUNITARIO=@VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ -- VLRUNITARIO
			   UPDATE FCJ SET VALORTOTAL =  @VALOR WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
            
            IF @SELECCIONADOS IS NOT NULL --DESDE ACAAA===>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            BEGIN
               --UPDATE CAJR SET VALOR = VALOR  + (SELECT SUM(VALOR) FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.TRASLADO_CNSFACJ = @CNSFACJ) WHERE  CAJR.CODCAJA = @CODCAJA AND CAJR.FORMAPAGO IN (SELECT TIPOPAGO FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.TRASLADO_CNSFACJ = @CNSFACJ)  
               
               UPDATE PCJ SET TRASLADO_CNSFACJ =  NULL, TRASLADADO = NULL WHERE TRASLADO_CNSFACJ = @CNSFACJ AND TRASLADADO = 1 

               DECLARE @TTABLE3 TABLE ( CONSECUTIVO VARCHAR(13) )
               INSERT INTO @TTABLE3( CONSECUTIVO )
	            SELECT VALUE from string_split(@SELECCIONADOS,',')SELECCIONADOS
               UPDATE PCJ SET TRASLADADO = 1 , TRASLADO_CNSFACJ =   @CNSFACJ WHERE CNSPCJ IN (SELECT CONSECUTIVO FROM @TTABLE3)
              -- UPDATE CAJR SET VALOR = VALOR - (SELECT  SUM(PCJ.VALOR) FROM PCJ WHERE  CNSPCJ IN (SELECT CONSECUTIVO FROM @TTABLE3)) WHERE  CAJR.CODCAJA = @CODCAJA AND CAJR.FORMAPAGO = '01'
            END

         END TRY
         BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END

         SELECT 'OK' OK
         RETURN
      END
   END
	IF @METODO = 'CRUDFPA'
	BEGIN
     SELECT @AUX = DATOS FROM OPENJSON(@PARAMETROS) WITH  (DATOS NVARCHAR(MAX) AS JSON)
     
     SELECT    @PROCESO            = PROCESO ,
               @CNSFACJ            = CNSFACJ ,
               @CNSFACJDEP         = CNSFACJDEP ,
               @CNSPCJ             = CNSPCJ ,
               @CNSACJ             = CNSACJ,
               @CODCAJA            = CODCAJA ,
               @CODCAJADEP         = (SELECT VALOR FROM OPENJSON(CODCAJADEP )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @CTA_BCO            = CTA_BCO ,
               @NUMEROAUTORIZA     = NUMEROAUTORIZA ,
               @NUMERODOCUMENTO    = NUMERODOCUMENTO ,
               @NUM_CUENTA         = NUM_CUENTA ,
               @VALOR              = VALOR ,
               @SUCURSAL           = SUCURSAL ,
               @CNSDOC             = CNSDOC,
               @DESC_NUMDOCUMENTO  = DESC_NUMDOCUMENTO,
			      @PAG_IDPAGARE		  = PAG_IDPAGARE,
               @BANCODATO          = (SELECT VALOR FROM OPENJSON(BANCODATO )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @TERCERO            = (SELECT VALOR FROM OPENJSON(TERCERO )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @TIPOPAGO           = (SELECT VALOR FROM OPENJSON(TIPOPAGO )    WITH (VALOR VARCHAR(20) '$.value'))  ,  
               @TIPO_TERCERO       = (SELECT VALOR FROM OPENJSON(TIPO_TERCERO )    WITH (VALOR VARCHAR(20) '$.value'))  
      FROM OPENJSON(@AUX) 
      WITH (	
            PROCESO           VARCHAR(30)   '$.PROCESO' ,
            CNSFACJ           VARCHAR(20)   '$.CNSFACJ' , 
            CNSFACJDEP        VARCHAR(50)   '$.CNSFACJDEP' , 
            CNSPCJ            VARCHAR(20)   '$.CNSPCJ' , 
            CNSACJ            VARCHAR(20)   '$.CNSACJ' , 
            CODCAJA           VARCHAR(10)   '$.CODCAJA' , 
            CODCAJADEP        NVARCHAR(MAX)   AS JSON, 
            CTA_BCO           VARCHAR(40)   '$.CTA_BCO' , 
            NUMEROAUTORIZA    VARCHAR(20)   '$.NUMEROAUTORIZA' , 
            NUMERODOCUMENTO   VARCHAR(20)   '$.NUMERODOCUMENTO' , 
            VALOR             DECIMAL(12,4) '$.VALOR' , 
            SUCURSAL          VARCHAR(20)   '$.SUCURSAL' , 
            CNSDOC            VARCHAR(20)   '$.CNSDOC' , 
            DESC_NUMDOCUMENTO VARCHAR(20)   '$.DESC_NUMDOCUMENTO' , 
            PAG_IDPAGARE      VARCHAR(20)   '$.PAG_IDPAGARE' , 
            NUM_CUENTA        VARCHAR(20)   '$.NUM_CUENTA' , 
            BANCODATO         NVARCHAR(MAX)   AS JSON,
            TERCERO           NVARCHAR(MAX)   AS JSON,
            TIPOPAGO          NVARCHAR(MAX)   AS JSON,
            TIPO_TERCERO      NVARCHAR(MAX)   AS JSON
           )

      SELECT @IDCJFPAEFECTIVO=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO')
      SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      SELECT @TOTAL = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )


     IF UPPER(@PROCESO) = 'INSERTAR'
     BEGIN
         IF 1=2
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'Error de prueba.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         print 'ingrese a insertar FPA'
         PRINT '@NUMERODOCUMENTO='+@NUMERODOCUMENTO

         IF @TOTAL + @VALOR > @TOTALFCJ
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El monto total de las formas de pago, supera el monto del servicio.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
			
         BEGIN TRY --NUM_CUENTA NUMERODOCUMENTO
            SELECT @CNSPCJ = NULL
				EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE,'@PCJ', @CNSPCJ OUTPUT  
				SELECT @CNSPCJ = @IDSEDE+REPLACE(SPACE(8 - LEN(@CNSPCJ))+LTRIM(RTRIM(@CNSPCJ)),SPACE(1),0)

            --IF @TIPOPAGO = '01'
            IF EXISTS(SELECT * FROM FPA WHERE FPA.FORMAPAGO = @TIPOPAGO AND FPA.FISICO = 1)
            BEGIN
               IF EXISTS (SELECT * FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TIPOPAGO = @TIPOPAGO  )
               BEGIN
                  UPDATE PCJ SET VALOR = VALOR + @VALOR WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TIPOPAGO = @TIPOPAGO
               END
               ELSE
               BEGIN
                  PRINT 'INGRESE POR PARTE 1'
                  INSERT INTO PCJ (CODCAJA, CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, NUMEROAUTORIZA,
								    FECHA, CNSACJ, IDTERCERO, IMPRESO, CODCAJADEP, CNSFACJDEP, DOCORIGEN, BANCO_DEP, CTA_BCO_DEP, CUENTA,
								    VLR_DEVUELTO, VARIOS, TRASLADADO, TRASLADO_CNSFACJ, VALORREINTEGRO)
				      SELECT @CODCAJA, @CNSPCJ, @CNSFACJ, @TIPOPAGO, @VALOR, (SELECT BANCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA), 
                        (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA), (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)
                        , @CNSDOC, @NUMERODOCUMENTO, @NUMEROAUTORIZA,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					            @CNSACJ, @TERCERO, 0, @CODCAJADEP, @CNSFACJDEP, 0, '', '', @TIPO_TERCERO, 0, 0, '', '', 0
               END
            END
            ELSE
            BEGIN
                  PRINT 'INGRESE POR ESTE LADO'
                  INSERT INTO PCJ (CODCAJA, CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, NUMEROAUTORIZA,
								    FECHA, CNSACJ, IDTERCERO, IMPRESO, CODCAJADEP, CNSFACJDEP, DOCORIGEN, BANCO_DEP, CTA_BCO_DEP, CUENTA,
								    VLR_DEVUELTO, VARIOS, TRASLADADO, TRASLADO_CNSFACJ, VALORREINTEGRO)
				      SELECT @CODCAJA, @CNSPCJ, @CNSFACJ, @TIPOPAGO, @VALOR, (SELECT BANCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA), 
                         (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA), (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)
                        ,@CNSDOC, @NUMERODOCUMENTO, @NUMEROAUTORIZA,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					          @CNSACJ, @TERCERO, 0, @CODCAJADEP, @CNSFACJDEP, 0, '', '', @TIPO_TERCERO, 0, 0, '', '', 0
            END
            PRINT '-----3----'
            IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDCJFPADESCUENT_NOMI' AND DATO = @TIPOPAGO )
		      BEGIN
               PRINT '-----4----'
			      UPDATE PCJ SET PCJ.VALOR = PRS.VLRPRESTAMO, PCJ.CNSDOC = PRS.NUMDOCUMENTO, PCJ.IDTERCERO = PRS.IDDEUDOR  
               FROM   PCJ INNER JOIN PRS ON PRS.NUMDOCUMENTO = @DESC_NUMDOCUMENTO 
               WHERE  PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
		      END
		      IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDFPAPAGARE' AND DATO = @TIPOPAGO )
		      BEGIN
               PRINT '-----5----'
			      UPDATE PCJ SET PCJ.VALOR = APAG.VALOR_NUM, PCJ.CNSDOC = APAG.IDPAGARE, PCJ.IDTERCERO = APAG.IDTERCERO  FROM PCJ INNER JOIN APAG ON APAG.IDPAGARE = @PAG_IDPAGARE WHERE   PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
		      END

         END TRY
         BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         PRINT 'ANTES DE TOTALES'
         SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @TOTAL    = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @CERRADA  = CERRADA FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
         SELECT @FALTANTE = @TOTALFCJ - @TOTAL
         SELECT 'OK' OK ,@TOTALFCJ VALORCOPAGO ,@FALTANTE VALORFALTANTE ,@TOTAL VALORPAGADO ,@CERRADA CERRADA

         RETURN
      END
     IF UPPER(@PROCESO) = 'EDITAR'
     BEGIN
        IF 1=2
        BEGIN
           INSERT INTO @TBLERRORES(ERROR) SELECT 'Editar de prueba.'
           SELECT 'KO' OK
           SELECT ERROR FROM @TBLERRORES
           RETURN
        END
        IF (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND CNSPCJ <> @CNSPCJ ) + @VALOR > @TOTALFCJ
        BEGIN
           INSERT INTO @TBLERRORES(ERROR) SELECT 'El monto total de las formas de pago, supera el monto del servicio.'
           SELECT 'KO' OK
           SELECT ERROR FROM @TBLERRORES
           RETURN
        END

        BEGIN TRY
    
           UPDATE PCJ SET    TIPOPAGO = @TIPOPAGO  ,  VALOR = @VALOR,  BANCO = (SELECT BANCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)   ,SUCURSAL  = (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA) 
                    ,CTA_BCO = (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA),  NUMERODOCUMENTO = CASE WHEN @TIPOPAGO = @IDCJFPAEFECTIVO THEN NULL ELSE  @NUMERODOCUMENTO END, NUMEROAUTORIZA = @NUMEROAUTORIZA
                    ,FECHA = DBO.FNK_FECHA_SIN_MLS(GETDATE()), CNSACJ = @CNSACJ, IDTERCERO = @TERCERO, IMPRESO = 0, CODCAJADEP = @CODCAJADEP, CNSFACJDEP = @CNSFACJDEP
                    ,CUENTA = @TIPO_TERCERO, PCJ.CNSDOC = NULL
           
           WHERE  CNSPCJ = @CNSPCJ

		     IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDCJFPADESCUENT_NOMI' AND DATO = @TIPOPAGO )
		     BEGIN
			     UPDATE PCJ SET PCJ.VALOR = PRS.VLRPRESTAMO, PCJ.CNSDOC = PRS.NUMDOCUMENTO, PCJ.IDTERCERO = PRS.IDDEUDOR  FROM PCJ INNER JOIN PRS ON PRS.NUMDOCUMENTO = @DESC_NUMDOCUMENTO WHERE   PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
	        END
	        IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDFPAPAGARE' AND DATO = @TIPOPAGO )
	        BEGIN
			     UPDATE PCJ SET PCJ.VALOR = APAG.VALOR_NUM, PCJ.CNSDOC = APAG.IDPAGARE, PCJ.IDTERCERO = APAG.IDTERCERO  FROM PCJ INNER JOIN APAG ON APAG.IDPAGARE = @PAG_IDPAGARE WHERE   PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
	        END

        END TRY
        BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
        END CATCH
        IF(SELECT COUNT(*) FROM @TBLERRORES)>0
        BEGIN
           SELECT 'KO' OK
           SELECT ERROR FROM @TBLERRORES
           RETURN
        END
        SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @TOTAL    = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @CERRADA  = CERRADA FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
         SELECT @FALTANTE = @TOTALFCJ - @TOTAL
         SELECT 'OK' OK ,@TOTALFCJ VALORCOPAGO ,@FALTANTE VALORFALTANTE ,@TOTAL VALORPAGADO ,@CERRADA CERRADA
        RETURN
     END
   END
	IF @METODO = 'CRUDFPA_2'
	BEGIN
     SELECT @AUX = DATOS FROM OPENJSON(@PARAMETROS) WITH  (DATOS NVARCHAR(MAX) AS JSON)
     
     SELECT    @PROCESO            = PROCESO ,
               @CNSFACJ            = CNSFACJ ,
               @CNSFACJDEP         = CNSFACJDEP ,
               @CNSPCJ             = CNSPCJ ,
               @CNSACJ             = CNSACJ,
               @CODCAJA            = CODCAJA ,
               @CODCAJADEP         = (SELECT VALOR FROM OPENJSON(CODCAJADEP )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @CTA_BCO            = CTA_BCO ,
               @NUMEROAUTORIZA     = NUMEROAUTORIZA ,
               @NUMERODOCUMENTO    = NUMERODOCUMENTO ,
               @NUM_CUENTA         = NUM_CUENTA ,
               @VALOR              = VALOR ,
               @SUCURSAL           = SUCURSAL ,
               @CNSDOC             = CNSDOC,
               @DESC_NUMDOCUMENTO  = DESC_NUMDOCUMENTO,
			   @PAG_IDPAGARE	   = PAG_IDPAGARE,
               @BANCODATO          = (SELECT VALOR FROM OPENJSON(BANCODATO )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @TERCERO            = (SELECT VALOR FROM OPENJSON(TERCERO )    WITH (VALOR VARCHAR(20) '$.value')) ,
               @TIPOPAGO           = (SELECT VALOR FROM OPENJSON(TIPOPAGO )    WITH (VALOR VARCHAR(20) '$.value'))  ,  
               @TIPO_TERCERO       = (SELECT VALOR FROM OPENJSON(TIPO_TERCERO )    WITH (VALOR VARCHAR(20) '$.value'))  
      FROM OPENJSON(@AUX) 
      WITH (	
            PROCESO           VARCHAR(30)   '$.PROCESO' ,
            CNSFACJ           VARCHAR(20)   '$.CNSFACJ' , 
            CNSFACJDEP        VARCHAR(50)   '$.CNSFACJDEP' , 
            CNSPCJ            VARCHAR(20)   '$.CNSPCJ' , 
            CNSACJ            VARCHAR(20)   '$.CNSACJ' , 
            CODCAJA           VARCHAR(10)   '$.CODCAJA' , 
            CODCAJADEP        NVARCHAR(MAX)   AS JSON, 
            CTA_BCO           VARCHAR(40)   '$.CTA_BCO' , 
            NUMEROAUTORIZA    VARCHAR(20)   '$.NUMEROAUTORIZA' , 
            NUMERODOCUMENTO   VARCHAR(20)   '$.NUMERODOCUMENTO' , 
            VALOR             DECIMAL(12,4) '$.VALOR' , 
            SUCURSAL          VARCHAR(20)   '$.SUCURSAL' , 
            CNSDOC            VARCHAR(20)   '$.CNSDOC' , 
            DESC_NUMDOCUMENTO VARCHAR(20)   '$.DESC_NUMDOCUMENTO' , 
            PAG_IDPAGARE      VARCHAR(20)   '$.PAG_IDPAGARE' , 
            NUM_CUENTA        VARCHAR(20)   '$.NUM_CUENTA' , 
            BANCODATO         NVARCHAR(MAX)   AS JSON,
            TERCERO           NVARCHAR(MAX)   AS JSON,
            TIPOPAGO          NVARCHAR(MAX)   AS JSON,
            TIPO_TERCERO      NVARCHAR(MAX)   AS JSON
           )



     IF UPPER(@PROCESO) = 'INSERTAR'
     BEGIN
		IF DBO.FNK_VALORVARIABLE('IDCJTECXP') = (SELECT TIPOEGRESO FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ)
		BEGIN
			DECLARE @VALOR_FCJD DECIMAL(14,2), @VALOR_PCJ DECIMAL(14,2)
			SELECT @VALOR_FCJD = VALORUNITARIO FROM FCJD WHERE  FCJD.CNSFACJ = @CNSFACJ AND FCJD.CODCAJA = @CODCAJA
			SELECT @VALOR_PCJ = COALESCE((SELECT SUM(VALOR) FROM PCJ WHERE  PCJ.CNSFACJ = @CNSFACJ AND PCJ.CODCAJA = @CODCAJA),0)
			IF @VALOR_FCJD < @VALOR_PCJ+@VALOR
			BEGIN
				INSERT INTO @TBLERRORES(ERROR) SELECT 'El monto es mayor al monto a pagar.'
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
				RETURN
			END
		END
		IF 1=2
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'Error de prueba.'
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		print 'ingrese a insertar FPA'
		PRINT '@NUMERODOCUMENTO='+@NUMERODOCUMENTO

       
			
         BEGIN TRY --NUM_CUENTA NUMERODOCUMENTO
            SELECT @CNSPCJ = NULL
				EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE,'@PCJ', @CNSPCJ OUTPUT  
				SELECT @CNSPCJ = @IDSEDE+REPLACE(SPACE(8 - LEN(@CNSPCJ))+LTRIM(RTRIM(@CNSPCJ)),SPACE(1),0)

            --IF @TIPOPAGO = '01'
            IF EXISTS(SELECT * FROM FPA WHERE FPA.FORMAPAGO = @TIPOPAGO AND FPA.FISICO = 1)
            BEGIN
               IF EXISTS (SELECT * FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TIPOPAGO = @TIPOPAGO  )
               BEGIN
                  UPDATE PCJ SET VALOR = VALOR + @VALOR WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TIPOPAGO = @TIPOPAGO
               END
               ELSE
               BEGIN
                  PRINT 'INGRESE POR PARTE 1'
                  INSERT INTO PCJ (CODCAJA, CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, NUMEROAUTORIZA,
								    FECHA, CNSACJ, IDTERCERO, IMPRESO, CODCAJADEP, CNSFACJDEP, DOCORIGEN, BANCO_DEP, CTA_BCO_DEP, CUENTA,
								    VLR_DEVUELTO, VARIOS, TRASLADADO, TRASLADO_CNSFACJ, VALORREINTEGRO)
				      SELECT @CODCAJA, @CNSPCJ, @CNSFACJ, @TIPOPAGO, @VALOR, (SELECT BANCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA), 
                        (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA), (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)
                        , @CNSDOC, @NUMERODOCUMENTO, @NUMEROAUTORIZA,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					            @CNSACJ, @TERCERO, 0, @CODCAJADEP, @CNSFACJDEP, 0, '', '', @TIPO_TERCERO, 0, 0, '', '', 0
               END
            END
            ELSE
            BEGIN
                  PRINT 'INGRESE POR ESTE LADO'
                  INSERT INTO PCJ (CODCAJA, CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, NUMEROAUTORIZA,
								    FECHA, CNSACJ, IDTERCERO, IMPRESO, CODCAJADEP, CNSFACJDEP, DOCORIGEN, BANCO_DEP, CTA_BCO_DEP, CUENTA,
								    VLR_DEVUELTO, VARIOS, TRASLADADO, TRASLADO_CNSFACJ, VALORREINTEGRO)
				      SELECT @CODCAJA, @CNSPCJ, @CNSFACJ, @TIPOPAGO, @VALOR, (SELECT BANCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA), 
                         (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA), (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)
                        ,@CNSDOC, @NUMERODOCUMENTO, @NUMEROAUTORIZA,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
					          @CNSACJ, @TERCERO, 0, @CODCAJADEP, @CNSFACJDEP, 0, '', '', @TIPO_TERCERO, 0, 0, '', '', 0
            END
            PRINT '-----3----'
			IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDCJFPADESCUENT_NOMI' AND DATO = @TIPOPAGO )
			BEGIN
			PRINT '-----4----'
				UPDATE PCJ SET PCJ.VALOR = PRS.VLRPRESTAMO, PCJ.CNSDOC = PRS.NUMDOCUMENTO, PCJ.IDTERCERO = PRS.IDDEUDOR  
			FROM   PCJ INNER JOIN PRS ON PRS.NUMDOCUMENTO = @DESC_NUMDOCUMENTO 
			WHERE  PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
			END
			IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDFPAPAGARE' AND DATO = @TIPOPAGO )
			BEGIN
			PRINT '-----5----'
				UPDATE PCJ SET PCJ.VALOR = APAG.VALOR_NUM, PCJ.CNSDOC = APAG.IDPAGARE, PCJ.IDTERCERO = APAG.IDTERCERO  FROM PCJ INNER JOIN APAG ON APAG.IDPAGARE = @PAG_IDPAGARE WHERE   PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
			END
			IF DBO.FNK_VALORVARIABLE('IDCJTECXP') <> (SELECT TIPOEGRESO FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
				AND NOT EXISTS (SELECT  * FROM CAJ WHERE CAJ.CODCAJA = @CODCAJA AND CAJ.CLASE ='Menor')
			BEGIN
				UPDATE FCJ SET VALORTOTAL = (SELECT  SUM (PCJ.VALOR) FROM PCJ WHERE PCJ.CNSFACJ = @CNSFACJ AND PCJ.CODCAJA = @CODCAJA ) WHERE FCJ.CNSFACJ = @CNSFACJ AND FCJ.CODCAJA = @CODCAJA
				UPDATE FCJD SET VALORUNITARIO = (SELECT  SUM (PCJ.VALOR) FROM PCJ WHERE PCJ.CNSFACJ = @CNSFACJ AND PCJ.CODCAJA = @CODCAJA ), VALORTOTAL = FCJD.CANTIDAD* (SELECT  SUM (PCJ.VALOR) FROM PCJ WHERE PCJ.CNSFACJ = @CNSFACJ AND PCJ.CODCAJA = @CODCAJA ) WHERE FCJD.CNSFACJ = @CNSFACJ AND FCJD.CODCAJA = @CODCAJA
			END

         END TRY
         BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         PRINT 'ANTES DE TOTALES'
         SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @TOTAL    = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @CERRADA  = CERRADA FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
         SELECT @FALTANTE = @TOTALFCJ - @TOTAL
         SELECT 'OK' OK ,@TOTALFCJ VALORCOPAGO ,@FALTANTE VALORFALTANTE ,@TOTAL VALORPAGADO ,@CERRADA CERRADA

         RETURN
      END
     IF UPPER(@PROCESO) = 'EDITAR'
     BEGIN
        IF 1=2
        BEGIN
           INSERT INTO @TBLERRORES(ERROR) SELECT 'Editar de prueba.'
           SELECT 'KO' OK
           SELECT ERROR FROM @TBLERRORES
           RETURN
        END
        IF (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND CNSPCJ <> @CNSPCJ ) + @VALOR > @TOTALFCJ
        BEGIN
           INSERT INTO @TBLERRORES(ERROR) SELECT 'El monto total de las formas de pago, supera el monto del servicio.'
           SELECT 'KO' OK
           SELECT ERROR FROM @TBLERRORES
           RETURN
        END

        BEGIN TRY
    
           UPDATE PCJ SET    TIPOPAGO = @TIPOPAGO  ,  VALOR = @VALOR,  BANCO = (SELECT BANCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA)   ,SUCURSAL  = (SELECT SUCURSAL FROM BCT WHERE CTA_BCO = @NUM_CUENTA) 
                    ,CTA_BCO = (SELECT CTA_BCO FROM BCT WHERE CTA_BCO = @NUM_CUENTA),  NUMERODOCUMENTO = CASE WHEN @TIPOPAGO = @IDCJFPAEFECTIVO THEN NULL ELSE  @NUMERODOCUMENTO END, NUMEROAUTORIZA = @NUMEROAUTORIZA
                    ,FECHA = DBO.FNK_FECHA_SIN_MLS(GETDATE()), CNSACJ = @CNSACJ, IDTERCERO = @TERCERO, IMPRESO = 0, CODCAJADEP = @CODCAJADEP, CNSFACJDEP = @CNSFACJDEP
                    ,CUENTA = @TIPO_TERCERO, PCJ.CNSDOC = NULL
           
           WHERE  CNSPCJ = @CNSPCJ

		     IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDCJFPADESCUENT_NOMI' AND DATO = @TIPOPAGO )
		     BEGIN
			     UPDATE PCJ SET PCJ.VALOR = PRS.VLRPRESTAMO, PCJ.CNSDOC = PRS.NUMDOCUMENTO, PCJ.IDTERCERO = PRS.IDDEUDOR  FROM PCJ INNER JOIN PRS ON PRS.NUMDOCUMENTO = @DESC_NUMDOCUMENTO WHERE   PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
	        END
	        IF EXISTS (SELECT * FROM USVGS WHERE  IDVARIABLE = 'IDFPAPAGARE' AND DATO = @TIPOPAGO )
	        BEGIN
			     UPDATE PCJ SET PCJ.VALOR = APAG.VALOR_NUM, PCJ.CNSDOC = APAG.IDPAGARE, PCJ.IDTERCERO = APAG.IDTERCERO  FROM PCJ INNER JOIN APAG ON APAG.IDPAGARE = @PAG_IDPAGARE WHERE   PCJ.CNSPCJ = @CNSPCJ AND PCJ.CODCAJA = @CODCAJA AND PCJ.TIPOPAGO = @TIPOPAGO
	        END

        END TRY
        BEGIN CATCH
           INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
        END CATCH
        IF(SELECT COUNT(*) FROM @TBLERRORES)>0
        BEGIN
           SELECT 'KO' OK
           SELECT ERROR FROM @TBLERRORES
           RETURN
        END
        SELECT @TOTALFCJ = (SELECT COALESCE(SUM(VALORTOTAL),0) FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @TOTAL    = (SELECT COALESCE( SUM(VALOR),0) FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
         SELECT @CERRADA  = CERRADA FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ 
         SELECT @FALTANTE = @TOTALFCJ - @TOTAL
         SELECT 'OK' OK ,@TOTALFCJ VALORCOPAGO ,@FALTANTE VALORFALTANTE ,@TOTAL VALORPAGADO ,@CERRADA CERRADA
        RETURN
     END
   END
   IF @METODO = 'DATOS'
	BEGIN
		PRINT 'INGRESE DATOS'
		SELECT @PROCESO = PROCESO
		FROM OPENJSON(@PARAMETROS) 
		WITH (	
			PROCESO            VARCHAR(20)  '$.PROCESO'
			)
		IF @PROCESO = 'TIPO_PAGO'
		BEGIN
			SELECT 'OK' OK
		      --SELECT FORMAPAGO value, DESCRIPCION label, FISICO, REQBCO, REQDOC, REQAUT, CXC, AUTINT, MEDIOPAGO, TEDEVOLUCION, CEROENAPERTURA, USAR_CUENTACAJA, REQCTA_BCO_DEP, GENCHEQUE, COMPROBANTE_EGR, DATAFONO
		      --FROM FPA 
            SELECT CODIGO  value, DESCRIPCION label, TABLA, CAMPO FROM TGEN WHERE  CAMPO = 'FORMAPAGO'  
			RETURN
		END

		RETURN
	END
   IF @METODO = 'DEVOLVER_RECIBO_CAJA'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' 

      )
     
       IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO = 'A' ) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo se encuentra Anulado.'
      END
      IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO = 'D' ) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo se encuentra desechado.'
      END
      IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND CERRADA = 1 ) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo se encuentra recaudado.'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY

            EXEC SPK_DEVUELVERECIB_CAJA @CODCAJA,@CNSFACJ,@COMPANIA,@IDSEDE

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
    END
   END
   IF @METODO = 'VALIDA_ANULAR_RECIBO_CAJA'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ ,@CLASE_FAC = CLASE_FAC
      FROM OPENJSON(@PARAMETROS)WITH(
	      CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	      CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	      CNSACJ      VARCHAR(20)    '$.CNSACJ'   ,
         CLASE_FAC   VARCHAR(5)     '$.CLASE_FAC '  
      )
      --Validaciones Generales
      IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.CERRADA = 0 ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular un Recibo sin Confirmar.'
 	   IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO = 'A' ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo se encuentra anulado.'
	   IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO = 'D' ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular un recibo desecho...'
	   IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.DEAPERTURA = 1 ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular un recibo de Apertura...'
      IF (SELECT ABIERTA FROM ACJ WHERE CNSACJ = @CNSACJ) = 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular este recibo por que la Apertura de creacion se encuentra cerrada!...'
      IF(SELECT FCJ.TIPOEGRESO FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ) = TRIM(DBO.FNK_VALORVARIABLE('IDCJTETRASLADO'))
          INSERT INTO @TBLERRORES(ERROR) SELECT '<<< ANULAR RECIBO: Los Traslados entre Cajas No Pueden Anular... >>>'      
      IF TRIM(DBO.FNK_VALORVARIABLE('CAJCONCEPTNOANULABLE'))<>''
      BEGIN
         IF (SELECT COUNT(*) FROM FCJD WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND CONCEPTO IN (TRIM(DBO.FNK_VALORVARIABLE('CAJCONCEPTNOANULABLE'))))> 0
            INSERT INTO @TBLERRORES(ERROR) 
            SELECT '<<< Error: Este Recibo contiene Conceptos que no pueden ser Anulados.|Consulte al Administrador del Sistema. >>>'
      END
      
      IF @CLASE_FAC = 'COBRO'
      BEGIN
	      IF NOT EXISTS (SELECT * FROM USGRUH WHERE IDPROCEDIMIENTO = 'BrwCaja' AND GRUPO = @GRUPO AND IDCONTROL = 'btn_eliminar' AND PERMISO = 1  ) 
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No cuenta con permisos para anular.'
	      IF (SELECT COUNT(*) FROM  CIT WHERE CONSECUTIVO = (SELECT NOADMISION FROM FCJ WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND PROCEDENCIA = 'CITAS') AND CIT.FACTURADA = 1 ) > 0
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular, la cita se encuentra Facturada.'

         IF UPPER(DBO.FNK_VALORVARIABLE('MAN_RELRECIBOSFCJ')) = 'SI' 
         BEGIN
            IF (SELECT TOP 1 COALESCE(TRASLADO_CNSFACJ,'') FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TRASLADADO = '1' AND TRASLADO_CNSFACJ <> '') <> ''
            BEGIN
               SELECT TOP 1 @TRASLADO_CNSFACJ = COALESCE(TRASLADO_CNSFACJ,'') FROM PCJ 
               WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TRASLADADO = '1' AND TRASLADO_CNSFACJ <> ''
               INSERT INTO @TBLERRORES(ERROR) 
               SELECT '<<< Error: ¡No se puede Anular porque se encuentra relacionado en el traslado entre Cajas número ( '+@TRASLADO_CNSFACJ+ ' )!. >>>'
            END
         END


      END
      ELSE IF @CLASE_FAC = 'PAGO'
      BEGIN
         PRINT 'PAGO'
         IF NOT EXISTS (SELECT * FROM USGRUH WHERE IDPROCEDIMIENTO = 'BrwCaja' AND GRUPO = @GRUPO AND IDCONTROL = 'Anular' AND PERMISO = 1  ) 
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No cuenta con permisos para anular.'

         SELECT @CERRADO_PRI = COALESCE(PRI.CERRADO,0), @ESTADO_MCP = MCP.ESTADO, @CNSRESOL_FCJ = COALESCE(FCJ.CNSRESOL,''), @N_FACTURA_FCJ = COALESCE(FCJ.N_FACTURA,'')
         FROM   FCJ LEFT JOIN MCP ON FCJ.NROCOMPROBANTE = MCP.NROCOMPROBANTE 
                    LEFT JOIN PRI ON MCP.ANO = PRI.ANO 
                                 AND MCP.MES = PRI.MES
         WHERE  FCJ.CODCAJA = @CODCAJA  AND FCJ.CNSFACJ = @CNSFACJ
         IF @CERRADO_PRI = 1
            INSERT INTO @TBLERRORES(ERROR) 
            SELECT '<<< ANULAR: No se puede anular periodo contable cerrado... >>>'
         ELSE
         BEGIN
            IF @CNSRESOL_FCJ <> '' AND @N_FACTURA_FCJ <> '' AND DBO.FNK_VALORVARIABLE('IDNOTA_ANULAFCJDS') = ''
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) 
               SELECT '<<< ANULAR: Este egreso corresponde a un Documento Soporte, Debe configurar variable IDNOTA_ANULAFCJDS inicialmente... >>>'  
            END
         END
      END
	  
      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         SELECT 'OK' OK
         RETURN
      END
   END
   IF @METODO = 'ANULAR_RECIBO_CAJA'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ, @CAUSA = CAUSA, @OBSERVCION = OBSERVACION
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)     '$.CNSACJ' ,
	   CAUSA     VARCHAR(20)      '$.CAUSA' ,
	   OBSERVACION     VARCHAR(200)    '$.OBSERVACION' 
      )
      SELECT @NROCOMPROBANTE = NROCOMPROBANTE, @CLASE_FAC = CLASE_FAC ,@CONTABILIZADA_FCJ = CONTABILIZADA FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
      SELECT @ESTADO_MCP     = ESTADO ,@ANOMES_MCP = ANOMES FROM MCP WHERE NROCOMPROBANTE = @NROCOMPROBANTE
      SELECT @CERRADO_PRI    = CERRADO FROM  PRI WHERE ANOMES = @ANOMES_MCP
      SELECT @CLASE_CAJ = CLASE FROM CAJ WHERE CODCAJA = @CODCAJA
      --Validaciones Generales
      IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.CERRADA = 0 ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular un Recibo sin Confirmar.'
 	   IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO = 'A' ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo se encuentra anulado.'
	   IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO = 'D' ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular un recibo desecho...'
	   IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.DEAPERTURA = 1 ) > 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular un recibo de Apertura...'
      IF (SELECT ABIERTA FROM ACJ WHERE CNSACJ = @CNSACJ) = 0
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular este recibo por que la Apertura de creacion se encuentra cerrada!...'
      IF(SELECT FCJ.TIPOEGRESO FROM FCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ) = TRIM(DBO.FNK_VALORVARIABLE('IDCJTETRASLADO'))
          INSERT INTO @TBLERRORES(ERROR) SELECT '<<< ANULAR RECIBO: Los Traslados entre Cajas No Pueden Anular... >>>'      
      IF TRIM(DBO.FNK_VALORVARIABLE('CAJCONCEPTNOANULABLE'))<>''
      BEGIN
         IF (SELECT COUNT(*) FROM FCJD WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND CONCEPTO IN (TRIM(DBO.FNK_VALORVARIABLE('CAJCONCEPTNOANULABLE'))))> 0
            INSERT INTO @TBLERRORES(ERROR) 
            SELECT '<<< Error: Este Recibo contiene Conceptos que no pueden ser Anulados.|Consulte al Administrador del Sistema. >>>'
      END
      
      IF @CLASE_FAC = 'COBRO'
      BEGIN
	      IF NOT EXISTS (SELECT * FROM USGRUH WHERE IDPROCEDIMIENTO = 'BrwCaja' AND GRUPO = @GRUPO AND IDCONTROL = 'btn_eliminar' AND PERMISO = 1  ) 
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No cuenta con permisos para anular.'
	      IF (SELECT COUNT(*) FROM  CIT WHERE CONSECUTIVO = (SELECT NOADMISION FROM FCJ WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND PROCEDENCIA = 'CITAS') AND CIT.FACTURADA = 1 ) > 0
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede anular, la cita se encuentra Facturada.'

         IF UPPER(DBO.FNK_VALORVARIABLE('MAN_RELRECIBOSFCJ')) = 'SI' 
         BEGIN
            IF (SELECT TOP 1 COALESCE(TRASLADO_CNSFACJ,'') FROM PCJ WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TRASLADADO = '1' AND TRASLADO_CNSFACJ <> '') <> ''
            BEGIN
               SELECT TOP 1 @TRASLADO_CNSFACJ = COALESCE(TRASLADO_CNSFACJ,'') FROM PCJ 
               WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ AND TRASLADADO = '1' AND TRASLADO_CNSFACJ <> ''
               INSERT INTO @TBLERRORES(ERROR) 
               SELECT '<<< Error: ¡No se puede Anular porque se encuentra relacionado en el traslado entre Cajas número ( '+@TRASLADO_CNSFACJ+ ' )!. >>>'
            END
         END
         PRINT 'Valido valores'
         DECLARE @SALDOS BIT = 0
         DECLARE PCJ_CURSOR CURSOR FOR 
         SELECT TIPOPAGO,SUM(VALOR)  
         FROM  PCJ INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO
         WHERE PCJ.CODCAJA = @CODCAJA 
         AND   PCJ.CNSACJ  = @CNSACJ 
         AND   PCJ.CNSFACJ = @CNSFACJ
         AND   COALESCE(FPA.FISICO,0)=1
         GROUP BY TIPOPAGO
         OPEN PCJ_CURSOR    
         FETCH NEXT FROM PCJ_CURSOR    
         INTO @TIPOPAGO,@VALOR
         WHILE @@FETCH_STATUS = 0    
         BEGIN 
            IF EXISTS(SELECT * FROM CAJR WHERE  CAJR.CODCAJA = @CODCAJA AND COALESCE(VALOR,0) <=0)
            BEGIN
               SELECT @SALDOS = 0
               BREAK
            END
            IF EXISTS (SELECT * FROM CAJR WHERE  CAJR.CODCAJA = @CODCAJA 
            AND FORMAPAGO=@TIPOPAGO
            AND (VALOR - @VALOR) >= 0) 
            BEGIN
               SELECT @SALDOS =1
            END
            ELSE 
            BEGIN
               SELECT @SALDOS = 0
               BREAK
            END
            FETCH NEXT FROM PCJ_CURSOR    
            INTO @TIPOPAGO,@VALOR
         END
         CLOSE PCJ_CURSOR
         DEALLOCATE PCJ_CURSOR
         IF @SALDOS = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) 
            SELECT '<<< ANULAR: Saldos Insuficientes No se puede Continuar... >>>'
         END
      END
      ELSE IF @CLASE_FAC = 'PAGO'
      BEGIN
         PRINT 'PAGO'
         IF NOT EXISTS (SELECT * FROM USGRUH WHERE IDPROCEDIMIENTO = 'BrwCaja' AND GRUPO = @GRUPO AND IDCONTROL = 'Anular' AND PERMISO = 1  ) 
            INSERT INTO @TBLERRORES(ERROR) SELECT 'No cuenta con permisos para anular.'

         SELECT @CERRADO_PRI = COALESCE(PRI.CERRADO,0), @ESTADO_MCP = MCP.ESTADO, @CNSRESOL_FCJ = COALESCE(FCJ.CNSRESOL,''), @N_FACTURA_FCJ = COALESCE(FCJ.N_FACTURA,'')
         FROM   FCJ LEFT JOIN MCP ON FCJ.NROCOMPROBANTE = MCP.NROCOMPROBANTE 
                    LEFT JOIN PRI ON MCP.ANO = PRI.ANO 
                                 AND MCP.MES = PRI.MES
         WHERE  FCJ.CODCAJA = @CODCAJA  AND FCJ.CNSFACJ = @CNSFACJ
         IF @CERRADO_PRI = 1
            INSERT INTO @TBLERRORES(ERROR) 
            SELECT '<<< ANULAR: No se puede anular periodo contable cerrado... >>>'
         ELSE
         BEGIN
            IF @CNSRESOL_FCJ <> '' AND @N_FACTURA_FCJ <> '' AND DBO.FNK_VALORVARIABLE('IDNOTA_ANULAFCJDS') = ''
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) 
               SELECT '<<< ANULAR: Este egreso corresponde a un Documento Soporte, Debe configurar variable IDNOTA_ANULAFCJDS inicialmente... >>>'  
            END
         END
      END


      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            EXEC SPK_ANULARECIBO_CAJA @CODCAJA, @CNSFACJ, @USUARIO

            IF @CLASE_FAC = 'COBRO'
            BEGIN
               IF @ESTADO_MCP = 2
               BEGIN
                  IF @CERRADO_PRI = 1
                  BEGIN
                     EXEC SPK_REVERSAR_MCP @NROCOMPROBANTE , @CNSFACJ , 'REVCAJAING', @CODCAJA, @CNSFACJ ,'01',@IDSEDE,@USUARIO,@SYS_COMPUTERNAME,''
                  END
                  ELSE
                  BEGIN
                     UPDATE MCP SET ANULADO=1 WHERE NROCOMPROBANTE=@NROCOMPROBANTE
                  END
               END
               ELSE
               BEGIN
                  EXEC SPK_CONTAB_CAJA_ING @CNSFACJ,@CODCAJA,@USUARIO,@SYS_COMPUTERNAME,'01',@IDSEDE,@NROCOMPROBANTE
                  SELECT @CONTABILIZADA_FCJ = CONTABILIZADA FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
               END
               IF @CONTABILIZADA_FCJ = 2
               BEGIN
                  DELETE MCHE WHERE NROCOMPROBANTE = @NROCOMPROBANTE
                  DELETE MCPE WHERE NROCOMPROBANTE = @NROCOMPROBANTE
               END
            END
            ELSE IF @CLASE_FAC= 'PAGO'
            BEGIN
               IF @CLASE_CAJ <> 'Menor'
               BEGIN
                  IF @ESTADO_MCP = 2
                  BEGIN
                     IF @CERRADO_PRI = 1
                     BEGIN
                        EXEC SPK_REVERSAR_MCP @NROCOMPROBANTE,@CNSFACJ,'REVCAJAEGR',@CODCAJA,@CNSFACJ,'01',@IDSEDE,@USUARIO,@SYS_COMPUTERNAME,''
                        --Message('Se ha Generado un Comprobante de reversión para éste Egreso','Reversión',icon:asterisk)
                     END
                     ELSE
                     BEGIN
                        UPDATE MCP SET ANULADO=1 WHERE NROCOMPROBANTE=@NROCOMPROBANTE
                        EXEC SPK_CONTAB_CAJA_ING @CNSFACJ,@CODCAJA,@USUARIO,@SYS_COMPUTERNAME,'01',@IDSEDE,@NROCOMPROBANTE
                     END
                  END
                  ELSE
                  BEGIN
                     EXEC SPK_CONTAB_CAJA_EGR @CNSFACJ,@CODCAJA,@USUARIO,@SYS_COMPUTERNAME,'01',@IDSEDE,@NROCOMPROBANTE
                     SELECT @CONTABILIZADA_FCJ = CONTABILIZADA FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
                  END
                  IF @CONTABILIZADA_FCJ = 2
                  BEGIN
                     DELETE MCHE WHERE NROCOMPROBANTE=@NROCOMPROBANTE
                     DELETE MCPE WHERE NROCOMPROBANTE=@NROCOMPROBANTE
                  END
               END
               ELSE
               BEGIN
                  INSERT INTO @TBLERRORES(ERROR) 
                  SELECT 'En las Cajas Menores no se Contabiliza la Anulacion'
               END
            END
            ELSE
            BEGIN
               INSERT INTO @TBLERRORES(ERROR) 
               SELECT 'No es ni COBRO ni PAGO el tipo de Recibo'
            END

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         UPDATE FCJ SET FECHAANU = DBO.FNK_FECHA_SIN_MLS(GETDATE()), IDCAUSALANUL = @CAUSA, DETALLEANULACION = @OBSERVCION, 
                        SYS_COMPUTERNAMEANUL = @SYS_COMPUTERNAME ,USUARIOANUL = @USUARIO  
         WHERE FCJ.CODCAJA = @CODCAJA 
         AND   FCJ.CNSACJ  = @CNSACJ 
         AND   FCJ.CNSFACJ = @CNSFACJ
         PRINT 'Actualizo CAJR.....'

         DECLARE CAJ_CURSOR CURSOR FOR 
         SELECT TIPOPAGO,SUM(VALOR)  FROM  PCJ INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO
         WHERE PCJ.CODCAJA = @CODCAJA 
         AND   PCJ.CNSACJ  = @CNSACJ 
         AND   PCJ.CNSFACJ = @CNSFACJ
         AND   COALESCE(FPA.FISICO,0)=1
         GROUP BY TIPOPAGO
         OPEN CAJ_CURSOR    
         FETCH NEXT FROM CAJ_CURSOR    
         INTO @TIPOPAGO,@VALOR
         WHILE @@FETCH_STATUS = 0    
         BEGIN 
            IF @CLASE_FAC = 'COBRO'
            BEGIN
               UPDATE CAJR SET VALOR = VALOR - @VALOR 
               WHERE  CAJR.CODCAJA = @CODCAJA 
               AND FORMAPAGO=@TIPOPAGO  
            END
            ELSE
            BEGIN
               UPDATE CAJR SET VALOR = VALOR + @VALOR 
               WHERE  CAJR.CODCAJA = @CODCAJA 
               AND FORMAPAGO=@TIPOPAGO 
            END
            FETCH NEXT FROM CAJ_CURSOR    
            INTO @TIPOPAGO,@VALOR
         END
         CLOSE CAJ_CURSOR
         DEALLOCATE CAJ_CURSOR
         /* Ta loco
         UPDATE CAJR SET VALOR = VALOR - (SELECT SUM(VALOR) FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ) 
         WHERE  CAJR.CODCAJA = @CODCAJA 
         AND    CAJR.FORMAPAGO IN (SELECT TIPOPAGO FROM PCJ WHERE  CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ)  
         */
         SELECT 'OK' OK
    END
   END
   IF @METODO = 'ARCHIVAR_FCJ'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' 

      )
     
      IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO NOT IN ('D') ) > 0
      BEGIN
          IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND  FCJ.ESTADO = 'P' AND FCJ.CERRADA <> 1)  > 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo debe de estar desechado o confirmado.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
			   RETURN
         END
      END
      IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND  FCJ.ESTADO = 'P' AND FCJ.CERRADA <> 1)  > 0
      BEGIN
         IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND FCJ.ESTADO NOT IN ('D') ) > 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo debe de estar desechado o confirmado.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
			   RETURN
         END
      END
         BEGIN TRY

           UPDATE FCJ SET ARCHIVADO = 1 WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
   END
--QUERY 3
   IF @METODO = 'ACTIVAR_FCJ'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' 

      )
     
          IF (SELECT COUNT(*) FROM  FCJ WHERE CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ AND CNSFACJ = @CNSFACJ AND  FCJ.ESTADO = 'P' AND FCJ.ARCHIVADO <> 1 ) > 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo no se encuentra archivado.'
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
			   RETURN
         END
    
         BEGIN TRY

           UPDATE FCJ SET ARCHIVADO = NULL WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
   END
   IF @METODO = 'CONFIRMAR_RECIBO_EGRESO'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' 
      )
      SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO,@IDSEDE=COALESCE(UBEQ.IDSEDE,USUSU.IDSEDE),@COMPANIA=COALESCE(UBEQ.COMPANIA,USUSU.COMPANIA)  FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO
      SELECT @TOTAL = VALORTOTAL, @N_FACTURA = N_FACTURA, @IDAFILIADO = IDAFILIADO, @PROCEDENCIA = PROCEDENCIA,
             @IDTERCERO = IDTERCERO, @ESTADO= ESTADO, @FECHAFCJ = FECHA, @NOADMISION = NOADMISION FROM FCJ WHERE  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ

      IF (SELECT COALESCE(SUM (VALOR),0) FROM PCJ WHERE PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ ) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo no tiene detalles de pago.'
      END
      IF  (SELECT COALESCE(SUM (VALOR),0) FROM PCJ WHERE PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ ) > 0
      BEGIN
         IF (SELECT COALESCE(SUM (VALOR),0) FROM PCJ WHERE PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ ) <>  @TOTAL
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El valor del detalle de pago, es diferente al valor del Recibo'
         END
      END
      IF @FECHAFCJ > GETDATE()
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La fecha del recibo es mayor a la fecha actual'
      END
      IF (SELECT CASE WHEN EXISTS(SELECT * FROM PRI WHERE FECHA_INI<=FCJ.FECHA AND FECHA_FIN>FCJ.FECHA AND CERRADO=0) THEN 'OK' ELSE 'ERROR' END FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ) <>'OK'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El periodo contable esta cerrado'
      END
      IF (SELECT CERRADA FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ ) = 1
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo ya se encuentra confirmado'
      END
      IF (SELECT ESTADO FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ ) = 'D'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede Confirmar un Recibo Desecho.'
      END
      IF (SELECT ESTADO FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ ) = 'A'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede Confirmar un Recibo Anulado.'
      END
      IF @TOTAL<=0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede Confirmar un Recibo Con Valor Cero (0).'
      END
      IF (SELECT COUNT(1) FROM MCP WHERE PROCEDENCIA='CAJA' AND   REFERENCIA2 = @CODCAJA AND REFERENCIA1 = @CNSFACJ   AND COALESCE(ANULADO,0)=0) <> 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Este recibo ya se encuentra Contabilizado, posible duplicidad, por favor comuniquese con el Dpto de Tecnologia.'
      END
      IF @PROCEDENCIA = 'CITAS'
      BEGIN
         IF (SELECT COUNT(1)  FROM CIT WHERE  CONSECUTIVO = @NOADMISION AND IDAFILIADO = @IDAFILIADO    ) = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La cita fue cancelada, no se puede confirmar.'
         END
      END
      IF @PROCEDENCIA = 'CE'
      BEGIN
         IF (SELECT ESTADO  FROM AUT WHERE  NOAUT  = @NOADMISION AND  @PROCEDENCIA = 'CE' ) = 'Anulada'
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La cita fue anulada, no se puede confirmar.'
         END
      END
      IF (SELECT COUNT(1) FROM  ACJ WHERE  CODCAJA = @CODCAJA AND ABIERTA = 1 ) >1
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja se encuentra abierta mas de una vez.'
      END
      IF (SELECT COUNT(1) FROM  ACJ WHERE  CODCAJA = @CODCAJA AND ABIERTA = 1 ) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja no se encuentra abierta.'
      END
      IF (SELECT CASE WHEN EXISTS(SELECT * FROM PRI WHERE FECHA_INI<=FCJ.FECHA AND FECHA_FIN>FCJ.FECHA AND CERRADO=0) THEN 'OK' ELSE 'ERROR' END FROM FCJ WHERE CNSFACJ=@CNSFACJ AND CODCAJA=@CODCAJA) = 'ERROR'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No Existe periodo Contable o Esta Cerrado NO SE Puede Confirmar  este Comprobante.'
      END
      IF (SELECT DATEDIFF(MINUTE,DBO.FNK_FECHA_SIN_MLS(GETDATE()),FCJ.FECHA)    FROM FCJ WHERE CNSFACJ=@CNSFACJ AND CODCAJA=@CODCAJA ) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Fecha/Hora de Recibo Mayor a la Fecha del Sistema.'
      END
      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            EXEC SPK_CIERRERECIBO_CAJA @CODCAJA, @CNSFACJ, @COMPANIA, @IDSEDE, @USUARIO, @SYS_COMPUTERNAME
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
    END
    BEGIN TRY
		 
		 PRINT 'VOY A CONTABILZIAR'
		 PRINT 'EXEC SPK_NC_CONTAB_CAJA_EGR '''+@CNSFACJ+''','''+@CODCAJA+''','''+@USUARIO+''','''+@SYS_COMPUTERNAME+''','''+@COMPANIA +''','''+@IDSEDE+''','''''
		 EXEC SPK_NC_CONTAB_CAJA_EGR @CNSFACJ, @CODCAJA, @USUARIO, @SYS_COMPUTERNAME, @COMPANIA, @IDSEDE, ''

         UPDATE FCJ SET CERRADA = 1 WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA AND CNSACJ = @CNSACJ
      END TRY
      BEGIN CATCH
         INSERT INTO @TBLERRORES(ERROR) 
         SELECT ERROR_MESSAGE()
      END CATCH
      IF(SELECT COUNT(*) FROM @TBLERRORES)>0
      BEGIN
         SELECT 'KO' OK 
         SELECT ERROR FROM @TBLERRORES
         RETURN
      END
         SELECT 'OK' OK
      RETURN
   END
   IF @METODO = 'CONFIRMAR_RECIBO'
	BEGIN
      SELECT @CNSFACJ = CNSFACJ, @CODCAJA = CODCAJA, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' ,
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' 
      )
      SELECT @CNSACJ =  CAJ.CNSACJ, @CODCAJERO = USUSU.CODCAJERO  FROM  USUSU
            INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
            INNER JOIN CAJ ON UBEQ.CAJA = CAJ.CODCAJA
            WHERE  USUARIO = @USUARIO
      SELECT @TOTAL = VALORTOTAL, @N_FACTURA = N_FACTURA, @IDAFILIADO = IDAFILIADO, @PROCEDENCIA = PROCEDENCIA,
             @IDTERCERO = IDTERCERO, @ESTADO= ESTADO, @FECHAFCJ = FECHA, @NOADMISION = NOADMISION FROM FCJ WHERE  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ

      IF (SELECT COALESCE(SUM (VALOR),0) FROM PCJ WHERE PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ ) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo no tiene detalles de pago.'
      END
      IF  (SELECT COALESCE(SUM (VALOR),0) FROM PCJ WHERE PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ ) > 0
      BEGIN
         IF (SELECT COALESCE(SUM (VALOR),0) FROM PCJ WHERE PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ ) <>  @TOTAL
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El valor del detalle de pago, es diferente al valor del Recibo'
         END
      END
      IF @FECHAFCJ > GETDATE()
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La fecha del recibo es mayor a la fecha actual'
      END
      IF (SELECT CASE WHEN EXISTS(SELECT * FROM PRI WHERE FECHA_INI<=FCJ.FECHA AND FECHA_FIN>FCJ.FECHA AND CERRADO=0) THEN 'OK' ELSE 'ERROR' END FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ) <>'OK'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El periodo contable esta cerrado'
      END
      IF (SELECT CERRADA FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ ) = 1
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo ya se encuentra confirmado'
      END
      IF (SELECT ESTADO FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ ) = 'D'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede Confirmar un Recibo Desecho.'
      END
      IF (SELECT ESTADO FROM FCJ WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ ) = 'A'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede Confirmar un Recibo Anulado.'
      END
      IF @TOTAL<=0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'No se puede Confirmar un Recibo Con Valor Cero (0).'
      END
      IF (SELECT COUNT(1) FROM MCP WHERE PROCEDENCIA='CAJA' AND   REFERENCIA2 = @CODCAJA AND REFERENCIA1 = @CNSFACJ   AND COALESCE(ANULADO,0)=0) <> 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo ya se encuentra contabilizado'
      END
      IF @PROCEDENCIA = 'CITAS'
      BEGIN
         IF (SELECT COUNT(1)  FROM CIT WHERE  CONSECUTIVO = @NOADMISION AND IDAFILIADO = @IDAFILIADO    ) = 0
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La cita fue cancelada, no se puede confirmar.'
         END
      END
      IF @PROCEDENCIA = 'CE'
      BEGIN
         IF (SELECT ESTADO  FROM AUT WHERE  NOAUT  = @NOADMISION AND  @PROCEDENCIA = 'CE' ) = 'Anulada'
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'La Autorización fue anulada, no se puede confirmar.'
         END
      END
      IF (SELECT COUNT(1) FROM  ACJ WHERE  CODCAJA = @CODCAJA AND ABIERTA = 1 ) >1
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja se encuentra abierta mas de una vez.'
      END
      IF (SELECT COUNT(1) FROM  ACJ WHERE  CODCAJA = @CODCAJA AND ABIERTA = 1 ) = 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'La caja no se encuentra abierta.'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            IF @CNSACJ <> (SELECT CNSACJ FROM  ACJ WHERE  CODCAJA = @CODCAJA AND ABIERTA = 1)
            UPDATE FCJ SET CNSACJ = (SELECT CNSACJ FROM  ACJ WHERE  CODCAJA = @CODCAJA AND ABIERTA = 1) WHERE FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ  
         
            EXEC SPK_CIERRERECIBO_CAJA @CODCAJA, @CNSFACJ, @COMPANIA, @IDSEDE, @USUARIO, @SYS_COMPUTERNAME
            EXEC SPK_ACTUALIZA_SALDO_BANCO @CNSFACJ, @CODCAJA
            EXEC SPK_NC_CONTAB_CAJA_ING @CNSFACJ, @CODCAJA, @USUARIO, @SYS_COMPUTERNAME, @COMPANIA, @IDSEDE, @NROCOMPROBANTE

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
    END
   END
   IF @METODO = 'DETALLE_MOVIMIENTO'
   BEGIN
      SELECT @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(10)    '$.CODCAJA' ,
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' 

      )
	   BEGIN 
         SELECT FCJ.CNSFACJ, FCJ.NROCOMPROBANTE, FCJ.CODCAJA,CAJ.DESCRIPCION, FCJ.CLASE_FAC, FCJ.VALORTOTAL, FCJ.COMPANIA, FCJ.IDAFILIADO,CJR.DESCRIPCION [DESCJR]
            , FCJ.CERRADA, FCJ.FECHA, FCJ.PROCEDENCIA, FCJ.CNSACJ, FCJ.TIPO, FCJ.ESTADO, AFI.NOMBREAFI, AFI.TIPO_DOC, AFI.DOCIDAFILIADO
            , FCJ.SYS_ComputerName, FCJ.OBSERVACION, FCJ.USUARIOLOG, FCJ.IDTERCERO,TER.RAZONSOCIAL,FCJ.USUARIO 
            , COALESCE((SELECT SUM(VALOR) FROM PCJ WHERE  PCJ.CODCAJA = FCJ.CODCAJA AND PCJ.CNSFACJ = FCJ.CNSFACJ),0) [MONTOTOTAL]
            , FCJ.VALORTOTAL - COALESCE((SELECT SUM(VALOR) FROM PCJ WHERE  PCJ.CODCAJA = FCJ.CODCAJA AND PCJ.CNSFACJ = FCJ.CNSFACJ),0) [MONTOPENDIENTE]
         FROM [dbo].[FCJ] 
               INNER JOIN  CAJ ON FCJ.CODCAJA = CAJ.CODCAJA
               LEFT JOIN AFI ON FCJ.IDAFILIADO = AFI.IDAFILIADO
               LEFT JOIN TER ON FCJ.IDTERCERO = TER.IDTERCERO
               LEFT JOIN CJR ON FCJ.IDAFILIADO = CJR.CODCAJERO 
         WHERE  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ
      END
   END
   IF @METODO = 'NUEVO_RECIBO_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSACJ = CNSACJ, @TIPOPAGO = TIPOPAGO, @TERCERO = TERCERO , @OBSERVACION = OBSERVACION , @NUMERO_CUENTA = NUMERO_CUENTA
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSACJ     VARCHAR(20)    '$.CNSACJ' ,
	   TIPOPAGO     VARCHAR(20)    '$.TIPOPAGO' ,
	   TERCERO     VARCHAR(20)    '$.TERCERO' ,
	   OBSERVACION     VARCHAR(200)    '$.OBSERVACION',
	   NUMERO_CUENTA     VARCHAR(20)    '$.NUMERO_CUENTA'
      )

      IF (SELECT COUNT(*) FROM FCJ WHERE CLASE_FAC = 'PAGO' AND CODCAJA = @CODCAJA AND TIPOEGRESO = @TIPOPAGO AND COALESCE(CERRADA,0)  = 0 AND COALESCE(ARCHIVADO,0) = 0  AND ESTADO='P' AND FCJ.CNSACJ = @CNSACJ ) > 0
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Tiene Pendiente un traslado sin Cerrar, CAJA - EGRESOS.'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
			IF (SELECT CAST( CASE WHEN U1.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) CONSIGNACION
				FROM CJTE
					LEFT JOIN USVGS U1 ON U1.IDVARIABLE = 'IDCJTECONSIGNACION' 
				WHERE EXISTS(SELECT  * FROM TGEN WHERE TABLA = @CODCAJA AND CJTE.TIPOEGRESO = @TIPOPAGO  AND  CAMPO = 'TIPOEGRESO' AND CODIGO = CJTE.CODIGO )
					AND EXISTS (SELECT   IDTERCERO, RAZONSOCIAL FROM VWK_TEXCA WHERE VWK_TEXCA.IDCATEGORIA = CJTE.IDCATEGORIA AND ESTADO = 'Activo' AND CJTE.MTERCERO = 1 ))=0
			BEGIN
				SELECT @NUMERO_CUENTA = NULL
			END
			DECLARE @TIPO_2 VARCHAR(20)
			SELECT @TIPO_2 = (SELECT CODIGO FROM CJTE WHERE TIPOEGRESO =@TIPOPAGO )

			SET @CNSFACJ=NULL
			EXEC SPK_GENCONSECUTIVO @COMPANIA,@CODCAJA,'@FCJE',@CNSFACJ OUTPUT
			SELECT @CNSFACJ = 'E' + REPLACE(SPACE(8 - LEN(@CNSFACJ))+LTRIM(RTRIM(@CNSFACJ)),SPACE(1),0)
	
			 INSERT INTO FCJ (CNSFACJ,TIPO,CODCAJA,COMPANIA, CLASE_FAC,CNSACJ,ESTADO,USUARIO,SYS_ComputerName,IDTERCERO, FECHA, TIPOEGRESO, OBSERVACION, PROCEDENCIA, VALORTOTAL , USUARIOLOG
			 ,BANCO, SUCURSAL, CTA_BCO , DEAPERTURA)
			 
			 SELECT @CNSFACJ, 'INTERNO', @CODCAJA, @COMPANIA, 'PAGO', @CNSACJ, 'P', @CODCAJERO, @SYS_COMPUTERNAME, @TERCERO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), @TIPOPAGO, @OBSERVACION, 'CAJA',0, @USUARIO
			, (SELECT BANCO FROM BCT WHERE  CTA_BCO = @NUMERO_CUENTA), (SELECT SUCURSAL FROM BCT WHERE  CTA_BCO = @NUMERO_CUENTA), @NUMERO_CUENTA , 0
			IF (SELECT COUNT(*) FROM CJTE WHERE TIPOEGRESO =  @TIPOPAGO AND GENCPAUT = 1 AND COALESCE(CODIGO, '') = '') > 0
			BEGIN
				INSERT INTO FCJD (CODCAJA, CNSFACJ, ITEM, CONCEPTO,CANTIDAD,VALORUNITARIO,VALORTOTAL)
				SELECT @CODCAJA, @CNSFACJ, 1, @TIPO_2,1,0,0
			END
			IF (SELECT COUNT(*) FROM CJTE WHERE TIPOEGRESO =  @TIPOPAGO AND GENCPAUT = 1 AND COALESCE(CODIGO, '') <> '') > 0
			BEGIN
				INSERT INTO FCJD (CODCAJA, CNSFACJ, ITEM, CONCEPTO,CANTIDAD,VALORUNITARIO,VALORTOTAL)
				SELECT @CODCAJA, @CNSFACJ, 1, @TIPO_2,1,0,0
			END

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END
   IF @METODO = 'VALIDA_INSERT_FCJD_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA     VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ     VARCHAR(20)    '$.CNSFACJ' 
      )
      
      IF EXISTS (SELECT * FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ)
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Ya cuenta con un movimiento de detalle'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            SELECT 'OK' OK
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END
   IF @METODO = 'INSERT_FCJD_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ, @CONCEPTO = CONCEPTO, @VLR_UNIT = VLR_UNIT , @CANTIDAD = CANTIDAD, @CCOSTO = CCOSTO
      , @TERCERO = TERCERO, @UNS = UNS
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' ,
	   CONCEPTO       VARCHAR(20)    '$.CONCEPTO' ,
	   VLR_UNIT       INT            '$.VLR_UNIT' ,
	   CANTIDAD       INT            '$.CANTIDAD' ,
	   TERCERO        VARCHAR(20)    '$.TERCERO' ,
	   UNS            VARCHAR(20)    '$.UNS' ,
	   CCOSTO            VARCHAR(20)    '$.CCOSTO' 
      )
      
      IF 1 = 2
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Ya cuenta con un movimiento de detalle'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            INSERT INTO FCJD (CODCAJA, CNSFACJ, ITEM, CONCEPTO, VALORUNITARIO, CANTIDAD, VALORTOTAL, IDTERCERO, UNSPSC, CCOSTO)
            SELECT @CODCAJA, @CNSFACJ, 1, @CONCEPTO, COALESCE( @VLR_UNIT, 0) , COALESCE(@CANTIDAD,0), COALESCE( @VLR_UNIT, 0) *  COALESCE(@CANTIDAD,0), @TERCERO, @UNS, @CCOSTO
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END
   IF @METODO = 'ELIMINAR_FCJD_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' 
      )
      
      IF 1 = 2
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Ya cuenta con un movimiento de detalle'
      END
      IF EXISTS(SELECT * FROM PCJ WHERE  CODCAJA = @CODCAJA  AND CNSFACJ = @CNSFACJ )
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Cuenta con formas de pago existentes'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            DELETE FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END 
   IF @METODO = 'DESHACER_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' 
      )
      
      IF (SELECT ESTADO FROM FCJ WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ) = 'D'
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo se encuentra desechado'
      END
      IF EXISTS (SELECT * FROM PCJ WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo cuenta con un registro en Forma de Pago'
      END
      IF EXISTS (SELECT * FROM FCJD WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ )
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo cuenta con un registro en Movimiento'
      END

      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
            UPDATE FCJ SET ESTADO = 'D' WHERE  CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END 
   IF @METODO = 'PCJ_INGRESOS'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' 
      )
      --CNSFACJ
	  SELECT @IDCJFPAEFECTIVO = (SELECT DBO.FNK_VALORVARIABLE ('IDCJFPAEFECTIVO'))
      SELECT  @CNSACJ = CNSACJ FROM FCJ WHERE  FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ
      SELECT PCJ.CNSFACJ,PCJ.CNSPCJ, PCJ.CODCAJA,  FORMAT(PCJ.VALOR, 'C2', 'en-us') VALOR, PCJ.TIPOPAGO ,PCJ.CNSACJ,  SUBSTRING(UPPER (FPA.DESCRIPCION), 1, 1) + SUBSTRING (LOWER (FPA.DESCRIPCION), 2,30) [DESCRIPCION] 
     ,TRASLADO_CNSFACJ, TRASLADADO,  FCJ.TIPOEGRESO, FCJ.CLASE_FAC, FCJ.ESTADO, CASE WHEN PCJ.TRASLADO_CNSFACJ = @CNSFACJ THEN 1 ELSE 0 END SELECCIONADO
     FROM PCJ 
     INNER JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
     INNER JOIN FCJ ON PCJ.CNSFACJ = FCJ.CNSFACJ AND PCJ.CODCAJA = FCJ.CODCAJA
     WHERE  PCJ.CODCAJA = @CODCAJA AND PCJ.CNSACJ = @CNSACJ AND PCJ.TIPOPAGO = @IDCJFPAEFECTIVO AND  FCJ.CLASE_FAC = 'COBRO' AND FCJ.ESTADO = 'P'
      AND (PCJ.TRASLADO_CNSFACJ = @CNSFACJ OR COALESCE(PCJ.TRASLADO_CNSFACJ,'')='') AND FCJ.CERRADA = 1 --AND  PCJ.CNSFACJ = '00001123'
	  AND COALESCE(FCJ.DEAPERTURA,0)<>1  -- agregado por EEMC 26-07-2024 porque las aperturas estaban saliendo elegible para trasladar
      ORDER BY  PCJ.CNSFACJ DESC
     --CNSFACJ
   END 
   IF @METODO = 'SELECCION_PCJ'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ, @SELECCIONADOS = SELECCIONADOS
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' ,
	   SELECCIONADOS        VARCHAR(1000)    '$.SELECCIONADOS' 
      )

      DECLARE @TTABLE TABLE ( CONSECUTIVO VARCHAR(13) )
	   INSERT INTO @TTABLE( CONSECUTIVO )
	   SELECT VALUE from string_split(@SELECCIONADOS,',')SELECCIONADOS
      SELECT @VALOR = SUM(VALOR) FROM PCJ WHERE CNSPCJ IN (SELECT CONSECUTIVO FROM @TTABLE )
      --SELECT @VALORAUTD = 
      --SELECT SUM(VALOR) FROM CAJR WHERE  CODCAJA = @CODCAJA

      IF 1 = 2
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El monto no puede ser mayor.'
      END
      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY
           SELECT 'OK' OK, SUM(VALOR) VALOR , FORMAT(SUM(VALOR), 'C0') FORMATO_SUMA, CAST(SUM(VALOR) as money) DINERO FROM PCJ WHERE CNSPCJ IN (SELECT CONSECUTIVO FROM @TTABLE )

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END 
   IF @METODO = 'IMPRIME_CONTA_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' ,
	   CNSACJ         VARCHAR(20)    '$.CNSACJ' 
      )
       SELECT @NROCOMPROBANTE = FCJ.NROCOMPROBANTE FROM FCJ WHERE  FCJ.CLASE_FAC = 'PAGO' AND FCJ.CNSACJ =  @CNSACJ AND FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ 
      IF (SELECT COALESCE(CERRADA,0) FROM FCJ WHERE  FCJ.CLASE_FAC = 'PAGO' AND FCJ.CNSACJ =  @CNSACJ AND FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ) <> 1
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'El recibo no esta confirmado aun.'
      END
      IF NOT EXISTS (SELECT * FROM MCP WHERE NROCOMPROBANTE = @NROCOMPROBANTE)
      BEGIN
         INSERT INTO @TBLERRORES(ERROR) SELECT 'Comprobante con errores contables.'
      END
      IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
      ELSE
      BEGIN
         BEGIN TRY--OBSERVACION
         SELECT 'OK' OK,@USUNOMBRE [USUNOMBRE], FCJ.NROCOMPROBANTE, MCP.COMPROBANTE, MCP.NOREFERENCIA, MCP.REFERENCIA1,TER.IDTERCERO, TER.RAZONSOCIAL,TER.NIT,  MCP.FECHA, MCP.BANCO, MCP.NOCHEQUE, MCP.VALOR_CHEQUE
         , REPLACE(REPLACE(REPLACE(RTRIM(LTRIM(REPLACE(REPLACE(REPLACE(convert(nvarchar(max),MCP.OBSERVACION),CHaR(10),' ') ,CHaR(13),' ') ,'  ',' '))),CHAR(9),''),'"',''),'	 ',' ') OBSERVACION
         ,CONVERT(varchar,FCJ.FECHA,104) FECHAFORMATO, CONVERT (DATETIME ,FCJ.FECHA) FECHACOMPLETA, REPLACE(REPLACE(RIGHT(CONVERT(VARCHAR(25), FCJ.FECHA, 100), 7), 'AM', ' a.m.'), 'PM', ' p.m.') HORA
            , Format(FCJ.FECHA,'dd/MM/yyyy hh:mm tt') AS FECHA_HORARIO,   CONVERT(varchar,FCJ.FECHA,104) FECHAFCJ , CONVERT(DATE,FCJ.FECHA) SOLOFECHA
            ,SED.DESCRIPCION [SED_NOMBRE], SED.DIRECCION [SED_DIRECCION]
         , SED.TELEFONOS [SED_TELEFONOS],   SED.NIT [SED_NIT], SED.DV [SED_DV], TERSED.NIT [NIT_ASEG], TERSED.RAZONSOCIAL [ASEG_NOMBRE],CIUSED.NOMBRE [SED_CIUDAD], FCJ.USUARIO,USU_CREA.NOMBRE [USU_CREA_NOMBRE]
         FROM [dbo].[FCJ]
                      LEFT JOIN MCP ON FCJ.NROCOMPROBANTE = MCP.NROCOMPROBANTE
                      LEFT JOIN TER ON MCP.IDTERCERO = TER.IDTERCERO
                      LEFT JOIN SED ON SED.IDSEDE = @IDSEDE
                      LEFT JOIN TER TERSED ON SED.NIT = TERSED.NIT AND COALESCE(TERSED.RAZONSOCIAL,'') <> ''
                      LEFT JOIN CIU CIUSED ON SED.CIUDAD = CIUSED.CIUDAD
					  LEFT JOIN USUSU USU_CREA ON FCJ.USUARIO = USU_CREA.USUARIO
          WHERE FCJ.CLASE_FAC = 'PAGO' AND FCJ.CNSACJ =  @CNSACJ AND FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSFACJ 

         SELECT NROCOMPROBANTE, CUENTA, COALESCE(DETALLE,'') DETALLE, TIPO, CASE WHEN TIPO = 'DB' THEN VALOR ELSE 0 END DB,
                 CASE WHEN TIPO = 'CR' THEN VALOR ELSE 0 END CR
         FROM MCH  WHERE NROCOMPROBANTE = @NROCOMPROBANTE ORDER BY   TIPO  DESC

         SELECT  (SELECT SUM(VALOR) FROM MCH M WHERE M.NROCOMPROBANTE = MCH.NROCOMPROBANTE AND M.TIPO = 'DB' )DEBITO ,(SELECT SUM(VALOR) FROM MCH M WHERE M.NROCOMPROBANTE = MCH.NROCOMPROBANTE AND M.TIPO = 'CR' )CREDITO
         FROM MCH WHERE NROCOMPROBANTE = @NROCOMPROBANTE GROUP BY NROCOMPROBANTE 

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END 
   IF @METODO = 'IMPRIME_ARQUEO_EGRESO'
	BEGIN
      SELECT  @CODCAJA = CODCAJA, @CNSFACJ = CNSFACJ, @CNSACJ = CNSACJ
      FROM OPENJSON(@PARAMETROS)WITH(
	   CODCAJA        VARCHAR(20)    '$.CODCAJA' ,
	   CNSFACJ        VARCHAR(20)    '$.CNSFACJ' ,
	   CNSACJ         VARCHAR(20)    '$.CNSACJ' 
      )

		IF NOT EXISTS (SELECT ACJ.CNSACJ, ACJ.CODCAJA, CAJ.DESCRIPCION, 
				convert(varchar,ACJ.FECHAAPERTURA,103)+' '+convert(varchar,ACJ.FECHAAPERTURA,8) FECHAAPERTURA,
				ACJ.CODTURNO, TUR.DESCRIPCION, ACJ.CODCAJERO, CJR.DESCRIPCION, 
				convert(varchar,ACJ.FECHACIERRE,103)+' '+convert(varchar,ACJ.FECHACIERRE,8) FECHACIERRE, 
				IIF(ACJ.ABIERTA=0,'NO','SI') ABIERTA
			FROM ACJ 
				INNER JOIN CAJ ON ACJ.CODCAJA = CAJ.CODCAJA
				INNER JOIN TUR ON TUR.CODTURNO = ACJ.CODTURNO
				INNER JOIN CJR ON ACJ.CODCAJERO = CJR.CODCAJERO
			WHERE ACJ.CODCAJA = @CODCAJA AND ACJ.CNSACJ = @CNSACJ)
		BEGIN
			INSERT INTO @TBLERRORES(ERROR) SELECT 'No cuenta con Arquedo de Caja.'
		END
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
			SELECT 'KO' OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		ELSE
		BEGIN
			BEGIN TRY
				SELECT 'OK' OK,ACJ.CNSACJ, ACJ.CODCAJA, CAJ.DESCRIPCION, 
					convert(varchar,ACJ.FECHAAPERTURA,103)+' '+convert(varchar,ACJ.FECHAAPERTURA,8) FECHAAPERTURA,
					ACJ.CODTURNO, TUR.DESCRIPCION [DESC_TURNO], ACJ.CODCAJERO, CJR.DESCRIPCION [NOM_CAJERO], 
					convert(varchar,ACJ.FECHACIERRE,103)+' '+convert(varchar,ACJ.FECHACIERRE,8) FECHACIERRE, 
					IIF(ACJ.ABIERTA=0,'NO','SI') ABIERTA
					,SED.DESCRIPCION [SED_NOMBRE], SED.DIRECCION [SED_DIRECCION]
					, SED.TELEFONOS [SED_TELEFONOS],   SED.NIT [SED_NIT], SED.DV [SED_DV], TERSED.NIT [NIT_ASEG], TERSED.RAZONSOCIAL [ASEG_NOMBRE],CIUSED.NOMBRE [SED_CIUDAD]
				FROM ACJ 
					INNER JOIN CAJ ON ACJ.CODCAJA = CAJ.CODCAJA
					INNER JOIN TUR ON TUR.CODTURNO = ACJ.CODTURNO
					INNER JOIN CJR ON ACJ.CODCAJERO = CJR.CODCAJERO
					LEFT JOIN SED ON SED.IDSEDE = @IDSEDE
					LEFT JOIN TER TERSED ON SED.NIT = TERSED.NIT AND COALESCE(TERSED.RAZONSOCIAL,'') <> ''
					LEFT JOIN CIU CIUSED ON SED.CIUDAD = CIUSED.CIUDAD
				WHERE ACJ.CODCAJA = @CODCAJA AND ACJ.CNSACJ = @CNSACJ
				ORDER BY FECHAAPERTURA ASC

         /*DETALLE*/
         SELECT 'OK' OK, FCJ.CNSFACJ, FCJ.FECHA, FCJ.NOMBRECLIENTE, FCJD.CONCEPTO+' - '+CPCJ.DESCRIPCION [CONCEPTO], 
                SUM(CASE WHEN FCJ.CLASE_FAC='COBRO' THEN  PCJ.VALOR ELSE 0 END) INGRESOS, 
                SUM(CASE WHEN FCJ.CLASE_FAC='PAGO' THEN  PCJ.VALOR ELSE 0 END)  EGRESOS
         FROM FCJ INNER JOIN FCJD ON FCJ.CNSFACJ = FCJD.CNSFACJ AND FCJ.CODCAJA = FCJD.CODCAJA
                  INNER JOIN PCJ ON FCJ.CODCAJA=PCJ.CODCAJA AND FCJ.CNSFACJ=PCJ.CNSFACJ 
                  INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO 
                  LEFT  JOIN CPCJ ON FCJD.CONCEPTO = CPCJ.CODIGO
         WHERE FCJ.CNSACJ=@CNSACJ
         AND FCJ.CERRADA=1 
         AND COALESCE(FCJ.DEAPERTURA,0) <>1 
         AND FCJ.ESTADO<>'A' AND FCJ.CLASE_FAC = 'COBRO'
         GROUP BY  FCJ.CNSFACJ, FCJ.FECHA, FCJ.NOMBRECLIENTE, FCJD.CONCEPTO+' - '+CPCJ.DESCRIPCION
         UNION ALL
         SELECT  'OK' OK, FCJ.CNSACJ, FCJ.FECHA, ACJ.CODCAJERO+'-'+ CJR.DESCRIPCION [NOMBRECLIENTE] , FCJD.CONCEPTO+'-'+CPCJ.DESCRIPCION [CONCEPTO] , FCJ.VALORTOTAL INGRESOS, 0 EGRESOS 
         FROM FCJ 
               INNER JOIN FCJD ON FCJ.CNSFACJ = FCJD.CNSFACJ AND FCJ.CODCAJA = FCJD.CODCAJA
               INNER JOIN ACJ ON FCJ.CNSACJ = ACJ.CNSACJ AND FCJ.CODCAJA = ACJ.CODCAJA
               INNER JOIN CJR ON ACJ.CODCAJERO = CJR.CODCAJERO
               LEFT JOIN PCJ ON FCJ.CODCAJA=PCJ.CODCAJA AND FCJ.CNSFACJ=PCJ.CNSFACJ 
               LEFT  JOIN CPCJ ON FCJD.CONCEPTO = CPCJ.CODIGO
         WHERE  FCJ.CNSACJ = @CNSACJ AND FCJ.CODCAJA = @CODCAJA AND FCJ.CNSFACJ = @CNSACJ
         UNION ALL
         SELECT 'OK' OK,  FCJ.N_RECIBO CNSFACJ, FCJ.FECHA, FCJ.IDTERCERO+'-'+TER.RAZONSOCIAL [NOMBRECLIENTE], FCJD.CONCEPTO+' - '+CPCJ.DESCRIPCION [CONCEPTO], 
                SUM(CASE WHEN FCJ.CLASE_FAC='COBRO' THEN  PCJ.VALOR ELSE 0 END) INGRESOS, 
                SUM(CASE WHEN FCJ.CLASE_FAC='PAGO' THEN  PCJ.VALOR ELSE 0 END)  EGRESOS
         FROM FCJ INNER JOIN FCJD ON FCJ.CNSFACJ = FCJD.CNSFACJ AND FCJ.CODCAJA = FCJD.CODCAJA
                  INNER JOIN PCJ ON FCJ.CODCAJA=PCJ.CODCAJA AND FCJ.CNSFACJ=PCJ.CNSFACJ 
                  INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO 
                  LEFT  JOIN CPCJ ON FCJD.CONCEPTO = CPCJ.CODIGO
                  --LEFT JOIN CAJ ON FCJ.IDTERCERO = CAJ.CODCAJA
				  LEFT JOIN TER ON FCJ.IDTERCERO = TER.IDTERCERO
         WHERE FCJ.CNSACJ=@CNSACJ
         AND FCJ.CERRADA=1 
         AND COALESCE(FCJ.DEAPERTURA,0) <>1 
         AND FCJ.ESTADO<>'A' AND FCJ.CLASE_FAC = 'PAGO'
         GROUP BY  FCJ.N_RECIBO , FCJ.FECHA, FCJ.IDTERCERO+'-'+TER.RAZONSOCIAL , FCJD.CONCEPTO+' - '+CPCJ.DESCRIPCION
         
         /*Total Recibos*/
         SELECT SUM(CASE WHEN FCJ.CLASE_FAC='COBRO' THEN  PCJ.VALOR ELSE 0 END) INGRESOS, 
                SUM(CASE WHEN FCJ.CLASE_FAC='PAGO' THEN  PCJ.VALOR ELSE 0 END)  EGRESOS
         FROM FCJ INNER JOIN FCJD ON FCJ.CNSFACJ = FCJD.CNSFACJ AND FCJ.CODCAJA = FCJD.CODCAJA
                  INNER JOIN PCJ ON FCJ.CODCAJA=PCJ.CODCAJA AND FCJ.CNSFACJ=PCJ.CNSFACJ 
                  INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO 
                  LEFT  JOIN CPCJ ON FCJD.CONCEPTO = CPCJ.CODIGO
         WHERE FCJ.CNSACJ=@CNSACJ
         AND FCJ.CERRADA=1 
         AND COALESCE(FCJ.DEAPERTURA,0) <>1 
         AND FCJ.ESTADO<>'A'

         /*SUB TOTAL*/
         SELECT PCJ.TIPOPAGO,FPA.DESCRIPCION,SUM(CASE WHEN FCJ.CLASE_FAC='COBRO' THEN  PCJ.VALOR ELSE 0 END) [VLR_INGRESO], 
            SUM(CASE WHEN FCJ.CLASE_FAC='PAGO' THEN  PCJ.VALOR ELSE 0 END) [VLR_EGRESOS],
            SUM(CASE WHEN FCJ.CLASE_FAC='COBRO' THEN  PCJ.VALOR ELSE 0 END)-SUM(CASE WHEN FCJ.CLASE_FAC='PAGO' THEN  PCJ.VALOR ELSE 0 END) [VLR_SALDO]
         FROM FCJ INNER JOIN PCJ ON FCJ.CODCAJA=PCJ.CODCAJA AND FCJ.CNSFACJ=PCJ.CNSFACJ 
                  INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO 
         WHERE FCJ.CNSACJ=@CNSACJ
         AND FCJ.CERRADA=1 
         AND COALESCE(FCJ.DEAPERTURA,0) <>1  
         AND FCJ.ESTADO<>'A'
         GROUP BY PCJ.TIPOPAGO,FPA.DESCRIPCION

         /*CAJERO IMPRIME*/
         SELECT CJR.CODCAJERO+' - '+CJR.DESCRIPCION [NOM_CAJERO] FROM  USUSU 
            LEFT JOIN CJR ON USUSU.CODCAJERO = CJR.CODCAJERO
         WHERE USUSU.USUARIO = @USUARIO

         END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END 
	IF @METODO = 'FORMA_PAGO_EGRESO_NO'
	BEGIN
	SELECT @CODCAJA = CODCAJA
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (CODCAJA				VARCHAR(5)		'$.CODCAJA'
					)

		SELECT 'OK' AS OK
		/* TIPOS DE EGRESO */
		SELECT  CJTE.TIPOEGRESO value, CJTE.DESCRIPCION label, CJTE.IDCATEGORIA
			, CAST( CASE WHEN U1.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) CONSIGNACION
			,CAST( CASE WHEN U2.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) ESBANCO
			,CAST( CASE WHEN U3.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) TRASLADOBANCOCAJA
			,CAST( CASE WHEN U4.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) ESTRASLADO
			,CAST( CASE WHEN U5.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) ESNOMINA
			,CAST( CASE WHEN U6.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) TRASLADOENTREBANCOS
			,CAST( CASE WHEN U7.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS BIT) ESDEVOLUCION
			--, TERCEROS= (SELECT  IDTERCERO value, RAZONSOCIAL label, VWK_TEXCA.IDCATEGORIA  
			--			FROM VWK_TEXCA 
			--			WHERE VWK_TEXCA.IDCATEGORIA = CJTE.IDCATEGORIA AND ESTADO = 'Activo' AND CJTE.MTERCERO = 1 FOR JSON PATH)  
			, CJTE.MTERCERO
		FROM CJTE
			LEFT JOIN USVGS U1 ON U1.IDVARIABLE = 'IDCJTECONSIGNACION' 
			LEFT JOIN USVGS U2 ON U2.IDVARIABLE = 'TERCATBANCO' 
			LEFT JOIN USVGS U3 ON U3.IDVARIABLE = 'IDCJTETRASBCOCAJA' 
			LEFT JOIN USVGS U4 ON U4.IDVARIABLE = 'IDCJTETRASLADO' 
			LEFT JOIN USVGS U5 ON U5.IDVARIABLE = 'IDCJTENOMINA' 
			LEFT JOIN USVGS U6 ON U6.IDVARIABLE = 'IDCJTETRASLADOBCO' 
			LEFT JOIN USVGS U7 ON U7.IDVARIABLE = 'IDCJTEDEVOLDEPOSITO' 
		WHERE EXISTS(SELECT  * FROM TGEN WHERE TABLA = @CODCAJA AND  CAMPO = 'TIPOEGRESO' AND CODIGO = CJTE.TIPOEGRESO )
			AND EXISTS (SELECT   IDTERCERO, RAZONSOCIAL FROM VWK_TEXCA WHERE VWK_TEXCA.IDCATEGORIA = CJTE.IDCATEGORIA AND ESTADO = 'Activo' AND CJTE.MTERCERO = 1 )

		/* FORMAS DE PAGO */
		SELECT
			FPA.FORMAPAGO value
			,FPA.DESCRIPCION label
			,FISICO = CAST(FISICO AS BIT)
			,REQBCO = CAST(REQBCO AS BIT)
			,REQDOC = CAST(REQDOC AS BIT)
			,REQAUT = CAST(REQAUT AS BIT)
			,CXC = CAST(CXC AS BIT)
			,AUTINT = CAST(AUTINT AS BIT)
			,MEDIOPAGO  = CAST(MEDIOPAGO AS BIT)
			,TEDEVOLUCION = CAST(TEDEVOLUCION AS BIT)
			,CUENTA
			,CEROENAPERTURA = CAST(CEROENAPERTURA AS BIT)
			,USAR_CUENTACAJA = CAST(USAR_CUENTACAJA AS BIT)  
			,REQCTA_BCO_DEP = CAST(REQCTA_BCO_DEP AS BIT)
			,GENCHEQUE = CAST(GENCHEQUE AS BIT)
			,COMPROBANTE_EGR
			,DATAFONO = CAST(COALESCE(DATAFONO,0) AS BIT)
			,PAGARE = CAST(CASE WHEN U1.DATO = FPA.FORMAPAGO THEN 1 ELSE 0 END AS BIT)
			,DESCUENTO_NOMINA = CAST(CASE WHEN U2.DATO = FPA.FORMAPAGO THEN 1 ELSE 0 END AS BIT)
			,TERCEROS = (SELECT TER.IDTERCERO value, TER.RAZONSOCIAL label FROM BCO INNER JOIN TER ON BCO.IDTERCERO = TER.IDTERCERO WHERE CAST(REQBCO AS BIT) = 1 FOR JSON PATH)
		FROM FPA
			INNER JOIN TGEN ON FPA.FORMAPAGO = TGEN.CODIGO AND TGEN.CAMPO = 'FORMAPAGO' AND TGEN.TABLA = @CODCAJA
			LEFT JOIN USVGS U1 ON U1.IDVARIABLE = 'IDFPAPAGARE'
			LEFT JOIN USVGS U2 ON U2.IDVARIABLE = 'IDCJFPADESCUENT_NOMI'

	END
	IF @METODO = 'ESTADO_CAJA'
	BEGIN
		SELECT @CODCAJA = CODCAJA
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (CODCAJA				VARCHAR(5)		'$.CODCAJA'
			   )

		SELECT 'OK' AS OK
		SELECT CAJ.CODCAJA
			,CAJ.DESCRIPCION
			,CAJ.TIPO
			,CAJ.CLASE
			,CAJ.FOFI
			,CAJ.ESTADO
			,CAJ.ABIERTA
			,CASE 
				WHEN CAJ.ABIERTA = 1
					THEN 'Abierta'
				ELSE 'Cerrada'
				END [ESTACAJA]
			,CAJ.CNSACJ
		FROM [dbo].[CAJ]
		WHERE (
				CAJ.CODCAJA LIKE '%%%%'
				OR CAJ.DESCRIPCION LIKE '%%%%'
				)
			AND CAJ.ESTADO IN (
				'Activo'
				,'Inactivo'
				)
			AND CAJ.CODCAJA = @CODCAJA

	END
	IF @METODO = 'FORMA_TIPOEGRESO'
	BEGIN
		SELECT @FORMAPAGO =  FORMAPAGO, @CODCAJA = CODCAJA, @DESCRIPCION = DESCRIPCION
	   FROM OPENJSON (@PARAMETROS)
	   WITH		 (FORMAPAGO				VARCHAR(20)		'$.FORMAPAGO'
				   ,CODCAJA				VARCHAR(5)		'$.CODCAJA'
				   ,DESCRIPCION			VARCHAR(100)    '$.DESCRIPCION'
			   )

		BEGIN TRY 
			SELECT 'OK'OK
			SELECT  CJTE.TIPOEGRESO value, CJTE.DESCRIPCION label, CJTE.IDCATEGORIA
			,CAST( CASE WHEN U1.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) CONSIGNACION
			,CAST( CASE WHEN U2.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) ESBANCO
			,CAST( CASE WHEN U3.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) TRASLADOBANCOCAJA
			,CAST( CASE WHEN U4.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) ESTRASLADO
			,CAST( CASE WHEN U5.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) ESNOMINA
			,CAST( CASE WHEN U6.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) TRASLADOENTREBANCOS
			,CAST( CASE WHEN U7.DATO = CJTE.TIPOEGRESO THEN 1 ELSE 0 END AS INT) ESDEVOLUCION
			, TERCEROS= (SELECT   IDTERCERO value, RAZONSOCIAL label, VWK_TEXCA.IDCATEGORIA  
						FROM VWK_TEXCA 
						WHERE VWK_TEXCA.IDCATEGORIA = CJTE.IDCATEGORIA AND ESTADO = 'Activo' AND CJTE.MTERCERO = 1 FOR JSON PATH)  
			, CJTE.MTERCERO
		FROM CJTE
			LEFT JOIN USVGS U1 ON U1.IDVARIABLE = 'IDCJTECONSIGNACION' 
			LEFT JOIN USVGS U2 ON U2.IDVARIABLE = 'TERCATBANCO' 
			LEFT JOIN USVGS U3 ON U3.IDVARIABLE = 'IDCJTETRASBCOCAJA' 
			LEFT JOIN USVGS U4 ON U4.IDVARIABLE = 'IDCJTETRASLADO' 
			LEFT JOIN USVGS U5 ON U5.IDVARIABLE = 'IDCJTENOMINA' 
			LEFT JOIN USVGS U6 ON U6.IDVARIABLE = 'IDCJTETRASLADOBCO' 
			LEFT JOIN USVGS U7 ON U7.IDVARIABLE = 'IDCJTEDEVOLDEPOSITO' 
		WHERE EXISTS(SELECT  * FROM TGEN WHERE TABLA = @CODCAJA AND CJTE.TIPOEGRESO = @FORMAPAGO  AND  CAMPO = 'TIPOEGRESO' AND CODIGO = CJTE.TIPOEGRESO )
			AND EXISTS (SELECT   IDTERCERO, RAZONSOCIAL FROM VWK_TEXCA WHERE VWK_TEXCA.IDCATEGORIA = CJTE.IDCATEGORIA AND ESTADO = 'Activo' AND CJTE.MTERCERO = 1 )
		END TRY
		BEGIN CATCH
			INSERT INTO @TBLERRORES(ERROR)
			SELECT ERROR_MESSAGE()
		END CATCH

		IF EXISTS(SELECT 1 FROM @TBLERRORES)
		BEGIN
			SELECT 'KO' AS OK
			SELECT ERROR FROM @TBLERRORES
			RETURN
		END

		SELECT 'OK' AS OK

		RETURN
	END
	ELSE
		EXEC SPQ_CONF_CAJA_2 @JSON
END

